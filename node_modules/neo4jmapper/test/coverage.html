<!DOCTYPE html><html><head><title>Coverage</title><script>

headings = [];

onload = function(){
  headings = document.querySelectorAll('h2');
};

onscroll = function(e){
  var heading = find(window.scrollY);
  if (!heading) return;
  var links = document.querySelectorAll('#menu a')
    , link;

  for (var i = 0, len = links.length; i < len; ++i) {
    link = links[i];
    link.className = link.getAttribute('href') == '#' + heading.id
      ? 'active'
      : '';
  }
};

function find(y) {
  var i = headings.length
    , heading;

  while (i--) {
    heading = headings[i];
    if (y >= heading.offsetTop) {
      return heading;
    }
  }
}
</script>
<style>

body {
  font: 14px/1.6 "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: 0;
  color: #2C2C2C;
  border-top: 2px solid #ddd;
}

#coverage {
  padding: 60px;
}

h1 a {
  color: inherit;
  font-weight: inherit;
}

h1 a:hover {
  text-decoration: none;
}

.onload h1 {
  opacity: 1;
}

h2 {
  width: 80%;
  margin-top: 80px;
  margin-bottom: 0;
  font-weight: 100;
  letter-spacing: 1px;
  border-bottom: 1px solid #eee;
}

a {
  color: #8A6343;
  font-weight: bold;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

ul {
  margin-top: 20px;
  padding: 0 15px;
  width: 100%;
}

ul li {
  float: left;
  width: 40%;
  margin-top: 5px;
  margin-right: 60px;
  list-style: none;
  border-bottom: 1px solid #eee;
  padding: 5px 0;
  font-size: 12px;
}

ul::after {
  content: '.';
  height: 0;
  display: block;
  visibility: hidden;
  clear: both;
}

code {
  font: 12px monaco, monospace;
}

pre {
  margin: 30px;
  padding: 30px;
  border: 1px solid #eee;
  border-bottom-color: #ddd;
  -webkit-border-radius: 2px;
  -moz-border-radius: 2px;
  -webkit-box-shadow: inset 0 0 10px #eee;
  -moz-box-shadow: inset 0 0 10px #eee;
  overflow-x: auto;
}

img {
  margin: 30px;
  padding: 1px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  -webkit-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  -moz-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  max-width: 100%;
}

footer {
  background: #eee;
  width: 100%;
  padding: 50px 0;
  text-align: right;
  border-top: 1px solid #ddd;
}

footer span {
  display: block;
  margin-right: 30px;
  color: #888;
  font-size: 12px;
}

#menu {
  position: fixed;
  font-size: 12px;
  overflow-y: auto;
  top: 0;
  right: 0;
  margin: 0;
  height: 100%;
  padding: 15px 0;
  text-align: right;
  border-left: 1px solid #eee;
  -moz-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-font-smoothing: antialiased;
  background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGYAAABmCAMAAAAOARRQAAABelBMVEUjJSU6OzshIyM5OjoqKy02NjgsLS01NTYjJCUzNTUgISMlJSc0NTUvMDA6PDwlJyg1NjYoKis2NjYrLS02ODkpKyw0NDYrLC04ODovLzA4Ojo0NDUtLy86OjwjIyU4OTosLS82ODgtLS8hIyQvMTEnKCooKSsrKy0qLCwkJSUnKCkrLCwpKiwwMjIxMzMqLC0tLS0pKissLC00NTYwMDIwMTQpKysoKSovMDEtLzA2OTkxMzUrKywvLy8qKyszNTY5OzsqKiw6OjswMDExNDUoKiozNDUvMDIyNDY1Njg2Njk5OTozMzU0NjY4ODkiIyUiIyQ4OTkuMDEmKCowMjQwMTErLS4qKywwMTMhIiMpKiopKy0tLjAkJScxNDQvLzExNDYyNDQmKCk5OTslJig5OjskJSYxMzQrLS8gISIwMTIoKCk1NTUlJSUnJygwMDA4ODgiIiMhISI8PDw6Ojo5OTkpKSojIyQ7OzsyMjIpKSssLCw6Ozw1NjlrfLakAAAg2UlEQVR42jR6i3ea6rYvPgANIAhVXh8WvkQlioUiFlFcBtAmoiRNdzxqu9p0J7vrdK29zuPeex77nnvO/35n1r1ndHRktI0jTOacv/l7lCBK5UqVpOha/YxmWK7BC4TQFKVXrbYsnimqxuuMVlOQ0XltWjUdCwRJ1M+tC1KudOs9q6+da2adUewG0SC0SwELfHtgDds93VEuydEbl3QMWeNoYkR7b/0x1ZRobGI3mLwzAhePqTAwhg6aogjNsGy7/jwQ4rkdqe7CWLxF8k9LfMVFyRS7VJqtkrW8Vt/bkR8FZJao16ipknbC3Yw2lM7laO6HBEOadEZ2tpf65c4v8e3u7FyU6qbiNNyCuzXZ6pawgnwgmrpTT/Q7w2EZmiIJ0dzWDI7mhQ80IfRnMu2kzA5r5r1pIFoia+/d93HRYp1GV8TbrkWoU/+jdI0Ff6yGwTjT1Hn8J+8m1rKpGiYPuNiHnMtNMIv+zpsk84MYTNW1/+DpwXLvckdOCMYowVNPREe0QlM8xRHXXFhcNDzupwsSmb5pH+0t0RP2Qk+QtI7F1Qm6JRC6ZPBtPq/dq/kH+jxtCljn9TIpW6rQIgmSVyj6lPICIw4N/taka41PFUInth0je9+jO6Kt1G4/a7V2LEgG02B0pHVuCZrgltSKMuIl5SyufUv9mYuQi+mFgzbBEtFo2g+Dh4sSTrLNu8JPh00sQydpb00tqXBvqRN7Q7kqzcnIxCGnvZt/WmJacoOEO6Dcn8Qre03pOCSQxbMOXUuDNx9SxuLz4W1I18gvjViQ67zV0rxdWL8Te/TQkuo8STS41DR48W7L6YP2uWIqiUV8rd6Gbf/rnegKZeG8TpAM6afhGze9JAOxbLjsnUXEbrZ9vLYd7MT32cPF5mKKxmjy7huaoD9n62GOxni3iIJwv0IzZAZjdZkUtolCNLVfYZNaquFjGszVVf+J0vrz4CawoKdHnOzb0NMH7CDBOybfYNJ4rfeMyFNjkFYVTzMFs87rnPGXLUOeNKRVc0LnU7/UIgelzsy3CMuth0YfvnY0wsD3vODUL3eJcKqHQpm8yM3XZQWJxO6Un9iYloyyLpOwN2obHy6W6gbpcb44XmyC+mg+itAcaprGcrwZCqMj/GmtKn0zPvpTz/Cv1dw21XwP3cRupg3H3MF/S71eTKj1YrdwKdc2Mw0fRmb2sFf8lW3aU6JbIZSEPqvXvjM7G/aApyXlXeqKfMq0g/Su3rUGJPSPrtGElgknrZM3xUXqsAP6zMCNVn5u8aJnSNpJv2uru7t2jfRziW2+GuhqfldUNbPk71olwo+46ePUo1U3WKk/e5YK07F/wGRgcpODmQnIlVeHCWBE4puBi2jq28UKpqiN1/4UOrGz59TNYrrQHtd+11sG40BGD+pXdelNqGOg4NXe8W4eacJV/NS9/2Umtym6WQqveqR9xdCMElpxnbkalM4Vf9uaEcWZaKdyibEIjWKxJZPN95niCL3GiaXyssIrHxoLkqkzLCXULN46/f2h3tQJgyip+Tk9EAjJ9aJshq7t8X45aowSKspMSvPf7r9R8yxNptIaHS5ozuEm6luPDApugyNP8OaqiQ4BjaequXA54SLC83eHIY2r+CZp4409Xqw8Aa2oI7XkCrQi+in0w5AqF/kLNrcUz+qkl/lAobY1jSnx5OJNhyXIz3qfNFlXc0TKaglNwdWkWYt9QQ1Kr6W8zue21iNrdJk+N5oCr2O9nEtWKC7IS5J/zdDEYrmnAYfg6agCy+qcgz7ZofeDc4PbUWSvkshWuAc7OjiUyLkj+RAtdlwXJcjxdpkTTHDhK8lBCi8+JtvDVL1W6elmOM++YS0LuSlaP1oUvAeiW3cFnvTr8EbTz1tsSMYdGeZe40sRWu5uAfj7q+ZoKv2FNQ0p5XY1lmlcigHZqTPpabufEVrNuNPi165w3uCVQJHyJqmSJ7ZHnguqwtCmwViIJijj04ba2JNYtB+yORf5gg1/9t9iw4vUpeqiunSAbf+IBdj/b+iG2qrHvuNP0Vd/+ThVZT/lrvHYjjgDbbyxaqgHNM2uhxa1GW3UedZYhMMwM4mQhltouK+IV4NdbIQNM+8Yv311RZk9kT4tiYR4LkyFcuPpdcjuhUuFqBAWRZa11lcZ3gEBlXywsNhrt+plISZP5DlsV9l4EgY6J3yZPTUcMrgaWAT3oI79eSbGEbcJpr6BD8kyDiVt+G0/hXosQN4NFXKlfWIfsIs0BHODVok1/IGnKFHJYIquh8Xo+2+bkQNTGgWmN/fZ0Y33LSj6lr1GyV7mWIKg7ZTRZPGuhF/zjRNcQ1UPtSYgnWQxSs0yrVhwNDcdGMNSNe2JT3WuzbAM3HykyAajS3Uphf6STKEqxLas9EnmnhA/lyj9Uj+JoY7SVgVmGLl46Rm2u98sbkap2lzAdKBG4r6LgulQOSSjQv1GWdQ0jtDUK/mAaqM1Uqjpu4k3Rvfvxv7YTxLSK+wN3E5jVIzmF23uZ7hiH/sVP49D7tvoKp4S8b1LuvRlivVB/algbhcFITYVXvDpLzpDfplR2uD5V4XJFxpjmIpLc9Y5sB2TpBRix7Bme6GZIq+06v3XzNeTcA4obQIKxrnT4C2JpOqD92dbmSX8MGazly5EsZVMvSU1f4RZwyu8iQXbVdeLlZrjuTT1jrY1uk5c7iZ7RsvhhluqAkq4JpVQAg7RJFtSu+xgJ8Pv6O1j5DkLxT8mkbfyRW5DrQmG7hiDIjCgBsADbjuof6YHLGeV6a5Q1Smx9joUXPpdaaDx97A/Wq00oJkdR7ZYuQRfS533JtxO1erduqWOYIt3wh0wpbLuCNIYkwxbswbikCUu2CDCS+Q+7rgVtfRcm+SOcdKPRlZ/rE7wNVUEE39KTS5uvUKN1PUnkloPkyzhyGQ8qkouEjJ3H/VXdqG6asSRiw3ecMlBvDDt8dDhBHXMwZ2Cajzjr7/76T+IavqPYvz6r7//E/3X3+N//h/0QozbjPgPiir69P/8X3/9F/yv8b/827/++98WItPu5/Hvwd8YPf5bp/2/lX/T/+Of/0MJ/lYTa+L/Ef+d9vN/3/2T6P/+jyTzu/evf6U7vxN7B6pJkRtAF6jUr8I+P8RsP/ptGhfqFk+pQ/DgAy6NJtRYJdXmp4gK7WLqLKJ+MaKhGjOojvL+SnIWrkpy0SLHDe4QuyNzaEA15mLMCcmE8Em+4HdOihW4/ZWuppJEmzeAwcDtv7MuLc9y2V5atvxXNe3S4DUMt5/Qy2LM9kSYKiVWBuKlfp4nxTntpuW03JbIlkiRvBXmT23g1I2OYe6IizUHPIq6zm6mbfsbteKmi/sg9J+ocQBMctGFO7iljo8TPN+z3jxw4do+ZwfqoR9dkNTKHyM305GpTkfhcHexVkPVGEbUOjuo9f0UMPHBFlGEx0SLvJvVRKTwW7PSew5oPme+E42+frJa9cGt2njS3dK5kIif2eYbhuSEQXEqMVfUjhGIuin0G0/W5ezJyJQy3SpMLai4M0JUWb5u1k9tny5bd1pPwYBpQuDCXZl62xg4CdVEAtflXHs6JKmP/pH6mOl796Lgopj0o8d5kKh00hxG3OSdEE/QBo9Hgr8JJqAeLDwJohG5j/DGh61Rc/+tf22/8kEnxHNCEjo0ElvvGfESZkqmz2BDcKV1H1buSkhkdg7p1IMGs2s17nYjpblrWuE2K9WEO/hcRp5e9oOF/QBmOaDtgil+oaU6szPrdwW65fOB0KUTsVUn7LFU7J8e6cxJIl9+FHw5MQMzuQJ+4oxMH3iW/5GK+hWuG0T+gTLs+fAjdtUd58TmIUq04EeyRCYCjkldow234aIgR5bqwrtZosZ+6YEqAmDqatJ9lWasz4IquKALPtd92hGI3Z2BdzzZue+REl1Om4DIWD+RrtUTOJLI+S0jHowXXdAxsGLSd40zYNuEUlOGhrwL6c7tcOtUOvpJCP7QBQS19H+GvZn05ewjlVLz+IGKoC9TyfQjLMBNmXCuqqtTdOSukZW48B0HqgSTCBrBnlFvF4CG2Su7yFzqmJFURK3UmTT3ru050r0ptUpMilYnBJWfl2Bv6kPlUuE1kxxpdzui9AubsR2N2boVSu81OulAwBqoSr1LZ0LLYOomyZHmjqnXlP72s8LnDouEJjtodBvdHaG1jMySYO7crWd90MpCRyCG14vb5IE7Arupw/y/RcCm/Tm3zK6zYj8PYNaGldiUfkB/LHWcmf2lVM+mwyU27a0qq2tscrQ/vzBjN26DnntIrOyGizzXK35yKQdYnUABkyN4saz3WD/viF+eCcsXnIajdWYJWaYHRstIis9CS+tqnFGmz2j5uzfr3Z4prqgK4XOT/PyftvjZqIm8lhkfxJ7Ol3CJF1piYBGAG8wtAk56Drw1YwmOpcz+NdfkSpSLplRXLXHL0Rquj6YW/gabqgK7Dgr6NwtH0B/AN7XrN+MVJ6AmXmUuqmQulrNNYPmH0RoDogydOKLo/QbfYNARSQQKISRCzRXU+q9WWJFL3LZW6u34CkeG97xC0NNGaJ0bvK6SnZS3zPskr5EtuCgjMWR5o2x5BqhKmDWJPRe7JMEOyRb5uUKlHaGVtq5ivSOaSliSXp9SQm2qk8MRJh10MAp9QQ2H5t59J8rjiwSZtoIfMGjlLPVNdYl/LBR0AO6WLGDmkLkIPRE45Y9MftdAK/yNu1Hn6tzOQTesgQ+8fSzB19wO91vCnO23vOWQdwJ63SJrYjdfKFW6W281PKs2k8iT9ai1cgJ4sa3xqdvmtxR8/+D1B8AKc2u+6JftryRhMWSQtoSBgIyyQGyxcnELuAasXN12oSriU4RMz1DD6RL0TSV+om7i1Yt+jEE/jnawM8cX/UhN4nkiv/w9eALrzNhXuQfOzFL0Fi6SjF7/4Qn8rLYBoa85cvgAnkCEBP+HPbEnquVXCZsMS/yzYw2Vru60P/+nJPYKkzZFjmbykzUoEqV836T5q3fP/L383dF82tx18/AZgZczMAgyeWYKmSZIqtHL+e+O4ZRcq9VI3g/qPeCoiK4pcgEqdbS0S/Be54sbVQOuJVPNBblIghzeasNu7h/g+Sz1IdhI5lCwq1nUb3Ji4OCIcqQZqtqJ5w7rXrg/DA9IgVmEGhDgGecEwnCTHffXcXs0V3OCEVzYDKS1vp/oX+ng+6XVU86UjA6FMO2RXOOOrqY1GgPvrAk9HV/BXtCu5RuwF8qgdGDLsBcui4E33ymdBip1X8uKyhIWT8qNRDsXz+gvO9UiEC0d8RG4Tf2x8H4slljgHtCBcxHLTWOYJm5H/fCPCzOgf9qgOUxTRZ0Pc6ha5yLuLVT9ntvIa6gacE99mCovdUumTQdRP4RPsS9129eEe2uSvvGh0bV4Y3QPPhPZMqhZWSMa5R0Hc1SGO4IVOQc0FrirlibTVfKRrYkD8kz3b+X65/QkUNaZdrdl3mCap0Hf3YcCw/LiouJYNbqz88UqeDYv93yO7vvXtgl4XCyAO4ODkY6W+83+LZU//p3/zXNGGrUKClCiOnL27iJZbNWDF02XXAOeFlB7IaADoMH1Yqr+UP9biyZDEa/iJt4MDeIz6GKTdLVBfWGVtRN4fdT2rgReX8UXwF2zOrradm4J0nyTgdPnai3RvzpZvCKDUqjOwD/QA6EDaMCLewX6QWYVnHY1sx1bd8ovYnPm1ZvPH+rE20lWjOCnZ66/xDt0QAl15FjfBcZp+i9OU0RNPQ0t3x2pSNWo8eiYudwsnuP1Hq6iH1LJCJynkYsfgJ0p3pF6SoQk2l+jqE8CPk+ziGJRSKjs+W5AO185umPdkYzlK4wl7TC9NxyyDP7ZoyYVoXiuS6SjnInlLWrwz1i8bGTKXX0AVQWkSfIlglW3zRJRJ8bg5VgE6ZEnqNu9B++0GNQvDQJvFize4ESNKBJP+8vA3LM4AX5SIBq08Mob+7QMTCZx4nwP/64+4BnlZC+8WtlP/CXw6t1PwMwkJ3jhP1FiXLhDF/3I6FGUzO2DSi9ABxKyyL9paZxSEz40ZCPQToDAJu1959k7QdbVxgB4icsu2s4zsTPJhcEDo+N1GX4zSk/wriRh8AqwL62972i9HJHd1ydaLXVzvKvOfGGw5RVcUVMiKXFH4APdkQU/dc5BX0YfKTNZYXCW9mb8bc8mufoQP6BbdQmT99ZjoYfr/go4TgQX9IDgztim7wyFeGMfbNaeqj8Dzs38pgcqwSv2hbqB3oSGKWKy+sesY7p57wAHldqE6NDudk/W7s/zjrK4rZFlFvaGxnSZdHbc1y47qDN6xkoK8O3bfr2j41dlJZ71rB4dlDqapPFa8N6xBrprUdtenUCHwxKNhw1uuTBh+9uU45k4REpQABN2bAO9DSLqoIL26gNroWgup5pUMxHUNSq4Gyz47vBPvilpo5f9OYI2ddAqTqmnxXERxQJ3UK8fHbVE9HagHi3+tqNRoNsArdmAxHA5LwtQo9ZAaNKUTljnokljo2x8scqVpEEIPc01fPCdHOCg0DeWBz8D5TVAAfx8aRH5X2ZYNI3ebKDZdeJ+oBDAxmRqJ30Eh2/DaeAy5diVNMpEDmXiPDsGTzBLXy8eVDdJoIafgx/gxMyQi454QrW56nCyeELgSuNNEmYkflF+t3CZQOVRWjKhIuCclmQSlAXT3+4JGG75B4t/5hQ+ldMP4LsAW6z3XmU6IJJwpnGVnsgUZhoY1fZlwTR8wSU7xRejf2uCx9Z5trVTRRJP9KnEb134dEieil6eCOGWgboI7xsqsqM99jfJLTePjygKlH2CVxxsse9QRzTBFjD/Kjqitr/CCTBt/SJ6nLxz7cKP9pFqBpp0lN5y+adKNsZjrPuroemZauH9aTTFD3EKHW8S55XBLFQAt1jgxTQCTwxmx/JyfsZDN1RroN3VaxpSenpIX7K+ZbL8VdlQDcI4Cbzg3QJLa9yVqNxUelu+EtxLVqeekaAvSJkO6sSVqbUajxqhKshNpvZqoeApF0k/0P0ikkwUcbdwc4A1ejN7Oo0O15kG7hTMoK3hZRBCX7YYeLW0wvcXx/18n/u37yLgzBYVBUvORGli+sfRcX/74uD6P4hq+7xu54TlWJLFzT63uwUDwuEDdOjJQqx7JV+ZjaEAPi7t0MMrR4Q8Rkf18uxD6RK0RKh0hL8YU+DeL97i4pa5ZSyAfXKwZRS/8gXcxdZXm62RBDj8U3sN8x95b5PpPs/mCBKYvpaA50pN5Ct/499AFTtwQ5vgeSh+NHrKIi4NVpwM/XzRaNfJD856lPE6M21zWPguFsH7jbLVyEDfRmt4VwrhCJ5VTYmcSPfGgO5clfN+vbaDZ7sakU5+2vZ2WCDY031NxJarVytfDDVtiafcTGO2rJ/taoL3zChN2qmjxofczTOYQPPVQPh0JVtYgdUQINcSiNEEy58UdYXX1MpWUCEBx7LbcGtAm8XWRQTVOaoV3ySri4RShhs/B/0m4jX6OAwXOvcA09bNSG4czEGv/Wey6V/jbTCNTW6awXdNTcA1GsPe1E9fZdGl7R0vyoVpIdJtfC6d32NNErrvq/R+d65VG+YOwRXppXxOCYyGNSf1K3x6VxAW/vtz4EC1SgCOSPdN62sLsoIzuDfg8GwZAbquVO8HIuFP/ToVoeUB7nnwMF35a1wK1tI6fkrqFKhQdeJpwyls0pIy8AZde3/6LUUbFaYJthyUJSU/kqDXTLQElnn0Jr4B2RVghNrmNmoEn7pXIeshPguXVsvwoTdmClq49JJU3LWhHyWTrJL9bRP6VKv3tZoA/th77p5Jw++OEENvyvWy/pNeExiDUVQaXIRGh8xySZTI36yueFaSXo1uJY0RnXYgEOoWWOJHeaVuX/bGNhHsh2yinznl/++NJcE9j6fBPRcBdq9hb8awNw8U7Bl6GM7x69EDOIIbX/npZ++amlHR9L/35mE/2Ss4gb0xCcY4VyTFLRE796vHysLAamqcyO+aFQyJIDBNslbH2/MrAvZiSEIedc/cqjmv4fbda2pXbv+F5a2szSsdkm9noiNURXt8edUhGUF6fSZWd1IJaXKFwD+49R6eCXD4Bkef7j9tRtNMVgW8BhRz/Qpy1TmeYk0doyjZoJSbePOReVHgkFsCFuQJ+Lgc4BxeAsK/cOiNDRmdNw0ctYhn/nQ498dYI5znzGLoJi1rav7Cn88rL3wLePVtDK5gl77Tki3gHEsIAQ2+IKgarj7Y8W1IQzV5V9N+0TjLqbg68WfKcOmBCOj3JkwJhVIkwDhc+JorXuZEPMEh0vvH3x7iqf+VAwXgd4diZiaJD1zHL9Snx6Wfg4IugreyhabQkcir+y5XgDtdx3Avs7lkeeCBwDvZoTUCXx5QrZkcEqWfYEiEYRs/EphmRALSNGR1Iclgdr5VFoELpzF4++f35w3/j0t5ucW3n2ch4PQCLuUXupsPRR7UA5FjSKrMtPcKAZJfagO4lGE7FH3YKMjorpK0ZxAv+i2JkJhtAMWWWFej4RhPR/cJ3DxwocCvXDi4SGZU4cu+K32XndiFWgopAl+0GApcwf1XvymJcFs39jExIBO4yUjU9MExBLQYc9H+W7+IgdESPRpciT+rKZPebVtaVq+1GYO/5xTAL3HASjNTGIgMvdjWbgc7JvdE1zIFpuC0U9ESiZyzBixzxWxj4Kwh8My34q+FK3KNLtmsA1qyrmKSNQOXCPUZd+ONelBTvFoUI/CYsqa/RhtKiyMf2CgSFqEPk59Y3uqnlZ8gFpswfSYyko23yVZYxzKGxGm49Zqxg1l8oz5Ra9XaRwHkuxepmgyhm0SoNy2KlbcEqK+9QqS9PNx9Ihm9U7gsR55SSJ1FBDNnkuWKxIZ0SDpXuOGwZdoUbOMDPHP4vBAgz2VlSEJAHZGJVbYIg7l/FO5KfIVvxC8pPPxMGcNMoevFDeStt2iqztE10n2TA4dgJH76YS9HDhKHD3iCx6ieFX84BAI3QQnngh76f5ruPQVbr5qZmck/5UjDc26lfrOvUBWy0Ogl8bCoOkMOns81TnC3cuUS9KW8+9A+fe3XYZOFUPG1u5epSSmDLw0s5s2F0W30ANeo+zJkJQz9SPZgzwYpEoktofhGVfmLOAB20boCbW1QWq/NpET/hnMecw/uSyAH4NJc3ECOU4nnkK1fj3S/i5dwb3R7k00AqQQUwt7Ie1qV0aY/VQX0J8hLPy7eBNXMHYZYDNxHZ2Qh6AuXJxq+AeRec/Q+JLhZV6hpXwQEzw7bf5v9uUf2vpq3qlhmy0IIGTkwYdCfSAFmqbdo+3XvDTDjFJde0mbeQLcn2n31xaAqJ0ixO/CLsT4I4G4DoncVTgRGNBtsCcjISWT+oeXZ4Iedw/8OsJI1aPnNKLX/60VvcZb94uasRxCkqlPQ11u1Sa2hHvB80WQENxVyzjns0/PiEByyil21Te6oisk3mNCEMrhouCFO3yEZTHHOCMy9eb/4Tmi8cVf3Lf7P53SY2hX3PSN033As3ETIMLHWumWEO9JXHA2y2SIBlIPpLGG2qvNsCIlIr+B1SWAqRKm2w6Blf7U+zCSBwJrfHG5i8J5Gax/cVonMlon7aHJX/gSvucIncRP93XCqkv7D8IFKFsLiBgHqUpXhE3pYjEcV1dk/JD9zFVCfEaQIVX8Jmfz7IIofcBKQ4OaG+C3xC2veX9CD+iAFXDNaGg9eTVxvkbJRJlW4Nk9Wk13kn696jWppRDe/8pDrYMO9ZyxZ98ReKSz9kWKLLyk2zCZgAniCkLJVX3n1M9DYbomyahWiv/KixRIV9hj/oFz87I+HLznbPTjpa+D+bZQnMuRsljTpv90vQUt/pK7jCFnA30B/jtroSF2/m/gpWn1aQs5WeA6ghzF8SdqWI20fghdSeDOCSCmLgTkfaGgGDmw7nHFkRzGtag57IHS2na06I+gzEphXo1w/Zx2BM/jKL2nZoFjHggtFQjYi8nSVRSXIE58RPbBObXk7uuIL9+rs/5Zo7suJInEUxgsiZZAWS25iBtpEiZeBgDtghEoAE0sjcayNq85M4tbu/LF5h51335PsGzQ09O875+vUS89lkWMyNOFoip2PuyWyMP/iU2XIZdfCCJNDjebDoBLQdpy7QQZC7s9c0wjHJervQNDu2jWzBW5MSAJMr7bP+Iv92BkS/GGgzjEn7MF1IRKFwwzbjbS4/slGOmhx9cZrFu7HSEefojNv3r0UaKfKOWzXsq1zEugbzlMDFsacRJJI/iJlK3vtkZ+PLZIVMFlKA32wbq2Kd5T0uCLZ1CPkAfCdzkz2EYscjDcZq2AWfziN2covN4kXE1lQXPPLTNM1xx3tbiepcO/t3SWm4w87qfh99SL0ZnY+LKFPLPeXVM2mIIoVWt+9Nk0I7nY4O79iGYqxZ8RVz289an6NVdJWnSKZvJQCAuHNiVaDxPAFoH392t9wot5t0/qmU95eEWNbU2udUW5sN9JVqcYlvAIfLeYC33oUzzxZgSktsv21mA7Uly1FA5VnoJFh6N244Wmv3YJGFv/TCPryaw+ZORlpZjQdq/2DYXr3EZskfed0G61P09ipTKmlTQ1067Rg5+PAk5FlQ9e0SWbGf2B/08kqymOTMVOznsALHHNFH4LFRKl2F/NOiYFl9khNHnSu9Ak5sq26Ynl/i2fdTle29Y1ugqmR5Yj4YT9pvslFyYCbw0mNFr5rVQm1LvkG27QMq9ph3t8fmn6r6SQ4oSbr5tz+J1kIawGzDxb6VYOvvWhobDTXfBeNv3b4aNm5XUinsCGqG2q/45m3+LoCOsddFceYhRx1Tsss9PLdPfJdErFMjYd3gddjiP0+XQjcRadZP6bwNLySvunFf20Czy6JqdEW2a96KxdYdOryBv1BjbuUq2yCHeh+6sk7fGmmPi50pe/1l5TyPe5oHW9oPnhPswLyf2TFDdCyYlhwBCstv5C1HwlW7xWoGT9XZt4qVj5WryLPLLD6h/5cMLEjWzgCeAIKNsLak92aBqBsHl4AJwl2N4jfvbSkBExGimv0nFvv09uDScQbjx+w4kPQjgjlW+g9ws9VEJvI2k8N6XxVu0uIwovgTFdunG24gBtaDi+y1YLQwZ8mwbip5fVlO3k0n0AEr/ETbtu8Vjkm+nNSiEb7X/3fMjBL5A8PdgG+/FnbexbFFExmEfetXAnisEKy5z44WVPpQZjSy/jzeGn4yDRsFGqhh87QPaDBWhlo37IFbe/C0xynS91d2tP/AJoJS0sVF6iwAAAAAElFTkSuQmCC");
}

#menu::after {
  display: block;
  content: '';
  padding-top: 80px;
}

#logo {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(255,255,255,.1);
  font-size: 11px;
  display: block;
  width: 20px;
  height: 20px;
  line-height: 20px;
  text-align: center;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  -webkit-box-shadow: 0 0 3px rgba(0,0,0,.2);
  -moz-box-shadow: 0 0 3px rgba(0,0,0,.2);
  color: inherit;
}

#menu li a {
  display: block;
  color: white;
  padding: 0 35px 0 25px;
  -webkit-transition: background 300ms;
  -moz-transition: background 300ms;
}

#menu li {
  position: relative;
  list-style: none;
}

#menu a:hover,
#menu a.active {
  text-decoration: none;
  background: rgba(255,255,255,.1);
}

#menu li:hover .cov {
  opacity: 1;
}

#menu li .dirname {
  opacity: .60;
  padding-right: 2px;
}

#menu li .basename {
  opacity: 1;
}

#menu .cov {
  background: rgba(0,0,0,.4);
  position: absolute;
  top: 0;
  right: 8px;
  font-size: 9px;
  opacity: .6;
  text-align: left;
  width: 17px;
  -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
  padding: 2px 3px;
  text-align: center;
}

#stats:nth-child(2n) {
  display: inline-block;
  margin-top: 15px;
  border: 1px solid #eee;
  padding: 10px;
  -webkit-box-shadow: inset 0 0 2px #eee;
  -moz-box-shadow: inset 0 0 2px #eee;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
}

#stats div {
  float: left;
  padding: 0 5px;
}

#stats::after {
  display: block;
  content: '';
  clear: both;
}

#stats .sloc::after {
  content: ' SLOC';
  color: #b6b6b6;
}

#stats .percentage::after {
  content: ' coverage';
  color: #b6b6b6;
}

#stats .hits,
#stats .misses {
  display: none;
}

.high {
  color: #00d4b4;
}
.medium {
  color: #e87d0d;
}
.low {
  color: #d4081a;
}
.terrible {
  color: #d4081a;
  font-weight: bold;
}

table {
  width: 80%;
  margin-top: 10px;
  border-collapse: collapse;
  border: 1px solid #cbcbcb;
  color: #363636;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
}

table thead {
  display: none;
}

table td.line,
table td.hits {
  width: 20px;
  background: #eaeaea;
  text-align: center;
  font-size: 11px;
  padding: 0 10px;
  color: #949494;
}

table td.hits {
  width: 10px;
  padding: 2px 5px;
  color: rgba(0,0,0,.2);
  background: #f0f0f0;
}

tr.miss td.line,
tr.miss td.hits {
  background: #e6c3c7;
}

tr.miss td {
  background: #f8d5d8;
}

td.source {
  padding-left: 15px;
  line-height: 15px;
  white-space: pre;
  font: 12px monaco, monospace;
}

code .comment { color: #ddd }
code .init { color: #2F6FAD }
code .string { color: #5890AD }
code .keyword { color: #8A6343 }
code .number { color: #2F6FAD }
</style></head><body><div id="coverage"><h1 id="overview">Coverage</h1><div id="menu"><li><a href="#overview">overview</a></li><li><span class="cov high">94</span><a href="#/Users/philipp/code/neo4jmapper/src/conditionalparameters.js"><span class="dirname">/Users/philipp/code/neo4jmapper/src/</span><span class="basename">conditionalparameters.js</span></a></li><li><span class="cov high">82</span><a href="#/Users/philipp/code/neo4jmapper/src/cypherquery.js"><span class="dirname">/Users/philipp/code/neo4jmapper/src/</span><span class="basename">cypherquery.js</span></a></li><li><span class="cov high">88</span><a href="#/Users/philipp/code/neo4jmapper/src/graph.js"><span class="dirname">/Users/philipp/code/neo4jmapper/src/</span><span class="basename">graph.js</span></a></li><li><span class="cov high">96</span><a href="#/Users/philipp/code/neo4jmapper/src/helpers.js"><span class="dirname">/Users/philipp/code/neo4jmapper/src/</span><span class="basename">helpers.js</span></a></li><li><span class="cov medium">70</span><a href="#/Users/philipp/code/neo4jmapper/src/index.js"><span class="dirname">/Users/philipp/code/neo4jmapper/src/</span><span class="basename">index.js</span></a></li><li><span class="cov high">97</span><a href="#/Users/philipp/code/neo4jmapper/src/lib/md5.js"><span class="dirname">/Users/philipp/code/neo4jmapper/src/lib/</span><span class="basename">md5.js</span></a></li><li><span class="cov terrible">24</span><a href="#/Users/philipp/code/neo4jmapper/src/lib/sequence.js"><span class="dirname">/Users/philipp/code/neo4jmapper/src/lib/</span><span class="basename">sequence.js</span></a></li><li><span class="cov high">82</span><a href="#/Users/philipp/code/neo4jmapper/src/neo4jrestful.js"><span class="dirname">/Users/philipp/code/neo4jmapper/src/</span><span class="basename">neo4jrestful.js</span></a></li><li><span class="cov high">84</span><a href="#/Users/philipp/code/neo4jmapper/src/node.js"><span class="dirname">/Users/philipp/code/neo4jmapper/src/</span><span class="basename">node.js</span></a></li><li><span class="cov high">87</span><a href="#/Users/philipp/code/neo4jmapper/src/path.js"><span class="dirname">/Users/philipp/code/neo4jmapper/src/</span><span class="basename">path.js</span></a></li><li><span class="cov high">87</span><a href="#/Users/philipp/code/neo4jmapper/src/relationship.js"><span class="dirname">/Users/philipp/code/neo4jmapper/src/</span><span class="basename">relationship.js</span></a></li><li><span class="cov high">85</span><a href="#/Users/philipp/code/neo4jmapper/src/transaction.js"><span class="dirname">/Users/philipp/code/neo4jmapper/src/</span><span class="basename">transaction.js</span></a></li><a id="logo" href="http://visionmedia.github.com/mocha/">m</a></div><div id="stats" class="high"><div class="percentage">86%</div><div class="sloc">3343</div><div class="hits">2879</div><div class="misses">464</div></div><div id="files"><div class="file"><h2 id="/Users/philipp/code/neo4jmapper/src/conditionalparameters.js">/Users/philipp/code/neo4jmapper/src/conditionalparameters.js</h2><div id="stats" class="high"><div class="percentage">94%</div><div class="sloc">105</div><div class="hits">99</div><div class="misses">6</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Builds a string from mongodb-like-query object</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">if (typeof window === 'object') {</td></tr><tr class="miss"><td class="line">6</td><td class="hits">0</td><td class="source">  var _ = window._;</td></tr><tr class="miss"><td class="line">7</td><td class="hits">0</td><td class="source">  var helpers = window.Neo4jMapper.helpers;</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">  var _ = require('underscore');</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">  var helpers = require('./helpers');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var ConditionalParameters = function ConditionalParameters(conditions, options) {</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">65</td><td class="source">  ConditionalParameters.parameterRuleset = {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    $IN: function(value) {</td></tr><tr class="hit"><td class="line">17</td><td class="hits">4</td><td class="source">      var s = '';</td></tr><tr class="hit"><td class="line">18</td><td class="hits">4</td><td class="source">      if ((typeof value === 'object') &amp;&amp; (value.length &gt; 0)) {</td></tr><tr class="hit"><td class="line">19</td><td class="hits">2</td><td class="source">        for (var i=0; i &lt; value.length; i++) {</td></tr><tr class="hit"><td class="line">20</td><td class="hits">8</td><td class="source">          value[i] = (typeof value[i] === 'string') ? &quot;'&quot;+helpers.escapeString(value[i])+&quot;'&quot; : helpers.valueToStringForCypherQuery(value[i]);</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">22</td><td class="hits">2</td><td class="source">        s = value.join(', ');</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">24</td><td class="hits">4</td><td class="source">      return 'IN [ ' + s + ' ]';</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    },</td></tr><tr class="hit"><td class="line">26</td><td class="hits">4</td><td class="source">    $in: function(value) { return this.$IN(value); }</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">65</td><td class="source">  ConditionalParameters.prototype.addValue = function(value) {</td></tr><tr class="hit"><td class="line">31</td><td class="hits">55</td><td class="source">    if (!this.parameters)</td></tr><tr class="hit"><td class="line">32</td><td class="hits">36</td><td class="source">      this.parameters = {};</td></tr><tr class="hit"><td class="line">33</td><td class="hits">55</td><td class="source">    var property = '_value'+(this.parametersStartCountAt + this.parametersCount())+'_';</td></tr><tr class="hit"><td class="line">34</td><td class="hits">55</td><td class="source">    this.parameters[property] = value;</td></tr><tr class="hit"><td class="line">35</td><td class="hits">55</td><td class="source">    return '{'+property+'}';</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">65</td><td class="source">  ConditionalParameters.prototype.values = function() {</td></tr><tr class="hit"><td class="line">39</td><td class="hits">32</td><td class="source">    var values = [];</td></tr><tr class="hit"><td class="line">40</td><td class="hits">32</td><td class="source">    for (var prop in this.parameters) {</td></tr><tr class="hit"><td class="line">41</td><td class="hits">66</td><td class="source">      values.push(this.parameters[prop]);</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">43</td><td class="hits">32</td><td class="source">    return values;</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">46</td><td class="hits">65</td><td class="source">  ConditionalParameters.prototype.parametersCount = function() {</td></tr><tr class="hit"><td class="line">47</td><td class="hits">89</td><td class="source">    if ((typeof this.parameters !== 'object')||(this.parameters === null))</td></tr><tr class="hit"><td class="line">48</td><td class="hits">6</td><td class="source">      return 0;</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">    else</td></tr><tr class="hit"><td class="line">50</td><td class="hits">83</td><td class="source">      return Object.keys(this.parameters).length;</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">53</td><td class="hits">65</td><td class="source">  ConditionalParameters.prototype.hasParameters = function() {</td></tr><tr class="hit"><td class="line">54</td><td class="hits">33</td><td class="source">    return (this.parametersCount() &gt; 0);</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">57</td><td class="hits">65</td><td class="source">  ConditionalParameters.prototype.cypherKeyValueToString = function(key, originalValue, identifier) {</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    // call cypherKeyValueToString with this object context</td></tr><tr class="hit"><td class="line">59</td><td class="hits">99</td><td class="source">    return helpers.cypherKeyValueToString(key, originalValue, identifier, this);</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">62</td><td class="hits">65</td><td class="source">  ConditionalParameters.prototype.convert = function(condition, operator) {</td></tr><tr class="hit"><td class="line">63</td><td class="hits">90</td><td class="source">    if (typeof condition === 'undefined')</td></tr><tr class="hit"><td class="line">64</td><td class="hits">59</td><td class="source">      condition = this.conditions;</td></tr><tr class="hit"><td class="line">65</td><td class="hits">90</td><td class="source">    var options = _.extend({}, this.defaultOptions, this.options);</td></tr><tr class="hit"><td class="line">66</td><td class="hits">90</td><td class="source">    if (options.firstLevel)</td></tr><tr class="hit"><td class="line">67</td><td class="hits">90</td><td class="source">      options.firstLevel = false;</td></tr><tr class="hit"><td class="line">68</td><td class="hits">90</td><td class="source">    if (options.parametersStartCountAt)</td></tr><tr class="hit"><td class="line">69</td><td class="hits">2</td><td class="source">      this.parametersStartCountAt = options.parametersStartCountAt;</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">    // TODO: if $not : [ {name: 'a'}] ~&gt; NOT (name = a)</td></tr><tr class="hit"><td class="line">71</td><td class="hits">90</td><td class="source">    if (typeof condition === 'string')</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">      condition = [ condition ];</td></tr><tr class="hit"><td class="line">73</td><td class="hits">90</td><td class="source">    if (typeof operator === 'undefined')</td></tr><tr class="hit"><td class="line">74</td><td class="hits">59</td><td class="source">      operator = this.operator; // AND</td></tr><tr class="hit"><td class="line">75</td><td class="hits">90</td><td class="source">    if (typeof condition === 'object')</td></tr><tr class="hit"><td class="line">76</td><td class="hits">90</td><td class="source">      for (var key in condition) {</td></tr><tr class="hit"><td class="line">77</td><td class="hits">125</td><td class="source">        var value = condition[key];</td></tr><tr class="hit"><td class="line">78</td><td class="hits">125</td><td class="source">        var property = null;</td></tr><tr class="hit"><td class="line">79</td><td class="hits">125</td><td class="source">        if (_.isObject(condition[key])) {</td></tr><tr class="hit"><td class="line">80</td><td class="hits">120</td><td class="source">          var properties = [];</td></tr><tr class="hit"><td class="line">81</td><td class="hits">120</td><td class="source">          var firstKey = (_.keys(value)) ? _.keys(value)[0] : null;</td></tr><tr class="hit"><td class="line">82</td><td class="hits">120</td><td class="source">          if ((firstKey)&amp;&amp;(ConditionalParameters.is_operator.test(firstKey))) {</td></tr><tr class="hit"><td class="line">83</td><td class="hits">31</td><td class="source">            properties.push(this.convert(condition[key][firstKey], firstKey.replace(/\$/g,' ').trim().toUpperCase(), options));</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="hit"><td class="line">85</td><td class="hits">89</td><td class="source">            for (var k in condition[key]) {</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">              // k = key/property, remove identifier e.g. n.name</td></tr><tr class="hit"><td class="line">87</td><td class="hits">104</td><td class="source">              var property = k.replace(/^[nmrp]\./,'');</td></tr><tr class="hit"><td class="line">88</td><td class="hits">104</td><td class="source">              value = condition[key][k];</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">              // only check for attributes if not s.th. like `n.name? = …`</td></tr><tr class="hit"><td class="line">91</td><td class="hits">104</td><td class="source">              var identifierWithProperty = (/\?$/.test(property)) ? '' : property;</td></tr><tr class="hit"><td class="line">92</td><td class="hits">104</td><td class="source">              if (identifierWithProperty) {</td></tr><tr class="hit"><td class="line">93</td><td class="hits">102</td><td class="source">                if (options.identifier)</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">                  // we have s.th. like options.identifier = n; property = '`'+identifierWithProperty+'`'</td></tr><tr class="hit"><td class="line">95</td><td class="hits">86</td><td class="source">                  identifierWithProperty = options.identifier + '.' + identifierWithProperty;</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">                else</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">                  // we have no explicit identifier, so we use the complete key/property and expecting it contains identifier</td></tr><tr class="hit"><td class="line">98</td><td class="hits">16</td><td class="source">                  identifierWithProperty = k;</td></tr><tr class="hit"><td class="line">99</td><td class="hits">102</td><td class="source">                identifierWithProperty = helpers.escapeProperty(identifierWithProperty);</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">              }</td></tr><tr class="hit"><td class="line">101</td><td class="hits">104</td><td class="source">              var hasAttribute = (identifierWithProperty) ? 'HAS ('+identifierWithProperty+') AND ' : '';</td></tr><tr class="hit"><td class="line">102</td><td class="hits">104</td><td class="source">              if (value === k) {</td></tr><tr class="hit"><td class="line">103</td><td class="hits">1</td><td class="source">                properties.push(hasAttribute+value);</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">              // do we have s.th. like { name: { $IN: [ … ] } }</td></tr><tr class="hit"><td class="line">105</td><td class="hits">103</td><td class="source">              } else if ((typeof value === 'object')&amp;&amp;(value !== null)&amp;&amp;(Object.keys(value).length === 1)&amp;&amp;(typeof ConditionalParameters.parameterRuleset[Object.keys(value)[0]] === 'function')) {</td></tr><tr class="hit"><td class="line">106</td><td class="hits">4</td><td class="source">                properties.push(hasAttribute+' '+(identifierWithProperty || k)+' '+ConditionalParameters.parameterRuleset[Object.keys(value)[0]](value[Object.keys(value)[0]]));</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">              } else {</td></tr><tr class="hit"><td class="line">108</td><td class="hits">99</td><td class="source">                properties.push(hasAttribute+this.cypherKeyValueToString(k, value,</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">                  // only add an identifier if we have NOT s.th. like</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">                  // n.name = ''  or r.since …</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">                  (/^[a-zA-Z\_\-]+\./).test(k) ? null : options.identifier</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">                ));</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">              }</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">          // merge sub conditions</td></tr><tr class="hit"><td class="line">117</td><td class="hits">120</td><td class="source">          condition[key] = properties.join(' '+operator+' ');</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">121</td><td class="hits">90</td><td class="source">    if ((condition.length === 1)&amp;&amp;(options.firstLevel === false)&amp;&amp;(/NOT/i.test(operator)))</td></tr><tr class="hit"><td class="line">122</td><td class="hits">2</td><td class="source">      return operator + ' ( '+condition.join('')+' )';</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">    else</td></tr><tr class="hit"><td class="line">124</td><td class="hits">88</td><td class="source">      return '( '+condition.join(' '+operator+' ')+' )';</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">127</td><td class="hits">65</td><td class="source">  ConditionalParameters.prototype.toString = function() {</td></tr><tr class="hit"><td class="line">128</td><td class="hits">65</td><td class="source">    if (this.conditions)</td></tr><tr class="hit"><td class="line">129</td><td class="hits">59</td><td class="source">      this._s = this.convert();</td></tr><tr class="hit"><td class="line">130</td><td class="hits">65</td><td class="source">    return this._s;</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">  // assign parameters and option(s)</td></tr><tr class="hit"><td class="line">134</td><td class="hits">65</td><td class="source">  if (typeof conditions === 'object') {</td></tr><tr class="hit"><td class="line">135</td><td class="hits">59</td><td class="source">    this.conditions = (conditions) ? conditions : {};</td></tr><tr class="hit"><td class="line">136</td><td class="hits">6</td><td class="source">  } else if (typeof conditions === 'string') {</td></tr><tr class="hit"><td class="line">137</td><td class="hits">6</td><td class="source">    this.conditions = null;</td></tr><tr class="hit"><td class="line">138</td><td class="hits">6</td><td class="source">    this._s = '( ' + conditions + ' )';</td></tr><tr class="hit"><td class="line">139</td><td class="hits">6</td><td class="source">    return;</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">  } else {</td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="source">    throw Error('First argument must be an object with conditional parameters or a plain string');</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">143</td><td class="hits">59</td><td class="source">  if (typeof options === 'object') {</td></tr><tr class="hit"><td class="line">144</td><td class="hits">59</td><td class="source">    this.options = options;</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">    // assign some options if they exists to current object</td></tr><tr class="hit"><td class="line">146</td><td class="hits">59</td><td class="source">    if (typeof this.options.valuesToParameters !== 'undefined')</td></tr><tr class="hit"><td class="line">147</td><td class="hits">58</td><td class="source">      this.valuesToParameters = this.options.valuesToParameters;</td></tr><tr class="hit"><td class="line">148</td><td class="hits">59</td><td class="source">    if (typeof this.options.identifier !== 'undefined')</td></tr><tr class="hit"><td class="line">149</td><td class="hits">48</td><td class="source">      this.identifier = this.options.identifier;</td></tr><tr class="hit"><td class="line">150</td><td class="hits">59</td><td class="source">    if (typeof this.options.operator !== 'undefined')</td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="source">      this.operator = this.options.operator;</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">155</td><td class="hits">1</td><td class="source">ConditionalParameters.is_operator = /^\$(AND|OR|XOR|NOT|AND\$NOT|OR\$NOT)$/i;</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">157</td><td class="hits">1</td><td class="source">ConditionalParameters.prototype.operator               = 'AND';</td></tr><tr class="hit"><td class="line">158</td><td class="hits">1</td><td class="source">ConditionalParameters.prototype.identifier             = 'n';</td></tr><tr class="hit"><td class="line">159</td><td class="hits">1</td><td class="source">ConditionalParameters.prototype.conditions             = null;</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">// options are used to prevent overriding object attributes on recursive calls</td></tr><tr class="hit"><td class="line">162</td><td class="hits">1</td><td class="source">ConditionalParameters.prototype.options                = null;</td></tr><tr class="hit"><td class="line">163</td><td class="hits">1</td><td class="source">ConditionalParameters.prototype.defaultOptions         = { firstLevel: true, identifier: null };</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">165</td><td class="hits">1</td><td class="source">ConditionalParameters.prototype.parameters             = null;</td></tr><tr class="hit"><td class="line">166</td><td class="hits">1</td><td class="source">ConditionalParameters.prototype.valuesToParameters     = true;</td></tr><tr class="hit"><td class="line">167</td><td class="hits">1</td><td class="source">ConditionalParameters.prototype._s                     = '';</td></tr><tr class="hit"><td class="line">168</td><td class="hits">1</td><td class="source">ConditionalParameters.prototype.parametersStartCountAt = 0;</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">170</td><td class="hits">1</td><td class="source">if (typeof window === 'object') {</td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="source">  window.Neo4jMapper.ConditionalParameters = ConditionalParameters;</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="hit"><td class="line">173</td><td class="hits">1</td><td class="source">  module.exports = exports = ConditionalParameters;</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">}</td></tr></tbody></table></div><div class="file"><h2 id="/Users/philipp/code/neo4jmapper/src/cypherquery.js">/Users/philipp/code/neo4jmapper/src/cypherquery.js</h2><div id="stats" class="high"><div class="percentage">82%</div><div class="sloc">79</div><div class="hits">65</div><div class="misses">14</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">if (typeof window === 'object') {</td></tr><tr class="miss"><td class="line">3</td><td class="hits">0</td><td class="source">  var _ = window._;</td></tr><tr class="miss"><td class="line">4</td><td class="hits">0</td><td class="source">  var helpers = window.Neo4jMapper.helpers;</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  var _ = require('underscore');</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">  var helpers = require('./helpers');</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">var CypherQuery = function CypherQuery(query, parameters) {</td></tr><tr class="hit"><td class="line">11</td><td class="hits">4914</td><td class="source">  this.statements = [];</td></tr><tr class="hit"><td class="line">12</td><td class="hits">4914</td><td class="source">  if (typeof query === 'string')</td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">    this.query = query;</td></tr><tr class="hit"><td class="line">14</td><td class="hits">4914</td><td class="source">  else if (typeof query === 'object')</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    this.statements = query;</td></tr><tr class="hit"><td class="line">16</td><td class="hits">4914</td><td class="source">  if (parameters)</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">    this.parameters = parameters;</td></tr><tr class="hit"><td class="line">18</td><td class="hits">4914</td><td class="source">  this.cypher = _.extend(CypherQuery.prototype.cypher);</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">CypherQuery.prototype.statementsToString = function(options) {</td></tr><tr class="hit"><td class="line">22</td><td class="hits">522</td><td class="source">  var s = '';</td></tr><tr class="hit"><td class="line">23</td><td class="hits">522</td><td class="source">  var chopLength = 15;</td></tr><tr class="hit"><td class="line">24</td><td class="hits">522</td><td class="source">  var defaultOptions = {</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    niceFormat: true</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">  };</td></tr><tr class="hit"><td class="line">27</td><td class="hits">522</td><td class="source">  if (this.statements) {</td></tr><tr class="hit"><td class="line">28</td><td class="hits">522</td><td class="source">    if (typeof options !== 'object')</td></tr><tr class="hit"><td class="line">29</td><td class="hits">522</td><td class="source">      options = {};</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    else</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">      _.defaults(options, defaultOptions);</td></tr><tr class="hit"><td class="line">32</td><td class="hits">522</td><td class="source">    for (var i=0; i &lt; this.statements.length; i++) {</td></tr><tr class="hit"><td class="line">33</td><td class="hits">1518</td><td class="source">      var queryFragment = this.statements[i];</td></tr><tr class="hit"><td class="line">34</td><td class="hits">1518</td><td class="source">      if (typeof queryFragment === 'string') {</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        // if we have just a string, we add the string to final query, no manipulation</td></tr><tr class="hit"><td class="line">36</td><td class="hits">18</td><td class="source">        s += queryFragment;</td></tr><tr class="hit"><td class="line">37</td><td class="hits">18</td><td class="source">        continue;</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">39</td><td class="hits">1500</td><td class="source">      var attribute = Object.keys(this.statements[i])[0];</td></tr><tr class="hit"><td class="line">40</td><td class="hits">1500</td><td class="source">      if ((typeof queryFragment === 'object') &amp;&amp; (typeof queryFragment.toQueryString === 'function')) {</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">        queryFragment = queryFragment.toQueryString();</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">        s += queryFragment;</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">        continue;</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">45</td><td class="hits">1500</td><td class="source">      var forQuery = this.statements[i][attribute];</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">      // do we have an object with a .toQueryString() method?</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">      // remove underscore from attribute, e.g. ORDER_BY -&gt; ORDER BY</td></tr><tr class="hit"><td class="line">49</td><td class="hits">1500</td><td class="source">      attribute = attribute.replace(/([A-Z]{1})\_([A-Z]{1})/g, '$1 $2');</td></tr><tr class="hit"><td class="line">50</td><td class="hits">1500</td><td class="source">      if (options.niceFormat) {</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        // extend attribute-string with whitespace</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">        attribute = attribute + Array(chopLength - attribute.length).join(' ');</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">54</td><td class="hits">1500</td><td class="source">      if (forQuery !== null) {</td></tr><tr class="hit"><td class="line">55</td><td class="hits">1500</td><td class="source">        if (typeof forQuery === 'string') {</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">          // remove dupliacted statement fragment identifier, e.g. START START … -&gt; START …</td></tr><tr class="hit"><td class="line">57</td><td class="hits">1226</td><td class="source">          forQuery = forQuery.trim().replace(new RegExp('^'+attribute+'\\s+', 'i'), '');</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">          // remove trailing semicolon</td></tr><tr class="hit"><td class="line">59</td><td class="hits">1226</td><td class="source">          forQuery = forQuery.replace(/\;$/, '');</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">61</td><td class="hits">274</td><td class="source">          forQuery = String(forQuery);</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">63</td><td class="hits">1500</td><td class="source">        s += '\n'+attribute+' '+forQuery+' ';</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">66</td><td class="hits">522</td><td class="source">    s = s.trim().replace(/;+$/,'');</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">68</td><td class="hits">522</td><td class="source">  return s + ';';</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">71</td><td class="hits">1</td><td class="source">CypherQuery.prototype.query = '';         // the cypher query string</td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">CypherQuery.prototype.parameters = null;</td></tr><tr class="hit"><td class="line">73</td><td class="hits">1</td><td class="source">CypherQuery.prototype.statements = null;</td></tr><tr class="hit"><td class="line">74</td><td class="hits">1</td><td class="source">CypherQuery.prototype.cypher = {};</td></tr><tr class="hit"><td class="line">75</td><td class="hits">1</td><td class="source">CypherQuery.prototype.useParameters = true;</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">77</td><td class="hits">1</td><td class="source">CypherQuery.prototype.hasParameters = function() {</td></tr><tr class="hit"><td class="line">78</td><td class="hits">1008</td><td class="source">  return ((this.parameters) &amp;&amp; (typeof this.parameters === 'object') &amp;&amp; (Object.keys(this.parameters).length &gt; 0));</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">81</td><td class="hits">1</td><td class="source">CypherQuery.prototype.toCypher = function(options) {</td></tr><tr class="hit"><td class="line">82</td><td class="hits">521</td><td class="source">  var s = '';</td></tr><tr class="hit"><td class="line">83</td><td class="hits">521</td><td class="source">  if (this.query)</td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">    s = this.query;</td></tr><tr class="hit"><td class="line">85</td><td class="hits">521</td><td class="source">  else if (this.statements.length &gt; 0)</td></tr><tr class="hit"><td class="line">86</td><td class="hits">521</td><td class="source">    s = this.statementsToString(options);</td></tr><tr class="hit"><td class="line">87</td><td class="hits">521</td><td class="source">  return s;</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">90</td><td class="hits">1</td><td class="source">CypherQuery.prototype.toString = function(options) {</td></tr><tr class="hit"><td class="line">91</td><td class="hits">4</td><td class="source">  var s = this.toCypher(options);</td></tr><tr class="hit"><td class="line">92</td><td class="hits">4</td><td class="source">  if ((s)&amp;&amp;(this.hasParameters())) {</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">    // replace identifiers with values to present a good equivalent</td></tr><tr class="hit"><td class="line">94</td><td class="hits">2</td><td class="source">    for (var key in this.parameters) {</td></tr><tr class="hit"><td class="line">95</td><td class="hits">2</td><td class="source">      var value = this.parameters[key];</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">      // TODO: better check that we detect placeholders</td></tr><tr class="hit"><td class="line">97</td><td class="hits">2</td><td class="source">      s = s.replace('{'+key+'}', helpers.valueToStringForCypherQuery(value, &quot;'&quot;));</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">100</td><td class="hits">4</td><td class="source">  return s;</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">103</td><td class="hits">1</td><td class="source">CypherQuery.prototype.addParameters = function(parameters) {</td></tr><tr class="hit"><td class="line">104</td><td class="hits">397</td><td class="source">  if (typeof parameters !== 'object')</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">    throw Error('parameter(s) as argument must be an object, e.g. { key: &quot;value&quot; }')</td></tr><tr class="hit"><td class="line">106</td><td class="hits">397</td><td class="source">  if (this.useParameters === null)</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">    this.useParameters = true;</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">  // reset parameters</td></tr><tr class="hit"><td class="line">109</td><td class="hits">397</td><td class="source">  if ((!this.hasParameters()) || ((parameters !== null) &amp;&amp; (Object.keys(parameters).length === 0)))</td></tr><tr class="hit"><td class="line">110</td><td class="hits">227</td><td class="source">    this.parameters = {};</td></tr><tr class="hit"><td class="line">111</td><td class="hits">397</td><td class="source">  for (var attr in parameters) {</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">    // replace undefined values with null because we can't work with undefined values in neo4j</td></tr><tr class="hit"><td class="line">113</td><td class="hits">427</td><td class="source">    this.parameters[attr] = (parameters[attr] === undefined) ? null : parameters[attr];</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">115</td><td class="hits">397</td><td class="source">  return this;</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">118</td><td class="hits">1</td><td class="source">CypherQuery.prototype.addParameter = CypherQuery.prototype.addParameters;</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">120</td><td class="hits">1</td><td class="source">if (typeof window === 'object') {</td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">  window.Neo4jMapper.CypherQuery = CypherQuery;</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="hit"><td class="line">123</td><td class="hits">1</td><td class="source">  module.exports = exports = CypherQuery;</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">}</td></tr></tbody></table></div><div class="file"><h2 id="/Users/philipp/code/neo4jmapper/src/graph.js">/Users/philipp/code/neo4jmapper/src/graph.js</h2><div id="stats" class="high"><div class="percentage">88%</div><div class="sloc">550</div><div class="hits">489</div><div class="misses">61</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * **The Graph** respresents the cypher-query-api of the neo4j database</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * You can perform basic actions and queries directly on the graph</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * ###[Query Structure](http://docs.neo4j.org/refcard/2.0/)</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Read Query Structure:</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * [START]</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> * [MATCH]</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> * [WHERE]</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * [WITH [ORDER BY] [SKIP] [LIMIT]]</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * RETURN [ORDER BY] [SKIP] [LIMIT]</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * Write-Only Query Structure:</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> * (CREATE [UNIQUE] | MERGE)*</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> * [SET|DELETE|FOREACH]*</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> * [RETURN [ORDER BY] [SKIP] [LIMIT]]</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> * Read-Write Query Structure:</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * [START]</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * [MATCH]</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> * [WHERE]</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> * [WITH [ORDER BY] [SKIP] [LIMIT]]</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> * [CREATE [UNIQUE]|MERGE]*</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> * [SET|DELETE|FOREACH]*</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> * [RETURN [ORDER BY] [SKIP] [LIMIT]]</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> * @todo: maybe check of valid query structure?!</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> * Initialize the Graph object with a neo4jrestful client</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> * @param {object} neo4jrestful object</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> * @return {object} Graph object</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">var __initGraph__ = function(neo4jrestful) {</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">  // Requirements (for browser and nodejs):</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">  //   * neo4jmapper helpers</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">  //   * underscorejs</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">8</td><td class="source">  if (typeof window === 'object') {</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">    var helpers               = window.Neo4jMapper.helpers;</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">    var _                     = window._;</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">    var CypherQuery           = window.Neo4jMapper.CypherQuery;</td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">    var ConditionalParameters = window.Neo4jMapper.ConditionalParameters;</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">  } else {</td></tr><tr class="hit"><td class="line">48</td><td class="hits">8</td><td class="source">    var helpers               = require('./helpers');</td></tr><tr class="hit"><td class="line">49</td><td class="hits">8</td><td class="source">    var _                     = require('underscore');</td></tr><tr class="hit"><td class="line">50</td><td class="hits">8</td><td class="source">    var CypherQuery           = require('./cypherquery');</td></tr><tr class="hit"><td class="line">51</td><td class="hits">8</td><td class="source">    var ConditionalParameters = require('./conditionalparameters')</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">  // Ensure that we have a Neo4jRestful client we can work with</td></tr><tr class="hit"><td class="line">55</td><td class="hits">8</td><td class="source">  if ((typeof neo4jrestful !== 'undefined') &amp;&amp; (helpers.constructorNameOfFunction(neo4jrestful) !== 'Neo4jRestful'))</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">    throw Error('You have to use an Neo4jRestful object as argument')</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">   * Constructor of Graph</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">   * @constructor</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">   * @param {string} url</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">63</td><td class="hits">8</td><td class="source">  var Graph = function Graph(url) {</td></tr><tr class="hit"><td class="line">64</td><td class="hits">1081</td><td class="source">    if (url) {</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">      this.neo4jrestful = new neo4jrestful.constructor(url);</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">67</td><td class="hits">1081</td><td class="source">    this.resetQuery();</td></tr><tr class="hit"><td class="line">68</td><td class="hits">1081</td><td class="source">    return this;</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">71</td><td class="hits">8</td><td class="source">  Graph.prototype.neo4jrestful                  = neo4jrestful;</td></tr><tr class="hit"><td class="line">72</td><td class="hits">8</td><td class="source">  Graph.prototype._query_history_               = null;</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">  // see graph.resetQuery() for initialization</td></tr><tr class="hit"><td class="line">74</td><td class="hits">8</td><td class="source">  Graph.prototype.cypher                        = null;</td></tr><tr class="hit"><td class="line">75</td><td class="hits">8</td><td class="source">  Graph.prototype._queryString_                 = '';           // stores a query string temporarily</td></tr><tr class="hit"><td class="line">76</td><td class="hits">8</td><td class="source">  Graph.prototype._loadOnResult_                = 'node|relationship|path';</td></tr><tr class="hit"><td class="line">77</td><td class="hits">8</td><td class="source">  Graph.prototype._resortResults_               = true;         // see in graph.query() -&gt; _increaseDone()</td></tr><tr class="hit"><td class="line">78</td><td class="hits">8</td><td class="source">  Graph.prototype._nativeResults_               = false;        // it's not implemented, all results are processed so far</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">80</td><td class="hits">8</td><td class="source">  Graph.prototype.info                          = null;         // contains the info response of the neo4j database</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">82</td><td class="hits">8</td><td class="source">  Graph.prototype._response_                    = null;         // contains the last response object</td></tr><tr class="hit"><td class="line">83</td><td class="hits">8</td><td class="source">  Graph.prototype._columns_                     = null;         // contains `columns` of { columns: [ … ], data: [ … ] }</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">    * The following argument combinations are accepted:</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    * * query, parameters, cb</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">    * * parameters, cb</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">    * * query, cb</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">    * * cb</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">    *</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">    * Example:</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">    *</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">    *     `Graph.new().exec('START n=node({id}) RETURN n;', { id: 123 }, cb);`</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">    *</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">    *</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">    * @param  {string|object|function} [query]</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">    * @param  {object|function} [parameters]</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">    * @param  {Function} cb (optional, but needed to trigger query execution finally)</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">    */</td></tr><tr class="hit"><td class="line">101</td><td class="hits">8</td><td class="source">  Graph.prototype.exec = function(query, parameters, cb) {</td></tr><tr class="hit"><td class="line">102</td><td class="hits">2840</td><td class="source">    if (typeof query === 'function') {</td></tr><tr class="hit"><td class="line">103</td><td class="hits">246</td><td class="source">      cb = query;</td></tr><tr class="hit"><td class="line">104</td><td class="hits">246</td><td class="source">      query = undefined;</td></tr><tr class="hit"><td class="line">105</td><td class="hits">246</td><td class="source">      parameters = undefined;</td></tr><tr class="hit"><td class="line">106</td><td class="hits">2594</td><td class="source">    } else if (typeof parameters === 'function') {</td></tr><tr class="hit"><td class="line">107</td><td class="hits">18</td><td class="source">      cb = parameters;</td></tr><tr class="hit"><td class="line">108</td><td class="hits">18</td><td class="source">      if (typeof query === 'object') {</td></tr><tr class="hit"><td class="line">109</td><td class="hits">18</td><td class="source">        parameters = query;</td></tr><tr class="hit"><td class="line">110</td><td class="hits">18</td><td class="source">        query = undefined;</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">113</td><td class="hits">2840</td><td class="source">    if (typeof query === 'object') {</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">      // query may be parameters</td></tr><tr class="hit"><td class="line">115</td><td class="hits">42</td><td class="source">      parameters = query;</td></tr><tr class="hit"><td class="line">116</td><td class="hits">42</td><td class="source">      query = undefined;</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">118</td><td class="hits">2840</td><td class="source">    if ((typeof parameters === 'object') &amp;&amp; (parameters !== null)) {</td></tr><tr class="hit"><td class="line">119</td><td class="hits">60</td><td class="source">      this.addParameters(parameters);</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">121</td><td class="hits">2840</td><td class="source">    if (typeof cb === 'function') {</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">      // args: queryString, parameters (are added above), cb, options (no options are used here)</td></tr><tr class="hit"><td class="line">123</td><td class="hits">264</td><td class="source">      this.query(query, {}, cb, {});</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">125</td><td class="hits">2840</td><td class="source">    return this;</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">   * Executes a (cypher)-query-string directly in neo4j</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">   * Example:</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">   *    `Graph.query('START n=node(123) RETURN n;', cb);`</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">   * @param  {string} cypherQuery</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">   * @param  {object} [parameters]</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">   * @param  {Function} cb</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">   * @param  {object} [options] will be passed to `neo4jrestful.query`</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">140</td><td class="hits">8</td><td class="source">  Graph.prototype.query = function(cypherQuery, parameters, cb, options) {</td></tr><tr class="hit"><td class="line">141</td><td class="hits">595</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">142</td><td class="hits">595</td><td class="source">    if (typeof cypherQuery !== 'string') {</td></tr><tr class="hit"><td class="line">143</td><td class="hits">264</td><td class="source">      cypherQuery = this.toCypherQuery();</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">145</td><td class="hits">595</td><td class="source">    if (typeof parameters === 'function') {</td></tr><tr class="hit"><td class="line">146</td><td class="hits">139</td><td class="source">      cb = parameters;</td></tr><tr class="hit"><td class="line">147</td><td class="hits">139</td><td class="source">      options = {};</td></tr><tr class="hit"><td class="line">148</td><td class="hits">139</td><td class="source">      parameters = {};</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">150</td><td class="hits">595</td><td class="source">    if ((typeof options !== 'object')&amp;&amp;(options !== null)) {</td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="source">      options = {};</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">154</td><td class="hits">595</td><td class="source">    if (!parameters)</td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">      parameters = {};</td></tr><tr class="hit"><td class="line">156</td><td class="hits">595</td><td class="source">    if (Object.keys(parameters).length &gt; 0) {</td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="source">      this.addParameters(parameters);</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">160</td><td class="hits">595</td><td class="source">    options.params = (typeof this.cypher.useParameters === 'boolean') ? this.parameters() : {};</td></tr><tr class="hit"><td class="line">161</td><td class="hits">595</td><td class="source">    options.context = self;</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">    // we expect a cb in most cases and perfom the query immediately</td></tr><tr class="hit"><td class="line">164</td><td class="hits">595</td><td class="source">    if (typeof cb === 'function') {</td></tr><tr class="hit"><td class="line">165</td><td class="hits">595</td><td class="source">      this.neo4jrestful.query(cypherQuery, options, function(err, res, debug) {</td></tr><tr class="hit"><td class="line">166</td><td class="hits">595</td><td class="source">        self._processResult(err, res, debug, options, function(err, res, debug) {</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">          // Is used by Node on performing an &quot;update&quot; via a cypher query</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">          // The result length is 1, so we remove the array</td></tr><tr class="hit"><td class="line">169</td><td class="hits">595</td><td class="source">          if ((res)&amp;&amp;(res.length===1)&amp;&amp;(options.cypher)) {</td></tr><tr class="hit"><td class="line">170</td><td class="hits">163</td><td class="source">            if ((options.cypher.limit === 1) || (options.cypher._update_) || (typeof res[0] !== 'object')) {</td></tr><tr class="hit"><td class="line">171</td><td class="hits">17</td><td class="source">              res = res[0];</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"><td class="line">174</td><td class="hits">595</td><td class="source">          cb(err, res, debug);</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">    } else {</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">      // otherwise we store the query string and expect it will be executed with `.exec(cb)` or `.stream(cb)`</td></tr><tr class="miss"><td class="line">179</td><td class="hits">0</td><td class="source">      this._queryString_ = cypherQuery;</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">182</td><td class="hits">595</td><td class="source">    return this;</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">   * Returns the number of column wich contains the labels</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">   * @param  {array} columns</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">   * @return {number} of column</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">191</td><td class="hits">8</td><td class="source">  Graph.prototype.__indexOfLabelColumn = function(columns) {</td></tr><tr class="hit"><td class="line">192</td><td class="hits">1475</td><td class="source">    var labelColumns = this.__indexOfLabelColumns(columns);</td></tr><tr class="hit"><td class="line">193</td><td class="hits">1475</td><td class="source">    var keys = Object.keys(labelColumns);</td></tr><tr class="hit"><td class="line">194</td><td class="hits">1475</td><td class="source">    return (keys.length === 1) ? keys[0] : -1;</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">   * Returns the numbers of column wich contain labels</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">   * @param  {array} columns</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">   * @return {array} indexes</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">203</td><td class="hits">8</td><td class="source">  Graph.prototype.__indexOfLabelColumns = function(columns) {</td></tr><tr class="hit"><td class="line">204</td><td class="hits">1475</td><td class="source">    var labelColumns = {};</td></tr><tr class="hit"><td class="line">205</td><td class="hits">1475</td><td class="source">    if (typeof columns === 'undefined')</td></tr><tr class="hit"><td class="line">206</td><td class="hits">317</td><td class="source">      columns = this._columns_;</td></tr><tr class="hit"><td class="line">207</td><td class="hits">1475</td><td class="source">    for (var i=0; i &lt; columns.length; i++) {</td></tr><tr class="hit"><td class="line">208</td><td class="hits">2049</td><td class="source">      if (/^labels\([a-zA-Z]+\)$/.test(columns[i]))</td></tr><tr class="hit"><td class="line">209</td><td class="hits">617</td><td class="source">        labelColumns[i] = columns[i];</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">211</td><td class="hits">1475</td><td class="source">    return labelColumns;</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">   * Removes label column from array</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">   * @param  {array} array</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">   * @param  {number} columnIndexOfLabel</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">   * @return {array} without label column</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">221</td><td class="hits">8</td><td class="source">  Graph.prototype.__removeLabelColumnFromArray = function(array, columnIndexOfLabel) {</td></tr><tr class="hit"><td class="line">222</td><td class="hits">317</td><td class="source">    if (typeof columnIndexOfLabel !== 'number')</td></tr><tr class="hit"><td class="line">223</td><td class="hits">317</td><td class="source">      columnIndexOfLabel = this.__indexOfLabelColumn();</td></tr><tr class="hit"><td class="line">224</td><td class="hits">317</td><td class="source">    array.splice(columnIndexOfLabel, 1);</td></tr><tr class="hit"><td class="line">225</td><td class="hits">317</td><td class="source">    return array;</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">   * Removes label column from results</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">   * @param  {array} result</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">   * @return {array} without label column</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">234</td><td class="hits">8</td><td class="source">  Graph.prototype.__sortOutLabelColumn = function(result) {</td></tr><tr class="hit"><td class="line">235</td><td class="hits">567</td><td class="source">    var nodeLabels = [];</td></tr><tr class="hit"><td class="line">236</td><td class="hits">567</td><td class="source">    var nodeLabelsColumn = this.__indexOfLabelColumn(result.columns);</td></tr><tr class="hit"><td class="line">237</td><td class="hits">567</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">238</td><td class="hits">567</td><td class="source">    if (nodeLabelsColumn &gt;= 0) {</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">      // we have a 'labels(n)' column</td></tr><tr class="hit"><td class="line">240</td><td class="hits">154</td><td class="source">      for (var i=0; i &lt; result.data.length; i++) {</td></tr><tr class="hit"><td class="line">241</td><td class="hits">151</td><td class="source">        nodeLabels.push(result.data[i][nodeLabelsColumn]);</td></tr><tr class="hit"><td class="line">242</td><td class="hits">151</td><td class="source">        result.data[i] = self.__removeLabelColumnFromArray(result.data[i], nodeLabelsColumn);</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">244</td><td class="hits">154</td><td class="source">      this._columns_ = self.__removeLabelColumnFromArray(this._columns_, nodeLabelsColumn);</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">246</td><td class="hits">567</td><td class="source">    return nodeLabels;</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">   * Processes results array, i.e.</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">   * * sort out data result</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">   * * detect objects and instantiate them</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">   * * applies labels from result set on node object(s)</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">   * @param  {object}   err</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">   * @param  {object}   result</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">   * @param  {object}   debug</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">   * @param  {object}   options</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">   * @param  {Function} cb</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">260</td><td class="hits">8</td><td class="source">  Graph.prototype._processResult = function(err, result, debug, options, cb) {</td></tr><tr class="hit"><td class="line">261</td><td class="hits">595</td><td class="source">    var self = options.context;</td></tr><tr class="hit"><td class="line">262</td><td class="hits">595</td><td class="source">    self._response_ = self.neo4jrestful._response_;</td></tr><tr class="hit"><td class="line">263</td><td class="hits">595</td><td class="source">    self._columns_ = self.neo4jrestful._columns_;</td></tr><tr class="hit"><td class="line">264</td><td class="hits">595</td><td class="source">    if (err)</td></tr><tr class="hit"><td class="line">265</td><td class="hits">9</td><td class="source">      return cb(err, result, debug);</td></tr><tr class="hit"><td class="line">266</td><td class="hits">586</td><td class="source">    var loadNode = /node/i.test(self._loadOnResult_);</td></tr><tr class="hit"><td class="line">267</td><td class="hits">586</td><td class="source">    var loadRelationship = /relation/i.test(self._loadOnResult_);</td></tr><tr class="hit"><td class="line">268</td><td class="hits">586</td><td class="source">    var loadPath = /path/i.test(self._loadOnResult_);</td></tr><tr class="hit"><td class="line">269</td><td class="hits">586</td><td class="source">    var todo = 0;</td></tr><tr class="hit"><td class="line">270</td><td class="hits">586</td><td class="source">    var iterationDone = false;</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">    // if we have the native mode, return results instantly at this point</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">    // TODO: to be implemented</td></tr><tr class="hit"><td class="line">274</td><td class="hits">586</td><td class="source">    if (self._nativeResults_)</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">      // we turned off all loading hooks and no sorting -&gt; so lets return the native result</td></tr><tr class="miss"><td class="line">276</td><td class="hits">0</td><td class="source">      return cb(err, result, debug);</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">    // increase the number of done jobs</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">    // resort the results if options is activated</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">    // and finally invoke the cb if we are done</td></tr><tr class="hit"><td class="line">281</td><td class="hits">586</td><td class="source">    var __oneMoreJobDone = function() {</td></tr><tr class="hit"><td class="line">282</td><td class="hits">1124</td><td class="source">      if ((todo === 0)&amp;&amp;(iterationDone)) {</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">284</td><td class="hits">586</td><td class="source">        if (result.data.length === 0) {</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">          // empty result</td></tr><tr class="hit"><td class="line">286</td><td class="hits">35</td><td class="source">          return cb(err, null, debug);</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">        // if is set to true, sort result:</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">        // * return only the data (columns are attached to graph._columns_)</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">        // * remove array if we only have one column</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">        // e.g. { columns: [ 'count' ], data: [ { 1 } ] } -&gt; 1</td></tr><tr class="hit"><td class="line">293</td><td class="hits">551</td><td class="source">        if (self._resortResults_) {</td></tr><tr class="hit"><td class="line">294</td><td class="hits">532</td><td class="source">          var cleanResult = result.data;</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source">          // remove array, if we have only one column</td></tr><tr class="hit"><td class="line">296</td><td class="hits">532</td><td class="source">          if (self._columns_.length === 1) {</td></tr><tr class="hit"><td class="line">297</td><td class="hits">530</td><td class="source">            for (var row=0; row &lt; cleanResult.length; row++) {</td></tr><tr class="hit"><td class="line">298</td><td class="hits">547</td><td class="source">              cleanResult[row] = cleanResult[row][0];</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"><td class="line">301</td><td class="hits">532</td><td class="source">          if ((self.cypher.limit === 1) &amp;&amp; (cleanResult.length === 1)) {</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source">            // if we have a limit of 1 we can only get data[0] or null</td></tr><tr class="hit"><td class="line">303</td><td class="hits">233</td><td class="source">            cleanResult = (cleanResult.length === 1) ? cleanResult[0] : null;</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"><td class="line">305</td><td class="hits">532</td><td class="source">          cb(err, cleanResult, debug);</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">307</td><td class="hits">19</td><td class="source">          cb(err, result, debug);</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">310</td><td class="hits">538</td><td class="source">        todo--;</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">316</td><td class="hits">586</td><td class="source">    if ((!result.data)&amp;&amp;(result.length === 1)) {</td></tr><tr class="miss"><td class="line">317</td><td class="hits">0</td><td class="source">      return cb(err, result[0], debug);</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">    // check for node labels column (is attached by query builder)</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">    // copy to a new array and remove column from result to the results cleaner</td></tr><tr class="hit"><td class="line">322</td><td class="hits">586</td><td class="source">    var nodeLabelsColumn = this.__indexOfLabelColumn(result.columns);</td></tr><tr class="hit"><td class="line">323</td><td class="hits">586</td><td class="source">    var nodeLabels = (this._resortResults_) ? this.__sortOutLabelColumn(result) : null;</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">325</td><td class="hits">586</td><td class="source">    var recommendConstructor = options.recommendConstructor;</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">327</td><td class="hits">586</td><td class="source">    for (var row=0; row &lt; result.data.length; row++) {</td></tr><tr class="hit"><td class="line">328</td><td class="hits">587</td><td class="source">      for (var column=0; column &lt; result.data[row].length; column++) {</td></tr><tr class="hit"><td class="line">329</td><td class="hits">593</td><td class="source">        var data = result.data[row][column];</td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source">        // try to create an instance if we have an object here</td></tr><tr class="hit"><td class="line">331</td><td class="hits">593</td><td class="source">        if ((typeof data === 'object') &amp;&amp; (data !== null))</td></tr><tr class="hit"><td class="line">332</td><td class="hits">562</td><td class="source">          self.neo4jrestful.createObjectFromResponseData(result.data[row][column], recommendConstructor);</td></tr><tr><td class="line">333</td><td class="hits"></td><td class="source">        // result.data[row][column] = object;</td></tr><tr class="hit"><td class="line">334</td><td class="hits">593</td><td class="source">        var object = result.data[row][column];</td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">336</td><td class="hits">593</td><td class="source">        if (object) {</td></tr><tr class="hit"><td class="line">337</td><td class="hits">589</td><td class="source">          if ((object.classification === 'Node') &amp;&amp; (loadNode)) {</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">339</td><td class="hits">483</td><td class="source">            if (nodeLabelsColumn &gt;= 0) {</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">              // if we have labels(n) column</td></tr><tr class="hit"><td class="line">341</td><td class="hits">150</td><td class="source">              var labels = nodeLabels.shift()</td></tr><tr class="hit"><td class="line">342</td><td class="hits">150</td><td class="source">              object = self.neo4jrestful.Node.instantiateNodeAsModel(object, labels, options.recommendConstructor);</td></tr><tr class="hit"><td class="line">343</td><td class="hits">150</td><td class="source">              object.__skip_loading_labels__ = true;</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">345</td><td class="hits">483</td><td class="source">            todo++;</td></tr><tr class="hit"><td class="line">346</td><td class="hits">483</td><td class="source">            object.load(__oneMoreJobDone);</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"><td class="line">348</td><td class="hits">106</td><td class="source">          else if ((object.classification === 'Relationship') &amp;&amp; (loadRelationship)) {</td></tr><tr class="hit"><td class="line">349</td><td class="hits">54</td><td class="source">            todo++;</td></tr><tr class="hit"><td class="line">350</td><td class="hits">54</td><td class="source">            object.load(__oneMoreJobDone);</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"><td class="line">352</td><td class="hits">52</td><td class="source">          else if ((object.classification === 'Path') &amp;&amp; (loadPath)) {</td></tr><tr class="hit"><td class="line">353</td><td class="hits">1</td><td class="source">            todo++;</td></tr><tr class="hit"><td class="line">354</td><td class="hits">1</td><td class="source">            object.load(__oneMoreJobDone);</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">357</td><td class="hits">589</td><td class="source">          result.data[row][column] = object;</td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">363</td><td class="hits">586</td><td class="source">    iterationDone = true;</td></tr><tr class="hit"><td class="line">364</td><td class="hits">586</td><td class="source">    __oneMoreJobDone();</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">366</td><td class="hits">586</td><td class="source">    return this;</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">368</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source">   * Stream a cypher query</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source">   * @param  {string}   [cypherQuery]</td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">374</td><td class="hits"></td><td class="source">   * @param  {Function} cb</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source">   * @param  {object}   [options]</td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">377</td><td class="hits">8</td><td class="source">  Graph.prototype.stream = function(cypherQuery, parameters, cb, options) {</td></tr><tr class="hit"><td class="line">378</td><td class="hits">7</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">379</td><td class="hits">7</td><td class="source">    var Node = Graph.Node;</td></tr><tr><td class="line">380</td><td class="hits"></td><td class="source">    // check arguments for callback</td></tr><tr class="hit"><td class="line">381</td><td class="hits">7</td><td class="source">    if (typeof cypherQuery === 'function') {</td></tr><tr class="hit"><td class="line">382</td><td class="hits">3</td><td class="source">      cb = cypherQuery;</td></tr><tr class="hit"><td class="line">383</td><td class="hits">3</td><td class="source">      cypherQuery = undefined;</td></tr><tr class="hit"><td class="line">384</td><td class="hits">4</td><td class="source">    } else if (typeof parameters === 'function') {</td></tr><tr class="hit"><td class="line">385</td><td class="hits">2</td><td class="source">      cb = parameters;</td></tr><tr class="hit"><td class="line">386</td><td class="hits">2</td><td class="source">      parameters = undefined;</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">388</td><td class="hits">7</td><td class="source">    if (typeof cypherQuery !== 'string') {</td></tr><tr class="hit"><td class="line">389</td><td class="hits">3</td><td class="source">      cypherQuery = this.toCypherQuery();</td></tr><tr><td class="line">390</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">391</td><td class="hits">7</td><td class="source">    if (parameters) {</td></tr><tr class="hit"><td class="line">392</td><td class="hits">2</td><td class="source">      this.addParameters(parameters);</td></tr><tr><td class="line">393</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">394</td><td class="hits">7</td><td class="source">    if (!options) {</td></tr><tr class="hit"><td class="line">395</td><td class="hits">5</td><td class="source">      options = {};</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">    // get and set option values</td></tr><tr class="hit"><td class="line">398</td><td class="hits">7</td><td class="source">    var recommendConstructor = (options) ? options.recommendConstructor || Node : Node;</td></tr><tr class="hit"><td class="line">399</td><td class="hits">7</td><td class="source">    options.params = (typeof this.cypher.useParameters === 'boolean') ? this.parameters() : {};</td></tr><tr class="hit"><td class="line">400</td><td class="hits">7</td><td class="source">    parameters = this.parameters();</td></tr><tr class="hit"><td class="line">401</td><td class="hits">7</td><td class="source">    var i = 0; // counter is used to prevent changing _columns_ more than once</td></tr><tr class="hit"><td class="line">402</td><td class="hits">7</td><td class="source">    var indexOfLabelColumn = null;</td></tr><tr class="hit"><td class="line">403</td><td class="hits">7</td><td class="source">    this.neo4jrestful.stream(cypherQuery, options, function(data, response, debug) {</td></tr><tr><td class="line">404</td><td class="hits"></td><td class="source">      // neo4jrestful already created an object, but not with a recommend constructor</td></tr><tr class="hit"><td class="line">405</td><td class="hits">31</td><td class="source">      self._columns_ = response._columns_;</td></tr><tr class="hit"><td class="line">406</td><td class="hits">31</td><td class="source">      if ((self._resortResults_)&amp;&amp;(i === 0)) {</td></tr><tr class="hit"><td class="line">407</td><td class="hits">5</td><td class="source">        indexOfLabelColumn = self.__indexOfLabelColumn(self._columns_);</td></tr><tr class="hit"><td class="line">408</td><td class="hits">5</td><td class="source">        if (indexOfLabelColumn &gt;= 0) {</td></tr><tr><td class="line">409</td><td class="hits"></td><td class="source">          // remove [ 'n', 'labels(n)' ] labels(n) column</td></tr><tr class="hit"><td class="line">410</td><td class="hits">2</td><td class="source">          self._columns_ = self.__removeLabelColumnFromArray(self._columns_, indexOfLabelColumn);</td></tr><tr><td class="line">411</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">413</td><td class="hits">31</td><td class="source">      if ((data) &amp;&amp; (typeof data === 'object')) {</td></tr><tr class="hit"><td class="line">414</td><td class="hits">24</td><td class="source">        if (data.constructor === Array) {</td></tr><tr class="hit"><td class="line">415</td><td class="hits">20</td><td class="source">          var labels = null;</td></tr><tr class="hit"><td class="line">416</td><td class="hits">20</td><td class="source">          if ((self._resortResults_) &amp;&amp; (indexOfLabelColumn &gt;= 0)) {</td></tr><tr class="hit"><td class="line">417</td><td class="hits">10</td><td class="source">            labels = data[indexOfLabelColumn];</td></tr><tr class="hit"><td class="line">418</td><td class="hits">10</td><td class="source">            data = self.__removeLabelColumnFromArray(data, indexOfLabelColumn);</td></tr><tr class="hit"><td class="line">419</td><td class="hits">10</td><td class="source">            if (data.length === 1)</td></tr><tr class="hit"><td class="line">420</td><td class="hits">10</td><td class="source">              data = data[0];</td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"><td class="line">422</td><td class="hits">20</td><td class="source">          for (var column = 0; column &lt; data.length; column++) {</td></tr><tr class="hit"><td class="line">423</td><td class="hits">20</td><td class="source">            if ((data[column]) &amp;&amp; (data[column]._response_)) {</td></tr><tr class="hit"><td class="line">424</td><td class="hits">10</td><td class="source">              data[column] = self.neo4jrestful.createObjectFromResponseData(data[column]._response_, recommendConstructor);</td></tr><tr class="hit"><td class="line">425</td><td class="hits">10</td><td class="source">              data[column] = self.neo4jrestful.Node.instantiateNodeAsModel(data[column], labels);</td></tr><tr><td class="line">426</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">427</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">428</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">429</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">430</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">431</td><td class="hits">31</td><td class="source">      self._response_ = response;</td></tr><tr class="hit"><td class="line">432</td><td class="hits">31</td><td class="source">      if ((data) &amp;&amp; (data._response_)) {</td></tr><tr class="hit"><td class="line">433</td><td class="hits">14</td><td class="source">        data = self.neo4jrestful.createObjectFromResponseData(data._response_, recommendConstructor);</td></tr><tr><td class="line">434</td><td class="hits"></td><td class="source">        // data = self.neo4jrestful.Node.instantiateNodeAsModel(data, labels);</td></tr><tr><td class="line">435</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">436</td><td class="hits">31</td><td class="source">      i++;</td></tr><tr class="hit"><td class="line">437</td><td class="hits">31</td><td class="source">      return cb(data, self, debug);</td></tr><tr><td class="line">438</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">439</td><td class="hits">7</td><td class="source">    return this;</td></tr><tr><td class="line">440</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">441</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">442</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">443</td><td class="hits"></td><td class="source">   * Shortcut for `graph.stream`</td></tr><tr><td class="line">444</td><td class="hits"></td><td class="source">   * @see  Graph.prototype.stream</td></tr><tr><td class="line">445</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">446</td><td class="hits">8</td><td class="source">  Graph.prototype.each = Graph.prototype.stream;</td></tr><tr><td class="line">447</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">448</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">449</td><td class="hits"></td><td class="source">   * Set cypher parameters (and removes previous ones if exists)</td></tr><tr><td class="line">450</td><td class="hits"></td><td class="source">   * @param  {object} parameters</td></tr><tr><td class="line">451</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">452</td><td class="hits">8</td><td class="source">  Graph.prototype.setParameters = function(parameters) {</td></tr><tr class="hit"><td class="line">453</td><td class="hits">173</td><td class="source">    if ((typeof parameters !== 'object') || (parameters === null))</td></tr><tr class="miss"><td class="line">454</td><td class="hits">0</td><td class="source">      throw Error('parameter(s) as argument must be an object, e.g. { key: &quot;value&quot; }')</td></tr><tr class="hit"><td class="line">455</td><td class="hits">173</td><td class="source">    if (this.cypher.useParameters === null)</td></tr><tr class="miss"><td class="line">456</td><td class="hits">0</td><td class="source">      this.cypher.useParameters = true;</td></tr><tr class="hit"><td class="line">457</td><td class="hits">173</td><td class="source">    this.cypher.parameters = parameters;</td></tr><tr class="hit"><td class="line">458</td><td class="hits">173</td><td class="source">    return this;</td></tr><tr><td class="line">459</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">460</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">461</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">462</td><td class="hits"></td><td class="source">   * Get cypher parameters</td></tr><tr><td class="line">463</td><td class="hits"></td><td class="source">   * @return  {object} parameters</td></tr><tr><td class="line">464</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">465</td><td class="hits">8</td><td class="source">  Graph.prototype.parameters = function() {</td></tr><tr class="hit"><td class="line">466</td><td class="hits">610</td><td class="source">    return this.cypher.parameters || {};</td></tr><tr><td class="line">467</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">468</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">469</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">470</td><td class="hits"></td><td class="source">   * Add cypher Parameters</td></tr><tr><td class="line">471</td><td class="hits"></td><td class="source">   * @param  {object} parameters</td></tr><tr><td class="line">472</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">473</td><td class="hits">8</td><td class="source">  Graph.prototype.addParameters = function(parameters) {</td></tr><tr class="hit"><td class="line">474</td><td class="hits">76</td><td class="source">    this.cypher.addParameters(parameters);</td></tr><tr class="hit"><td class="line">475</td><td class="hits">76</td><td class="source">    return this;</td></tr><tr><td class="line">476</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">477</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">478</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">479</td><td class="hits"></td><td class="source">   * Add cypher Parameter</td></tr><tr><td class="line">480</td><td class="hits"></td><td class="source">   * @param  {object} parameter</td></tr><tr><td class="line">481</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">482</td><td class="hits">8</td><td class="source">  Graph.prototype.addParameter = function(parameter) {</td></tr><tr class="hit"><td class="line">483</td><td class="hits">2</td><td class="source">    return this.addParameters(parameter);</td></tr><tr><td class="line">484</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">485</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">486</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">487</td><td class="hits"></td><td class="source">   * Deletes *all* nodes and *all* relationships</td></tr><tr><td class="line">488</td><td class="hits"></td><td class="source">   * @param  {Function} cb</td></tr><tr><td class="line">489</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">490</td><td class="hits">8</td><td class="source">  Graph.prototype.wipeDatabase = function(cb) {</td></tr><tr class="miss"><td class="line">491</td><td class="hits">0</td><td class="source">    var query = &quot;START n=node(*) MATCH n-[r?]-() DELETE n, r;&quot;;</td></tr><tr class="miss"><td class="line">492</td><td class="hits">0</td><td class="source">    return this.query(query, cb);</td></tr><tr><td class="line">493</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">494</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">495</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">496</td><td class="hits"></td><td class="source">   * Counts all objects of a specific type</td></tr><tr><td class="line">497</td><td class="hits"></td><td class="source">   * @param  {String}   (all|node|relationship|[nr]:Movie)</td></tr><tr><td class="line">498</td><td class="hits"></td><td class="source">   * @param  {Function} cb</td></tr><tr><td class="line">499</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">500</td><td class="hits">8</td><td class="source">  Graph.prototype.countAllOfType = function(type, cb) {</td></tr><tr class="hit"><td class="line">501</td><td class="hits">15</td><td class="source">    var query = '';</td></tr><tr class="hit"><td class="line">502</td><td class="hits">15</td><td class="source">    if      (/^n(ode)*$/i.test(type))</td></tr><tr class="hit"><td class="line">503</td><td class="hits">4</td><td class="source">      query = &quot;START n=node(*) RETURN count(n);&quot;</td></tr><tr class="hit"><td class="line">504</td><td class="hits">11</td><td class="source">    else if (/^r(elationship)*$/i.test(type))</td></tr><tr class="hit"><td class="line">505</td><td class="hits">9</td><td class="source">      query = &quot;START r=relationship(*) RETURN count(r);&quot;;</td></tr><tr class="hit"><td class="line">506</td><td class="hits">2</td><td class="source">    else if (/^[nr]\:.+/.test(type))</td></tr><tr><td class="line">507</td><td class="hits"></td><td class="source">      // count labels</td></tr><tr class="miss"><td class="line">508</td><td class="hits">0</td><td class="source">      query = &quot;MATCH &quot;+type+&quot; RETURN &quot;+type[0]+&quot;;&quot;;</td></tr><tr><td class="line">509</td><td class="hits"></td><td class="source">    else</td></tr><tr class="hit"><td class="line">510</td><td class="hits">2</td><td class="source">      query = &quot;START n=node(*) OPTIONAL MATCH n-[r]-() RETURN count(n), count(r);&quot;;</td></tr><tr class="hit"><td class="line">511</td><td class="hits">15</td><td class="source">    return Graph.query(query, function(err,data){</td></tr><tr class="hit"><td class="line">512</td><td class="hits">15</td><td class="source">      if ((data)&amp;&amp;(data.data)) {</td></tr><tr class="hit"><td class="line">513</td><td class="hits">15</td><td class="source">        var count = data.data[0][0];</td></tr><tr class="hit"><td class="line">514</td><td class="hits">15</td><td class="source">        if (typeof data.data[0][1] !== 'undefined')</td></tr><tr class="hit"><td class="line">515</td><td class="hits">2</td><td class="source">          count += data.data[0][1];</td></tr><tr class="hit"><td class="line">516</td><td class="hits">15</td><td class="source">        return cb(err, count);</td></tr><tr><td class="line">517</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">518</td><td class="hits">0</td><td class="source">      cb(err,data);</td></tr><tr><td class="line">519</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">520</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">521</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">522</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">523</td><td class="hits"></td><td class="source">   * Counts all relationships</td></tr><tr><td class="line">524</td><td class="hits"></td><td class="source">   * @param  {Function} cb</td></tr><tr><td class="line">525</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">526</td><td class="hits">8</td><td class="source">  Graph.prototype.countRelationships = function(cb) {</td></tr><tr class="hit"><td class="line">527</td><td class="hits">9</td><td class="source">    return this.countAllOfType('relationship', cb);</td></tr><tr><td class="line">528</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">529</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">530</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">531</td><td class="hits"></td><td class="source">   * Alias for countRelationships()</td></tr><tr><td class="line">532</td><td class="hits"></td><td class="source">   * @see Graph.countRelationships()</td></tr><tr><td class="line">533</td><td class="hits"></td><td class="source">   * @param  {Function} cb</td></tr><tr><td class="line">534</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">535</td><td class="hits">8</td><td class="source">  Graph.prototype.countRelations = function(cb) {</td></tr><tr class="hit"><td class="line">536</td><td class="hits">4</td><td class="source">    return this.countRelationships(cb);</td></tr><tr><td class="line">537</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">538</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">539</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">540</td><td class="hits"></td><td class="source">   * Counts all nodes</td></tr><tr><td class="line">541</td><td class="hits"></td><td class="source">   * @param  {Function} cb</td></tr><tr><td class="line">542</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">543</td><td class="hits">8</td><td class="source">  Graph.prototype.countNodes = function(cb) {</td></tr><tr class="hit"><td class="line">544</td><td class="hits">4</td><td class="source">    return this.countAllOfType('node', cb);</td></tr><tr><td class="line">545</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">546</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">547</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">548</td><td class="hits"></td><td class="source">   * Counts all relationships and nodes</td></tr><tr><td class="line">549</td><td class="hits"></td><td class="source">   * @param  {Function} cb</td></tr><tr><td class="line">550</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">551</td><td class="hits">8</td><td class="source">  Graph.prototype.countAll = function(cb) {</td></tr><tr class="hit"><td class="line">552</td><td class="hits">2</td><td class="source">    return this.countAllOfType('all', cb);</td></tr><tr><td class="line">553</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">554</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">555</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">556</td><td class="hits"></td><td class="source">   * Queries information of the database and stores it on `this.info`</td></tr><tr><td class="line">557</td><td class="hits"></td><td class="source">   * @param  {Function} cb</td></tr><tr><td class="line">558</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">559</td><td class="hits">8</td><td class="source">  Graph.prototype.about = function(cb) {</td></tr><tr class="hit"><td class="line">560</td><td class="hits">2</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">561</td><td class="hits">2</td><td class="source">    if (this.info)</td></tr><tr class="miss"><td class="line">562</td><td class="hits">0</td><td class="source">      return cb(null,info);</td></tr><tr><td class="line">563</td><td class="hits"></td><td class="source">    else</td></tr><tr class="hit"><td class="line">564</td><td class="hits">2</td><td class="source">      return this.neo4jrestful.get('/'+this.neo4jrestful.urlOptions.endpoint, function(err, info){</td></tr><tr class="hit"><td class="line">565</td><td class="hits">2</td><td class="source">        if (info) {</td></tr><tr class="hit"><td class="line">566</td><td class="hits">2</td><td class="source">          self.info = info</td></tr><tr><td class="line">567</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">568</td><td class="hits">2</td><td class="source">        if (typeof cb === 'function')</td></tr><tr class="hit"><td class="line">569</td><td class="hits">2</td><td class="source">          cb(err,info);</td></tr><tr><td class="line">570</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">571</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">572</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">573</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">574</td><td class="hits"></td><td class="source">   * Resets the query history</td></tr><tr><td class="line">575</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">576</td><td class="hits">8</td><td class="source">  Graph.prototype.resetQuery = function() {</td></tr><tr class="hit"><td class="line">577</td><td class="hits">2148</td><td class="source">    this._query_history_ = [];</td></tr><tr class="hit"><td class="line">578</td><td class="hits">2148</td><td class="source">    this._queryString_ = '';</td></tr><tr class="hit"><td class="line">579</td><td class="hits">2148</td><td class="source">    this.cypher = new CypherQuery();</td></tr><tr class="hit"><td class="line">580</td><td class="hits">2148</td><td class="source">    return this;</td></tr><tr><td class="line">581</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">582</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">583</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">584</td><td class="hits"></td><td class="source">   *  Startpoint to begin query chaining</td></tr><tr><td class="line">585</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">586</td><td class="hits"></td><td class="source">   *  Example:</td></tr><tr><td class="line">587</td><td class="hits"></td><td class="source">   *    `Graph.start().where( …`</td></tr><tr><td class="line">588</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">589</td><td class="hits"></td><td class="source">   * @param  {string}   start</td></tr><tr><td class="line">590</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">591</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">592</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">593</td><td class="hits">8</td><td class="source">  Graph.prototype.start = function(start, parameters, cb) {</td></tr><tr class="hit"><td class="line">594</td><td class="hits">1067</td><td class="source">    this.resetQuery();</td></tr><tr class="hit"><td class="line">595</td><td class="hits">1067</td><td class="source">    if (typeof start === 'function') {</td></tr><tr class="miss"><td class="line">596</td><td class="hits">0</td><td class="source">      cb = start;</td></tr><tr class="miss"><td class="line">597</td><td class="hits">0</td><td class="source">      start = null;</td></tr><tr><td class="line">598</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">599</td><td class="hits">1067</td><td class="source">    if (start)</td></tr><tr class="hit"><td class="line">600</td><td class="hits">519</td><td class="source">      this._query_history_.push({ START: start });</td></tr><tr class="hit"><td class="line">601</td><td class="hits">1067</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">602</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">603</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">604</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">605</td><td class="hits"></td><td class="source">   * `MATCH …`</td></tr><tr><td class="line">606</td><td class="hits"></td><td class="source">   * @param  {object|string|array}   match</td></tr><tr><td class="line">607</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">608</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">609</td><td class="hits"></td><td class="source">   * @param  {object}   [options]</td></tr><tr><td class="line">610</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">611</td><td class="hits">8</td><td class="source">  Graph.prototype.match = function(match, parameters, cb, options) {</td></tr><tr class="hit"><td class="line">612</td><td class="hits">137</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">613</td><td class="hits">137</td><td class="source">    if (typeof options !== 'object')</td></tr><tr class="hit"><td class="line">614</td><td class="hits">130</td><td class="source">      options = {};</td></tr><tr class="hit"><td class="line">615</td><td class="hits">137</td><td class="source">    var matchString = '';</td></tr><tr class="hit"><td class="line">616</td><td class="hits">137</td><td class="source">    if (typeof match === 'object') {</td></tr><tr class="hit"><td class="line">617</td><td class="hits">4</td><td class="source">      if (match.length) {</td></tr><tr class="hit"><td class="line">618</td><td class="hits">2</td><td class="source">        match.forEach(function(item){</td></tr><tr class="hit"><td class="line">619</td><td class="hits">6</td><td class="source">          if (typeof item === 'object') {</td></tr><tr class="hit"><td class="line">620</td><td class="hits">2</td><td class="source">            matchString += self._addObjectLiteralForStatement(item);</td></tr><tr><td class="line">621</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="hit"><td class="line">622</td><td class="hits">4</td><td class="source">            matchString += String(item);</td></tr><tr><td class="line">623</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">624</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">625</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">626</td><td class="hits">2</td><td class="source">        matchString = self._addObjectLiteralForStatement(match);</td></tr><tr><td class="line">627</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">628</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">629</td><td class="hits">133</td><td class="source">      matchString = match;</td></tr><tr><td class="line">630</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">631</td><td class="hits"></td><td class="source">    // do we have &quot;ON MATCH&quot;, &quot;OPTIONAL MATCH&quot; or &quot;MATCH&quot; ?</td></tr><tr class="hit"><td class="line">632</td><td class="hits">137</td><td class="source">    if (!options.switch)</td></tr><tr class="hit"><td class="line">633</td><td class="hits">130</td><td class="source">      this._query_history_.push({ MATCH: matchString });</td></tr><tr class="hit"><td class="line">634</td><td class="hits">7</td><td class="source">    else if (options.switch === 'ON MATCH')</td></tr><tr class="hit"><td class="line">635</td><td class="hits">2</td><td class="source">      this._query_history_.push({ ON_MATCH: matchString });</td></tr><tr class="hit"><td class="line">636</td><td class="hits">5</td><td class="source">    else if (options.switch === 'OPTIONAL MATCH')</td></tr><tr class="hit"><td class="line">637</td><td class="hits">5</td><td class="source">      this._query_history_.push({ OPTIONAL_MATCH: matchString });</td></tr><tr class="hit"><td class="line">638</td><td class="hits">137</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">639</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">640</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">641</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">642</td><td class="hits"></td><td class="source">   * `ON MATCH …`</td></tr><tr><td class="line">643</td><td class="hits"></td><td class="source">   * @param  {string|object|array}   onMatch</td></tr><tr><td class="line">644</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">645</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">646</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">647</td><td class="hits">8</td><td class="source">  Graph.prototype.onMatch = function(onMatch, parameters, cb) {</td></tr><tr class="hit"><td class="line">648</td><td class="hits">2</td><td class="source">    return this.match(onMatch, parameters, cb, { switch: 'ON MATCH' });</td></tr><tr><td class="line">649</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">650</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">651</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">652</td><td class="hits"></td><td class="source">   * `OPTIONAL MATCH …`</td></tr><tr><td class="line">653</td><td class="hits"></td><td class="source">   * @param  {string|object|array}   onMatch</td></tr><tr><td class="line">654</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">655</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">656</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">657</td><td class="hits">8</td><td class="source">  Graph.prototype.optionalMatch = function(optionalMatch, parameters, cb) {</td></tr><tr class="hit"><td class="line">658</td><td class="hits">5</td><td class="source">    return this.match(optionalMatch, parameters, cb, { switch: 'OPTIONAL MATCH' });</td></tr><tr><td class="line">659</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">660</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">661</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">662</td><td class="hits"></td><td class="source">   * `WITH …`</td></tr><tr><td class="line">663</td><td class="hits"></td><td class="source">   * @param  {string}   withStatement</td></tr><tr><td class="line">664</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">665</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">666</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">667</td><td class="hits">8</td><td class="source">  Graph.prototype.with = function(withStatement, parameters, cb) {</td></tr><tr class="hit"><td class="line">668</td><td class="hits">6</td><td class="source">    this._query_history_.push({ WITH: withStatement });</td></tr><tr class="hit"><td class="line">669</td><td class="hits">6</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">670</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">671</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">672</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">673</td><td class="hits"></td><td class="source">   * `SKIP …`</td></tr><tr><td class="line">674</td><td class="hits"></td><td class="source">   * @param  {number}   skip</td></tr><tr><td class="line">675</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">676</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">677</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">678</td><td class="hits">8</td><td class="source">  Graph.prototype.skip = function(skip, parameters, cb) {</td></tr><tr class="hit"><td class="line">679</td><td class="hits">8</td><td class="source">    skip = parseInt(skip);</td></tr><tr class="hit"><td class="line">680</td><td class="hits">8</td><td class="source">    if (skip === NaN)</td></tr><tr class="miss"><td class="line">681</td><td class="hits">0</td><td class="source">      throw Error('SKIP must be an integer');</td></tr><tr class="hit"><td class="line">682</td><td class="hits">8</td><td class="source">    this._query_history_.push({ SKIP: skip });</td></tr><tr class="hit"><td class="line">683</td><td class="hits">8</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">684</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">685</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">686</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">687</td><td class="hits"></td><td class="source">   * `LIMIT …`</td></tr><tr><td class="line">688</td><td class="hits"></td><td class="source">   * @param  {number}   limit</td></tr><tr><td class="line">689</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">690</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">691</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">692</td><td class="hits">8</td><td class="source">  Graph.prototype.limit = function(limit, parameters, cb) {</td></tr><tr class="hit"><td class="line">693</td><td class="hits">282</td><td class="source">    limit = parseInt(limit);</td></tr><tr class="hit"><td class="line">694</td><td class="hits">282</td><td class="source">    if (limit === NaN)</td></tr><tr class="miss"><td class="line">695</td><td class="hits">0</td><td class="source">      throw Error('LIMIT must be an integer');</td></tr><tr class="hit"><td class="line">696</td><td class="hits">282</td><td class="source">    this._query_history_.push({ LIMIT: limit });</td></tr><tr class="hit"><td class="line">697</td><td class="hits">282</td><td class="source">    this.cypher.limit = limit; // TODO: implement: if limit 1 only return { r } or null instead if [ { r } ]</td></tr><tr class="hit"><td class="line">698</td><td class="hits">282</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">699</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">700</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">701</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">702</td><td class="hits"></td><td class="source">   * `MERGE …`</td></tr><tr><td class="line">703</td><td class="hits"></td><td class="source">   * @param  {string}   merge</td></tr><tr><td class="line">704</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">705</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">706</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">707</td><td class="hits">8</td><td class="source">  Graph.prototype.merge = function(merge, parameters, cb) {</td></tr><tr><td class="line">708</td><td class="hits"></td><td class="source">    // TODO: values to parameter</td></tr><tr class="hit"><td class="line">709</td><td class="hits">2</td><td class="source">    this._query_history_.push({ MERGE: merge });</td></tr><tr class="hit"><td class="line">710</td><td class="hits">2</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">711</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">712</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">713</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">714</td><td class="hits"></td><td class="source">   * Pure string as statement segment</td></tr><tr><td class="line">715</td><td class="hits"></td><td class="source">   * @param  {string}   statement</td></tr><tr><td class="line">716</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">717</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">718</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">719</td><td class="hits">8</td><td class="source">  Graph.prototype.custom = function(statement, parameters, cb) {</td></tr><tr class="hit"><td class="line">720</td><td class="hits">24</td><td class="source">    if ((typeof statement === 'object') &amp;&amp; (typeof statement.toQuery === 'function')) {</td></tr><tr class="hit"><td class="line">721</td><td class="hits">1</td><td class="source">      this._query_history_.push(statement.toQuery().toString());</td></tr><tr><td class="line">722</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">723</td><td class="hits">23</td><td class="source">      this._query_history_.push(statement);</td></tr><tr><td class="line">724</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">725</td><td class="hits">24</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">726</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">727</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">728</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">729</td><td class="hits"></td><td class="source">   * `SET …`</td></tr><tr><td class="line">730</td><td class="hits"></td><td class="source">   * @param  {string|object}   set</td></tr><tr><td class="line">731</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">732</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">733</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">734</td><td class="hits">8</td><td class="source">  Graph.prototype.set = function(set, parameters, cb) {</td></tr><tr class="hit"><td class="line">735</td><td class="hits">15</td><td class="source">    var setString = '';</td></tr><tr class="hit"><td class="line">736</td><td class="hits">15</td><td class="source">    var data = null;</td></tr><tr class="hit"><td class="line">737</td><td class="hits">15</td><td class="source">    if ((typeof set === 'object')&amp;&amp;(set !== null)) {</td></tr><tr class="hit"><td class="line">738</td><td class="hits">13</td><td class="source">      if (set.constructor !== Array) {</td></tr><tr class="hit"><td class="line">739</td><td class="hits">2</td><td class="source">        data = set;</td></tr><tr class="hit"><td class="line">740</td><td class="hits">2</td><td class="source">        set = [];</td></tr><tr class="hit"><td class="line">741</td><td class="hits">2</td><td class="source">        if (this.cypher.useParameters) {</td></tr><tr class="hit"><td class="line">742</td><td class="hits">1</td><td class="source">          set = this._addKeyValuesToParameters(data, ' = ');</td></tr><tr><td class="line">743</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">744</td><td class="hits">1</td><td class="source">          for (var key in data) {</td></tr><tr class="hit"><td class="line">745</td><td class="hits">3</td><td class="source">            var value = data[key];</td></tr><tr class="hit"><td class="line">746</td><td class="hits">3</td><td class="source">            set.push(helpers.escapeProperty(key)+' = '+helpers.valueToStringForCypherQuery(value, &quot;'&quot;));</td></tr><tr><td class="line">747</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">748</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">749</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">750</td><td class="hits">13</td><td class="source">      setString += set.join(', ');</td></tr><tr><td class="line">751</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">752</td><td class="hits">2</td><td class="source">      setString += set;</td></tr><tr><td class="line">753</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">754</td><td class="hits">15</td><td class="source">    this._query_history_.push({ SET: setString });</td></tr><tr class="hit"><td class="line">755</td><td class="hits">15</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">756</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">757</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">758</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">759</td><td class="hits"></td><td class="source">   * `SET n = …`, sets explicit to a set of values</td></tr><tr><td class="line">760</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">761</td><td class="hits"></td><td class="source">   * Example:</td></tr><tr><td class="line">762</td><td class="hits"></td><td class="source">   *  `{ n: { name: 'Steve' } }`</td></tr><tr><td class="line">763</td><td class="hits"></td><td class="source">   *  ~&gt; SET n = { `name`: 'Steve' }</td></tr><tr><td class="line">764</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">765</td><td class="hits"></td><td class="source">   * @param  {object}   setWith value set</td></tr><tr><td class="line">766</td><td class="hits"></td><td class="source">   * @param  {[type]}   parameters</td></tr><tr><td class="line">767</td><td class="hits"></td><td class="source">   * @param  {Function} cb</td></tr><tr><td class="line">768</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">769</td><td class="hits">8</td><td class="source">  Graph.prototype.setWith = function(setWith, parameters, cb) {</td></tr><tr class="hit"><td class="line">770</td><td class="hits">10</td><td class="source">    var setString = '';</td></tr><tr class="hit"><td class="line">771</td><td class="hits">10</td><td class="source">    setString += Object.keys(setWith)[0]+' = ';</td></tr><tr class="hit"><td class="line">772</td><td class="hits">10</td><td class="source">    if (this.cypher.useParameters) {</td></tr><tr class="hit"><td class="line">773</td><td class="hits">9</td><td class="source">      setString += this._addObjectLiteralToParameters(setWith[Object.keys(setWith)[0]]);</td></tr><tr><td class="line">774</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">775</td><td class="hits">1</td><td class="source">      setString += helpers.serializeObjectForCypher(setWith[Object.keys(setWith)[0]]);</td></tr><tr><td class="line">776</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">777</td><td class="hits">10</td><td class="source">    this._query_history_.push({ SET: setString });</td></tr><tr class="hit"><td class="line">778</td><td class="hits">10</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">779</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">780</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">781</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">782</td><td class="hits"></td><td class="source">   * `CREATE …`</td></tr><tr><td class="line">783</td><td class="hits"></td><td class="source">   * @param  {string|object}   create</td></tr><tr><td class="line">784</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">785</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">786</td><td class="hits"></td><td class="source">   * @param  {[type]}   [options]</td></tr><tr><td class="line">787</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">788</td><td class="hits">8</td><td class="source">  Graph.prototype.create = function(create, parameters, cb, options) {</td></tr><tr class="hit"><td class="line">789</td><td class="hits">240</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">790</td><td class="hits">240</td><td class="source">    var creates = [];</td></tr><tr class="hit"><td class="line">791</td><td class="hits">240</td><td class="source">    if (typeof options !== 'object')</td></tr><tr class="hit"><td class="line">792</td><td class="hits">236</td><td class="source">      options = {};</td></tr><tr class="hit"><td class="line">793</td><td class="hits">240</td><td class="source">    options = _.defaults(options, {</td></tr><tr><td class="line">794</td><td class="hits"></td><td class="source">      action: 'CREATE'</td></tr><tr><td class="line">795</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">796</td><td class="hits">240</td><td class="source">    if (typeof create === 'object') {</td></tr><tr class="hit"><td class="line">797</td><td class="hits">233</td><td class="source">      creates.push('( ');</td></tr><tr class="hit"><td class="line">798</td><td class="hits">233</td><td class="source">      if (create.length) {</td></tr><tr class="hit"><td class="line">799</td><td class="hits">31</td><td class="source">        create.forEach(function(item){</td></tr><tr class="hit"><td class="line">800</td><td class="hits">93</td><td class="source">          if (typeof item === 'object') {</td></tr><tr class="hit"><td class="line">801</td><td class="hits">31</td><td class="source">            creates.push(self._addObjectLiteralForStatement(item));</td></tr><tr><td class="line">802</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="hit"><td class="line">803</td><td class="hits">62</td><td class="source">            creates.push(String(item));</td></tr><tr><td class="line">804</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">805</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">806</td><td class="hits"></td><td class="source">      } else {</td></tr><tr><td class="line">807</td><td class="hits"></td><td class="source">        // we have a object literal</td></tr><tr class="hit"><td class="line">808</td><td class="hits">202</td><td class="source">        var parts = [];</td></tr><tr><td class="line">809</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">810</td><td class="hits">202</td><td class="source">        for (var part in create) {</td></tr><tr><td class="line">811</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">812</td><td class="hits">202</td><td class="source">          for (var attr in create[part]) {</td></tr><tr><td class="line">813</td><td class="hits"></td><td class="source">            // on create, only add values beside `null` and `undefined`, otherwise neo4j will throw an exception</td></tr><tr class="hit"><td class="line">814</td><td class="hits">287</td><td class="source">            if ((create[part][attr] === undefined)||(create[part][attr] === null)) {</td></tr><tr class="hit"><td class="line">815</td><td class="hits">2</td><td class="source">              delete create[part][attr];</td></tr><tr><td class="line">816</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">817</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"><td class="line">818</td><td class="hits">202</td><td class="source">          parts.push(part + ' ' + self._addObjectLiteralForStatement(create[part]));</td></tr><tr><td class="line">819</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">820</td><td class="hits">202</td><td class="source">        creates.push(parts.join(', '));</td></tr><tr><td class="line">821</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">822</td><td class="hits">233</td><td class="source">      creates.push(' )');</td></tr><tr><td class="line">823</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">824</td><td class="hits">7</td><td class="source">      creates = [ create ];</td></tr><tr><td class="line">825</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">826</td><td class="hits">240</td><td class="source">    var statementSegment = {};</td></tr><tr><td class="line">827</td><td class="hits"></td><td class="source">    // { CREATE:  creates.join(' ') } for instance</td></tr><tr class="hit"><td class="line">828</td><td class="hits">240</td><td class="source">    statementSegment[options.action] = creates.join(' ');</td></tr><tr class="hit"><td class="line">829</td><td class="hits">240</td><td class="source">    this._query_history_.push(statementSegment);</td></tr><tr class="hit"><td class="line">830</td><td class="hits">240</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">831</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">832</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">833</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">834</td><td class="hits"></td><td class="source">   * `ON CREATE …`</td></tr><tr><td class="line">835</td><td class="hits"></td><td class="source">   * @see Graph.prototype.create</td></tr><tr><td class="line">836</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">837</td><td class="hits">8</td><td class="source">  Graph.prototype.onCreate = function(onCreate, parameters, cb) {</td></tr><tr class="hit"><td class="line">838</td><td class="hits">2</td><td class="source">    return this.create(onCreate, parameters, cb, { action: 'ON_CREATE' });</td></tr><tr><td class="line">839</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">840</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">841</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">842</td><td class="hits"></td><td class="source">   * `CREATE UNIQUE …`</td></tr><tr><td class="line">843</td><td class="hits"></td><td class="source">   * @see Graph.prototype.create</td></tr><tr><td class="line">844</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">845</td><td class="hits">8</td><td class="source">  Graph.prototype.createUnique = function(createUnique, parameters, cb) {</td></tr><tr class="hit"><td class="line">846</td><td class="hits">2</td><td class="source">    return this.create(createUnique, parameters, cb, { action: 'CREATE_UNIQUE' });</td></tr><tr><td class="line">847</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">848</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">849</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">850</td><td class="hits"></td><td class="source">   * `CREATE INDEX ON …`</td></tr><tr><td class="line">851</td><td class="hits"></td><td class="source">   * @see Graph.prototype.create</td></tr><tr><td class="line">852</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">853</td><td class="hits">8</td><td class="source">  Graph.prototype.createIndexOn = function(createIndexOn, parameters, cb) {</td></tr><tr class="miss"><td class="line">854</td><td class="hits">0</td><td class="source">    return this.create(createIndexOn, parameters, cb, { action: 'CREATE_INDEX_ON' });</td></tr><tr><td class="line">855</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">856</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">857</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">858</td><td class="hits"></td><td class="source">   * `CASE … END`</td></tr><tr><td class="line">859</td><td class="hits"></td><td class="source">   * @param  {string}   caseStatement</td></tr><tr><td class="line">860</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">861</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">862</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">863</td><td class="hits">8</td><td class="source">  Graph.prototype.case = function(caseStatement, parameters, cb) {</td></tr><tr class="hit"><td class="line">864</td><td class="hits">2</td><td class="source">    this._query_history_.push({ CASE: caseStatement.replace(/END\s*$/i,'') + ' END ' });</td></tr><tr class="hit"><td class="line">865</td><td class="hits">2</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">866</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">867</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">868</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">869</td><td class="hits"></td><td class="source">   * `DROP INDEX ON …`</td></tr><tr><td class="line">870</td><td class="hits"></td><td class="source">   * @param  {string}   dropIndexOn</td></tr><tr><td class="line">871</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">872</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">873</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">874</td><td class="hits">8</td><td class="source">  Graph.prototype.dropIndexOn = function(dropIndexOn, parameters, cb) {</td></tr><tr class="miss"><td class="line">875</td><td class="hits">0</td><td class="source">    this._query_history_.push({ DROP_INDEX_ON: dropIndexOn });</td></tr><tr class="miss"><td class="line">876</td><td class="hits">0</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">877</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">878</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">879</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">880</td><td class="hits"></td><td class="source">   * `ORDER BY …`</td></tr><tr><td class="line">881</td><td class="hits"></td><td class="source">   * @param  {string|object}   property</td></tr><tr><td class="line">882</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">883</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">884</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">885</td><td class="hits">8</td><td class="source">  Graph.prototype.orderBy = function(property, parameters, cb) {</td></tr><tr class="hit"><td class="line">886</td><td class="hits">11</td><td class="source">    var direction = ''</td></tr><tr><td class="line">887</td><td class="hits"></td><td class="source">      , s = '';</td></tr><tr class="hit"><td class="line">888</td><td class="hits">11</td><td class="source">    if (typeof property === 'object') {</td></tr><tr class="hit"><td class="line">889</td><td class="hits">2</td><td class="source">      var key = Object.keys(property)[0];</td></tr><tr class="hit"><td class="line">890</td><td class="hits">2</td><td class="source">      cb = direction;</td></tr><tr class="hit"><td class="line">891</td><td class="hits">2</td><td class="source">      direction = property[key];</td></tr><tr class="hit"><td class="line">892</td><td class="hits">2</td><td class="source">      property = key;</td></tr><tr class="hit"><td class="line">893</td><td class="hits">2</td><td class="source">      direction = ( (typeof direction === 'string') &amp;&amp; ((/^(ASC|DESC)$/).test(direction)) ) ? direction : 'ASC';</td></tr><tr class="hit"><td class="line">894</td><td class="hits">2</td><td class="source">      s = property+' '+direction;</td></tr><tr class="hit"><td class="line">895</td><td class="hits">9</td><td class="source">    } else if (typeof property === 'string') {</td></tr><tr class="hit"><td class="line">896</td><td class="hits">9</td><td class="source">      s = property;</td></tr><tr><td class="line">897</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">898</td><td class="hits">11</td><td class="source">    this._query_history_.push({ ORDER_BY: s });</td></tr><tr class="hit"><td class="line">899</td><td class="hits">11</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">900</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">901</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">902</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">903</td><td class="hits"></td><td class="source">   * `WHERE …`</td></tr><tr><td class="line">904</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">905</td><td class="hits"></td><td class="source">   * Examples:</td></tr><tr><td class="line">906</td><td class="hits"></td><td class="source">   *    Graph.start('n=node(1)').where({ $OR : [ { 'n.name?': 'Steve' }, { 'n.name?': 'Jobs' } ] })</td></tr><tr><td class="line">907</td><td class="hits"></td><td class="source">   *    Graph.start('n=node(1)').where(&quot;n.name? = {name1} OR n.name? = {name2}&quot;, { name1: 'Steve', name2: 'Jobs' })</td></tr><tr><td class="line">908</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">909</td><td class="hits"></td><td class="source">   * @param  {object|string}   where</td></tr><tr><td class="line">910</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">911</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">912</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">913</td><td class="hits">8</td><td class="source">  Graph.prototype.where = function(where, parameters, cb) {</td></tr><tr class="hit"><td class="line">914</td><td class="hits">93</td><td class="source">    if (typeof where === 'string') {</td></tr><tr class="hit"><td class="line">915</td><td class="hits">83</td><td class="source">      this._query_history_.push({ WHERE: where });</td></tr><tr class="hit"><td class="line">916</td><td class="hits">83</td><td class="source">      return this.exec(parameters, cb);</td></tr><tr><td class="line">917</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">918</td><td class="hits">10</td><td class="source">    if (this.cypher.useParameters === null)</td></tr><tr class="miss"><td class="line">919</td><td class="hits">0</td><td class="source">      this.cypher.useParameters = true;</td></tr><tr class="hit"><td class="line">920</td><td class="hits">10</td><td class="source">    if (!_.isArray(where))</td></tr><tr class="hit"><td class="line">921</td><td class="hits">10</td><td class="source">      where = [ where ];</td></tr><tr class="hit"><td class="line">922</td><td class="hits">10</td><td class="source">    var options = { valuesToParameters: this.cypher.useParameters, parametersStartCountAt: Object.keys(this.cypher.parameters || {}).length };</td></tr><tr class="hit"><td class="line">923</td><td class="hits">10</td><td class="source">    var condition = new ConditionalParameters(where, options);</td></tr><tr class="hit"><td class="line">924</td><td class="hits">10</td><td class="source">    var whereCondition = condition.toString().replace(/^\(\s(.+)\)$/, '$1');</td></tr><tr><td class="line">925</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">926</td><td class="hits">10</td><td class="source">    this._query_history_.push({ WHERE: whereCondition });</td></tr><tr class="hit"><td class="line">927</td><td class="hits">10</td><td class="source">    if (this.cypher.useParameters)</td></tr><tr class="hit"><td class="line">928</td><td class="hits">8</td><td class="source">      this.addParameters(condition.parameters);</td></tr><tr class="hit"><td class="line">929</td><td class="hits">10</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">930</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">931</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">932</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">933</td><td class="hits"></td><td class="source">   * `RETURN …`</td></tr><tr><td class="line">934</td><td class="hits"></td><td class="source">   * @param  {String}   returnStatement</td></tr><tr><td class="line">935</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">936</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">937</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">938</td><td class="hits">8</td><td class="source">  Graph.prototype.return = function(returnStatement, parameters, cb, distinct) {</td></tr><tr class="hit"><td class="line">939</td><td class="hits">688</td><td class="source">    var parts = [];</td></tr><tr class="hit"><td class="line">940</td><td class="hits">688</td><td class="source">    if (returnStatement) {</td></tr><tr class="hit"><td class="line">941</td><td class="hits">688</td><td class="source">      if (returnStatement.constructor === Array)</td></tr><tr class="miss"><td class="line">942</td><td class="hits">0</td><td class="source">        parts = returnStatement;</td></tr><tr class="hit"><td class="line">943</td><td class="hits">688</td><td class="source">      if ((typeof returnStatement === 'Object') &amp;&amp; (Object.keys(returnStatement).length &gt; 0))</td></tr><tr class="miss"><td class="line">944</td><td class="hits">0</td><td class="source">        Object.keys(returnStatement).forEach(function(key) {</td></tr><tr class="miss"><td class="line">945</td><td class="hits">0</td><td class="source">          parts.push(key+' AS ' + returnStatement[key]);</td></tr><tr><td class="line">946</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">947</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">948</td><td class="hits">688</td><td class="source">    if (parts.length &gt; 0)</td></tr><tr class="miss"><td class="line">949</td><td class="hits">0</td><td class="source">      returnStatement = parts.join(', ');</td></tr><tr class="hit"><td class="line">950</td><td class="hits">688</td><td class="source">    if (distinct === true)</td></tr><tr class="miss"><td class="line">951</td><td class="hits">0</td><td class="source">      this._query_history_.push({ RETURN_DISTINCT: returnStatement });</td></tr><tr><td class="line">952</td><td class="hits"></td><td class="source">    else</td></tr><tr class="hit"><td class="line">953</td><td class="hits">688</td><td class="source">      this._query_history_.push({ RETURN: returnStatement });</td></tr><tr class="hit"><td class="line">954</td><td class="hits">688</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">955</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">956</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">957</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">958</td><td class="hits"></td><td class="source">   * `RETURN DISTINCT …`</td></tr><tr><td class="line">959</td><td class="hits"></td><td class="source">   * @param  {[type]}   returnStatement</td></tr><tr><td class="line">960</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">961</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">962</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">963</td><td class="hits">8</td><td class="source">  Graph.prototype.returnDistinct = function(returnStatement, parameters, cb) {</td></tr><tr class="miss"><td class="line">964</td><td class="hits">0</td><td class="source">    return this.return(returnStatement, parameters, cb, true);</td></tr><tr><td class="line">965</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">966</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">967</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">968</td><td class="hits"></td><td class="source">   * `DELETE …`</td></tr><tr><td class="line">969</td><td class="hits"></td><td class="source">   * @param  {string}   deleteStatement</td></tr><tr><td class="line">970</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">971</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">972</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">973</td><td class="hits">8</td><td class="source">  Graph.prototype.delete = function(deleteStatement, parameters, cb) {</td></tr><tr class="hit"><td class="line">974</td><td class="hits">2</td><td class="source">    this._query_history_.push({ DELETE: deleteStatement });</td></tr><tr class="hit"><td class="line">975</td><td class="hits">2</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">976</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">977</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">978</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">979</td><td class="hits"></td><td class="source">   * `REMOVE …`</td></tr><tr><td class="line">980</td><td class="hits"></td><td class="source">   * @param  {string}   remove</td></tr><tr><td class="line">981</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">982</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">983</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">984</td><td class="hits">8</td><td class="source">  Graph.prototype.remove = function(remove, parameters, cb) {</td></tr><tr class="hit"><td class="line">985</td><td class="hits">2</td><td class="source">    this._query_history_.push({ REMOVE: remove });</td></tr><tr class="hit"><td class="line">986</td><td class="hits">2</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">987</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">988</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">989</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">990</td><td class="hits"></td><td class="source">   * `FOR EACH …`</td></tr><tr><td class="line">991</td><td class="hits"></td><td class="source">   * @param  {[type]}   foreach</td></tr><tr><td class="line">992</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">993</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">994</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">995</td><td class="hits">8</td><td class="source">  Graph.prototype.foreach = function(foreach, parameters, cb) {</td></tr><tr class="hit"><td class="line">996</td><td class="hits">2</td><td class="source">    this._query_history_.push({ FOREACH: foreach });</td></tr><tr class="hit"><td class="line">997</td><td class="hits">2</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">998</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">999</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1000</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1001</td><td class="hits"></td><td class="source">   * `UNION …`</td></tr><tr><td class="line">1002</td><td class="hits"></td><td class="source">   * @param  {[type]}   union</td></tr><tr><td class="line">1003</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">1004</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">1005</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1006</td><td class="hits">8</td><td class="source">  Graph.prototype.union = function(union, parameters, cb) {</td></tr><tr class="miss"><td class="line">1007</td><td class="hits">0</td><td class="source">    this._query_history_.push({ UNION: union });</td></tr><tr class="miss"><td class="line">1008</td><td class="hits">0</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">1009</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1010</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1011</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1012</td><td class="hits"></td><td class="source">   * `USING …`</td></tr><tr><td class="line">1013</td><td class="hits"></td><td class="source">   * @param  {[type]}   using</td></tr><tr><td class="line">1014</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">1015</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">1016</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1017</td><td class="hits">8</td><td class="source">  Graph.prototype.using = function(using, parameters, cb) {</td></tr><tr class="miss"><td class="line">1018</td><td class="hits">0</td><td class="source">    this._query_history_.push({ USING: using });</td></tr><tr class="miss"><td class="line">1019</td><td class="hits">0</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">1020</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1021</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1022</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1023</td><td class="hits"></td><td class="source">   * Cypher-compatible-comment</td></tr><tr><td class="line">1024</td><td class="hits"></td><td class="source">   * @param  {string}   comment</td></tr><tr><td class="line">1025</td><td class="hits"></td><td class="source">   * @param  {object}   [parameters]</td></tr><tr><td class="line">1026</td><td class="hits"></td><td class="source">   * @param  {Function} [cb]</td></tr><tr><td class="line">1027</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1028</td><td class="hits">8</td><td class="source">  Graph.prototype.comment = function(comment, parameters, cb) {</td></tr><tr class="hit"><td class="line">1029</td><td class="hits">4</td><td class="source">    this.custom(' /* '+comment.replace(/^\s*\/\*\s*/,'').replace(/\s*\*\/\s*$/,'')+' */ ');</td></tr><tr class="hit"><td class="line">1030</td><td class="hits">4</td><td class="source">    return this.exec(parameters, cb);</td></tr><tr><td class="line">1031</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1032</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1033</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1034</td><td class="hits"></td><td class="source">   * Returns cypher query object</td></tr><tr><td class="line">1035</td><td class="hits"></td><td class="source">   * @return {object} Cypher query object</td></tr><tr><td class="line">1036</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1037</td><td class="hits">8</td><td class="source">  Graph.prototype.toQuery = function() {</td></tr><tr class="hit"><td class="line">1038</td><td class="hits">739</td><td class="source">    this.cypher.statements = this._query_history_;</td></tr><tr class="hit"><td class="line">1039</td><td class="hits">739</td><td class="source">    return this.cypher;</td></tr><tr><td class="line">1040</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1041</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1042</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1043</td><td class="hits"></td><td class="source">   * Return query as String</td></tr><tr><td class="line">1044</td><td class="hits"></td><td class="source">   * @return {string} query</td></tr><tr><td class="line">1045</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1046</td><td class="hits">8</td><td class="source">  Graph.prototype.toQueryString = function() {</td></tr><tr class="miss"><td class="line">1047</td><td class="hits">0</td><td class="source">    return this.toQuery().toString();</td></tr><tr><td class="line">1048</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1049</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1050</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1051</td><td class="hits"></td><td class="source">   * @see Graph.prototype.toQueryString</td></tr><tr><td class="line">1052</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1053</td><td class="hits">8</td><td class="source">  Graph.prototype.toCypherQuery = function() {</td></tr><tr class="hit"><td class="line">1054</td><td class="hits">271</td><td class="source">    return this.toQuery().toCypher();</td></tr><tr><td class="line">1055</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1056</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1057</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1058</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1059</td><td class="hits"></td><td class="source">   * Enables loading for specific types</td></tr><tr><td class="line">1060</td><td class="hits"></td><td class="source">   * Define type(s) simply in a string</td></tr><tr><td class="line">1061</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">1062</td><td class="hits"></td><td class="source">   * Examples:</td></tr><tr><td class="line">1063</td><td class="hits"></td><td class="source">   *   'node|relationship|path' or '*' to enable load for all types</td></tr><tr><td class="line">1064</td><td class="hits"></td><td class="source">   *   'node|relationship' to enable for node + relationships</td></tr><tr><td class="line">1065</td><td class="hits"></td><td class="source">   *   '' to disable for all (you can also use `disableLoading()` instead)</td></tr><tr><td class="line">1066</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">1067</td><td class="hits"></td><td class="source">   * @param  {string} classifications</td></tr><tr><td class="line">1068</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1069</td><td class="hits">8</td><td class="source">  Graph.prototype.enableLoading = function(classifications) {</td></tr><tr class="hit"><td class="line">1070</td><td class="hits">1067</td><td class="source">    if (classifications === '*')</td></tr><tr class="hit"><td class="line">1071</td><td class="hits">1066</td><td class="source">      classifications = 'node|relationship|path';</td></tr><tr class="hit"><td class="line">1072</td><td class="hits">1067</td><td class="source">    this._loadOnResult_ = classifications;</td></tr><tr class="hit"><td class="line">1073</td><td class="hits">1067</td><td class="source">    return this;</td></tr><tr><td class="line">1074</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1075</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1076</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1077</td><td class="hits"></td><td class="source">   * Disables loading on results (speeds up queries but less convenient)</td></tr><tr><td class="line">1078</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1079</td><td class="hits">8</td><td class="source">  Graph.prototype.disableLoading = function() {</td></tr><tr class="hit"><td class="line">1080</td><td class="hits">23</td><td class="source">    this._loadOnResult_ = '';</td></tr><tr class="hit"><td class="line">1081</td><td class="hits">23</td><td class="source">    return this;</td></tr><tr><td class="line">1082</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1083</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1084</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1085</td><td class="hits"></td><td class="source">   * Sort Results</td></tr><tr><td class="line">1086</td><td class="hits"></td><td class="source">   * By default we get results like:</td></tr><tr><td class="line">1087</td><td class="hits"></td><td class="source">   * `{ columns: [ 'node' ], data: [ [ { nodeObject#1 } ], … [ { nodeObject#n} ]] }`</td></tr><tr><td class="line">1088</td><td class="hits"></td><td class="source">   * To keep it more handy, we return just the data</td></tr><tr><td class="line">1089</td><td class="hits"></td><td class="source">   * and (if we have only 1 column) instead of [ {node} ] -&gt; {node}</td></tr><tr><td class="line">1090</td><td class="hits"></td><td class="source">   * If you want to have access to the columns anyway, you can get them on `graph._columns_`</td></tr><tr><td class="line">1091</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">1092</td><td class="hits"></td><td class="source">   * @param  {boolean} trueOrFalse</td></tr><tr><td class="line">1093</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1094</td><td class="hits">8</td><td class="source">  Graph.prototype.sortResult = function(trueOrFalse) {</td></tr><tr class="hit"><td class="line">1095</td><td class="hits">1088</td><td class="source">    if (typeof trueOrFalse === 'undefined')</td></tr><tr class="miss"><td class="line">1096</td><td class="hits">0</td><td class="source">      trueOrFalse = true;</td></tr><tr class="hit"><td class="line">1097</td><td class="hits">1088</td><td class="source">    this._resortResults_ = trueOrFalse;</td></tr><tr class="hit"><td class="line">1098</td><td class="hits">1088</td><td class="source">    return this;</td></tr><tr><td class="line">1099</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1100</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1101</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1102</td><td class="hits"></td><td class="source">   * Enables sorting of result</td></tr><tr><td class="line">1103</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1104</td><td class="hits">8</td><td class="source">  Graph.prototype.enableSorting = function() {</td></tr><tr class="miss"><td class="line">1105</td><td class="hits">0</td><td class="source">    return this.sortResult(true);</td></tr><tr><td class="line">1106</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1107</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1108</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1109</td><td class="hits"></td><td class="source">   * Disbales sorting of result</td></tr><tr><td class="line">1110</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1111</td><td class="hits">8</td><td class="source">  Graph.prototype.disableSorting = function() {</td></tr><tr class="hit"><td class="line">1112</td><td class="hits">1</td><td class="source">    return this.sortResult(false);</td></tr><tr><td class="line">1113</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1114</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1115</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1116</td><td class="hits"></td><td class="source">   * Enables processing of result</td></tr><tr><td class="line">1117</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1118</td><td class="hits">8</td><td class="source">  Graph.prototype.enableProcessing = function() {</td></tr><tr class="hit"><td class="line">1119</td><td class="hits">1066</td><td class="source">    this.sortResult(true);</td></tr><tr class="hit"><td class="line">1120</td><td class="hits">1066</td><td class="source">    this.enableLoading('*');</td></tr><tr class="hit"><td class="line">1121</td><td class="hits">1066</td><td class="source">    return this;</td></tr><tr><td class="line">1122</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1123</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1124</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1125</td><td class="hits"></td><td class="source">   * Disbales processing of result</td></tr><tr><td class="line">1126</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1127</td><td class="hits">8</td><td class="source">  Graph.prototype.disableProcessing = function() {</td></tr><tr class="hit"><td class="line">1128</td><td class="hits">21</td><td class="source">    this.sortResult(false);</td></tr><tr class="hit"><td class="line">1129</td><td class="hits">21</td><td class="source">    this.disableLoading();</td></tr><tr class="hit"><td class="line">1130</td><td class="hits">21</td><td class="source">    return this;</td></tr><tr><td class="line">1131</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1132</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1133</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1134</td><td class="hits"></td><td class="source">   * Will be called for logging, can be overriddin with a custom function</td></tr><tr><td class="line">1135</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1136</td><td class="hits">8</td><td class="source">  Graph.prototype.log = function(){ /* &gt; /dev/null */ };</td></tr><tr><td class="line">1137</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1138</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1139</td><td class="hits"></td><td class="source">   * Expect s.th. like [ value, value2 ] or [ { key1: value }, { key2: value } ]</td></tr><tr><td class="line">1140</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">1141</td><td class="hits"></td><td class="source">   * @param  {object|array} parameters</td></tr><tr><td class="line">1142</td><td class="hits"></td><td class="source">   * @return {object} parameters</td></tr><tr><td class="line">1143</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1144</td><td class="hits">8</td><td class="source">  Graph.prototype._addParametersToCypher = function(parameters) {</td></tr><tr class="hit"><td class="line">1145</td><td class="hits">29</td><td class="source">    if ( (typeof parameters === 'object') &amp;&amp; (parameters) &amp;&amp; (parameters.constructor === Array) ) {</td></tr><tr class="hit"><td class="line">1146</td><td class="hits">29</td><td class="source">      if (!this.cypher.hasParameters())</td></tr><tr class="hit"><td class="line">1147</td><td class="hits">28</td><td class="source">        this.cypher.parameters = {};</td></tr><tr class="hit"><td class="line">1148</td><td class="hits">29</td><td class="source">      for (var i=0; i &lt; parameters.length; i++) {</td></tr><tr class="hit"><td class="line">1149</td><td class="hits">45</td><td class="source">        this._addParameterToCypher(parameters[i]);</td></tr><tr><td class="line">1150</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">1151</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">1152</td><td class="hits">0</td><td class="source">      throw Error('You need to pass parameters as array');</td></tr><tr><td class="line">1153</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1154</td><td class="hits">29</td><td class="source">    return this.cypher.parameters;</td></tr><tr><td class="line">1155</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1156</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1157</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1158</td><td class="hits"></td><td class="source">   * Expect s.th. like 'value' or { parameterkey: 'value' }</td></tr><tr><td class="line">1159</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">1160</td><td class="hits"></td><td class="source">   * @param  {string|object} parameter</td></tr><tr><td class="line">1161</td><td class="hits"></td><td class="source">   * @return {object} parameters</td></tr><tr><td class="line">1162</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1163</td><td class="hits">8</td><td class="source">  Graph.prototype._addParameterToCypher = function(parameter) {</td></tr><tr class="hit"><td class="line">1164</td><td class="hits">378</td><td class="source">    if (!this.cypher.hasParameters())</td></tr><tr class="hit"><td class="line">1165</td><td class="hits">232</td><td class="source">      this.cypher.parameters = {};</td></tr><tr class="hit"><td class="line">1166</td><td class="hits">378</td><td class="source">    if ((typeof parameter === 'object')&amp;&amp;(parameter !== null)) {</td></tr><tr class="miss"><td class="line">1167</td><td class="hits">0</td><td class="source">      _.extend(this.cypher.parameters, parameter);</td></tr><tr><td class="line">1168</td><td class="hits"></td><td class="source">    } else {</td></tr><tr><td class="line">1169</td><td class="hits"></td><td class="source">      // we name the parameter with `_value#_`</td></tr><tr class="hit"><td class="line">1170</td><td class="hits">378</td><td class="source">      var count = Object.keys(this.cypher.parameters).length;</td></tr><tr><td class="line">1171</td><td class="hits"></td><td class="source">      // values with `undefined` will be replaced with `null` because neo4j doesn't process `undefined`</td></tr><tr class="hit"><td class="line">1172</td><td class="hits">378</td><td class="source">      this.cypher.parameters['_value'+count+'_'] = (typeof parameter === 'undefined') ? null : parameter;</td></tr><tr><td class="line">1173</td><td class="hits"></td><td class="source">      // return the placeholder</td></tr><tr class="hit"><td class="line">1174</td><td class="hits">378</td><td class="source">      return '{_value'+count+'_}';</td></tr><tr><td class="line">1175</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">1176</td><td class="hits">0</td><td class="source">    return this.cypher.parameters;</td></tr><tr><td class="line">1177</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1178</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1179</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1180</td><td class="hits"></td><td class="source">   * Add key value to parameters</td></tr><tr><td class="line">1181</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">1182</td><td class="hits"></td><td class="source">   * @param  {object} key/value object literal</td></tr><tr><td class="line">1183</td><td class="hits"></td><td class="source">   * @param  {string} [assignOperator], can be ' = ' or ' : ' for instance</td></tr><tr><td class="line">1184</td><td class="hits"></td><td class="source">   * @return {array} values</td></tr><tr><td class="line">1185</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1186</td><td class="hits">8</td><td class="source">  Graph.prototype._addKeyValuesToParameters = function(o, assignOperator) {</td></tr><tr class="hit"><td class="line">1187</td><td class="hits">244</td><td class="source">    o = helpers.flattenObject(o);</td></tr><tr class="hit"><td class="line">1188</td><td class="hits">244</td><td class="source">    var values = [];</td></tr><tr class="hit"><td class="line">1189</td><td class="hits">244</td><td class="source">    var identifierDelimiter = '`';</td></tr><tr class="hit"><td class="line">1190</td><td class="hits">244</td><td class="source">    if (typeof assignOperator !== 'string')</td></tr><tr class="miss"><td class="line">1191</td><td class="hits">0</td><td class="source">      assignOperator = ' = ';</td></tr><tr class="hit"><td class="line">1192</td><td class="hits">244</td><td class="source">    for (var attr in o) {</td></tr><tr class="hit"><td class="line">1193</td><td class="hits">326</td><td class="source">      values.push(helpers.escapeProperty(attr, identifierDelimiter) + assignOperator + this._addParameterToCypher(o[attr]));</td></tr><tr><td class="line">1194</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1195</td><td class="hits">244</td><td class="source">    return values;</td></tr><tr><td class="line">1196</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1197</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1198</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1199</td><td class="hits"></td><td class="source">   * Add object literal to parameters</td></tr><tr><td class="line">1200</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">1201</td><td class="hits"></td><td class="source">   * @param {object} objectLiteral</td></tr><tr><td class="line">1202</td><td class="hits"></td><td class="source">   * @return {string} map, e.g. `{ n.`name`: '…', …, n.`phone`: '…'  }`</td></tr><tr><td class="line">1203</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1204</td><td class="hits">8</td><td class="source">  Graph.prototype._addObjectLiteralToParameters = function(objectLiteral) {</td></tr><tr class="hit"><td class="line">1205</td><td class="hits">243</td><td class="source">    return '{ '+this._addKeyValuesToParameters(objectLiteral, ' : ').join(', ')+' }';</td></tr><tr><td class="line">1206</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1207</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1208</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1209</td><td class="hits"></td><td class="source">   * Adds object literal to query.</td></tr><tr><td class="line">1210</td><td class="hits"></td><td class="source">   * If parameters are used (default), values will be added to parameters and replaced with `{_value%n_}`</td></tr><tr><td class="line">1211</td><td class="hits"></td><td class="source">   * @private</td></tr><tr><td class="line">1212</td><td class="hits"></td><td class="source">   * @param  {object} o</td></tr><tr><td class="line">1213</td><td class="hits"></td><td class="source">   * @return {string} serialized object literal</td></tr><tr><td class="line">1214</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1215</td><td class="hits">8</td><td class="source">  Graph.prototype._addObjectLiteralForStatement = function(o) {</td></tr><tr class="hit"><td class="line">1216</td><td class="hits">237</td><td class="source">    var s = '';</td></tr><tr class="hit"><td class="line">1217</td><td class="hits">237</td><td class="source">    if (this.cypher.useParameters)</td></tr><tr class="hit"><td class="line">1218</td><td class="hits">234</td><td class="source">      s = this._addObjectLiteralToParameters(o);</td></tr><tr><td class="line">1219</td><td class="hits"></td><td class="source">    else</td></tr><tr class="hit"><td class="line">1220</td><td class="hits">3</td><td class="source">      s = helpers.serializeObjectForCypher(o);</td></tr><tr class="hit"><td class="line">1221</td><td class="hits">237</td><td class="source">    return s;</td></tr><tr><td class="line">1222</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1223</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1224</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1225</td><td class="hits"></td><td class="source">   * # Static methods</td></tr><tr><td class="line">1226</td><td class="hits"></td><td class="source">   * are aliases to methods on instanced Graph()</td></tr><tr><td class="line">1227</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">1228</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1229</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1230</td><td class="hits"></td><td class="source">   * @see Graph.prototype.query</td></tr><tr><td class="line">1231</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1232</td><td class="hits">8</td><td class="source">  Graph.query = function(cypher, parameters, cb, options) {</td></tr><tr class="hit"><td class="line">1233</td><td class="hits">17</td><td class="source">    return Graph.disableProcessing().query(cypher, parameters, cb, options);</td></tr><tr><td class="line">1234</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1235</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1236</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1237</td><td class="hits"></td><td class="source">   * @see Graph.prototype.stream</td></tr><tr><td class="line">1238</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1239</td><td class="hits">8</td><td class="source">  Graph.stream = function(cypher, parameters, cb, options) {</td></tr><tr class="hit"><td class="line">1240</td><td class="hits">2</td><td class="source">    return new Graph.disableProcessing().stream(cypher, parameters, cb, options);</td></tr><tr><td class="line">1241</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1242</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1243</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1244</td><td class="hits"></td><td class="source">   * @see Graph.prototype.wipeDatabase</td></tr><tr><td class="line">1245</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1246</td><td class="hits">8</td><td class="source">  Graph.wipeDatabase = function(cb) {</td></tr><tr class="miss"><td class="line">1247</td><td class="hits">0</td><td class="source">    return new Graph().wipeDatabase(cb);</td></tr><tr><td class="line">1248</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1249</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1250</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1251</td><td class="hits"></td><td class="source">   * @see Graph.prototype.countAllOfType</td></tr><tr><td class="line">1252</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1253</td><td class="hits">8</td><td class="source">  Graph.countAllOfType = function(type, cb) {</td></tr><tr class="miss"><td class="line">1254</td><td class="hits">0</td><td class="source">    return new Graph().countAllOfType(type, cb);</td></tr><tr><td class="line">1255</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1256</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1257</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1258</td><td class="hits"></td><td class="source">   * @see Graph.prototype.countRelationships</td></tr><tr><td class="line">1259</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1260</td><td class="hits">8</td><td class="source">  Graph.countRelationships = function(cb) {</td></tr><tr class="miss"><td class="line">1261</td><td class="hits">0</td><td class="source">    return new Graph().countRelationships(cb);</td></tr><tr><td class="line">1262</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1263</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1264</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1265</td><td class="hits"></td><td class="source">   * @see Graph.prototype.countRelations</td></tr><tr><td class="line">1266</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1267</td><td class="hits">8</td><td class="source">  Graph.countRelations = function(cb) {</td></tr><tr class="miss"><td class="line">1268</td><td class="hits">0</td><td class="source">    return new Graph().countRelationships(cb);</td></tr><tr><td class="line">1269</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1270</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1271</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1272</td><td class="hits"></td><td class="source">   * @see Graph.prototype.countNodes</td></tr><tr><td class="line">1273</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1274</td><td class="hits">8</td><td class="source">  Graph.countNodes = function(cb) {</td></tr><tr class="miss"><td class="line">1275</td><td class="hits">0</td><td class="source">    return new Graph().countNodes(cb);</td></tr><tr><td class="line">1276</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1277</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1278</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1279</td><td class="hits"></td><td class="source">   * @see Graph.prototype.countAll</td></tr><tr><td class="line">1280</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1281</td><td class="hits">8</td><td class="source">  Graph.countAll = function(cb) {</td></tr><tr class="miss"><td class="line">1282</td><td class="hits">0</td><td class="source">    return new Graph().countAll(cb);</td></tr><tr><td class="line">1283</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1284</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1285</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1286</td><td class="hits"></td><td class="source">   * @see Graph.prototype.about</td></tr><tr><td class="line">1287</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1288</td><td class="hits">8</td><td class="source">  Graph.about = function(cb) {</td></tr><tr class="miss"><td class="line">1289</td><td class="hits">0</td><td class="source">    return new Graph().about(cb);</td></tr><tr><td class="line">1290</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1291</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1292</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1293</td><td class="hits"></td><td class="source">   * @see Graph.prototype.start</td></tr><tr><td class="line">1294</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1295</td><td class="hits">8</td><td class="source">  Graph.start = function(start, parameters, cb) {</td></tr><tr class="hit"><td class="line">1296</td><td class="hits">1066</td><td class="source">    return new Graph().enableProcessing().start(start, parameters, cb);</td></tr><tr><td class="line">1297</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1298</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1299</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1300</td><td class="hits"></td><td class="source">   * @see Graph.prototype.custom</td></tr><tr><td class="line">1301</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1302</td><td class="hits">8</td><td class="source">  Graph.custom = function(statement, parameters, cb) {</td></tr><tr class="hit"><td class="line">1303</td><td class="hits">1</td><td class="source">    return Graph.start().custom(statement, parameters, cb);</td></tr><tr><td class="line">1304</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1305</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1306</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1307</td><td class="hits"></td><td class="source">   * @see Graph.prototype.match</td></tr><tr><td class="line">1308</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1309</td><td class="hits">8</td><td class="source">  Graph.match = function(statement, parameters, cb) {</td></tr><tr class="miss"><td class="line">1310</td><td class="hits">0</td><td class="source">    return Graph.start().match(statement, parameters, cb);</td></tr><tr><td class="line">1311</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1312</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1313</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1314</td><td class="hits"></td><td class="source">   * @see Graph.prototype.where</td></tr><tr><td class="line">1315</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1316</td><td class="hits">8</td><td class="source">  Graph.where = function(statement, parameters, cb) {</td></tr><tr class="miss"><td class="line">1317</td><td class="hits">0</td><td class="source">    return Graph.start().where(statement, parameters, cb);</td></tr><tr><td class="line">1318</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1319</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1320</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1321</td><td class="hits"></td><td class="source">   * @see Graph.prototype.return</td></tr><tr><td class="line">1322</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1323</td><td class="hits">8</td><td class="source">  Graph.return = function(statement, parameters, cb) {</td></tr><tr class="miss"><td class="line">1324</td><td class="hits">0</td><td class="source">    return Graph.start().return(statement, parameters, cb);</td></tr><tr><td class="line">1325</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1326</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1327</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1328</td><td class="hits"></td><td class="source">   * @see Graph.prototype.create</td></tr><tr><td class="line">1329</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1330</td><td class="hits">8</td><td class="source">  Graph.create = function(statement, parameters, cb) {</td></tr><tr class="hit"><td class="line">1331</td><td class="hits">3</td><td class="source">    return Graph.start().create(statement, parameters, cb);</td></tr><tr><td class="line">1332</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1333</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1334</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1335</td><td class="hits"></td><td class="source">   * @see Graph.prototype.enableLoading</td></tr><tr><td class="line">1336</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1337</td><td class="hits">8</td><td class="source">  Graph.enableLoading = function(classifications) {</td></tr><tr class="miss"><td class="line">1338</td><td class="hits">0</td><td class="source">    return Graph.start().enableLoading(classifications);</td></tr><tr><td class="line">1339</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1340</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1341</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1342</td><td class="hits"></td><td class="source">   * @see Graph.prototype.disableLoading</td></tr><tr><td class="line">1343</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1344</td><td class="hits">8</td><td class="source">  Graph.disableLoading = function() {</td></tr><tr class="miss"><td class="line">1345</td><td class="hits">0</td><td class="source">    return Graph.start().disableLoading();</td></tr><tr><td class="line">1346</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1347</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1348</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1349</td><td class="hits"></td><td class="source">   * @see Graph.prototype.disableProcessing</td></tr><tr><td class="line">1350</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1351</td><td class="hits">8</td><td class="source">  Graph.disableProcessing = function() {</td></tr><tr class="hit"><td class="line">1352</td><td class="hits">20</td><td class="source">    return Graph.start().disableProcessing();</td></tr><tr><td class="line">1353</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1354</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1355</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1356</td><td class="hits"></td><td class="source">   * @see Graph.prototype.enableProcessing</td></tr><tr><td class="line">1357</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1358</td><td class="hits">8</td><td class="source">  Graph.enableProcessing = function() {</td></tr><tr class="miss"><td class="line">1359</td><td class="hits">0</td><td class="source">    return Graph.start().enableProcessing();</td></tr><tr><td class="line">1360</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1361</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1362</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1363</td><td class="hits"></td><td class="source">   * @see Graph.prototype.enableSorting</td></tr><tr><td class="line">1364</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1365</td><td class="hits">8</td><td class="source">  Graph.enableSorting = function() {</td></tr><tr class="miss"><td class="line">1366</td><td class="hits">0</td><td class="source">    return Graph.start().enableSorting();</td></tr><tr><td class="line">1367</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1368</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1369</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1370</td><td class="hits"></td><td class="source">   * @see Graph.prototype.disableSorting</td></tr><tr><td class="line">1371</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1372</td><td class="hits">8</td><td class="source">  Graph.disableSorting = function() {</td></tr><tr class="miss"><td class="line">1373</td><td class="hits">0</td><td class="source">    return Graph.start().disableSorting();</td></tr><tr><td class="line">1374</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1375</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1376</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1377</td><td class="hits"></td><td class="source">   * Returns a new neo4jrestful client</td></tr><tr><td class="line">1378</td><td class="hits"></td><td class="source">   * Can be used for direct requests on neo4j for instance</td></tr><tr><td class="line">1379</td><td class="hits"></td><td class="source">   * @return {object} neo4jrestful</td></tr><tr><td class="line">1380</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1381</td><td class="hits">8</td><td class="source">  Graph.request = function() {</td></tr><tr><td class="line">1382</td><td class="hits"></td><td class="source">    // creates a new neo4jrestful client</td></tr><tr class="hit"><td class="line">1383</td><td class="hits">429</td><td class="source">    return neo4jrestful.singleton();</td></tr><tr><td class="line">1384</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1385</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1386</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">1387</td><td class="hits"></td><td class="source">   * Instanciate a new Graph object, same as `new Graph()</td></tr><tr><td class="line">1388</td><td class="hits"></td><td class="source">   * @see Graph</td></tr><tr><td class="line">1389</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">1390</td><td class="hits">8</td><td class="source">  Graph.new = function(url) {</td></tr><tr class="miss"><td class="line">1391</td><td class="hits">0</td><td class="source">    return new Graph(url);</td></tr><tr><td class="line">1392</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1393</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1394</td><td class="hits">8</td><td class="source">  return neo4jrestful.Graph = Graph;</td></tr><tr><td class="line">1395</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">1396</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1397</td><td class="hits">1</td><td class="source">if (typeof window !== 'object') {</td></tr><tr class="hit"><td class="line">1398</td><td class="hits">1</td><td class="source">  module.exports = exports = {</td></tr><tr><td class="line">1399</td><td class="hits"></td><td class="source">    init: __initGraph__</td></tr><tr><td class="line">1400</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">1401</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="miss"><td class="line">1402</td><td class="hits">0</td><td class="source">  window.Neo4jMapper.initGraph = __initGraph__;</td></tr><tr><td class="line">1403</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">1404</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/philipp/code/neo4jmapper/src/helpers.js">/Users/philipp/code/neo4jmapper/src/helpers.js</h2><div id="stats" class="high"><div class="percentage">96%</div><div class="sloc">144</div><div class="hits">139</div><div class="misses">5</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">if (typeof window === 'object') {</td></tr><tr class="miss"><td class="line">3</td><td class="hits">0</td><td class="source">  var _ = window._;</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">  var _ = require('underscore');</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var isConditionalOperator = /^\$(AND|OR|XOR|NOT|AND\$NOT|OR\$NOT)$/i;</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">var sortStringAndOptionsArguments = function(string, options) {</td></tr><tr class="hit"><td class="line">11</td><td class="hits">3</td><td class="source">  if (typeof string === 'object') {</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    return { string: null, options: string };</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">14</td><td class="hits">2</td><td class="source">  return {</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    string: string || null,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    options: options || {}</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">var sortOptionsAndCallbackArguments = function(options, callback) {</td></tr><tr class="hit"><td class="line">21</td><td class="hits">1714</td><td class="source">  if (typeof options === 'function') {</td></tr><tr class="hit"><td class="line">22</td><td class="hits">439</td><td class="source">    return { options: {}, callback: options };</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">24</td><td class="hits">1275</td><td class="source">  return {</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    options: options || {},</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    callback: callback</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">var sortStringAndCallbackArguments = function(string, callback) {</td></tr><tr class="hit"><td class="line">31</td><td class="hits">2</td><td class="source">  if (typeof string === 'function') {</td></tr><tr class="hit"><td class="line">32</td><td class="hits">1</td><td class="source">    callback = string;</td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">    string = null;</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">35</td><td class="hits">2</td><td class="source">  return {</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    callback: callback,</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    string: string</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">var getIdFromObject = function(o) {</td></tr><tr class="hit"><td class="line">42</td><td class="hits">56</td><td class="source">  if ((typeof o === 'object') &amp;&amp; (!isNaN(o._id_)))</td></tr><tr class="hit"><td class="line">43</td><td class="hits">40</td><td class="source">    return o._id_;</td></tr><tr class="hit"><td class="line">44</td><td class="hits">16</td><td class="source">  if (!isNaN(parseInt(o)))</td></tr><tr class="hit"><td class="line">45</td><td class="hits">13</td><td class="source">    return parseInt(o);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">  // else</td></tr><tr class="hit"><td class="line">47</td><td class="hits">3</td><td class="source">  return o.id || null;</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">// source: https://gist.github.com/penguinboy/762197</td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">var flattenObject = function(ob, keepNullValues) {</td></tr><tr class="hit"><td class="line">52</td><td class="hits">1123</td><td class="source">  var toReturn = {};</td></tr><tr class="hit"><td class="line">53</td><td class="hits">1123</td><td class="source">  if (typeof keepNullValues !== 'boolean')</td></tr><tr class="hit"><td class="line">54</td><td class="hits">1123</td><td class="source">    keepNullValues = true;</td></tr><tr class="hit"><td class="line">55</td><td class="hits">1123</td><td class="source">  for (var i in ob) {</td></tr><tr class="hit"><td class="line">56</td><td class="hits">1132</td><td class="source">    if (!ob.hasOwnProperty(i))</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">      continue;</td></tr><tr class="hit"><td class="line">58</td><td class="hits">1132</td><td class="source">    if ((keepNullValues) &amp;&amp; (ob[i] === null)) {</td></tr><tr class="hit"><td class="line">59</td><td class="hits">7</td><td class="source">      toReturn[i] = ob[i];</td></tr><tr class="hit"><td class="line">60</td><td class="hits">1125</td><td class="source">    } else if ((typeof ob[i]) === 'object') {</td></tr><tr class="hit"><td class="line">61</td><td class="hits">92</td><td class="source">      var flatObject = flattenObject(ob[i]);</td></tr><tr class="hit"><td class="line">62</td><td class="hits">92</td><td class="source">      for (var x in flatObject) {</td></tr><tr class="hit"><td class="line">63</td><td class="hits">100</td><td class="source">        if (!flatObject.hasOwnProperty(x)) continue;</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">65</td><td class="hits">100</td><td class="source">        toReturn[i + '.' + x] = flatObject[x];</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">68</td><td class="hits">1033</td><td class="source">      toReturn[i] = ob[i];</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">71</td><td class="hits">1123</td><td class="source">  return toReturn;</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">// source: https://github.com/hughsk/flat/blob/master/index.js</td></tr><tr class="hit"><td class="line">75</td><td class="hits">1</td><td class="source">var unflattenObject = function (target, opts) {</td></tr><tr class="hit"><td class="line">76</td><td class="hits">2104</td><td class="source">  var opts = opts || {}</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">    , delimiter = opts.delimiter || '.'</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">    , result = {}</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">80</td><td class="hits">2104</td><td class="source">  if (Object.prototype.toString.call(target) !== '[object Object]') {</td></tr><tr class="hit"><td class="line">81</td><td class="hits">1245</td><td class="source">      return target</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">84</td><td class="hits">859</td><td class="source">  function getkey(key) {</td></tr><tr class="hit"><td class="line">85</td><td class="hits">2914</td><td class="source">      var parsedKey = parseInt(key)</td></tr><tr class="hit"><td class="line">86</td><td class="hits">2914</td><td class="source">      return (isNaN(parsedKey) ? key : parsedKey)</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">89</td><td class="hits">859</td><td class="source">  Object.keys(target).forEach(function(key) {</td></tr><tr class="hit"><td class="line">90</td><td class="hits">1245</td><td class="source">      var split = key.split(delimiter)</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">        , firstNibble</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        , secondNibble</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">        , recipient = result</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">95</td><td class="hits">1245</td><td class="source">      firstNibble = getkey(split.shift())</td></tr><tr class="hit"><td class="line">96</td><td class="hits">1245</td><td class="source">      secondNibble = getkey(split[0])</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">98</td><td class="hits">1245</td><td class="source">      while (secondNibble !== undefined) {</td></tr><tr class="hit"><td class="line">99</td><td class="hits">212</td><td class="source">          if (recipient[firstNibble] === undefined) {</td></tr><tr class="hit"><td class="line">100</td><td class="hits">200</td><td class="source">              recipient[firstNibble] = ((typeof secondNibble === 'number') ? [] : {})</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">103</td><td class="hits">212</td><td class="source">          recipient = recipient[firstNibble]</td></tr><tr class="hit"><td class="line">104</td><td class="hits">212</td><td class="source">          if (split.length &gt; 0) {</td></tr><tr class="hit"><td class="line">105</td><td class="hits">212</td><td class="source">              firstNibble = getkey(split.shift())</td></tr><tr class="hit"><td class="line">106</td><td class="hits">212</td><td class="source">              secondNibble = getkey(split[0])</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">      // unflatten again for 'messy objects'</td></tr><tr class="hit"><td class="line">111</td><td class="hits">1245</td><td class="source">      recipient[firstNibble] = unflattenObject(target[key])</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">114</td><td class="hits">859</td><td class="source">  return result</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">117</td><td class="hits">1</td><td class="source">var escapeString = function(s) {</td></tr><tr class="hit"><td class="line">118</td><td class="hits">80</td><td class="source">  if (typeof s !== 'string')</td></tr><tr class="hit"><td class="line">119</td><td class="hits">1</td><td class="source">    return s;</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">  // trim quotes if exists</td></tr><tr class="hit"><td class="line">121</td><td class="hits">79</td><td class="source">  if ( (/^&quot;.+&quot;$/.test(s)) || (/^'.+'$/.test(s)) )</td></tr><tr class="hit"><td class="line">122</td><td class="hits">4</td><td class="source">    s = s.substr(1,s.length-2);</td></tr><tr class="hit"><td class="line">123</td><td class="hits">79</td><td class="source">  return s.replace(/^(['&quot;]{1})/, '\\$1').replace(/([^\\]){1}(['&quot;]{1})/g,'$1\\$2');</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">126</td><td class="hits">1</td><td class="source">var escapeProperty = function(identifier, delimiter) {</td></tr><tr class="hit"><td class="line">127</td><td class="hits">589</td><td class="source">  if (typeof delimiter !== 'string')</td></tr><tr class="hit"><td class="line">128</td><td class="hits">263</td><td class="source">    delimiter = '`';</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">  // do we have s.th. like ?! appending</td></tr><tr class="hit"><td class="line">130</td><td class="hits">589</td><td class="source">  var appending = identifier.match(/^(.*)([\?\!]{1})$/) || '';</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">  // console.log(appending)</td></tr><tr class="hit"><td class="line">132</td><td class="hits">589</td><td class="source">  if ((appending)&amp;&amp;(appending[2])) {</td></tr><tr class="hit"><td class="line">133</td><td class="hits">3</td><td class="source">    identifier = appending[1];</td></tr><tr class="hit"><td class="line">134</td><td class="hits">3</td><td class="source">    appending = appending[2];</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">  // no escaping if last char is a delimiter or ?, because we expect that the identifier is already escaped somehow</td></tr><tr class="hit"><td class="line">137</td><td class="hits">589</td><td class="source">  if (new RegExp(''+delimiter+'{1}$').test(identifier))</td></tr><tr class="hit"><td class="line">138</td><td class="hits">318</td><td class="source">    return identifier;</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">  // remove all delimiters `</td></tr><tr class="hit"><td class="line">140</td><td class="hits">271</td><td class="source">  identifier = identifier.replace(new RegExp(delimiter, 'g'), '');</td></tr><tr class="hit"><td class="line">141</td><td class="hits">271</td><td class="source">  if (/^(.+?)\..+$/.test(identifier))</td></tr><tr class="hit"><td class="line">142</td><td class="hits">222</td><td class="source">    identifier = identifier.replace(/^(.+?)\.(.+)$/, '$1.'+delimiter+'$2'+delimiter);</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">  else</td></tr><tr class="hit"><td class="line">144</td><td class="hits">49</td><td class="source">    identifier = delimiter+identifier+delimiter;</td></tr><tr class="hit"><td class="line">145</td><td class="hits">271</td><td class="source">  return identifier + appending;</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">148</td><td class="hits">1</td><td class="source">var valueToStringForCypherQuery = function(value, delimiter) {</td></tr><tr class="hit"><td class="line">149</td><td class="hits">59</td><td class="source">  if (typeof delimiter !== 'string')</td></tr><tr class="hit"><td class="line">150</td><td class="hits">42</td><td class="source">    delimiter = '';</td></tr><tr class="hit"><td class="line">151</td><td class="hits">59</td><td class="source">  if ((value) &amp;&amp; (value.constructor === RegExp)) {</td></tr><tr class="hit"><td class="line">152</td><td class="hits">19</td><td class="source">    value = value.toString().replace(/^\/(\^)*(.+?)\/[ig]*$/, (value.ignoreCase) ? '$1(?i)$2' : '$1$2');</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">    // replace `\` with `\\` to keep compatibility with Java regex</td></tr><tr class="hit"><td class="line">154</td><td class="hits">19</td><td class="source">    value = value.replace(/([^\\]{1})\\([^\\]{1})/g, '$1\\\\$2');</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">  } else {</td></tr><tr class="hit"><td class="line">156</td><td class="hits">40</td><td class="source">    if ((typeof value === 'undefined') || (value === null))</td></tr><tr class="hit"><td class="line">157</td><td class="hits">4</td><td class="source">      value = 'NULL';</td></tr><tr class="hit"><td class="line">158</td><td class="hits">36</td><td class="source">    else if (value === NaN)</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">      // what would be a good representation of NaN?</td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="source">      value = delimiter+'NaN'+delimiter;</td></tr><tr class="hit"><td class="line">161</td><td class="hits">36</td><td class="source">    else if ((typeof value === 'boolean') || (typeof value === 'number'))</td></tr><tr class="hit"><td class="line">162</td><td class="hits">22</td><td class="source">      value = String(value);</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">    else</td></tr><tr class="hit"><td class="line">164</td><td class="hits">14</td><td class="source">      value = delimiter + escapeString(value) + delimiter;</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">167</td><td class="hits">59</td><td class="source">  return value;</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">170</td><td class="hits">1</td><td class="source">var cypherKeyValueToString = function(key, originalValue, identifier, conditionalParametersObject) {</td></tr><tr class="hit"><td class="line">171</td><td class="hits">110</td><td class="source">  var value = originalValue;</td></tr><tr class="hit"><td class="line">172</td><td class="hits">110</td><td class="source">  var s = ''; // string that will be returned</td></tr><tr class="hit"><td class="line">173</td><td class="hits">110</td><td class="source">  if (typeof conditionalParametersObject !== 'object')</td></tr><tr class="hit"><td class="line">174</td><td class="hits">4</td><td class="source">    conditionalParametersObject = null;</td></tr><tr class="hit"><td class="line">175</td><td class="hits">110</td><td class="source">  if (typeof identifier === 'string') {</td></tr><tr class="hit"><td class="line">176</td><td class="hits">67</td><td class="source">    if (/^[nmr]\./.test(key))</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">      // we have already an identifier</td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="source">      key = key;</td></tr><tr class="hit"><td class="line">179</td><td class="hits">67</td><td class="source">    else if (/[\?\!]$/.test(key))</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">      // we have a default statement, escape without ! or ?</td></tr><tr class="hit"><td class="line">181</td><td class="hits">2</td><td class="source">      key = identifier+'.'+key;</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">    else</td></tr><tr class="hit"><td class="line">183</td><td class="hits">65</td><td class="source">      key = identifier+'.'+key;</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">185</td><td class="hits">110</td><td class="source">  key = escapeProperty(key)</td></tr><tr class="hit"><td class="line">186</td><td class="hits">110</td><td class="source">  if (_.isRegExp(value)) {</td></tr><tr class="hit"><td class="line">187</td><td class="hits">18</td><td class="source">    value = valueToStringForCypherQuery(value);</td></tr><tr class="hit"><td class="line">188</td><td class="hits">18</td><td class="source">    value = ((conditionalParametersObject) &amp;&amp; (conditionalParametersObject.valuesToParameters)) ? ((conditionalParametersObject.addValue) ? conditionalParametersObject.addValue(value) : value) : &quot;'&quot;+value+&quot;'&quot;;</td></tr><tr class="hit"><td class="line">189</td><td class="hits">18</td><td class="source">    s = key + &quot; =~ &quot; + value;</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">  else {</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">    // convert to string</td></tr><tr class="hit"><td class="line">193</td><td class="hits">92</td><td class="source">    if ((_.isNumber(value)) || (_.isBoolean(value)))</td></tr><tr class="hit"><td class="line">194</td><td class="hits">26</td><td class="source">      value = ((conditionalParametersObject) &amp;&amp; (conditionalParametersObject.valuesToParameters)) ? ((conditionalParametersObject.addValue) ? conditionalParametersObject.addValue(value) : value) : valueToStringForCypherQuery(value);</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">    // else escape</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">    else</td></tr><tr class="hit"><td class="line">197</td><td class="hits">66</td><td class="source">      value = ((conditionalParametersObject) &amp;&amp; (conditionalParametersObject.valuesToParameters)) ? ((conditionalParametersObject.addValue) ? conditionalParametersObject.addValue(value) : value) : &quot;'&quot;+escapeString(value)+&quot;'&quot;;</td></tr><tr class="hit"><td class="line">198</td><td class="hits">92</td><td class="source">    s = key + &quot; = &quot; + value;</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">201</td><td class="hits">110</td><td class="source">  return s;</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">204</td><td class="hits">1</td><td class="source">var extractAttributesFromCondition = function(condition, attributes) {</td></tr><tr class="hit"><td class="line">205</td><td class="hits">22</td><td class="source">  if (typeof attributes === 'undefined')</td></tr><tr class="hit"><td class="line">206</td><td class="hits">2</td><td class="source">    attributes = [];</td></tr><tr class="hit"><td class="line">207</td><td class="hits">22</td><td class="source">  _.each(condition, function(value, key) {</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">209</td><td class="hits">24</td><td class="source">    if (_.isObject(value)) {</td></tr><tr class="hit"><td class="line">210</td><td class="hits">20</td><td class="source">      extractAttributesFromCondition(condition[key], attributes);</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">212</td><td class="hits">24</td><td class="source">    if ( (!isConditionalOperator.test(key)) &amp;&amp; (/^[a-zA-Z\_\-\.]+$/.test(key)) ) {</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">      // remove identifiers if exists</td></tr><tr class="hit"><td class="line">214</td><td class="hits">7</td><td class="source">      attributes.push(key.replace(/^[nmr]{1}\./,''));</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">  });</td></tr><tr class="hit"><td class="line">217</td><td class="hits">22</td><td class="source">  return _.uniq(attributes);</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">220</td><td class="hits">1</td><td class="source">var constructorNameOfFunction = function(func) {</td></tr><tr class="hit"><td class="line">221</td><td class="hits">1275</td><td class="source">  var name = func.constructor.toString().match(/^function\s(.+?)\(/)[1];</td></tr><tr class="hit"><td class="line">222</td><td class="hits">1275</td><td class="source">  if (name === 'Function') {</td></tr><tr class="hit"><td class="line">223</td><td class="hits">43</td><td class="source">    name = func.toString().match(/^function\s(.+)\(/)[1]</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">225</td><td class="hits">1275</td><td class="source">  return name;</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">228</td><td class="hits">1</td><td class="source">var isObjectLiteral = function(data) {</td></tr><tr class="hit"><td class="line">229</td><td class="hits">3185</td><td class="source">  return Boolean((typeof data === 'object') &amp;&amp; (data !== null) &amp;&amp; (typeof Object.keys(data).length === 'number'));</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">232</td><td class="hits">1</td><td class="source">var serializeObjectForCypher = function(o, options) {</td></tr><tr class="hit"><td class="line">233</td><td class="hits">5</td><td class="source">  o = this.flattenObject(o);</td></tr><tr class="hit"><td class="line">234</td><td class="hits">5</td><td class="source">  var result = [];</td></tr><tr class="hit"><td class="line">235</td><td class="hits">5</td><td class="source">  if (typeof options !== 'object')</td></tr><tr class="hit"><td class="line">236</td><td class="hits">5</td><td class="source">    options = {};</td></tr><tr class="hit"><td class="line">237</td><td class="hits">5</td><td class="source">  options = _.defaults(options, {</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">    identifierDelimiter: '`',</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">    valueDelimiter: &quot;'&quot;,</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">  });</td></tr><tr class="hit"><td class="line">241</td><td class="hits">5</td><td class="source">  for (var attr in o) {</td></tr><tr class="hit"><td class="line">242</td><td class="hits">12</td><td class="source">    var value = o[attr];</td></tr><tr class="hit"><td class="line">243</td><td class="hits">12</td><td class="source">    result.push(escapeProperty(attr)+' : '+valueToStringForCypherQuery(value, options.valueDelimiter));</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">245</td><td class="hits">5</td><td class="source">  return '{ '+result.join(', ')+' }';</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">248</td><td class="hits">1</td><td class="source">var helpers = {</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">  sortStringAndOptionsArguments: sortStringAndOptionsArguments,</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">  sortOptionsAndCallbackArguments: sortOptionsAndCallbackArguments,</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">  sortStringAndCallbackArguments: sortStringAndCallbackArguments,</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">  flattenObject: flattenObject,</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">  unflattenObject: unflattenObject,</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">  extractAttributesFromCondition: extractAttributesFromCondition,</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">  getIdFromObject: getIdFromObject,</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">  escapeString: escapeString,</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">  escapeProperty: escapeProperty,</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">  constructorNameOfFunction: constructorNameOfFunction,</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">  cypherKeyValueToString: cypherKeyValueToString,</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">  valueToStringForCypherQuery: valueToStringForCypherQuery,</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">  md5: (typeof window === 'object') ? window.Neo4jMapper.md5 : require('./lib/md5'),</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">  isConditionalOperator: isConditionalOperator,</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">  isObjectLiteral: isObjectLiteral,</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">  serializeObjectForCypher: serializeObjectForCypher,</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">267</td><td class="hits">1</td><td class="source">if (typeof window !== 'object') {</td></tr><tr class="hit"><td class="line">268</td><td class="hits">1</td><td class="source">  module.exports = exports = helpers;</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="miss"><td class="line">270</td><td class="hits">0</td><td class="source">  window.Neo4jMapper.helpers = helpers;</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">}</td></tr></tbody></table></div><div class="file"><h2 id="/Users/philipp/code/neo4jmapper/src/index.js">/Users/philipp/code/neo4jmapper/src/index.js</h2><div id="stats" class="medium"><div class="percentage">70%</div><div class="sloc">41</div><div class="hits">29</div><div class="misses">12</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// # Neo4jMapper</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// **(c) 2013 by Philipp Ständer &lt;philipp.staender@gmail.com&gt;**</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">//</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">// *Distributed under the GNU General Public License*</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">//</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">// Neo4jMapper is an **object mapper for neo4j databases**.</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var Neo4jMapper = function Neo4jMapper(urlOrOptions) {</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">8</td><td class="source">  var _client_ = null;</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">8</td><td class="source">  if (typeof window === 'object') {</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    // Browser</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    var Neo4jRestful  = this.Neo4jRestful  = window.Neo4jMapper.initNeo4jRestful(urlOrOptions);</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">    this.client = _client_ = new Neo4jRestful();</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">    this.Graph         = window.Neo4jMapper.initGraph(_client_);</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">    this.Transaction   = window.Neo4jMapper.initTransaction(_client_, this.Graph);</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">    this.Node          = window.Neo4jMapper.initNode(_client_, this.Graph);</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">    this.Relationship  = window.Neo4jMapper.initRelationship(_client_, this.Graph, this.Node);</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">    this.Path          = window.Neo4jMapper.initPath(_client_, this.Graph);</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">    this.helpers = window.Neo4jMapper.helpers;</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">    this.helpers.ConditionalParameters = window.Neo4jMapper.ConditionalParameters;</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">    this.helpers.CypherQuery = window.Neo4jMapper.CypherQuery;</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  } else {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    // NodeJS</td></tr><tr class="hit"><td class="line">29</td><td class="hits">8</td><td class="source">    var Neo4jRestful  = this.Neo4jRestful  = require('./neo4jrestful').init(urlOrOptions);</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">31</td><td class="hits">8</td><td class="source">    this.client = _client_ = new Neo4jRestful();</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">33</td><td class="hits">8</td><td class="source">    this.Graph         = require('./graph').init(_client_);</td></tr><tr class="hit"><td class="line">34</td><td class="hits">8</td><td class="source">    this.Transaction   = require('./transaction').init(_client_);</td></tr><tr class="hit"><td class="line">35</td><td class="hits">8</td><td class="source">    this.Node          = require('./node').init(_client_, this.Graph);</td></tr><tr class="hit"><td class="line">36</td><td class="hits">8</td><td class="source">    this.Relationship  = require('./relationship').init(_client_, this.Graph, this.Node);</td></tr><tr class="hit"><td class="line">37</td><td class="hits">8</td><td class="source">    this.Path          = require('./path').init(_client_, this.Graph);</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">8</td><td class="source">    this.helpers = require('./helpers');</td></tr><tr class="hit"><td class="line">40</td><td class="hits">8</td><td class="source">    this.helpers.ConditionalParameters = require('./conditionalparameters');</td></tr><tr class="hit"><td class="line">41</td><td class="hits">8</td><td class="source">    this.helpers.CypherQuery = require('./cypherquery');</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">  // create references among the constructors themeselves</td></tr><tr class="hit"><td class="line">45</td><td class="hits">8</td><td class="source">  this.Node.Relationship          = this.Relationship;</td></tr><tr class="hit"><td class="line">46</td><td class="hits">8</td><td class="source">  this.Relationship.Node          = this.Node;</td></tr><tr class="hit"><td class="line">47</td><td class="hits">8</td><td class="source">  this.Neo4jRestful.Node          = this.Node;</td></tr><tr class="hit"><td class="line">48</td><td class="hits">8</td><td class="source">  this.Neo4jRestful.Path          = this.Path;</td></tr><tr class="hit"><td class="line">49</td><td class="hits">8</td><td class="source">  this.Neo4jRestful.Relationship  = this.Relationship;</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">Neo4jMapper.prototype.Node = null;</td></tr><tr class="hit"><td class="line">54</td><td class="hits">1</td><td class="source">Neo4jMapper.prototype.Relationship = null;</td></tr><tr class="hit"><td class="line">55</td><td class="hits">1</td><td class="source">Neo4jMapper.prototype.Graph = null;</td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">Neo4jMapper.prototype.Transaction = null;</td></tr><tr class="hit"><td class="line">57</td><td class="hits">1</td><td class="source">Neo4jMapper.prototype.Path = null;</td></tr><tr class="hit"><td class="line">58</td><td class="hits">1</td><td class="source">Neo4jMapper.prototype.Neo4jRestful = null;</td></tr><tr class="hit"><td class="line">59</td><td class="hits">1</td><td class="source">Neo4jMapper.prototype.client = null;</td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">Neo4jMapper.prototype.helpers = null;</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">62</td><td class="hits">1</td><td class="source">Neo4jMapper.init = function(urlOrOptions) {</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">  return new Neo4jMapper(urlOrOptions);</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">66</td><td class="hits">1</td><td class="source">if (typeof window !== 'object') {</td></tr><tr class="hit"><td class="line">67</td><td class="hits">1</td><td class="source">  module.exports = exports = Neo4jMapper;</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">  window.Neo4jMapper = Neo4jMapper;</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/philipp/code/neo4jmapper/src/lib/md5.js">/Users/philipp/code/neo4jmapper/src/lib/md5.js</h2><div id="stats" class="high"><div class="percentage">97%</div><div class="sloc">158</div><div class="hits">154</div><div class="misses">4</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// source: https://gist.github.com/aredo/3001685</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">var md5 = function (string) {</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">3099</td><td class="source">  function RotateLeft(lValue, iShiftBits) {</td></tr><tr class="hit"><td class="line">5</td><td class="hits">656896</td><td class="source">   return (lValue&lt;&lt;iShiftBits) | (lValue&gt;&gt;&gt;(32-iShiftBits));</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">3099</td><td class="source">  function AddUnsigned(lX,lY) {</td></tr><tr class="hit"><td class="line">9</td><td class="hits">2668640</td><td class="source">    var lX4,lY4,lX8,lY8,lResult;</td></tr><tr class="hit"><td class="line">10</td><td class="hits">2668640</td><td class="source">    lX8 = (lX &amp; 0x80000000);</td></tr><tr class="hit"><td class="line">11</td><td class="hits">2668640</td><td class="source">    lY8 = (lY &amp; 0x80000000);</td></tr><tr class="hit"><td class="line">12</td><td class="hits">2668640</td><td class="source">    lX4 = (lX &amp; 0x40000000);</td></tr><tr class="hit"><td class="line">13</td><td class="hits">2668640</td><td class="source">    lY4 = (lY &amp; 0x40000000);</td></tr><tr class="hit"><td class="line">14</td><td class="hits">2668640</td><td class="source">    lResult = (lX &amp; 0x3FFFFFFF)+(lY &amp; 0x3FFFFFFF);</td></tr><tr class="hit"><td class="line">15</td><td class="hits">2668640</td><td class="source">    if (lX4 &amp; lY4) {</td></tr><tr class="hit"><td class="line">16</td><td class="hits">703223</td><td class="source">      return (lResult ^ 0x80000000 ^ lX8 ^ lY8);</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">18</td><td class="hits">1965417</td><td class="source">    if (lX4 | lY4) {</td></tr><tr class="hit"><td class="line">19</td><td class="hits">1335004</td><td class="source">      if (lResult &amp; 0x40000000) {</td></tr><tr class="hit"><td class="line">20</td><td class="hits">689406</td><td class="source">        return (lResult ^ 0xC0000000 ^ lX8 ^ lY8);</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">22</td><td class="hits">645598</td><td class="source">        return (lResult ^ 0x40000000 ^ lX8 ^ lY8);</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">25</td><td class="hits">630413</td><td class="source">      return (lResult ^ lX8 ^ lY8);</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">29</td><td class="hits">167323</td><td class="source">  function F(x,y,z) { return (x &amp; y) | ((~x) &amp; z); }</td></tr><tr class="hit"><td class="line">30</td><td class="hits">167323</td><td class="source">  function G(x,y,z) { return (x &amp; z) | (y &amp; (~z)); }</td></tr><tr class="hit"><td class="line">31</td><td class="hits">167323</td><td class="source">  function H(x,y,z) { return (x ^ y ^ z); }</td></tr><tr class="hit"><td class="line">32</td><td class="hits">167323</td><td class="source">  function I(x,y,z) { return (y ^ (x | (~z))); }</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">34</td><td class="hits">3099</td><td class="source">  function FF(a,b,c,d,x,s,ac) {</td></tr><tr class="hit"><td class="line">35</td><td class="hits">164224</td><td class="source">    a = AddUnsigned(a, AddUnsigned(AddUnsigned(F(b, c, d), x), ac));</td></tr><tr class="hit"><td class="line">36</td><td class="hits">164224</td><td class="source">    return AddUnsigned(RotateLeft(a, s), b);</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">3099</td><td class="source">  function GG(a,b,c,d,x,s,ac) {</td></tr><tr class="hit"><td class="line">40</td><td class="hits">164224</td><td class="source">    a = AddUnsigned(a, AddUnsigned(AddUnsigned(G(b, c, d), x), ac));</td></tr><tr class="hit"><td class="line">41</td><td class="hits">164224</td><td class="source">    return AddUnsigned(RotateLeft(a, s), b);</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">3099</td><td class="source">  function HH(a,b,c,d,x,s,ac) {</td></tr><tr class="hit"><td class="line">45</td><td class="hits">164224</td><td class="source">    a = AddUnsigned(a, AddUnsigned(AddUnsigned(H(b, c, d), x), ac));</td></tr><tr class="hit"><td class="line">46</td><td class="hits">164224</td><td class="source">    return AddUnsigned(RotateLeft(a, s), b);</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">49</td><td class="hits">3099</td><td class="source">  function II(a,b,c,d,x,s,ac) {</td></tr><tr class="hit"><td class="line">50</td><td class="hits">164224</td><td class="source">    a = AddUnsigned(a, AddUnsigned(AddUnsigned(I(b, c, d), x), ac));</td></tr><tr class="hit"><td class="line">51</td><td class="hits">164224</td><td class="source">    return AddUnsigned(RotateLeft(a, s), b);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">54</td><td class="hits">3099</td><td class="source">  function ConvertToWordArray(string) {</td></tr><tr class="hit"><td class="line">55</td><td class="hits">3099</td><td class="source">    var lWordCount;</td></tr><tr class="hit"><td class="line">56</td><td class="hits">3099</td><td class="source">    var lMessageLength = string.length;</td></tr><tr class="hit"><td class="line">57</td><td class="hits">3099</td><td class="source">    var lNumberOfWords_temp1=lMessageLength + 8;</td></tr><tr class="hit"><td class="line">58</td><td class="hits">3099</td><td class="source">    var lNumberOfWords_temp2=(lNumberOfWords_temp1-(lNumberOfWords_temp1 % 64))/64;</td></tr><tr class="hit"><td class="line">59</td><td class="hits">3099</td><td class="source">    var lNumberOfWords = (lNumberOfWords_temp2+1)*16;</td></tr><tr class="hit"><td class="line">60</td><td class="hits">3099</td><td class="source">    var lWordArray=Array(lNumberOfWords-1);</td></tr><tr class="hit"><td class="line">61</td><td class="hits">3099</td><td class="source">    var lBytePosition = 0;</td></tr><tr class="hit"><td class="line">62</td><td class="hits">3099</td><td class="source">    var lByteCount = 0;</td></tr><tr class="hit"><td class="line">63</td><td class="hits">3099</td><td class="source">    while ( lByteCount &lt; lMessageLength ) {</td></tr><tr class="hit"><td class="line">64</td><td class="hits">527907</td><td class="source">      lWordCount = (lByteCount-(lByteCount % 4))/4;</td></tr><tr class="hit"><td class="line">65</td><td class="hits">527907</td><td class="source">      lBytePosition = (lByteCount % 4)*8;</td></tr><tr class="hit"><td class="line">66</td><td class="hits">527907</td><td class="source">      lWordArray[lWordCount] = (lWordArray[lWordCount] | (string.charCodeAt(lByteCount)&lt;&lt;lBytePosition));</td></tr><tr class="hit"><td class="line">67</td><td class="hits">527907</td><td class="source">      lByteCount++;</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">69</td><td class="hits">3099</td><td class="source">    lWordCount = (lByteCount-(lByteCount % 4))/4;</td></tr><tr class="hit"><td class="line">70</td><td class="hits">3099</td><td class="source">    lBytePosition = (lByteCount % 4)*8;</td></tr><tr class="hit"><td class="line">71</td><td class="hits">3099</td><td class="source">    lWordArray[lWordCount] = lWordArray[lWordCount] | (0x80&lt;&lt;lBytePosition);</td></tr><tr class="hit"><td class="line">72</td><td class="hits">3099</td><td class="source">    lWordArray[lNumberOfWords-2] = lMessageLength&lt;&lt;3;</td></tr><tr class="hit"><td class="line">73</td><td class="hits">3099</td><td class="source">    lWordArray[lNumberOfWords-1] = lMessageLength&gt;&gt;&gt;29;</td></tr><tr class="hit"><td class="line">74</td><td class="hits">3099</td><td class="source">    return lWordArray;</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">77</td><td class="hits">3099</td><td class="source">  function WordToHex(lValue) {</td></tr><tr class="hit"><td class="line">78</td><td class="hits">12396</td><td class="source">    var WordToHexValue=&quot;&quot;,WordToHexValue_temp=&quot;&quot;,lByte,lCount;</td></tr><tr class="hit"><td class="line">79</td><td class="hits">12396</td><td class="source">    for (lCount = 0;lCount&lt;=3;lCount++) {</td></tr><tr class="hit"><td class="line">80</td><td class="hits">49584</td><td class="source">      lByte = (lValue&gt;&gt;&gt;(lCount*8)) &amp; 255;</td></tr><tr class="hit"><td class="line">81</td><td class="hits">49584</td><td class="source">      WordToHexValue_temp = &quot;0&quot; + lByte.toString(16);</td></tr><tr class="hit"><td class="line">82</td><td class="hits">49584</td><td class="source">      WordToHexValue = WordToHexValue + WordToHexValue_temp.substr(WordToHexValue_temp.length-2,2);</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">84</td><td class="hits">12396</td><td class="source">    return WordToHexValue;</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">87</td><td class="hits">3099</td><td class="source">  function Utf8Encode(string) {</td></tr><tr class="hit"><td class="line">88</td><td class="hits">3099</td><td class="source">    string = string.replace(/\r\n/g,&quot;\n&quot;);</td></tr><tr class="hit"><td class="line">89</td><td class="hits">3099</td><td class="source">    var utftext = &quot;&quot;;</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">91</td><td class="hits">3099</td><td class="source">    for (var n = 0; n &lt; string.length; n++) {</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">93</td><td class="hits">527906</td><td class="source">      var c = string.charCodeAt(n);</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">95</td><td class="hits">527906</td><td class="source">      if (c &lt; 128) {</td></tr><tr class="hit"><td class="line">96</td><td class="hits">527905</td><td class="source">        utftext += String.fromCharCode(c);</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">98</td><td class="hits">1</td><td class="source">      else if((c &gt; 127) &amp;&amp; (c &lt; 2048)) {</td></tr><tr class="hit"><td class="line">99</td><td class="hits">1</td><td class="source">        utftext += String.fromCharCode((c &gt;&gt; 6) | 192);</td></tr><tr class="hit"><td class="line">100</td><td class="hits">1</td><td class="source">        utftext += String.fromCharCode((c &amp; 63) | 128);</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">      else {</td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">        utftext += String.fromCharCode((c &gt;&gt; 12) | 224);</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">        utftext += String.fromCharCode(((c &gt;&gt; 6) &amp; 63) | 128);</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">        utftext += String.fromCharCode((c &amp; 63) | 128);</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">110</td><td class="hits">3099</td><td class="source">    return utftext;</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">113</td><td class="hits">3099</td><td class="source">  var x=Array();</td></tr><tr class="hit"><td class="line">114</td><td class="hits">3099</td><td class="source">  var k,AA,BB,CC,DD,a,b,c,d;</td></tr><tr class="hit"><td class="line">115</td><td class="hits">3099</td><td class="source">  var S11=7, S12=12, S13=17, S14=22;</td></tr><tr class="hit"><td class="line">116</td><td class="hits">3099</td><td class="source">  var S21=5, S22=9 , S23=14, S24=20;</td></tr><tr class="hit"><td class="line">117</td><td class="hits">3099</td><td class="source">  var S31=4, S32=11, S33=16, S34=23;</td></tr><tr class="hit"><td class="line">118</td><td class="hits">3099</td><td class="source">  var S41=6, S42=10, S43=15, S44=21;</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">120</td><td class="hits">3099</td><td class="source">  string = Utf8Encode(string);</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">122</td><td class="hits">3099</td><td class="source">  x = ConvertToWordArray(string);</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">124</td><td class="hits">12396</td><td class="source">  a = 0x67452301; b = 0xEFCDAB89; c = 0x98BADCFE; d = 0x10325476;</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">126</td><td class="hits">3099</td><td class="source">  for (k=0;k&lt;x.length;k+=16) {</td></tr><tr class="hit"><td class="line">127</td><td class="hits">41056</td><td class="source">    AA=a; BB=b; CC=c; DD=d;</td></tr><tr class="hit"><td class="line">128</td><td class="hits">10264</td><td class="source">    a=FF(a,b,c,d,x[k+0], S11,0xD76AA478);</td></tr><tr class="hit"><td class="line">129</td><td class="hits">10264</td><td class="source">    d=FF(d,a,b,c,x[k+1], S12,0xE8C7B756);</td></tr><tr class="hit"><td class="line">130</td><td class="hits">10264</td><td class="source">    c=FF(c,d,a,b,x[k+2], S13,0x242070DB);</td></tr><tr class="hit"><td class="line">131</td><td class="hits">10264</td><td class="source">    b=FF(b,c,d,a,x[k+3], S14,0xC1BDCEEE);</td></tr><tr class="hit"><td class="line">132</td><td class="hits">10264</td><td class="source">    a=FF(a,b,c,d,x[k+4], S11,0xF57C0FAF);</td></tr><tr class="hit"><td class="line">133</td><td class="hits">10264</td><td class="source">    d=FF(d,a,b,c,x[k+5], S12,0x4787C62A);</td></tr><tr class="hit"><td class="line">134</td><td class="hits">10264</td><td class="source">    c=FF(c,d,a,b,x[k+6], S13,0xA8304613);</td></tr><tr class="hit"><td class="line">135</td><td class="hits">10264</td><td class="source">    b=FF(b,c,d,a,x[k+7], S14,0xFD469501);</td></tr><tr class="hit"><td class="line">136</td><td class="hits">10264</td><td class="source">    a=FF(a,b,c,d,x[k+8], S11,0x698098D8);</td></tr><tr class="hit"><td class="line">137</td><td class="hits">10264</td><td class="source">    d=FF(d,a,b,c,x[k+9], S12,0x8B44F7AF);</td></tr><tr class="hit"><td class="line">138</td><td class="hits">10264</td><td class="source">    c=FF(c,d,a,b,x[k+10],S13,0xFFFF5BB1);</td></tr><tr class="hit"><td class="line">139</td><td class="hits">10264</td><td class="source">    b=FF(b,c,d,a,x[k+11],S14,0x895CD7BE);</td></tr><tr class="hit"><td class="line">140</td><td class="hits">10264</td><td class="source">    a=FF(a,b,c,d,x[k+12],S11,0x6B901122);</td></tr><tr class="hit"><td class="line">141</td><td class="hits">10264</td><td class="source">    d=FF(d,a,b,c,x[k+13],S12,0xFD987193);</td></tr><tr class="hit"><td class="line">142</td><td class="hits">10264</td><td class="source">    c=FF(c,d,a,b,x[k+14],S13,0xA679438E);</td></tr><tr class="hit"><td class="line">143</td><td class="hits">10264</td><td class="source">    b=FF(b,c,d,a,x[k+15],S14,0x49B40821);</td></tr><tr class="hit"><td class="line">144</td><td class="hits">10264</td><td class="source">    a=GG(a,b,c,d,x[k+1], S21,0xF61E2562);</td></tr><tr class="hit"><td class="line">145</td><td class="hits">10264</td><td class="source">    d=GG(d,a,b,c,x[k+6], S22,0xC040B340);</td></tr><tr class="hit"><td class="line">146</td><td class="hits">10264</td><td class="source">    c=GG(c,d,a,b,x[k+11],S23,0x265E5A51);</td></tr><tr class="hit"><td class="line">147</td><td class="hits">10264</td><td class="source">    b=GG(b,c,d,a,x[k+0], S24,0xE9B6C7AA);</td></tr><tr class="hit"><td class="line">148</td><td class="hits">10264</td><td class="source">    a=GG(a,b,c,d,x[k+5], S21,0xD62F105D);</td></tr><tr class="hit"><td class="line">149</td><td class="hits">10264</td><td class="source">    d=GG(d,a,b,c,x[k+10],S22,0x2441453);</td></tr><tr class="hit"><td class="line">150</td><td class="hits">10264</td><td class="source">    c=GG(c,d,a,b,x[k+15],S23,0xD8A1E681);</td></tr><tr class="hit"><td class="line">151</td><td class="hits">10264</td><td class="source">    b=GG(b,c,d,a,x[k+4], S24,0xE7D3FBC8);</td></tr><tr class="hit"><td class="line">152</td><td class="hits">10264</td><td class="source">    a=GG(a,b,c,d,x[k+9], S21,0x21E1CDE6);</td></tr><tr class="hit"><td class="line">153</td><td class="hits">10264</td><td class="source">    d=GG(d,a,b,c,x[k+14],S22,0xC33707D6);</td></tr><tr class="hit"><td class="line">154</td><td class="hits">10264</td><td class="source">    c=GG(c,d,a,b,x[k+3], S23,0xF4D50D87);</td></tr><tr class="hit"><td class="line">155</td><td class="hits">10264</td><td class="source">    b=GG(b,c,d,a,x[k+8], S24,0x455A14ED);</td></tr><tr class="hit"><td class="line">156</td><td class="hits">10264</td><td class="source">    a=GG(a,b,c,d,x[k+13],S21,0xA9E3E905);</td></tr><tr class="hit"><td class="line">157</td><td class="hits">10264</td><td class="source">    d=GG(d,a,b,c,x[k+2], S22,0xFCEFA3F8);</td></tr><tr class="hit"><td class="line">158</td><td class="hits">10264</td><td class="source">    c=GG(c,d,a,b,x[k+7], S23,0x676F02D9);</td></tr><tr class="hit"><td class="line">159</td><td class="hits">10264</td><td class="source">    b=GG(b,c,d,a,x[k+12],S24,0x8D2A4C8A);</td></tr><tr class="hit"><td class="line">160</td><td class="hits">10264</td><td class="source">    a=HH(a,b,c,d,x[k+5], S31,0xFFFA3942);</td></tr><tr class="hit"><td class="line">161</td><td class="hits">10264</td><td class="source">    d=HH(d,a,b,c,x[k+8], S32,0x8771F681);</td></tr><tr class="hit"><td class="line">162</td><td class="hits">10264</td><td class="source">    c=HH(c,d,a,b,x[k+11],S33,0x6D9D6122);</td></tr><tr class="hit"><td class="line">163</td><td class="hits">10264</td><td class="source">    b=HH(b,c,d,a,x[k+14],S34,0xFDE5380C);</td></tr><tr class="hit"><td class="line">164</td><td class="hits">10264</td><td class="source">    a=HH(a,b,c,d,x[k+1], S31,0xA4BEEA44);</td></tr><tr class="hit"><td class="line">165</td><td class="hits">10264</td><td class="source">    d=HH(d,a,b,c,x[k+4], S32,0x4BDECFA9);</td></tr><tr class="hit"><td class="line">166</td><td class="hits">10264</td><td class="source">    c=HH(c,d,a,b,x[k+7], S33,0xF6BB4B60);</td></tr><tr class="hit"><td class="line">167</td><td class="hits">10264</td><td class="source">    b=HH(b,c,d,a,x[k+10],S34,0xBEBFBC70);</td></tr><tr class="hit"><td class="line">168</td><td class="hits">10264</td><td class="source">    a=HH(a,b,c,d,x[k+13],S31,0x289B7EC6);</td></tr><tr class="hit"><td class="line">169</td><td class="hits">10264</td><td class="source">    d=HH(d,a,b,c,x[k+0], S32,0xEAA127FA);</td></tr><tr class="hit"><td class="line">170</td><td class="hits">10264</td><td class="source">    c=HH(c,d,a,b,x[k+3], S33,0xD4EF3085);</td></tr><tr class="hit"><td class="line">171</td><td class="hits">10264</td><td class="source">    b=HH(b,c,d,a,x[k+6], S34,0x4881D05);</td></tr><tr class="hit"><td class="line">172</td><td class="hits">10264</td><td class="source">    a=HH(a,b,c,d,x[k+9], S31,0xD9D4D039);</td></tr><tr class="hit"><td class="line">173</td><td class="hits">10264</td><td class="source">    d=HH(d,a,b,c,x[k+12],S32,0xE6DB99E5);</td></tr><tr class="hit"><td class="line">174</td><td class="hits">10264</td><td class="source">    c=HH(c,d,a,b,x[k+15],S33,0x1FA27CF8);</td></tr><tr class="hit"><td class="line">175</td><td class="hits">10264</td><td class="source">    b=HH(b,c,d,a,x[k+2], S34,0xC4AC5665);</td></tr><tr class="hit"><td class="line">176</td><td class="hits">10264</td><td class="source">    a=II(a,b,c,d,x[k+0], S41,0xF4292244);</td></tr><tr class="hit"><td class="line">177</td><td class="hits">10264</td><td class="source">    d=II(d,a,b,c,x[k+7], S42,0x432AFF97);</td></tr><tr class="hit"><td class="line">178</td><td class="hits">10264</td><td class="source">    c=II(c,d,a,b,x[k+14],S43,0xAB9423A7);</td></tr><tr class="hit"><td class="line">179</td><td class="hits">10264</td><td class="source">    b=II(b,c,d,a,x[k+5], S44,0xFC93A039);</td></tr><tr class="hit"><td class="line">180</td><td class="hits">10264</td><td class="source">    a=II(a,b,c,d,x[k+12],S41,0x655B59C3);</td></tr><tr class="hit"><td class="line">181</td><td class="hits">10264</td><td class="source">    d=II(d,a,b,c,x[k+3], S42,0x8F0CCC92);</td></tr><tr class="hit"><td class="line">182</td><td class="hits">10264</td><td class="source">    c=II(c,d,a,b,x[k+10],S43,0xFFEFF47D);</td></tr><tr class="hit"><td class="line">183</td><td class="hits">10264</td><td class="source">    b=II(b,c,d,a,x[k+1], S44,0x85845DD1);</td></tr><tr class="hit"><td class="line">184</td><td class="hits">10264</td><td class="source">    a=II(a,b,c,d,x[k+8], S41,0x6FA87E4F);</td></tr><tr class="hit"><td class="line">185</td><td class="hits">10264</td><td class="source">    d=II(d,a,b,c,x[k+15],S42,0xFE2CE6E0);</td></tr><tr class="hit"><td class="line">186</td><td class="hits">10264</td><td class="source">    c=II(c,d,a,b,x[k+6], S43,0xA3014314);</td></tr><tr class="hit"><td class="line">187</td><td class="hits">10264</td><td class="source">    b=II(b,c,d,a,x[k+13],S44,0x4E0811A1);</td></tr><tr class="hit"><td class="line">188</td><td class="hits">10264</td><td class="source">    a=II(a,b,c,d,x[k+4], S41,0xF7537E82);</td></tr><tr class="hit"><td class="line">189</td><td class="hits">10264</td><td class="source">    d=II(d,a,b,c,x[k+11],S42,0xBD3AF235);</td></tr><tr class="hit"><td class="line">190</td><td class="hits">10264</td><td class="source">    c=II(c,d,a,b,x[k+2], S43,0x2AD7D2BB);</td></tr><tr class="hit"><td class="line">191</td><td class="hits">10264</td><td class="source">    b=II(b,c,d,a,x[k+9], S44,0xEB86D391);</td></tr><tr class="hit"><td class="line">192</td><td class="hits">10264</td><td class="source">    a=AddUnsigned(a,AA);</td></tr><tr class="hit"><td class="line">193</td><td class="hits">10264</td><td class="source">    b=AddUnsigned(b,BB);</td></tr><tr class="hit"><td class="line">194</td><td class="hits">10264</td><td class="source">    c=AddUnsigned(c,CC);</td></tr><tr class="hit"><td class="line">195</td><td class="hits">10264</td><td class="source">    d=AddUnsigned(d,DD);</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">198</td><td class="hits">3099</td><td class="source">  var temp = WordToHex(a)+WordToHex(b)+WordToHex(c)+WordToHex(d);</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">200</td><td class="hits">3099</td><td class="source">  return temp.toLowerCase();</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">203</td><td class="hits">1</td><td class="source">if (typeof window === 'object') {</td></tr><tr class="miss"><td class="line">204</td><td class="hits">0</td><td class="source">  window.Neo4jMapper.md5 = md5;</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="hit"><td class="line">206</td><td class="hits">1</td><td class="source">  module.exports = exports = md5;</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">}</td></tr></tbody></table></div><div class="file"><h2 id="/Users/philipp/code/neo4jmapper/src/lib/sequence.js">/Users/philipp/code/neo4jmapper/src/lib/sequence.js</h2><div id="stats" class="terrible"><div class="percentage">24%</div><div class="sloc">33</div><div class="hits">8</div><div class="misses">25</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// from: https://github.com/coolaj86/futures</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">;(function() {</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  function isSequence(obj) {</td></tr><tr class="miss"><td class="line">5</td><td class="hits">0</td><td class="source">    return obj instanceof Sequence;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  function Sequence(global_context) {</td></tr><tr class="miss"><td class="line">9</td><td class="hits">0</td><td class="source">    var self = this,</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">      waiting = true,</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">      data,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">      stack = [];</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    if (!isSequence(this)) {</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">      return new Sequence(global_context);</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">    global_context = global_context || null;</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">    function next() {</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">      var args = Array.prototype.slice.call(arguments),</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        seq = stack.shift(); // BUG this will eventually leak</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">      data = arguments;</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">      if (!seq) {</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        // the chain has ended (for now)</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">        waiting = true;</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">        return;</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">      args.unshift(next);</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">      seq.callback.apply(seq._context, args);</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">    function then(callback, context) {</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">      if ('function' !== typeof callback) {</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">        throw new Error(&quot;`Sequence().then(callback [context])` requires that `callback` be a function and that `context` be `null`, an object, or a function&quot;);</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">      stack.push({</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        callback: callback,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        _context: (null === context ? null : context || global_context),</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        index: stack.length</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">      // if the chain has stopped, start it back up</td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">      if (waiting) {</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">        waiting = false;</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">        next.apply(null, data);</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">      return self;</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">    self.next = next;</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">    self.then = then;</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">59</td><td class="hits">1</td><td class="source">  function createSequence(context) {</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">    // TODO use prototype instead of new</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">    return (new Sequence(context));</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">63</td><td class="hits">1</td><td class="source">  Sequence.create = createSequence;</td></tr><tr class="hit"><td class="line">64</td><td class="hits">1</td><td class="source">  Sequence.isSequence = isSequence;</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">66</td><td class="hits">1</td><td class="source">  if (typeof window === 'object')</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">    window.Sequence = Sequence;</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">  else</td></tr><tr class="hit"><td class="line">69</td><td class="hits">1</td><td class="source">    module.exports = Sequence;</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">})();</td></tr></tbody></table></div><div class="file"><h2 id="/Users/philipp/code/neo4jmapper/src/neo4jrestful.js">/Users/philipp/code/neo4jmapper/src/neo4jrestful.js</h2><div id="stats" class="high"><div class="percentage">82%</div><div class="sloc">360</div><div class="hits">297</div><div class="misses">63</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">var __initNeo4jRestful__ = function(urlOrOptions) {</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">  // will be set with environment depending values below</td></tr><tr class="hit"><td class="line">5</td><td class="hits">8</td><td class="source">  var helpers                    = null;</td></tr><tr class="hit"><td class="line">6</td><td class="hits">8</td><td class="source">  var _                          = null;</td></tr><tr class="hit"><td class="line">7</td><td class="hits">8</td><td class="source">  var jQuery                     = null;</td></tr><tr class="hit"><td class="line">8</td><td class="hits">8</td><td class="source">  var Sequence                   = null;</td></tr><tr class="hit"><td class="line">9</td><td class="hits">8</td><td class="source">  var JSONStream                 = null;</td></tr><tr class="hit"><td class="line">10</td><td class="hits">8</td><td class="source">  var request                    = null;</td></tr><tr class="hit"><td class="line">11</td><td class="hits">8</td><td class="source">  var __established_connection__ = {};    // a flag of all different db connections (differs by url)</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">8</td><td class="source">  if (typeof window === 'object') {</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    // browser</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    helpers      = window.Neo4jMapper.helpers;</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">    _            = window._;</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">    jQuery       = window.jQuery;</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">    Sequence     = window.Sequence;</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">    request      = window.superagent;</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">  } else {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    // nodejs</td></tr><tr class="hit"><td class="line">22</td><td class="hits">8</td><td class="source">    helpers      = require('./helpers');</td></tr><tr class="hit"><td class="line">23</td><td class="hits">8</td><td class="source">    _            = require('underscore');</td></tr><tr class="hit"><td class="line">24</td><td class="hits">8</td><td class="source">    jQuery       = null;</td></tr><tr class="hit"><td class="line">25</td><td class="hits">8</td><td class="source">    Sequence     = require('./lib/sequence');</td></tr><tr class="hit"><td class="line">26</td><td class="hits">8</td><td class="source">    request      = require('request');</td></tr><tr class="hit"><td class="line">27</td><td class="hits">8</td><td class="source">    JSONStream   = require('JSONStream');</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">8</td><td class="source">  var ResponseError = function ResponseError(message, code) {</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">    var e = new Error(message);</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">    e.code = code;</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">    return e;</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">36</td><td class="hits">8</td><td class="source">  ResponseError.prototype.code = 0;</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">  // Base for QueryError and CypherQueryError</td></tr><tr class="hit"><td class="line">39</td><td class="hits">8</td><td class="source">  var CustomError = function CustomError(message) {</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">    if (typeof message === 'string')</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">      this.message = message;</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">8</td><td class="source">  CustomError.prototype.message = '';</td></tr><tr class="hit"><td class="line">45</td><td class="hits">8</td><td class="source">  CustomError.prototype.name = '';</td></tr><tr class="hit"><td class="line">46</td><td class="hits">8</td><td class="source">  CustomError.prototype.exception = null;</td></tr><tr class="hit"><td class="line">47</td><td class="hits">8</td><td class="source">  CustomError.prototype.cypher = null;</td></tr><tr class="hit"><td class="line">48</td><td class="hits">8</td><td class="source">  CustomError.prototype.stacktrace = null;</td></tr><tr class="hit"><td class="line">49</td><td class="hits">8</td><td class="source">  CustomError.prototype.statusCode = null;</td></tr><tr class="hit"><td class="line">50</td><td class="hits">8</td><td class="source">  CustomError.prototype.method = null;</td></tr><tr class="hit"><td class="line">51</td><td class="hits">8</td><td class="source">  CustomError.prototype.url = null;</td></tr><tr class="hit"><td class="line">52</td><td class="hits">8</td><td class="source">  CustomError.prototype.data = null;</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">  // will be used to debug request+response</td></tr><tr class="hit"><td class="line">55</td><td class="hits">8</td><td class="source">  var RequestDebug = function RequestDebug(obj) {</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    // apply given data to current object</td></tr><tr class="hit"><td class="line">57</td><td class="hits">1057</td><td class="source">    if ((typeof obj === 'object') &amp;&amp; (obj))</td></tr><tr class="hit"><td class="line">58</td><td class="hits">1057</td><td class="source">      for (var key in obj)</td></tr><tr class="hit"><td class="line">59</td><td class="hits">8456</td><td class="source">        this[key] = obj[key];</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">62</td><td class="hits">8</td><td class="source">  RequestDebug.prototype.options        = null;</td></tr><tr class="hit"><td class="line">63</td><td class="hits">8</td><td class="source">  RequestDebug.prototype.requested_url  = '';</td></tr><tr class="hit"><td class="line">64</td><td class="hits">8</td><td class="source">  RequestDebug.prototype.method         = '';</td></tr><tr class="hit"><td class="line">65</td><td class="hits">8</td><td class="source">  RequestDebug.prototype.header         = null;</td></tr><tr class="hit"><td class="line">66</td><td class="hits">8</td><td class="source">  RequestDebug.prototype.res            = null;</td></tr><tr class="hit"><td class="line">67</td><td class="hits">8</td><td class="source">  RequestDebug.prototype.status         = null;</td></tr><tr class="hit"><td class="line">68</td><td class="hits">8</td><td class="source">  RequestDebug.prototype.err            = null;</td></tr><tr class="hit"><td class="line">69</td><td class="hits">8</td><td class="source">  RequestDebug.prototype.responseTime   = null;</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">71</td><td class="hits">8</td><td class="source">  var QueryError = function(message, options, name) {</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">    var error = new CustomError(message);</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">    error.name = (typeof name === 'string') ? name : &quot;QueryError&quot;;</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">    if (typeof options === 'object') {</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">      error = _.extend(error, options);</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">79</td><td class="hits">8</td><td class="source">  var CypherQueryError = function(message, options) {</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">    var error = QueryError(message, options, 'CypherQueryError');</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">    return _.extend(this, error);</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">  /*</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">   * Constructor</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">87</td><td class="hits">8</td><td class="source">  var Neo4jRestful = function Neo4jRestful(url, options) {</td></tr><tr class="hit"><td class="line">88</td><td class="hits">453</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">89</td><td class="hits">453</td><td class="source">    var urlPattern = /^(http(s)*)\:\/\/((.+?)\:(.+?)\@)*(.+?)(\:([0-9]+)?)\/(.+)*$/i;</td></tr><tr class="hit"><td class="line">90</td><td class="hits">453</td><td class="source">    var urlMatches = null;</td></tr><tr class="hit"><td class="line">91</td><td class="hits">453</td><td class="source">    if (typeof url === 'undefined') {</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">      // use global</td></tr><tr class="hit"><td class="line">93</td><td class="hits">8</td><td class="source">      url = urlOrOptions;</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">95</td><td class="hits">453</td><td class="source">    if (typeof options !== 'object') {</td></tr><tr class="hit"><td class="line">96</td><td class="hits">453</td><td class="source">      options = (typeof url === 'object') ? url : {};</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">98</td><td class="hits">453</td><td class="source">    if (typeof url === 'string') {</td></tr><tr class="hit"><td class="line">99</td><td class="hits">448</td><td class="source">      options.url = url;</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">101</td><td class="hits">453</td><td class="source">    if (typeof options.url === 'string') {</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">      // check url</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">      // ensure one trailing slash</td></tr><tr class="hit"><td class="line">104</td><td class="hits">453</td><td class="source">      options.url = options.url.replace(/\/*$/, '/');</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">      // stop here if we don't have a valid url</td></tr><tr class="hit"><td class="line">106</td><td class="hits">453</td><td class="source">      if (!urlPattern.test(options.url)) {</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">        var message = &quot;Your URL (&quot;+url+&quot;) needs to match the default url pattern 'http(s)://(username:password@)domain(:port)/(endpoint)…'&quot;;</td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">        throw Error(message);</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">      // extract all parts from the given url</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">      // TODO: use extractet Options</td></tr><tr class="hit"><td class="line">112</td><td class="hits">453</td><td class="source">      urlMatches = options.url.match(urlPattern);</td></tr><tr class="hit"><td class="line">113</td><td class="hits">453</td><td class="source">      this.urlOptions = _.defaults({</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">        'protocol': urlMatches[1],</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">        'user': urlMatches[4],</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">        'password': urlMatches[5],</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">        'domain': urlMatches[6],</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">        'port': urlMatches[8],</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">        'endpoint': urlMatches[9]</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">      }, this.urlOptions);</td></tr><tr class="hit"><td class="line">121</td><td class="hits">453</td><td class="source">      if (this.urlOptions.endpoint) {</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        // strip preceding slash(es)</td></tr><tr class="hit"><td class="line">123</td><td class="hits">453</td><td class="source">        this.urlOptions.endpoint = this.urlOptions.endpoint.replace(/^\/+/, '');</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="source">      throw Error('No url found. Argument must be either an URL as string or an option object including an `.url` property.');</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">    // we may have an error handler in options, if so, assign it to this object</td></tr><tr class="hit"><td class="line">130</td><td class="hits">453</td><td class="source">    if (typeof options.onConnectionError === 'function') {</td></tr><tr class="hit"><td class="line">131</td><td class="hits">4</td><td class="source">      this.onConnectionError = options.onConnectionError;</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">    // copy header</td></tr><tr class="hit"><td class="line">135</td><td class="hits">453</td><td class="source">    self.header = _.extend({}, Neo4jRestful.prototype.header);</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">137</td><td class="hits">453</td><td class="source">    if (!__established_connection__[this.absoluteUrl('/')])</td></tr><tr class="hit"><td class="line">138</td><td class="hits">8</td><td class="source">      self.checkAvailability();</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">141</td><td class="hits">8</td><td class="source">  Neo4jRestful.RequestDebug = RequestDebug;</td></tr><tr class="hit"><td class="line">142</td><td class="hits">8</td><td class="source">  Neo4jRestful.CustomError  = CustomError;</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">144</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.options                    = null;</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">  // template for the header of each request to neo4j</td></tr><tr class="hit"><td class="line">146</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.header = {</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">    'Accept': 'application/json',</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">    'Content-Type': 'application/json'</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">  };</td></tr><tr class="hit"><td class="line">150</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.timeout                    = 5000;</td></tr><tr class="hit"><td class="line">151</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.exact_version              = null;</td></tr><tr class="hit"><td class="line">152</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.version                    = null;</td></tr><tr class="hit"><td class="line">153</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.ignoreExceptionPattern     = /^(Node|Relationship)NotFoundException$/; // in some case we will ignore exceptions from neo4j, e.g. not found</td></tr><tr class="hit"><td class="line">154</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.urlOptions = {</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">    protocol: 'http',</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">    domain: 'localhost',</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">    port: 7474,</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">    user: '',</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">    password: '',</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">    endpoint: 'db/data/'</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">  // is used for measurement of request-to-respond</td></tr><tr class="hit"><td class="line">164</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype._request_on_               = null;</td></tr><tr class="hit"><td class="line">165</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype._response_on_              = null;</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">  // contains data of the response</td></tr><tr class="hit"><td class="line">167</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype._response_                 = null;</td></tr><tr class="hit"><td class="line">168</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype._columns_                  = null;</td></tr><tr class="hit"><td class="line">169</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype._detectTypesOnColumns_     = false; // n AS `(Node)`, labels(n) AS `(Node.id)`, r AS `[Relationship]`</td></tr><tr class="hit"><td class="line">170</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype._debug_                    = null;</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">172</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.query = function(cypher, options, cb) {</td></tr><tr class="hit"><td class="line">173</td><td class="hits">604</td><td class="source">    var args;</td></tr><tr class="hit"><td class="line">174</td><td class="hits">604</td><td class="source">    ( ( args = helpers.sortOptionsAndCallbackArguments(options, cb) ) &amp;&amp; ( options = args.options ) &amp;&amp; ( cb = args.callback ) );</td></tr><tr class="hit"><td class="line">175</td><td class="hits">604</td><td class="source">    if (typeof cypher !== 'string') {</td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="source">      throw Error('cypher argument has to be a string');</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">178</td><td class="hits">604</td><td class="source">      this.log('**info**', 'cypher:', cypher.trim().replace(/\s+/g,' '));</td></tr><tr class="hit"><td class="line">179</td><td class="hits">604</td><td class="source">      this.post('/'+this.urlOptions.endpoint+'cypher',{</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">        data: {</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">          query: cypher,</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">          params: options.params || {}</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">      }, function(err, result, debug){</td></tr><tr class="hit"><td class="line">185</td><td class="hits">628</td><td class="source">        return cb(err, result, debug);</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">  // http://docs.neo4j.org/chunked/preview/rest-api-transactional.html</td></tr><tr class="hit"><td class="line">191</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.statement = function() {</td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="source">    throw Error('Not implemented, yet');</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">195</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.checkAvailability = function(cb) {</td></tr><tr class="hit"><td class="line">196</td><td class="hits">11</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">197</td><td class="hits">11</td><td class="source">    this._sendHttpRequest({</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">      method: 'GET',</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">      url: self.absoluteUrl('/'),</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">      timeout: self.timeout</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">    }, function(err, res) {</td></tr><tr class="hit"><td class="line">202</td><td class="hits">11</td><td class="source">        var body = (res) ? res.body : null;</td></tr><tr class="hit"><td class="line">203</td><td class="hits">11</td><td class="source">        if ((typeof res !== 'undefined') &amp;&amp; (res.status === 200)&amp;&amp;(body)&amp;&amp;(body.neo4j_version)) {</td></tr><tr class="hit"><td class="line">204</td><td class="hits">11</td><td class="source">          self.exact_version = body.neo4j_version;</td></tr><tr class="hit"><td class="line">205</td><td class="hits">11</td><td class="source">          self.version = Number(self.exact_version.replace(/^([0-9]+\.*[0-9]*)(.*)$/, '$1'));</td></tr><tr class="hit"><td class="line">206</td><td class="hits">11</td><td class="source">          var error = (self.version &lt; 2) ? Error('Neo4jMapper is not build+tested for neo4j version below v2') : null;</td></tr><tr class="hit"><td class="line">207</td><td class="hits">11</td><td class="source">          __established_connection__[self.absoluteUrl('/')] = true;</td></tr><tr class="hit"><td class="line">208</td><td class="hits">11</td><td class="source">          if (typeof cb === 'function')</td></tr><tr class="hit"><td class="line">209</td><td class="hits">3</td><td class="source">            cb(error, body.neo4j_version);</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">211</td><td class="hits">0</td><td class="source">          __established_connection__[self.absoluteUrl('/')] = false;</td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="source">          self.onConnectionError(Error(&quot;Can't detect neo4j… Sure neo4j service is available on &quot;+self.absoluteUrl('/')+&quot;? &quot;+((err) ? '('+err.message+')' : '')), self);</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">    );</td></tr><tr class="hit"><td class="line">216</td><td class="hits">11</td><td class="source">    return this;</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">219</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.absoluteUrl = function(url) {</td></tr><tr class="hit"><td class="line">220</td><td class="hits">1595</td><td class="source">    if (typeof url !== 'string')</td></tr><tr class="hit"><td class="line">221</td><td class="hits">1058</td><td class="source">      url = '';</td></tr><tr class="hit"><td class="line">222</td><td class="hits">1595</td><td class="source">    if (!url)</td></tr><tr class="hit"><td class="line">223</td><td class="hits">1058</td><td class="source">      url = this.url || '/';</td></tr><tr class="hit"><td class="line">224</td><td class="hits">1595</td><td class="source">    if (url) {</td></tr><tr class="hit"><td class="line">225</td><td class="hits">1595</td><td class="source">      var baseUrl = this._connectionString();</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">      // strip redundant endpoints if they exists</td></tr><tr class="hit"><td class="line">227</td><td class="hits">1595</td><td class="source">      return baseUrl + url.replace(/^\/+/, '').replace(new RegExp('^'+this.urlOptions.endpoint.split('/').join('\\/')+'*'), '');</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">231</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype._connectionString = function() {</td></tr><tr class="hit"><td class="line">232</td><td class="hits">2040</td><td class="source">    return this.urlOptions.protocol + '://'</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">      + String(((this.urlOptions.user)&amp;&amp;(this.urlOptions.password)) ? this.urlOptions.user + ':' + this.urlOptions.password+'@' : '' )</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">      + this.urlOptions.domain</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">      + ':' + this.urlOptions.port</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">      + '/' + this.urlOptions.endpoint;</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">239</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.request = function(url, options, cb) {</td></tr><tr class="hit"><td class="line">240</td><td class="hits">1057</td><td class="source">    var debug = null; // debug object</td></tr><tr class="hit"><td class="line">241</td><td class="hits">1057</td><td class="source">    if (typeof options === 'undefined')</td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="source">      options = {};</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">    // apply default options</td></tr><tr class="hit"><td class="line">245</td><td class="hits">1057</td><td class="source">    _.defaults(options, {</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">      method: 'GET',</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">      data: null,</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">      debug: false,</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">      // use copy of header, not reference</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">      header: _.extend({},this.header)</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">253</td><td class="hits">1057</td><td class="source">    if (typeof url !== 'string') {</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="source">      throw Error(&quot;First argument 'url' hast to be a string&quot;);</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">259</td><td class="hits">1057</td><td class="source">    this.url = options.url = url;</td></tr><tr class="hit"><td class="line">260</td><td class="hits">1057</td><td class="source">    this.header = options.header;</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">262</td><td class="hits">1057</td><td class="source">    var requestedUrl = this.absoluteUrl();</td></tr><tr class="hit"><td class="line">263</td><td class="hits">1057</td><td class="source">    var data = options.data;</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">265</td><td class="hits">1057</td><td class="source">    if ( (typeof data === 'object') &amp;&amp; (data !== null) )</td></tr><tr class="hit"><td class="line">266</td><td class="hits">636</td><td class="source">     data = JSON.stringify(options.data);</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">    // create debug object</td></tr><tr class="hit"><td class="line">269</td><td class="hits">1057</td><td class="source">    this._debug_ = new RequestDebug({</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">      options: options,</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">      requested_url: requestedUrl,</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">      method: options.method,</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">      data: data,</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">      header: this.header,</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">      res: null,</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">      status: null,</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">      err: null</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">    // options for makeRequest()</td></tr><tr class="hit"><td class="line">281</td><td class="hits">1057</td><td class="source">    var _options_ = {</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">      requestedUrl: requestedUrl,</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">      method: options.method,</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">      data: data,</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">      options: options,</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">      debug: debug,</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">      url: url</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">290</td><td class="hits">1057</td><td class="source">    return this._makeRequest(_options_, cb);</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">293</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype._makeRequest = function(_options_, cb) {</td></tr><tr class="hit"><td class="line">294</td><td class="hits">1057</td><td class="source">    var self = this;</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source">    // apply default options on options</td></tr><tr class="hit"><td class="line">296</td><td class="hits">1057</td><td class="source">    _.defaults(_options_, {</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source">      cache: false,</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">      timeout: this.timeout,</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">      loadNode: true // enables the load hooks</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source">    // create final options object from _options_.options</td></tr><tr class="hit"><td class="line">303</td><td class="hits">1057</td><td class="source">    var options = _options_.options;</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">305</td><td class="hits">1057</td><td class="source">    options.absolute_url = _options_.requestedUrl;</td></tr><tr class="hit"><td class="line">306</td><td class="hits">1057</td><td class="source">    options.url = _options_.url;</td></tr><tr class="hit"><td class="line">307</td><td class="hits">1057</td><td class="source">    options.method = _options_.method;</td></tr><tr class="hit"><td class="line">308</td><td class="hits">1057</td><td class="source">    options.data = _options_.data;</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">310</td><td class="hits">1057</td><td class="source">    this.log('**debug**', 'URI:', options.method+&quot;:&quot;+options.url+&quot; (&quot;+options.absolute_url+&quot;)&quot;);</td></tr><tr class="hit"><td class="line">311</td><td class="hits">1057</td><td class="source">    this.log('**debug**', 'sendedData:', options.data);</td></tr><tr class="hit"><td class="line">312</td><td class="hits">1057</td><td class="source">    this.log('**debug**', 'sendedHeader:', self.header);</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">314</td><td class="hits">1057</td><td class="source">    this._request_on_ = new Date().getTime();</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">316</td><td class="hits">1057</td><td class="source">    var requestOptions = {</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source">      method: options.method,</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">      url: options.absolute_url,</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">      header: self.header</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">322</td><td class="hits">1057</td><td class="source">    if (options.data)</td></tr><tr class="hit"><td class="line">323</td><td class="hits">636</td><td class="source">      requestOptions.data = options.data;</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source">    // stream</td></tr><tr class="hit"><td class="line">326</td><td class="hits">1057</td><td class="source">    if (this.header['X-Stream'] === 'true') {</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">328</td><td class="hits">7</td><td class="source">      var stream = JSONStream.parse([/^columns|data$/, true]);</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">330</td><td class="hits">7</td><td class="source">      var isDataColumn = false;</td></tr><tr class="hit"><td class="line">331</td><td class="hits">7</td><td class="source">      self._columns_ = [];</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">333</td><td class="hits">7</td><td class="source">      stream.on('data', function(data) {</td></tr><tr><td class="line">334</td><td class="hits"></td><td class="source">        // detect column and data array</td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source">        // { columns: [ '1', … , 'n' ], data: [ [ … ] ] }</td></tr><tr class="hit"><td class="line">336</td><td class="hits">34</td><td class="source">        if (isDataColumn) {</td></tr><tr class="hit"><td class="line">337</td><td class="hits">17</td><td class="source">          return cb(data);</td></tr><tr class="hit"><td class="line">338</td><td class="hits">17</td><td class="source">        } else if (data) {</td></tr><tr class="hit"><td class="line">339</td><td class="hits">17</td><td class="source">          if (data.constructor === Array) {</td></tr><tr class="hit"><td class="line">340</td><td class="hits">7</td><td class="source">            isDataColumn = true;</td></tr><tr class="hit"><td class="line">341</td><td class="hits">7</td><td class="source">            return cb(data);</td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="hit"><td class="line">343</td><td class="hits">10</td><td class="source">            self._columns_.push(data);</td></tr><tr class="hit"><td class="line">344</td><td class="hits">10</td><td class="source">            return;</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">349</td><td class="hits">7</td><td class="source">      stream.on('end', function() {</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">        // prevent to pass undefined, but maybe an undefined is more clear</td></tr><tr class="hit"><td class="line">351</td><td class="hits">7</td><td class="source">        cb(null, null);</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">353</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">354</td><td class="hits">7</td><td class="source">      stream.on('root', function(root, count) {</td></tr><tr class="hit"><td class="line">355</td><td class="hits">7</td><td class="source">        self._response_on_ = new Date().getTime();</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">        // remove x-stream from header</td></tr><tr class="hit"><td class="line">357</td><td class="hits">7</td><td class="source">        delete self.header['X-Stream'];</td></tr><tr class="hit"><td class="line">358</td><td class="hits">7</td><td class="source">        if (!count) {</td></tr><tr class="miss"><td class="line">359</td><td class="hits">0</td><td class="source">          cb(null, Error('No matches in stream found ('+ root +')'), self._de);</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">363</td><td class="hits">7</td><td class="source">      requestOptions.stream = stream;</td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">    // now finally send the request</td></tr><tr class="hit"><td class="line">368</td><td class="hits">1057</td><td class="source">    this._sendHttpRequest(requestOptions, function(err, res) {</td></tr><tr class="hit"><td class="line">369</td><td class="hits">1050</td><td class="source">      self._response_ = res;</td></tr><tr class="hit"><td class="line">370</td><td class="hits">1050</td><td class="source">      self._response_on_ = new Date().getTime();</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">372</td><td class="hits">1050</td><td class="source">      self._debug_.responseTime = self.responseTime();</td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">374</td><td class="hits">1050</td><td class="source">      if (err) {</td></tr><tr class="miss"><td class="line">375</td><td class="hits">0</td><td class="source">        self.onError(cb, err, 'error', options);</td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source">      } else {</td></tr><tr><td class="line">377</td><td class="hits"></td><td class="source">        // we might have a reponse with a failure status code</td></tr><tr class="hit"><td class="line">378</td><td class="hits">1050</td><td class="source">        if (res.status &gt;= 400) {</td></tr><tr class="hit"><td class="line">379</td><td class="hits">13</td><td class="source">          self.onError(cb, res.body, 'error', options);</td></tr><tr><td class="line">380</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">381</td><td class="hits">1037</td><td class="source">          if (res.body)</td></tr><tr class="hit"><td class="line">382</td><td class="hits">1029</td><td class="source">            self._columns_ = res.body.columns || null;</td></tr><tr class="hit"><td class="line">383</td><td class="hits">1037</td><td class="source">          self.onSuccess(cb, res.body, 'success', options);</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">389</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">390</td><td class="hits"></td><td class="source">  // ### Wrapper for superagent and request</td></tr><tr><td class="line">391</td><td class="hits"></td><td class="source">  // Private method, can be indirectly 'accessed' via neo4jrestful.get|post|delete|put or neo4jrestfule.request</td></tr><tr class="hit"><td class="line">392</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype._sendHttpRequest = function(options, cb) {</td></tr><tr class="hit"><td class="line">393</td><td class="hits">1068</td><td class="source">    _.defaults(options, {</td></tr><tr><td class="line">394</td><td class="hits"></td><td class="source">      header: {},</td></tr><tr><td class="line">395</td><td class="hits"></td><td class="source">      data: null,</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source">      method: 'GET',</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">      timeout: null,</td></tr><tr><td class="line">398</td><td class="hits"></td><td class="source">      stream: false</td></tr><tr><td class="line">399</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">400</td><td class="hits">1068</td><td class="source">    var isBrowser = Boolean(typeof window === 'object');</td></tr><tr class="hit"><td class="line">401</td><td class="hits">1068</td><td class="source">    if (typeof cb !== 'function')</td></tr><tr class="miss"><td class="line">402</td><td class="hits">0</td><td class="source">      throw Error('Callback as 2nd argument is mandatory');</td></tr><tr class="hit"><td class="line">403</td><td class="hits">1068</td><td class="source">    if ((typeof options !== 'object')||(!options.url))</td></tr><tr class="miss"><td class="line">404</td><td class="hits">0</td><td class="source">      cb(Error(&quot;Set { url: '…' } as argument&quot;));</td></tr><tr class="hit"><td class="line">405</td><td class="hits">1068</td><td class="source">    if (isBrowser) {</td></tr><tr><td class="line">406</td><td class="hits"></td><td class="source">      // ### superagent for browserside usage</td></tr><tr class="miss"><td class="line">407</td><td class="hits">0</td><td class="source">      var req = window.superagent(options.method, options.url).set(options.header);</td></tr><tr class="miss"><td class="line">408</td><td class="hits">0</td><td class="source">      if (options.data)</td></tr><tr class="miss"><td class="line">409</td><td class="hits">0</td><td class="source">        req.send(options.data);</td></tr><tr class="miss"><td class="line">410</td><td class="hits">0</td><td class="source">      if (options.stream) {</td></tr><tr class="miss"><td class="line">411</td><td class="hits">0</td><td class="source">        return req.pipe(options.stream);</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">413</td><td class="hits">0</td><td class="source">        return req.end(function(err, res) {</td></tr><tr><td class="line">414</td><td class="hits"></td><td class="source">          // compatibility of superagent to response api</td></tr><tr class="miss"><td class="line">415</td><td class="hits">0</td><td class="source">          if (typeof res === 'object') {</td></tr><tr class="miss"><td class="line">416</td><td class="hits">0</td><td class="source">            res.statusCode = res.status;</td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source">          }</td></tr><tr class="miss"><td class="line">418</td><td class="hits">0</td><td class="source">          return cb(err, res);</td></tr><tr><td class="line">419</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">420</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source">    } else {</td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source">      // ### request module for nodejs</td></tr><tr class="hit"><td class="line">424</td><td class="hits">1068</td><td class="source">      var req = request;</td></tr><tr class="hit"><td class="line">425</td><td class="hits">1068</td><td class="source">      options.json = true;</td></tr><tr class="hit"><td class="line">426</td><td class="hits">1068</td><td class="source">      if (options.data) {</td></tr><tr class="hit"><td class="line">427</td><td class="hits">636</td><td class="source">        if (typeof options.data === 'string')</td></tr><tr class="hit"><td class="line">428</td><td class="hits">636</td><td class="source">          options.body = options.data;</td></tr><tr><td class="line">429</td><td class="hits"></td><td class="source">        else</td></tr><tr class="miss"><td class="line">430</td><td class="hits">0</td><td class="source">          options.json = options.data;</td></tr><tr><td class="line">431</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">432</td><td class="hits">1068</td><td class="source">      if (options.stream) {</td></tr><tr class="hit"><td class="line">433</td><td class="hits">7</td><td class="source">        return req(options).pipe(options.stream);</td></tr><tr><td class="line">434</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">435</td><td class="hits">1061</td><td class="source">        return req(options, function(err, res) {</td></tr><tr><td class="line">436</td><td class="hits"></td><td class="source">          // compatibility of response to superagent api</td></tr><tr class="hit"><td class="line">437</td><td class="hits">1061</td><td class="source">          if (typeof res === 'object') {</td></tr><tr class="hit"><td class="line">438</td><td class="hits">1061</td><td class="source">            res.status = res.statusCode;</td></tr><tr><td class="line">439</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"><td class="line">440</td><td class="hits">1061</td><td class="source">          return cb(err, res);</td></tr><tr><td class="line">441</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">442</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">443</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">444</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">445</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">446</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.onProcess = function(res, cb, debug) {</td></tr><tr class="hit"><td class="line">447</td><td class="hits">1037</td><td class="source">    if (!res) {</td></tr><tr><td class="line">448</td><td class="hits"></td><td class="source">      // return here if no response is present</td></tr><tr class="hit"><td class="line">449</td><td class="hits">8</td><td class="source">      return cb(null, res, debug);</td></tr><tr class="hit"><td class="line">450</td><td class="hits">1029</td><td class="source">    } else if (_.isArray(res)) {</td></tr><tr class="hit"><td class="line">451</td><td class="hits">399</td><td class="source">      for (var i=0; i &lt; res.length; i++) {</td></tr><tr class="hit"><td class="line">452</td><td class="hits">131</td><td class="source">        res[i] = this.createObjectFromResponseData(res[i]);</td></tr><tr><td class="line">453</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">454</td><td class="hits">630</td><td class="source">    } else if ( (res.data) &amp;&amp; (_.isArray(res.data)) ) {</td></tr><tr><td class="line">455</td><td class="hits"></td><td class="source">      // iterate throught res.data rows + columns</td></tr><tr><td class="line">456</td><td class="hits"></td><td class="source">      // an try to detect Node, Relationships + Path objects</td></tr><tr class="hit"><td class="line">457</td><td class="hits">588</td><td class="source">      for (var row=0; row &lt; res.data.length; row++) {</td></tr><tr class="hit"><td class="line">458</td><td class="hits">589</td><td class="source">        for (var column=0; column &lt; res.data[row].length; column++) {</td></tr><tr class="hit"><td class="line">459</td><td class="hits">746</td><td class="source">          res.data[row][column] = this.createObjectFromResponseData(res.data[row][column]);</td></tr><tr><td class="line">460</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">461</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">462</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">463</td><td class="hits">42</td><td class="source">    } else if (_.isObject(res)) {</td></tr><tr class="hit"><td class="line">464</td><td class="hits">42</td><td class="source">      res = this.createObjectFromResponseData(res);</td></tr><tr><td class="line">465</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">466</td><td class="hits">1029</td><td class="source">    cb(null, res, debug);</td></tr><tr><td class="line">467</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">468</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">469</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.onProcessStream = function(res, cb, debug) {</td></tr><tr class="hit"><td class="line">470</td><td class="hits">24</td><td class="source">    if (res) {</td></tr><tr class="hit"><td class="line">471</td><td class="hits">24</td><td class="source">      for (var column=0; column &lt; res.length; column++) {</td></tr><tr class="hit"><td class="line">472</td><td class="hits">44</td><td class="source">        res[column] = this.createObjectFromResponseData(res[column]);</td></tr><tr><td class="line">473</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">474</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">475</td><td class="hits">24</td><td class="source">    cb(null, res, debug);</td></tr><tr><td class="line">476</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">477</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">478</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.onSuccess = function(cb, res, status) {</td></tr><tr><td class="line">479</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">480</td><td class="hits">1037</td><td class="source">    this._debug_.res = res;</td></tr><tr class="hit"><td class="line">481</td><td class="hits">1037</td><td class="source">    this._debug_.status = status;</td></tr><tr><td class="line">482</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">483</td><td class="hits">1037</td><td class="source">    if (status === 'success') {</td></tr><tr class="hit"><td class="line">484</td><td class="hits">1037</td><td class="source">      if (typeof this.onProcess === 'function')</td></tr><tr class="hit"><td class="line">485</td><td class="hits">1037</td><td class="source">        return this.onProcess(res, cb, this._debug_);</td></tr><tr><td class="line">486</td><td class="hits"></td><td class="source">      else</td></tr><tr class="miss"><td class="line">487</td><td class="hits">0</td><td class="source">        return cb(null, res, this._debug_);</td></tr><tr><td class="line">488</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">489</td><td class="hits">0</td><td class="source">      cb(res, status, this._debug_);</td></tr><tr><td class="line">490</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">491</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">492</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">493</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.onError = function(cb, responseError, res, options) {</td></tr><tr><td class="line">494</td><td class="hits"></td><td class="source">    // in some (rare) case, we get an empty {} as error</td></tr><tr class="hit"><td class="line">495</td><td class="hits">13</td><td class="source">    if ( (responseError) &amp;&amp; (typeof responseError === 'object') &amp;&amp; (Object.keys(responseError).length === 0) ) {</td></tr><tr class="miss"><td class="line">496</td><td class="hits">0</td><td class="source">      return cb(null, res.body || null, this._debug_);</td></tr><tr><td class="line">497</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">498</td><td class="hits">13</td><td class="source">    var err = responseError;</td></tr><tr class="hit"><td class="line">499</td><td class="hits">13</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">500</td><td class="hits">13</td><td class="source">    var statusCode = (this._response_) ? this._response_.status : null;</td></tr><tr class="hit"><td class="line">501</td><td class="hits">13</td><td class="source">    var error = ( err &amp;&amp; err.responseText ) ? Error(err.responseText) : err;</td></tr><tr class="hit"><td class="line">502</td><td class="hits">13</td><td class="source">    if (!error) {</td></tr><tr><td class="line">503</td><td class="hits"></td><td class="source">      // TODO: code with description</td></tr><tr class="miss"><td class="line">504</td><td class="hits">0</td><td class="source">      var errDescription = 'Response Error ('+this._response_.status+')';</td></tr><tr class="miss"><td class="line">505</td><td class="hits">0</td><td class="source">      error = new ResponseError(errDescription, this._response_.status);</td></tr><tr><td class="line">506</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">507</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">508</td><td class="hits">13</td><td class="source">    this._debug_.res = res;</td></tr><tr class="hit"><td class="line">509</td><td class="hits">13</td><td class="source">    this._debug_.err = err;</td></tr><tr class="hit"><td class="line">510</td><td class="hits">13</td><td class="source">    this._debug_.error = error;</td></tr><tr><td class="line">511</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">512</td><td class="hits">13</td><td class="source">    try {</td></tr><tr><td class="line">513</td><td class="hits"></td><td class="source">      // jquery is an optional feature since superagent</td></tr><tr class="hit"><td class="line">514</td><td class="hits">13</td><td class="source">      if (jQuery) {</td></tr><tr><td class="line">515</td><td class="hits"></td><td class="source">        // try to extract the first &lt;p&gt; or &lt;pre&gt; from html body, else return error object for better debugging</td></tr><tr class="miss"><td class="line">516</td><td class="hits">0</td><td class="source">        if (jQuery(err.responseText).find('body pre:first, body p:first')[0])</td></tr><tr class="miss"><td class="line">517</td><td class="hits">0</td><td class="source">          err.responseText = jQuery(err.responseText).find('body pre:first, body p:first').first().text().trim().replace(/(\s|\n)+/g,' ');</td></tr><tr class="miss"><td class="line">518</td><td class="hits">0</td><td class="source">        else if (jQuery(err.responseText).text()) {</td></tr><tr class="miss"><td class="line">519</td><td class="hits">0</td><td class="source">          err.responseText = jQuery(err.responseText).text().trim();</td></tr><tr><td class="line">520</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">521</td><td class="hits"></td><td class="source">      } else {</td></tr><tr><td class="line">522</td><td class="hits"></td><td class="source">        // remove all tags to get plain message</td></tr><tr><td class="line">523</td><td class="hits"></td><td class="source">        // TODO: find a real jQuery replacement</td></tr><tr class="hit"><td class="line">524</td><td class="hits">13</td><td class="source">        err.responseText = err.responseText.replace(/(&lt;([^&gt;]+)&gt;)/ig,'').trim();</td></tr><tr><td class="line">525</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">526</td><td class="hits"></td><td class="source">    } catch(e) {</td></tr><tr><td class="line">527</td><td class="hits"></td><td class="source">      // ignore exception</td></tr><tr><td class="line">528</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">529</td><td class="hits"></td><td class="source">    // try to create a valuable error object from response</td></tr><tr class="hit"><td class="line">530</td><td class="hits">13</td><td class="source">    if ((err)&amp;&amp;(err.responseText)&amp;&amp;(typeof err.responseText === 'string')) {</td></tr><tr class="miss"><td class="line">531</td><td class="hits">0</td><td class="source">      try {</td></tr><tr class="miss"><td class="line">532</td><td class="hits">0</td><td class="source">        var err = JSON.parse(err.responseText);</td></tr><tr class="miss"><td class="line">533</td><td class="hits">0</td><td class="source">        var ErrorHandler = (/^(\/)*db\/data(\/)*$/.test(options.url)) ? CypherQueryError : QueryError;</td></tr><tr class="miss"><td class="line">534</td><td class="hits">0</td><td class="source">        err = new ErrorHandler(err.message, {</td></tr><tr><td class="line">535</td><td class="hits"></td><td class="source">          stacktrace: err.stacktrace,</td></tr><tr><td class="line">536</td><td class="hits"></td><td class="source">          exception: err.exception,</td></tr><tr><td class="line">537</td><td class="hits"></td><td class="source">          statusCode: statusCode,</td></tr><tr><td class="line">538</td><td class="hits"></td><td class="source">          url: options.url,</td></tr><tr><td class="line">539</td><td class="hits"></td><td class="source">          method: options.method,</td></tr><tr><td class="line">540</td><td class="hits"></td><td class="source">          data: data</td></tr><tr><td class="line">541</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">542</td><td class="hits"></td><td class="source">      } catch (e) {</td></tr><tr class="miss"><td class="line">543</td><td class="hits">0</td><td class="source">        self.log('**debug** Could not create/parse a valuable error object', e);</td></tr><tr><td class="line">544</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">545</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">546</td><td class="hits">13</td><td class="source">    if ( (err) &amp;&amp; (err.exception) &amp;&amp; (self.ignoreExceptionPattern) &amp;&amp; (self.ignoreExceptionPattern.test(err.exception)) ) {</td></tr><tr><td class="line">547</td><td class="hits"></td><td class="source">      // we ignore by default notfound exceptions, because they are no &quot;syntactical&quot; errors</td></tr><tr class="hit"><td class="line">548</td><td class="hits">4</td><td class="source">      return cb(null, null, this._debug_);</td></tr><tr><td class="line">549</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">550</td><td class="hits">9</td><td class="source">      return cb(err || error, null, this._debug_);</td></tr><tr><td class="line">551</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">552</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">553</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">554</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.stream = function(cypher, options, cb) {</td></tr><tr class="hit"><td class="line">555</td><td class="hits">7</td><td class="source">    var args;</td></tr><tr class="hit"><td class="line">556</td><td class="hits">7</td><td class="source">    ( ( args = helpers.sortOptionsAndCallbackArguments(options, cb) ) &amp;&amp; ( options = args.options ) &amp;&amp; ( cb = args.callback ) );</td></tr><tr class="hit"><td class="line">557</td><td class="hits">7</td><td class="source">    this.header['X-Stream'] = 'true';</td></tr><tr class="hit"><td class="line">558</td><td class="hits">7</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">559</td><td class="hits">7</td><td class="source">    var todo = 0;</td></tr><tr class="hit"><td class="line">560</td><td class="hits">7</td><td class="source">    var done = 0;</td></tr><tr><td class="line">561</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">562</td><td class="hits">7</td><td class="source">    if (typeof cypher !== 'string')</td></tr><tr class="miss"><td class="line">563</td><td class="hits">0</td><td class="source">      throw Error('cypher argument has to be a string');</td></tr><tr><td class="line">564</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">565</td><td class="hits">7</td><td class="source">    return this.query(cypher, options, function(data) {</td></tr><tr class="hit"><td class="line">566</td><td class="hits">31</td><td class="source">      if (data) {</td></tr><tr class="hit"><td class="line">567</td><td class="hits">24</td><td class="source">        if (typeof self.onProcessStream === 'function') {</td></tr><tr class="hit"><td class="line">568</td><td class="hits">24</td><td class="source">          todo++;</td></tr><tr class="hit"><td class="line">569</td><td class="hits">24</td><td class="source">          self.onProcessStream(data, function(err, data) {</td></tr><tr class="hit"><td class="line">570</td><td class="hits">24</td><td class="source">            if ( (data) &amp;&amp; (data.length === 1) )</td></tr><tr class="hit"><td class="line">571</td><td class="hits">4</td><td class="source">              data = data[0];</td></tr><tr class="hit"><td class="line">572</td><td class="hits">24</td><td class="source">            if (done &gt;= todo) {</td></tr><tr><td class="line">573</td><td class="hits"></td><td class="source">              // done</td></tr><tr class="miss"><td class="line">574</td><td class="hits">0</td><td class="source">              cb(data, self);</td></tr><tr class="miss"><td class="line">575</td><td class="hits">0</td><td class="source">              return cb(null, self, self._debug_);</td></tr><tr><td class="line">576</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="hit"><td class="line">577</td><td class="hits">24</td><td class="source">              return cb(data, self, self._debug_);</td></tr><tr><td class="line">578</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">579</td><td class="hits"></td><td class="source">          })</td></tr><tr><td class="line">580</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">581</td><td class="hits">0</td><td class="source">          return cb(data, self, self._debug_);</td></tr><tr><td class="line">582</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">583</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">584</td><td class="hits">7</td><td class="source">        return cb(null, self, self._debug_);</td></tr><tr><td class="line">585</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">586</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">587</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">588</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">589</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.get = function(url, options, cb) {</td></tr><tr class="hit"><td class="line">590</td><td class="hits">413</td><td class="source">    var args;</td></tr><tr class="hit"><td class="line">591</td><td class="hits">413</td><td class="source">    ( ( args = helpers.sortOptionsAndCallbackArguments(options, cb) ) &amp;&amp; ( options = args.options ) &amp;&amp; ( cb = args.callback ) &amp;&amp; ( options.method = 'GET' ) );</td></tr><tr class="hit"><td class="line">592</td><td class="hits">413</td><td class="source">    return this.request(url, options, cb);</td></tr><tr><td class="line">593</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">594</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">595</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.post = function(url, options, cb) {</td></tr><tr class="hit"><td class="line">596</td><td class="hits">635</td><td class="source">    var args;</td></tr><tr class="hit"><td class="line">597</td><td class="hits">635</td><td class="source">    ( ( args = helpers.sortOptionsAndCallbackArguments(options, cb) ) &amp;&amp; ( options = args.options ) &amp;&amp; ( cb = args.callback ) &amp;&amp; ( options.method = 'POST' ) );</td></tr><tr class="hit"><td class="line">598</td><td class="hits">635</td><td class="source">    return this.request(url, options, cb);</td></tr><tr><td class="line">599</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">600</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.put = function(url, options, cb) {</td></tr><tr class="hit"><td class="line">601</td><td class="hits">1</td><td class="source">    var args;</td></tr><tr class="hit"><td class="line">602</td><td class="hits">1</td><td class="source">    ( ( args = helpers.sortOptionsAndCallbackArguments(options, cb) ) &amp;&amp; ( options = args.options ) &amp;&amp; ( cb = args.callback ) &amp;&amp; ( options.method = 'PUT' ) );</td></tr><tr class="hit"><td class="line">603</td><td class="hits">1</td><td class="source">    return this.request(url, options, cb);</td></tr><tr><td class="line">604</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">605</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">606</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.delete = function(url, options, cb) {</td></tr><tr class="hit"><td class="line">607</td><td class="hits">8</td><td class="source">    var args;</td></tr><tr class="hit"><td class="line">608</td><td class="hits">8</td><td class="source">    ( ( args = helpers.sortOptionsAndCallbackArguments(options, cb) ) &amp;&amp; ( options = args.options ) &amp;&amp; ( cb = args.callback ) &amp;&amp; ( options.method = 'DELETE' ) );</td></tr><tr class="hit"><td class="line">609</td><td class="hits">8</td><td class="source">    return this.request(url, options, cb);</td></tr><tr><td class="line">610</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">611</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">612</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.log = function(){ /* &gt; /dev/null */ };</td></tr><tr><td class="line">613</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">614</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.createObjectFromResponseData = function(responseData, Class) {</td></tr><tr class="hit"><td class="line">615</td><td class="hits">1549</td><td class="source">    if ((responseData === null) || (responseData === ''))</td></tr><tr class="miss"><td class="line">616</td><td class="hits">0</td><td class="source">      return null;</td></tr><tr class="hit"><td class="line">617</td><td class="hits">1549</td><td class="source">    var uri = (responseData) ? responseData.self : null;</td></tr><tr class="hit"><td class="line">618</td><td class="hits">1549</td><td class="source">    var Node = Neo4jRestful.Node;</td></tr><tr class="hit"><td class="line">619</td><td class="hits">1549</td><td class="source">    var Relationship = Neo4jRestful.Relationship;</td></tr><tr class="hit"><td class="line">620</td><td class="hits">1549</td><td class="source">    var Path = Neo4jRestful.Path;</td></tr><tr class="hit"><td class="line">621</td><td class="hits">1549</td><td class="source">    if (typeof Class !== 'function')</td></tr><tr class="hit"><td class="line">622</td><td class="hits">1375</td><td class="source">      Class = Node;</td></tr><tr class="hit"><td class="line">623</td><td class="hits">1549</td><td class="source">    if (uri) {</td></tr><tr class="hit"><td class="line">624</td><td class="hits">619</td><td class="source">      if (/\/db\/data\/node\/[0-9]+\/*$/.test(uri)) {</td></tr><tr><td class="line">625</td><td class="hits"></td><td class="source">        // we have a node or an inheriated class</td></tr><tr class="hit"><td class="line">626</td><td class="hits">557</td><td class="source">        var n = new Class();</td></tr><tr class="hit"><td class="line">627</td><td class="hits">557</td><td class="source">        n = n.populateWithDataFromResponse(responseData);</td></tr><tr class="hit"><td class="line">628</td><td class="hits">557</td><td class="source">        return n;</td></tr><tr class="hit"><td class="line">629</td><td class="hits">62</td><td class="source">      } else if (/\/db\/data\/relationship\/[0-9]+\/*$/.test(uri)) {</td></tr><tr><td class="line">630</td><td class="hits"></td><td class="source">        // we have a relationship</td></tr><tr class="hit"><td class="line">631</td><td class="hits">62</td><td class="source">        var r = new Relationship();</td></tr><tr class="hit"><td class="line">632</td><td class="hits">62</td><td class="source">        r = r.populateWithDataFromResponse(responseData);</td></tr><tr class="hit"><td class="line">633</td><td class="hits">62</td><td class="source">        return r;</td></tr><tr><td class="line">634</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">635</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">636</td><td class="hits"></td><td class="source">    else {</td></tr><tr class="hit"><td class="line">637</td><td class="hits">930</td><td class="source">      if ((_.isNumber(responseData.length))&amp;&amp;(_.isString(responseData.start))) {</td></tr><tr><td class="line">638</td><td class="hits"></td><td class="source">        // we have a path</td></tr><tr class="hit"><td class="line">639</td><td class="hits">2</td><td class="source">        var p = new Path();</td></tr><tr class="hit"><td class="line">640</td><td class="hits">2</td><td class="source">        p = p.populateWithDataFromResponse(responseData);</td></tr><tr class="hit"><td class="line">641</td><td class="hits">2</td><td class="source">        return p;</td></tr><tr><td class="line">642</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">643</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">644</td><td class="hits">928</td><td class="source">    return responseData;</td></tr><tr><td class="line">645</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">646</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">647</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.responseTime = function() {</td></tr><tr class="hit"><td class="line">648</td><td class="hits">1052</td><td class="source">    if ((this._request_on_ &gt; 0) &amp;&amp; (this._response_on_ &gt; 0)) {</td></tr><tr class="hit"><td class="line">649</td><td class="hits">1052</td><td class="source">      return this._response_on_ - this._request_on_;</td></tr><tr><td class="line">650</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">651</td><td class="hits">0</td><td class="source">      return null;</td></tr><tr><td class="line">652</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">653</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">654</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">655</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.responseTimeAsString = function() {</td></tr><tr class="hit"><td class="line">656</td><td class="hits">1</td><td class="source">    var time = this.responseTime();</td></tr><tr class="hit"><td class="line">657</td><td class="hits">1</td><td class="source">    if (time) {</td></tr><tr class="hit"><td class="line">658</td><td class="hits">1</td><td class="source">      return Math.floor(time/10)/100 + '[s]';</td></tr><tr><td class="line">659</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">660</td><td class="hits">0</td><td class="source">      return '';</td></tr><tr><td class="line">661</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">662</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">663</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">664</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.onConnectionError = function(/* err, self */) {</td></tr><tr><td class="line">665</td><td class="hits"></td><td class="source">    // overwrite with your own function to decide what to do if no connection can be established</td></tr><tr><td class="line">666</td><td class="hits"></td><td class="source">    /* /dev/null */</td></tr><tr><td class="line">667</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">668</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">669</td><td class="hits">8</td><td class="source">  Neo4jRestful.prototype.singleton = function() {</td></tr><tr><td class="line">670</td><td class="hits"></td><td class="source">    // creates a new instanced copy of this client</td></tr><tr class="hit"><td class="line">671</td><td class="hits">445</td><td class="source">    return new Neo4jRestful(this._connectionString());</td></tr><tr><td class="line">672</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">673</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">674</td><td class="hits">8</td><td class="source">  Neo4jRestful.create = function(url, options) {</td></tr><tr class="miss"><td class="line">675</td><td class="hits">0</td><td class="source">    return new Neo4jRestful(url, options);</td></tr><tr><td class="line">676</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">677</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">678</td><td class="hits">8</td><td class="source">  if (typeof window === 'object')</td></tr><tr class="miss"><td class="line">679</td><td class="hits">0</td><td class="source">    window.Neo4jRestful = Neo4jRestful;</td></tr><tr><td class="line">680</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">681</td><td class="hits">8</td><td class="source">  return Neo4jRestful;</td></tr><tr><td class="line">682</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">683</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">684</td><td class="hits">1</td><td class="source">if (typeof window !== 'object') {</td></tr><tr><td class="line">685</td><td class="hits"></td><td class="source">  // nodejs</td></tr><tr class="hit"><td class="line">686</td><td class="hits">1</td><td class="source">  module.exports = exports = {</td></tr><tr><td class="line">687</td><td class="hits"></td><td class="source">    init: __initNeo4jRestful__</td></tr><tr><td class="line">688</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">689</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="miss"><td class="line">690</td><td class="hits">0</td><td class="source">  window.Neo4jMapper.initNeo4jRestful = __initNeo4jRestful__;</td></tr><tr><td class="line">691</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">692</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/philipp/code/neo4jmapper/src/node.js">/Users/philipp/code/neo4jmapper/src/node.js</h2><div id="stats" class="high"><div class="percentage">84%</div><div class="sloc">1324</div><div class="hits">1122</div><div class="misses">202</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * ## Node</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Represents the node object model and the neo4j-node-query-api</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * You can register own models, including &quot;inheritance&quot;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> * Requirements (for browser and nodejs):</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> * * neo4jmapper helpers</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * * underscorejs</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * * sequence (https://github.com/coolaj86/futures)</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">var __initNode__ = function(neo4jrestful, Graph) {</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">8</td><td class="source">  if (typeof window === 'object') {</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    // browser</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    // TODO: find a solution for bson object id</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">    var helpers               = window.Neo4jMapper.helpers;</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">    var _                     = window._;</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">    var ConditionalParameters = window.Neo4jMapper.ConditionalParameters;</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">    var CypherQuery           = window.Neo4jMapper.CypherQuery;</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">  } else {</td></tr><tr class="hit"><td class="line">22</td><td class="hits">8</td><td class="source">    var helpers               = require('./helpers');</td></tr><tr class="hit"><td class="line">23</td><td class="hits">8</td><td class="source">    var _                     = require('underscore');</td></tr><tr class="hit"><td class="line">24</td><td class="hits">8</td><td class="source">    var ConditionalParameters = require('./conditionalparameters');</td></tr><tr class="hit"><td class="line">25</td><td class="hits">8</td><td class="source">    var CypherQuery           = require('./cypherquery');</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">   * ### Constructor of Node</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">   * Calls this.init(data,id) to set all values to default</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">32</td><td class="hits">8</td><td class="source">  var Node = function Node(data, id, cb) {</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    // id can be a callback as well</td></tr><tr class="hit"><td class="line">34</td><td class="hits">1203</td><td class="source">    if (typeof id === 'function') {</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">      cb = id;</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">      id = undefined;</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    // will be used for labels and classes</td></tr><tr class="hit"><td class="line">39</td><td class="hits">1203</td><td class="source">    if (!this._constructor_name_)</td></tr><tr class="hit"><td class="line">40</td><td class="hits">1203</td><td class="source">      this._constructor_name_ = helpers.constructorNameOfFunction(this) || 'Node';</td></tr><tr class="hit"><td class="line">41</td><td class="hits">1203</td><td class="source">    this.init(data, id);</td></tr><tr class="hit"><td class="line">42</td><td class="hits">1203</td><td class="source">    if (cb)</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">      return this.save(cb);</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">   * Initialize all values on node object</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">49</td><td class="hits">8</td><td class="source">  Node.prototype.init = function(data, id) {</td></tr><tr class="hit"><td class="line">50</td><td class="hits">1279</td><td class="source">    this.setId(id || null);</td></tr><tr class="hit"><td class="line">51</td><td class="hits">1279</td><td class="source">    this.data = _.extend({}, data);</td></tr><tr class="hit"><td class="line">52</td><td class="hits">1279</td><td class="source">    this.resetQuery();</td></tr><tr class="hit"><td class="line">53</td><td class="hits">1279</td><td class="source">    if (id) {</td></tr><tr class="hit"><td class="line">54</td><td class="hits">4</td><td class="source">      this.setUriById(id);</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    // nested objects must be extended nestedly</td></tr><tr class="hit"><td class="line">57</td><td class="hits">1279</td><td class="source">    this.fields = _.extend({}, {</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">      defaults: _.extend({}, this.fields.defaults),</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">      indexes: _.extend({}, this.fields.indexes),</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">      unique: _.extend({}, this.fields.unique)</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">    // copy array</td></tr><tr class="hit"><td class="line">63</td><td class="hits">1279</td><td class="source">    this.labels = _.uniq(this.labels);</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">65</td><td class="hits">1279</td><td class="source">    this._is_instanced_ = true;</td></tr><tr class="hit"><td class="line">66</td><td class="hits">1279</td><td class="source">    return this;</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">  /** Instantiate a node from a specific model</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">    * Model can be a constructor() or a String</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">    * and must be registered in Node.registered_models()</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">    *</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    * @param {Function|String}</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    */</td></tr><tr class="hit"><td class="line">75</td><td class="hits">8</td><td class="source">  Node.prototype.convertToModel = function(model) {</td></tr><tr class="hit"><td class="line">76</td><td class="hits">153</td><td class="source">    var Class = this.recommendConstructor();</td></tr><tr class="hit"><td class="line">77</td><td class="hits">153</td><td class="source">    if (typeof model === 'function') {</td></tr><tr class="hit"><td class="line">78</td><td class="hits">115</td><td class="source">      Class = model;</td></tr><tr class="hit"><td class="line">79</td><td class="hits">38</td><td class="source">    } else if ((typeof model === 'string') &amp;&amp; (Node.registeredModel(model))) {</td></tr><tr class="hit"><td class="line">80</td><td class="hits">33</td><td class="source">      Class = Node.registeredModel(model);</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">82</td><td class="hits">153</td><td class="source">    var node = new Class();</td></tr><tr class="hit"><td class="line">83</td><td class="hits">153</td><td class="source">    this.copyTo(node);</td></tr><tr class="hit"><td class="line">84</td><td class="hits">153</td><td class="source">    return node;</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">  // if we have a distinct label, we will create a model from of it</td></tr><tr class="hit"><td class="line">88</td><td class="hits">8</td><td class="source">  Node.instantiateNodeAsModel = function(node, labels, label) {</td></tr><tr class="hit"><td class="line">89</td><td class="hits">161</td><td class="source">    var model = label;</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">    // if we have given explicit a specific model</td></tr><tr class="hit"><td class="line">91</td><td class="hits">161</td><td class="source">    if (typeof labels === 'string') {</td></tr><tr class="hit"><td class="line">92</td><td class="hits">1</td><td class="source">      model = labels;</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">    // alternative: if we have only one label we instantiate from this</td></tr><tr class="hit"><td class="line">95</td><td class="hits">161</td><td class="source">    if ((labels) &amp;&amp; (labels.length === 1))</td></tr><tr class="hit"><td class="line">96</td><td class="hits">36</td><td class="source">      model = labels[0];</td></tr><tr class="hit"><td class="line">97</td><td class="hits">161</td><td class="source">    if (model)</td></tr><tr class="hit"><td class="line">98</td><td class="hits">151</td><td class="source">      node = node.convertToModel(model);</td></tr><tr class="hit"><td class="line">99</td><td class="hits">161</td><td class="source">    node.setLabels(labels);</td></tr><tr class="hit"><td class="line">100</td><td class="hits">161</td><td class="source">    node.isPersisted(true);</td></tr><tr class="hit"><td class="line">101</td><td class="hits">161</td><td class="source">    return node;</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">104</td><td class="hits">8</td><td class="source">  Node.__models__ = {};                             // contains all globally registered models</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">106</td><td class="hits">8</td><td class="source">  Node.prototype.classification   = 'Node';         // only needed for toObject(), just for better identification of the object for the user</td></tr><tr class="hit"><td class="line">107</td><td class="hits">8</td><td class="source">  Node.prototype.data             = {};             // will contain all data for the node</td></tr><tr class="hit"><td class="line">108</td><td class="hits">8</td><td class="source">  Node.prototype.id               = null;           // ”public“ id attribute</td></tr><tr class="hit"><td class="line">109</td><td class="hits">8</td><td class="source">  Node.prototype._id_             = null;           // ”private“ id attribute (to ensure that this.id deosn't get manipulated accidently)</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">  // can be used to define schema-like-behavior</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">  // TODO: implement unique</td></tr><tr class="hit"><td class="line">112</td><td class="hits">8</td><td class="source">  Node.prototype.fields = {</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">    defaults: {},</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">    indexes: {},</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">    unique: {}</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">118</td><td class="hits">8</td><td class="source">  Node.prototype.uri              = null;           // uri of the node</td></tr><tr class="hit"><td class="line">119</td><td class="hits">8</td><td class="source">  Node.prototype._response_       = null;           // original response object</td></tr><tr class="hit"><td class="line">120</td><td class="hits">8</td><td class="source">  Node.prototype._query_history_  = null;           // an array that contains all query actions chronologically, is also a flag for a modified query</td></tr><tr class="hit"><td class="line">121</td><td class="hits">8</td><td class="source">  Node.prototype._stream_         = null;           // flag for processing result data</td></tr><tr class="hit"><td class="line">122</td><td class="hits">8</td><td class="source">  Node.prototype._hashedData_     = null;           // contains md5 hash of a persisted object</td></tr><tr class="hit"><td class="line">123</td><td class="hits">8</td><td class="source">  Node.prototype.Relationship     = null;           // constructor object for Relationship()</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">  // cypher properties will be **copied** on each new object on cypher.segments in resetQuery()</td></tr><tr class="hit"><td class="line">126</td><td class="hits">8</td><td class="source">  Node.cypherStatementSegments = {</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">    limit: '',              // Number</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">    skip: '',               // Number</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">    filter: '',             // `FILTER`   statement</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">    match: null,            // `MATCH`    statement</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">    start: null,            // `START`    statement</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">    set: '',                // `SET`      statement</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">    With: null,             // `WITH`     statement</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">    distinct: null,         // `DISTINCT` option</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">    return_properties: [],  // [a|b|n|r|p], will be joined with `, `</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">    where: [],              // `WHERE`  statements, will be joined with `AND`</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">    hasProperty: [],</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">    from: null,             // Number</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">    to: null,               // Number</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">    direction: null,        // (incoming|outgoing|all)</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">    order_by: '',           // $property</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">    order_direction: '',    // (ASC|DESC)</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">    relationship: '',       // String</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">    outgoing: null,         // Boolean</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">    incoming: null,         // Boolean</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">    label: null,            // String</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">    node_identifier: null,  // [a|b|n]</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">    parameters: null,       // object that contains all parameters for query</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">    count: '',              // count(n) (DISTINCT)</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">    // Boolean flags</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">    _optionalMatch: null,</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">    _count: null,</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">    _distinct: null,</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">    by_id: null</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">157</td><td class="hits">8</td><td class="source">  Node.prototype.ignoreExceptionPattern   = /^EntityNotFoundException$/; // will be used ONLY on findById</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">159</td><td class="hits">8</td><td class="source">  Node.prototype._is_instanced_           = null;   // flag that this object is instanced</td></tr><tr class="hit"><td class="line">160</td><td class="hits">8</td><td class="source">  Node.prototype._is_singleton_           = false;  // flag that this object is a singleton</td></tr><tr class="hit"><td class="line">161</td><td class="hits">8</td><td class="source">  Node.prototype._is_loaded_              = null;</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">163</td><td class="hits">8</td><td class="source">  Node.prototype.labels                   = null;   // an array of all labels</td></tr><tr class="hit"><td class="line">164</td><td class="hits">8</td><td class="source">  Node.prototype.label                    = null;   // will be set with a label a) if only one label exists b) if one label matches to model</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">166</td><td class="hits">8</td><td class="source">  Node.prototype._constructor_name_       = null;   // will be with the name of the function of the constructor</td></tr><tr class="hit"><td class="line">167</td><td class="hits">8</td><td class="source">  Node.prototype._load_hook_reference_    = null;   // a reference to acticate or deactivate the load hook</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">169</td><td class="hits">8</td><td class="source">  Node.prototype.__skip_loading_labels__  = null;   // is used in _onBeforeLoad() to prevent loading labels in an extra request</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">   * Should **never** be changed</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">   * it's used to dictinct nodes and relationships</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">   * many queries containg `node()` command will use this value</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">   * e.g. n = node(*)</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">177</td><td class="hits">8</td><td class="source">  Node.prototype.__TYPE__                 = 'node';</td></tr><tr class="hit"><td class="line">178</td><td class="hits">8</td><td class="source">  Node.prototype.__TYPE_IDENTIFIER__      = 'n';</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">  // ### Initializes the model</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">  // Calls the onBeforeInitialize &amp; onAfterInitialize hook</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">  // The callback can be used to ensure that all async processes are finished</td></tr><tr class="hit"><td class="line">184</td><td class="hits">8</td><td class="source">  Node.prototype.initialize = function(cb) {</td></tr><tr class="hit"><td class="line">185</td><td class="hits">12</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">186</td><td class="hits">12</td><td class="source">    return this.onBeforeInitialize(function(err, res, debug) {</td></tr><tr class="hit"><td class="line">187</td><td class="hits">12</td><td class="source">      if (err)</td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="source">        cb(err, null, debug);</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">      else</td></tr><tr class="hit"><td class="line">190</td><td class="hits">12</td><td class="source">        self.onAfterInitialize(cb);</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">194</td><td class="hits">8</td><td class="source">  Node.prototype.onBeforeInitialize = function(next) {</td></tr><tr class="hit"><td class="line">195</td><td class="hits">12</td><td class="source">    return next(null,null,null);</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">198</td><td class="hits">8</td><td class="source">  Node.prototype.onAfterInitialize = function(cb) {</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">    // here we return the constructor as 2nd argument in cb</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">    // because it is expected at `Node.register_model('Label', cb)`</td></tr><tr class="hit"><td class="line">201</td><td class="hits">12</td><td class="source">    var self = this;</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">    // Index fields</td></tr><tr class="hit"><td class="line">203</td><td class="hits">12</td><td class="source">    var fieldsToIndex = this.fieldsForAutoindex();</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">    // we create an object to get the label</td></tr><tr class="hit"><td class="line">205</td><td class="hits">12</td><td class="source">    var node = new this.constructor();</td></tr><tr class="hit"><td class="line">206</td><td class="hits">12</td><td class="source">    var label = node.label;</td></tr><tr class="hit"><td class="line">207</td><td class="hits">12</td><td class="source">    if (label) {</td></tr><tr class="hit"><td class="line">208</td><td class="hits">12</td><td class="source">      if (fieldsToIndex.length &gt; 0) {</td></tr><tr class="hit"><td class="line">209</td><td class="hits">10</td><td class="source">        return node.ensureIndex({ label: label, fields: fieldsToIndex }, function(err, res, debug) {</td></tr><tr class="hit"><td class="line">210</td><td class="hits">10</td><td class="source">          return cb(err, self.constructor, debug);</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">213</td><td class="hits">2</td><td class="source">        return cb(null, self.constructor, null);</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="source">      return cb(Error('No label found'), this.constructor, null);</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">  // Copys only the node's relevant data(s) to another object</td></tr><tr class="hit"><td class="line">221</td><td class="hits">8</td><td class="source">  Node.prototype.copyTo = function(n) {</td></tr><tr class="hit"><td class="line">222</td><td class="hits">352</td><td class="source">    n.id = n._id_ = this._id_;</td></tr><tr class="hit"><td class="line">223</td><td class="hits">352</td><td class="source">    n.data   = _.extend(this.data);</td></tr><tr class="hit"><td class="line">224</td><td class="hits">352</td><td class="source">    n.labels = _.clone(this.labels);</td></tr><tr class="hit"><td class="line">225</td><td class="hits">352</td><td class="source">    if (this.label)</td></tr><tr class="hit"><td class="line">226</td><td class="hits">35</td><td class="source">      n.label  = this.label;</td></tr><tr class="hit"><td class="line">227</td><td class="hits">352</td><td class="source">    n.uri = this.uri;</td></tr><tr class="hit"><td class="line">228</td><td class="hits">352</td><td class="source">    n._response_ = _.extend(this._response_);</td></tr><tr class="hit"><td class="line">229</td><td class="hits">352</td><td class="source">    return null;</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">   * Resets the query **but** should not be used since you should start from Node.… instead</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">   * Anyhow, e.g.:</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">   * Example:</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">   *    n = Node.findOne().where(cb)</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">   *    n.resetQuery().findOne(otherCb)</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">240</td><td class="hits">8</td><td class="source">  Node.prototype.resetQuery = function() {</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">    // we have to copy the cypher values on each object</td></tr><tr class="hit"><td class="line">242</td><td class="hits">2728</td><td class="source">    this.cypher = new CypherQuery();</td></tr><tr class="hit"><td class="line">243</td><td class="hits">2728</td><td class="source">    this.cypher.segments = {};</td></tr><tr class="hit"><td class="line">244</td><td class="hits">2728</td><td class="source">    _.extend(this.cypher.segments, this.constructor.cypherStatementSegments);</td></tr><tr class="hit"><td class="line">245</td><td class="hits">2728</td><td class="source">    this.cypher.segments.where = [];</td></tr><tr class="hit"><td class="line">246</td><td class="hits">2728</td><td class="source">    this.cypher.segments.hasProperty = [];</td></tr><tr class="hit"><td class="line">247</td><td class="hits">2728</td><td class="source">    this.cypher.segments.match = [];</td></tr><tr class="hit"><td class="line">248</td><td class="hits">2728</td><td class="source">    this.cypher.segments.return_properties = [];</td></tr><tr class="hit"><td class="line">249</td><td class="hits">2728</td><td class="source">    this.cypher.segments.start = {};</td></tr><tr class="hit"><td class="line">250</td><td class="hits">2728</td><td class="source">    this._query_history_ = [];</td></tr><tr class="hit"><td class="line">251</td><td class="hits">2728</td><td class="source">    if (this.id)</td></tr><tr class="hit"><td class="line">252</td><td class="hits">14</td><td class="source">      this.cypher.segments.from = this.id;</td></tr><tr class="hit"><td class="line">253</td><td class="hits">2728</td><td class="source">    return this; // return self for chaining</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">256</td><td class="hits">8</td><td class="source">  Node.prototype.hasId = function() {</td></tr><tr class="hit"><td class="line">257</td><td class="hits">1642</td><td class="source">    return ((this._is_instanced_) &amp;&amp; (_.isNumber(this._id_))) ? true : false;</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">260</td><td class="hits">8</td><td class="source">  Node.prototype.setUriById = function(id) {</td></tr><tr class="hit"><td class="line">261</td><td class="hits">4</td><td class="source">    if (_.isNumber(id))</td></tr><tr class="hit"><td class="line">262</td><td class="hits">4</td><td class="source">      this.uri = Graph.request().absoluteUrl(this.__TYPE__+'/'+id);</td></tr><tr class="hit"><td class="line">263</td><td class="hits">4</td><td class="source">    return this;</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">266</td><td class="hits">8</td><td class="source">  Node.prototype.flattenData = function(useReference) {</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">    // strongly recommend not to mutate attached node's data</td></tr><tr class="hit"><td class="line">268</td><td class="hits">241</td><td class="source">    if (typeof useReference !== 'boolean')</td></tr><tr class="hit"><td class="line">269</td><td class="hits">241</td><td class="source">      useReference = false;</td></tr><tr class="hit"><td class="line">270</td><td class="hits">241</td><td class="source">    if ((typeof this.data === 'object') &amp;&amp; (this.data !== null)) {</td></tr><tr class="hit"><td class="line">271</td><td class="hits">241</td><td class="source">      var data = (useReference) ? this.data : _.extend(this.data);</td></tr><tr class="hit"><td class="line">272</td><td class="hits">241</td><td class="source">      data = helpers.flattenObject(data);</td></tr><tr class="hit"><td class="line">273</td><td class="hits">241</td><td class="source">      return data;</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">275</td><td class="hits">0</td><td class="source">    return this.data;</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">278</td><td class="hits">8</td><td class="source">  Node.prototype.dataForCypher = function() {</td></tr><tr class="hit"><td class="line">279</td><td class="hits">239</td><td class="source">    var data = this.flattenData();</td></tr><tr class="hit"><td class="line">280</td><td class="hits">239</td><td class="source">    for (var attr in data) {</td></tr><tr class="hit"><td class="line">281</td><td class="hits">317</td><td class="source">      data['`'+attr+'`'] = data[attr];</td></tr><tr class="hit"><td class="line">282</td><td class="hits">317</td><td class="source">      delete data[attr];</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">284</td><td class="hits">239</td><td class="source">    return data;</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">287</td><td class="hits">8</td><td class="source">  Node.prototype.unflattenData = function(useReference) {</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">    // strongly recommend not to mutate attached node's data</td></tr><tr class="hit"><td class="line">289</td><td class="hits">557</td><td class="source">    if (typeof useReference !== 'boolean')</td></tr><tr class="hit"><td class="line">290</td><td class="hits">557</td><td class="source">      useReference = false;</td></tr><tr class="hit"><td class="line">291</td><td class="hits">557</td><td class="source">    var data = (useReference) ? this.data : _.extend(this.data);</td></tr><tr class="hit"><td class="line">292</td><td class="hits">557</td><td class="source">    return helpers.unflattenObject(data);</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">295</td><td class="hits">8</td><td class="source">  Node.prototype.hasValidData = function() {</td></tr><tr class="hit"><td class="line">296</td><td class="hits">3172</td><td class="source">    return helpers.isObjectLiteral(this.data);</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">299</td><td class="hits">8</td><td class="source">  Node.prototype.applyDefaultValues = function() {</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source">    // flatten data and defaults</td></tr><tr class="hit"><td class="line">301</td><td class="hits">240</td><td class="source">    var data     = helpers.flattenObject(this.data);</td></tr><tr class="hit"><td class="line">302</td><td class="hits">240</td><td class="source">    var defaults = helpers.flattenObject(this.fields.defaults);</td></tr><tr class="hit"><td class="line">303</td><td class="hits">240</td><td class="source">    for (var key in defaults) {</td></tr><tr class="hit"><td class="line">304</td><td class="hits">77</td><td class="source">      if (((typeof data[key] === 'undefined')||(data[key] === null))&amp;&amp;(typeof defaults[key] !== 'undefined'))</td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source">        // set a default value by defined function</td></tr><tr class="hit"><td class="line">306</td><td class="hits">74</td><td class="source">        if (typeof defaults[key] === 'function')</td></tr><tr class="hit"><td class="line">307</td><td class="hits">36</td><td class="source">          data[key] = defaults[key](this);</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source">        else</td></tr><tr class="hit"><td class="line">309</td><td class="hits">38</td><td class="source">          data[key] = defaults[key];</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">311</td><td class="hits">240</td><td class="source">    this.data = helpers.unflattenObject(data);</td></tr><tr class="hit"><td class="line">312</td><td class="hits">240</td><td class="source">    return this;</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">315</td><td class="hits">8</td><td class="source">  Node.prototype.hasFieldsToIndex = function() {</td></tr><tr class="miss"><td class="line">316</td><td class="hits">0</td><td class="source">    if (this.hasId())</td></tr><tr class="miss"><td class="line">317</td><td class="hits">0</td><td class="source">      return _.keys(this.fields.indexes).length;</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">    else</td></tr><tr class="miss"><td class="line">319</td><td class="hits">0</td><td class="source">      return null;</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">322</td><td class="hits">8</td><td class="source">  Node.prototype.fieldsToIndex = function() {</td></tr><tr class="hit"><td class="line">323</td><td class="hits">24</td><td class="source">    return ( (this.fields.indexes) &amp;&amp; (_.keys(this.fields.indexes).length &gt; 0) ) ? helpers.flattenObject(this.fields.indexes) : null;</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">326</td><td class="hits">8</td><td class="source">  Node.prototype.fieldsToIndexUnique = function() {</td></tr><tr class="miss"><td class="line">327</td><td class="hits">0</td><td class="source">    return ( (this.fields.unique)  &amp;&amp; (_.keys(this.fields.unique).length &gt; 0) )  ? helpers.flattenObject(this.fields.unique) : null;</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">330</td><td class="hits">8</td><td class="source">  Node.prototype.fieldsForAutoindex = function() {</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source">    // we merge unique and indexes fields</td></tr><tr class="hit"><td class="line">332</td><td class="hits">24</td><td class="source">    var fields = this.fieldsToIndex();</td></tr><tr class="hit"><td class="line">333</td><td class="hits">24</td><td class="source">    var keys = [];</td></tr><tr class="hit"><td class="line">334</td><td class="hits">24</td><td class="source">    _.each(fields, function(toBeIndexed, field) {</td></tr><tr class="hit"><td class="line">335</td><td class="hits">25</td><td class="source">      if (toBeIndexed === true)</td></tr><tr class="hit"><td class="line">336</td><td class="hits">25</td><td class="source">        keys.push(field);</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">338</td><td class="hits">24</td><td class="source">    keys = _.uniq(_.union(keys, this.uniqueFields()));</td></tr><tr class="hit"><td class="line">339</td><td class="hits">24</td><td class="source">    return keys;</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source">   * Returns all fields that should be unique</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source">   * They need to be defined in your model, e.g.:</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">   * Node.register_model({</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">   *  fields: {</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">   *    unique: {</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">   *      email: true</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">   *    }</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">   * }});</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">353</td><td class="hits">8</td><td class="source">  Node.prototype.uniqueFields = function() {</td></tr><tr class="hit"><td class="line">354</td><td class="hits">36</td><td class="source">    var keys = [];</td></tr><tr class="hit"><td class="line">355</td><td class="hits">36</td><td class="source">    _.each(this.fields.unique, function(isUnique, field) {</td></tr><tr class="hit"><td class="line">356</td><td class="hits">3</td><td class="source">      if (isUnique === true)</td></tr><tr class="hit"><td class="line">357</td><td class="hits">3</td><td class="source">        keys.push(field);</td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">359</td><td class="hits">36</td><td class="source">    return keys;</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source">   * # Autoindex</td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source">   * Check the `schema` of the model and builds an autoindex, optional with unique option</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">   * see for more details: http://docs.neo4j.org/chunked/milestone/query-constraints.html</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">   * TODO: only via cypher query, to simplify process</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">368</td><td class="hits">8</td><td class="source">  Node.prototype.ensureIndex = function(options, cb) {</td></tr><tr class="hit"><td class="line">369</td><td class="hits">12</td><td class="source">    var args;</td></tr><tr class="hit"><td class="line">370</td><td class="hits">12</td><td class="source">    ( ( args = helpers.sortOptionsAndCallbackArguments(options, cb) ) &amp;&amp; ( options = args.options ) &amp;&amp; ( cb = args.callback ) );</td></tr><tr class="hit"><td class="line">371</td><td class="hits">12</td><td class="source">    options = _.extend({</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source">      label: this.label,                  // index must be connected to a label</td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source">      fields: this.fieldsForAutoindex(),  // fields that have to be indexed</td></tr><tr><td class="line">374</td><td class="hits"></td><td class="source">      unique: this.uniqueFields() || []   // fields that have be indexed as unique</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source">    }, options);</td></tr><tr class="hit"><td class="line">376</td><td class="hits">12</td><td class="source">    var self    = this;</td></tr><tr class="hit"><td class="line">377</td><td class="hits">12</td><td class="source">    var keys    = _.uniq(_.union(options.fields, options.unique)); // merge index + unique here</td></tr><tr class="hit"><td class="line">378</td><td class="hits">12</td><td class="source">    var todo    = keys.length;</td></tr><tr class="hit"><td class="line">379</td><td class="hits">12</td><td class="source">    var done    = 0;</td></tr><tr class="hit"><td class="line">380</td><td class="hits">12</td><td class="source">    var errors  = [];</td></tr><tr class="hit"><td class="line">381</td><td class="hits">12</td><td class="source">    var results = [];</td></tr><tr class="hit"><td class="line">382</td><td class="hits">12</td><td class="source">    if (!options.label)</td></tr><tr class="miss"><td class="line">383</td><td class="hits">0</td><td class="source">      throw Error('Label is mandatory, you can set the label as options as well');</td></tr><tr class="hit"><td class="line">384</td><td class="hits">12</td><td class="source">    var url = 'schema/index/'+options.label;</td></tr><tr class="hit"><td class="line">385</td><td class="hits">12</td><td class="source">    var queryHead = &quot;CREATE CONSTRAINT ON (n:&quot; + options.label + &quot;) ASSERT &quot;;</td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source">    // get all indexes fields</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source">    // TODO: find a way to distinct index</td></tr><tr class="hit"><td class="line">388</td><td class="hits">12</td><td class="source">    this.getIndex(function(err, indexedFields, debug) {</td></tr><tr><td class="line">389</td><td class="hits"></td><td class="source">      // sort out fields that are already indexed</td></tr><tr class="hit"><td class="line">390</td><td class="hits">12</td><td class="source">      for (var i=0; i &lt; indexedFields.length; i++) {</td></tr><tr class="hit"><td class="line">391</td><td class="hits">8</td><td class="source">        keys = _.without(keys, indexedFields[i]);</td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">393</td><td class="hits"></td><td class="source">      // return without any arguments if there are no fields to index</td></tr><tr class="hit"><td class="line">394</td><td class="hits">12</td><td class="source">      if (keys.length === 0) {</td></tr><tr class="hit"><td class="line">395</td><td class="hits">5</td><td class="source">        return cb(null, null, debug);</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">397</td><td class="hits">7</td><td class="source">      _.each(keys, function(key){</td></tr><tr class="hit"><td class="line">398</td><td class="hits">8</td><td class="source">        var isUnique = (_.indexOf(options.unique, key) &gt;= 0);</td></tr><tr class="hit"><td class="line">399</td><td class="hits">8</td><td class="source">        var query = queryHead + &quot;n.`&quot; + key + &quot;`&quot; + ( (isUnique) ? &quot; IS UNIQUE&quot; : &quot;&quot;)+&quot;;&quot;;</td></tr><tr class="hit"><td class="line">400</td><td class="hits">8</td><td class="source">        var after = function(err, res) {</td></tr><tr class="hit"><td class="line">401</td><td class="hits">8</td><td class="source">          done++;</td></tr><tr class="hit"><td class="line">402</td><td class="hits">8</td><td class="source">          if ((err === 'object') &amp;&amp; (err !== null)) {</td></tr><tr><td class="line">403</td><td class="hits"></td><td class="source">            // we transform the given error(s) to an array to iterate through it</td></tr><tr class="miss"><td class="line">404</td><td class="hits">0</td><td class="source">            var errAsArray = (err.length &gt; 0) ? err : [ err ];</td></tr><tr class="miss"><td class="line">405</td><td class="hits">0</td><td class="source">            errAsArray.forEach(function(err) {</td></tr><tr class="miss"><td class="line">406</td><td class="hits">0</td><td class="source">              if ((err.cause) &amp;&amp; (err.cause.cause) &amp;&amp; (err.cause.cause.exception === 'AlreadyIndexedException')) {</td></tr><tr><td class="line">407</td><td class="hits"></td><td class="source">                // we ignore this &quot;error&quot;</td></tr><tr class="miss"><td class="line">408</td><td class="hits">0</td><td class="source">                results.push(res);</td></tr><tr><td class="line">409</td><td class="hits"></td><td class="source">              } else {</td></tr><tr class="miss"><td class="line">410</td><td class="hits">0</td><td class="source">                errors.push(err);</td></tr><tr><td class="line">411</td><td class="hits"></td><td class="source">              }</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">413</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="hit"><td class="line">414</td><td class="hits">8</td><td class="source">            results.push(res);</td></tr><tr><td class="line">415</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"><td class="line">416</td><td class="hits">8</td><td class="source">          if (done === todo) {</td></tr><tr class="hit"><td class="line">417</td><td class="hits">7</td><td class="source">            cb((errors.length &gt; 0) ? errors : null, results, debug);</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">419</td><td class="hits"></td><td class="source">        };</td></tr><tr class="hit"><td class="line">420</td><td class="hits">8</td><td class="source">        if (isUnique) {</td></tr><tr class="hit"><td class="line">421</td><td class="hits">1</td><td class="source">          self.query(query, after);</td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">423</td><td class="hits">7</td><td class="source">          Graph.request().post(url, { data: { property_keys: [ key ] } }, after);</td></tr><tr><td class="line">424</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">425</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">426</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">427</td><td class="hits">12</td><td class="source">    return this;</td></tr><tr><td class="line">428</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">429</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">430</td><td class="hits">8</td><td class="source">  Node.prototype.dropIndex = function(fields, cb) {</td></tr><tr class="hit"><td class="line">431</td><td class="hits">2</td><td class="source">    if (typeof fields === 'function') {</td></tr><tr class="miss"><td class="line">432</td><td class="hits">0</td><td class="source">      cb = fields;</td></tr><tr class="miss"><td class="line">433</td><td class="hits">0</td><td class="source">      fields = this.fieldsForAutoindex();</td></tr><tr><td class="line">434</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">435</td><td class="hits">2</td><td class="source">    if (!this.label)</td></tr><tr class="miss"><td class="line">436</td><td class="hits">0</td><td class="source">      return cb(Error(&quot;You need to set a label on `node.label` to work with autoindex&quot;), null);</td></tr><tr class="hit"><td class="line">437</td><td class="hits">2</td><td class="source">    var todo = fields.length;</td></tr><tr class="hit"><td class="line">438</td><td class="hits">2</td><td class="source">    var done = 0;</td></tr><tr class="hit"><td class="line">439</td><td class="hits">2</td><td class="source">    var url  = 'schema/index/'+this.label;</td></tr><tr><td class="line">440</td><td class="hits"></td><td class="source">    // skip if no fields</td></tr><tr class="hit"><td class="line">441</td><td class="hits">2</td><td class="source">    if (todo === 0)</td></tr><tr class="miss"><td class="line">442</td><td class="hits">0</td><td class="source">      return cb(null, null);</td></tr><tr class="hit"><td class="line">443</td><td class="hits">2</td><td class="source">    if (todo===0)</td></tr><tr class="miss"><td class="line">444</td><td class="hits">0</td><td class="source">      return cb(Error(&quot;No fields for indexing found&quot;, null));</td></tr><tr class="hit"><td class="line">445</td><td class="hits">2</td><td class="source">    _.each(fields, function(field) {</td></tr><tr class="hit"><td class="line">446</td><td class="hits">2</td><td class="source">      Graph.request().delete(url+'/'+field, function(/* err, res */) {</td></tr><tr class="hit"><td class="line">447</td><td class="hits">2</td><td class="source">        done++;</td></tr><tr class="hit"><td class="line">448</td><td class="hits">2</td><td class="source">        if (done === todo)</td></tr><tr class="hit"><td class="line">449</td><td class="hits">2</td><td class="source">          cb(null, null);</td></tr><tr><td class="line">450</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">451</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">452</td><td class="hits">2</td><td class="source">    return this;</td></tr><tr><td class="line">453</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">454</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">455</td><td class="hits">8</td><td class="source">  Node.prototype.dropEntireIndex = function(cb) {</td></tr><tr class="hit"><td class="line">456</td><td class="hits">2</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">457</td><td class="hits">2</td><td class="source">    this.getIndex(function(err, fields){</td></tr><tr class="hit"><td class="line">458</td><td class="hits">2</td><td class="source">      if (err)</td></tr><tr class="miss"><td class="line">459</td><td class="hits">0</td><td class="source">        return cb(err, fields);</td></tr><tr class="hit"><td class="line">460</td><td class="hits">2</td><td class="source">      return self.dropIndex(fields, cb);</td></tr><tr><td class="line">461</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">462</td><td class="hits">2</td><td class="source">    return this;</td></tr><tr><td class="line">463</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">464</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">465</td><td class="hits">8</td><td class="source">  Node.prototype.getIndex = function(cb) {</td></tr><tr class="hit"><td class="line">466</td><td class="hits">19</td><td class="source">    var label = this.label;</td></tr><tr class="hit"><td class="line">467</td><td class="hits">19</td><td class="source">    if (!label)</td></tr><tr class="miss"><td class="line">468</td><td class="hits">0</td><td class="source">      return cb(Error(&quot;You need to set a label on `node.label` to work with autoindex&quot;), null);</td></tr><tr class="hit"><td class="line">469</td><td class="hits">19</td><td class="source">    var url = 'schema/index/'+this.label;</td></tr><tr class="hit"><td class="line">470</td><td class="hits">19</td><td class="source">    return Graph.request().get(url, function(err, res, debug){</td></tr><tr class="hit"><td class="line">471</td><td class="hits">19</td><td class="source">      if ((typeof res === 'object') &amp;&amp; (res !== null)) {</td></tr><tr class="hit"><td class="line">472</td><td class="hits">19</td><td class="source">        var keys = [];</td></tr><tr class="hit"><td class="line">473</td><td class="hits">19</td><td class="source">        _.each(res, function(data){</td></tr><tr class="hit"><td class="line">474</td><td class="hits">15</td><td class="source">          if (data.label === label)</td></tr><tr class="hit"><td class="line">475</td><td class="hits">15</td><td class="source">            keys.push(data['property_keys']);</td></tr><tr><td class="line">476</td><td class="hits"></td><td class="source">        });</td></tr><tr class="hit"><td class="line">477</td><td class="hits">19</td><td class="source">        return cb(null, _.flatten(keys), debug);</td></tr><tr><td class="line">478</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">479</td><td class="hits">0</td><td class="source">        return cb(err, res, debug);</td></tr><tr><td class="line">480</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">481</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">482</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">483</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">484</td><td class="hits">8</td><td class="source">  Node.prototype._hashData_ = function() {</td></tr><tr class="hit"><td class="line">485</td><td class="hits">2808</td><td class="source">    if (this.hasValidData())</td></tr><tr class="hit"><td class="line">486</td><td class="hits">2808</td><td class="source">      return helpers.md5(JSON.stringify(this.toObject()));</td></tr><tr><td class="line">487</td><td class="hits"></td><td class="source">    else</td></tr><tr class="miss"><td class="line">488</td><td class="hits">0</td><td class="source">      return null;</td></tr><tr><td class="line">489</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">490</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">491</td><td class="hits">8</td><td class="source">  Node.prototype.isPersisted = function(setToTrueOrFalse) {</td></tr><tr class="hit"><td class="line">492</td><td class="hits">1470</td><td class="source">    if (typeof setToTrueOrFalse !== 'undefined') {</td></tr><tr><td class="line">493</td><td class="hits"></td><td class="source">      // use as setter</td></tr><tr class="hit"><td class="line">494</td><td class="hits">1464</td><td class="source">      if (setToTrueOrFalse) {</td></tr><tr class="hit"><td class="line">495</td><td class="hits">1464</td><td class="source">        this._hashedData_ = this._hashData_();</td></tr><tr><td class="line">496</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">497</td><td class="hits">0</td><td class="source">        this._hashedData_ = null;</td></tr><tr><td class="line">498</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">499</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">500</td><td class="hits">1470</td><td class="source">    return (this._hashedData_) ? (this._hashData_() === this._hashedData_) : false;</td></tr><tr><td class="line">501</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">502</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">503</td><td class="hits">8</td><td class="source">  Node.prototype.save = function(cb) {</td></tr><tr class="hit"><td class="line">504</td><td class="hits">202</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">505</td><td class="hits">202</td><td class="source">    var labels = (self.labels.length &gt; 0) ? self.labels : null;</td></tr><tr class="hit"><td class="line">506</td><td class="hits">202</td><td class="source">    return self._onBeforeSave(self, function(err) {</td></tr><tr><td class="line">507</td><td class="hits"></td><td class="source">      // don't execute if an error is passed through</td></tr><tr class="hit"><td class="line">508</td><td class="hits">202</td><td class="source">      if ((typeof err !== 'undefined')&amp;&amp;(err !== null))</td></tr><tr class="miss"><td class="line">509</td><td class="hits">0</td><td class="source">        cb(err, null);</td></tr><tr><td class="line">510</td><td class="hits"></td><td class="source">      else</td></tr><tr class="hit"><td class="line">511</td><td class="hits">202</td><td class="source">        self.onSave(function(err, node, debug) {</td></tr><tr><td class="line">512</td><td class="hits"></td><td class="source">          // assign labels back</td></tr><tr class="hit"><td class="line">513</td><td class="hits">202</td><td class="source">          if (labels)</td></tr><tr class="hit"><td class="line">514</td><td class="hits">38</td><td class="source">            self.labels = labels;</td></tr><tr class="hit"><td class="line">515</td><td class="hits">202</td><td class="source">          self._onAfterSave(err, self, cb, debug);</td></tr><tr><td class="line">516</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">517</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">518</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">519</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">520</td><td class="hits">8</td><td class="source">  Node.prototype._onBeforeSave = function(node, next) {</td></tr><tr class="hit"><td class="line">521</td><td class="hits">202</td><td class="source">    this.onBeforeSave(node, function(err) {</td></tr><tr class="hit"><td class="line">522</td><td class="hits">202</td><td class="source">      next(err);</td></tr><tr><td class="line">523</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">524</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">525</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">526</td><td class="hits">8</td><td class="source">  Node.prototype.onBeforeSave = function(node, next) {</td></tr><tr class="hit"><td class="line">527</td><td class="hits">201</td><td class="source">    next(null, null);</td></tr><tr><td class="line">528</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">529</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">530</td><td class="hits">8</td><td class="source">  Node.prototype.onSave = function(cb) {</td></tr><tr class="hit"><td class="line">531</td><td class="hits">202</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">532</td><td class="hits">202</td><td class="source">    if (this._is_singleton_)</td></tr><tr class="miss"><td class="line">533</td><td class="hits">0</td><td class="source">      return cb(Error('Singleton instances can not be persisted'), null);</td></tr><tr class="hit"><td class="line">534</td><td class="hits">202</td><td class="source">    if (!this.hasValidData())</td></tr><tr class="miss"><td class="line">535</td><td class="hits">0</td><td class="source">      return cb(Error(this.__TYPE__+' does not contain valid data. `'+this.__TYPE__+'.data` must be an object.'));</td></tr><tr class="hit"><td class="line">536</td><td class="hits">202</td><td class="source">    this.resetQuery();</td></tr><tr class="hit"><td class="line">537</td><td class="hits">202</td><td class="source">    this.applyDefaultValues();</td></tr><tr><td class="line">538</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">539</td><td class="hits">202</td><td class="source">    this.id = this._id_;</td></tr><tr><td class="line">540</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">541</td><td class="hits">202</td><td class="source">    if (this.id &gt; 0) {</td></tr><tr><td class="line">542</td><td class="hits"></td><td class="source">      // we generate: { n: { data } } -&gt; n.`prop` = '' , … ,</td></tr><tr><td class="line">543</td><td class="hits"></td><td class="source">      // update node</td></tr><tr class="hit"><td class="line">544</td><td class="hits">2</td><td class="source">      Graph</td></tr><tr><td class="line">545</td><td class="hits"></td><td class="source">        .start('n = node({id})')</td></tr><tr><td class="line">546</td><td class="hits"></td><td class="source">        .addParameter({ id: Number(this.id) })</td></tr><tr><td class="line">547</td><td class="hits"></td><td class="source">        .setWith({ n: this.dataForCypher() })</td></tr><tr><td class="line">548</td><td class="hits"></td><td class="source">        .exec(function(err, res, debug) {</td></tr><tr class="hit"><td class="line">549</td><td class="hits">2</td><td class="source">          if (err) {</td></tr><tr class="miss"><td class="line">550</td><td class="hits">0</td><td class="source">            return cb(err, res, debug);</td></tr><tr><td class="line">551</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="hit"><td class="line">552</td><td class="hits">2</td><td class="source">            self.isPersisted(true);</td></tr><tr class="hit"><td class="line">553</td><td class="hits">2</td><td class="source">            cb(err, self, debug);</td></tr><tr><td class="line">554</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">555</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">556</td><td class="hits"></td><td class="source">    } else {</td></tr><tr><td class="line">557</td><td class="hits"></td><td class="source">      // create node</td></tr><tr class="hit"><td class="line">558</td><td class="hits">200</td><td class="source">      var labels = (this.labels.length &gt; 0) ? ':'+this.labels.join(':') : '';</td></tr><tr class="hit"><td class="line">559</td><td class="hits">200</td><td class="source">      var data = {};</td></tr><tr class="hit"><td class="line">560</td><td class="hits">200</td><td class="source">      data['n'+labels] = this.dataForCypher();</td></tr><tr class="hit"><td class="line">561</td><td class="hits">200</td><td class="source">      Graph</td></tr><tr><td class="line">562</td><td class="hits"></td><td class="source">        .start()</td></tr><tr><td class="line">563</td><td class="hits"></td><td class="source">        .create(data)</td></tr><tr><td class="line">564</td><td class="hits"></td><td class="source">        .return('n')</td></tr><tr><td class="line">565</td><td class="hits"></td><td class="source">        .limit(1)</td></tr><tr><td class="line">566</td><td class="hits"></td><td class="source">        .exec(function(err, res, debug) {</td></tr><tr class="hit"><td class="line">567</td><td class="hits">200</td><td class="source">          if ((err)||(!res)) {</td></tr><tr class="hit"><td class="line">568</td><td class="hits">1</td><td class="source">            return cb(err, res, debug);</td></tr><tr><td class="line">569</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="hit"><td class="line">570</td><td class="hits">199</td><td class="source">            var node = res;</td></tr><tr><td class="line">571</td><td class="hits"></td><td class="source">            // copy persisted data on initially instanced node</td></tr><tr class="hit"><td class="line">572</td><td class="hits">199</td><td class="source">            node.copyTo(self);</td></tr><tr class="hit"><td class="line">573</td><td class="hits">199</td><td class="source">            node = self;</td></tr><tr class="hit"><td class="line">574</td><td class="hits">199</td><td class="source">            node._is_singleton_ = false;</td></tr><tr class="hit"><td class="line">575</td><td class="hits">199</td><td class="source">            node._is_instanced_ = true;</td></tr><tr class="hit"><td class="line">576</td><td class="hits">199</td><td class="source">            self.isPersisted(true);</td></tr><tr class="hit"><td class="line">577</td><td class="hits">199</td><td class="source">            return cb(null, node, debug);</td></tr><tr><td class="line">578</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">579</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">580</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">581</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">582</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">583</td><td class="hits">8</td><td class="source">  Node.prototype._onAfterSave = function(err, node, next, debug) {</td></tr><tr class="hit"><td class="line">584</td><td class="hits">202</td><td class="source">    this.onAfterSave(err, node, function(err, node, debug) {</td></tr><tr><td class="line">585</td><td class="hits"></td><td class="source">      // we use labelsAsArray to avoid duplicate labels</td></tr><tr class="hit"><td class="line">586</td><td class="hits">202</td><td class="source">      var labels = node.labels = node.labelsAsArray();</td></tr><tr><td class="line">587</td><td class="hits"></td><td class="source">      // cancel if we have an error here</td></tr><tr class="hit"><td class="line">588</td><td class="hits">202</td><td class="source">      if (err)</td></tr><tr class="hit"><td class="line">589</td><td class="hits">1</td><td class="source">        return next(err, node, debug);</td></tr><tr class="hit"><td class="line">590</td><td class="hits">201</td><td class="source">      if (labels.length &gt; 0) {</td></tr><tr><td class="line">591</td><td class="hits"></td><td class="source">        // we need to post the label in an extra request</td></tr><tr><td class="line">592</td><td class="hits"></td><td class="source">        // cypher inappropriate since it can't handle { attributes.with.dots: 'value' } …</td></tr><tr class="hit"><td class="line">593</td><td class="hits">38</td><td class="source">        node.addLabels(labels, function(labelError, notUseableData, debugLabel) {</td></tr><tr><td class="line">594</td><td class="hits"></td><td class="source">          // add label err if we have one</td></tr><tr class="hit"><td class="line">595</td><td class="hits">38</td><td class="source">          if (labelError)</td></tr><tr class="miss"><td class="line">596</td><td class="hits">0</td><td class="source">            err = labelError;</td></tr><tr><td class="line">597</td><td class="hits"></td><td class="source">          // add debug label if we have one</td></tr><tr class="hit"><td class="line">598</td><td class="hits">38</td><td class="source">          if (debug)</td></tr><tr class="hit"><td class="line">599</td><td class="hits">38</td><td class="source">            debug = (debugLabel) ? [ debug, debugLabel ] : debug;</td></tr><tr class="hit"><td class="line">600</td><td class="hits">38</td><td class="source">          return next(err, node, debug);</td></tr><tr><td class="line">601</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">602</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">603</td><td class="hits">163</td><td class="source">        return next(err, node, debug);</td></tr><tr><td class="line">604</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">605</td><td class="hits"></td><td class="source">    }, debug);</td></tr><tr><td class="line">606</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">607</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">608</td><td class="hits">8</td><td class="source">  Node.prototype.onAfterSave = function(err, node, next, debug) {</td></tr><tr class="hit"><td class="line">609</td><td class="hits">202</td><td class="source">    return next(err, node, debug);</td></tr><tr><td class="line">610</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">611</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">612</td><td class="hits">8</td><td class="source">  Node.prototype.update = function(data, cb) {</td></tr><tr class="hit"><td class="line">613</td><td class="hits">8</td><td class="source">    if (!this._is_singleton_) {</td></tr><tr class="hit"><td class="line">614</td><td class="hits">1</td><td class="source">      return this.constructor.findById(this._id_).update(data, cb);</td></tr><tr><td class="line">615</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">616</td><td class="hits">7</td><td class="source">    if (this.hasId() &amp;&amp; (typeof cb !== 'function')) {</td></tr><tr class="miss"><td class="line">617</td><td class="hits">0</td><td class="source">      throw Error('To perform an .update() on an instanced node, you have to give a cb as argument');</td></tr><tr><td class="line">618</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">619</td><td class="hits">7</td><td class="source">    if (!helpers.isObjectLiteral(data)) {</td></tr><tr class="miss"><td class="line">620</td><td class="hits">0</td><td class="source">      throw Error('To perform an .update() you need to pass a valid data object literal as first argument');</td></tr><tr><td class="line">621</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">622</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">623</td><td class="hits">7</td><td class="source">    data = helpers.flattenObject(data);</td></tr><tr class="hit"><td class="line">624</td><td class="hits">7</td><td class="source">    this.cypher.segments.set = [];</td></tr><tr class="hit"><td class="line">625</td><td class="hits">7</td><td class="source">    for (var attribute in data) {</td></tr><tr class="hit"><td class="line">626</td><td class="hits">11</td><td class="source">      this.addSetDefinition(attribute, data[attribute]);</td></tr><tr><td class="line">627</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">628</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">629</td><td class="hits">7</td><td class="source">    this.cypher.segments._update_ = true; // update flag is used in graph._processResults</td></tr><tr class="hit"><td class="line">630</td><td class="hits">7</td><td class="source">    this.cypher.segments.start[this.__TYPE_IDENTIFIER__] =  this.__TYPE__ + '(' + this.cypher.segments.by_id + ')';</td></tr><tr class="hit"><td class="line">631</td><td class="hits">7</td><td class="source">    return this.exec(cb);</td></tr><tr><td class="line">632</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">633</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">634</td><td class="hits">8</td><td class="source">  Node.prototype.addSetDefinition = function(attribute, value) {</td></tr><tr class="hit"><td class="line">635</td><td class="hits">11</td><td class="source">    if (this.cypher.useParameters) {</td></tr><tr class="hit"><td class="line">636</td><td class="hits">7</td><td class="source">      if (!this.cypher.hasParameters())</td></tr><tr class="hit"><td class="line">637</td><td class="hits">5</td><td class="source">        this.cypher.parameters = {};</td></tr><tr><td class="line">638</td><td class="hits"></td><td class="source">      // if already parameters are added, starting with {_value#i_} instead of {_value0_}</td></tr><tr class="hit"><td class="line">639</td><td class="hits">7</td><td class="source">      var parametersStartCountAt = (this.cypher.parameters) ? Object.keys(this.cypher.parameters).length : 0;</td></tr><tr class="hit"><td class="line">640</td><td class="hits">7</td><td class="source">      var key = '_value'+parametersStartCountAt+'_';</td></tr><tr class="hit"><td class="line">641</td><td class="hits">7</td><td class="source">      var parameter = {};</td></tr><tr class="hit"><td class="line">642</td><td class="hits">7</td><td class="source">      parameter[key] = value;</td></tr><tr class="hit"><td class="line">643</td><td class="hits">7</td><td class="source">      this.cypher.segments.set.push(</td></tr><tr><td class="line">644</td><td class="hits"></td><td class="source">        helpers.cypherKeyValueToString(attribute, '{'+key+'}', this.__TYPE_IDENTIFIER__, { valuesToParameters: true })</td></tr><tr><td class="line">645</td><td class="hits"></td><td class="source">      );</td></tr><tr class="hit"><td class="line">646</td><td class="hits">7</td><td class="source">      this._addParameterToCypher(value);</td></tr><tr><td class="line">647</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">648</td><td class="hits">4</td><td class="source">      this.cypher.segments.set.push(helpers.cypherKeyValueToString(attribute, value, this.__TYPE_IDENTIFIER__));</td></tr><tr><td class="line">649</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">650</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">651</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">652</td><td class="hits">8</td><td class="source">  Node.prototype.load = function(cb, debug) {</td></tr><tr class="hit"><td class="line">653</td><td class="hits">483</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">654</td><td class="hits">483</td><td class="source">    return this._onBeforeLoad(self, function(err, node) {</td></tr><tr class="hit"><td class="line">655</td><td class="hits">483</td><td class="source">      if (err)</td></tr><tr class="miss"><td class="line">656</td><td class="hits">0</td><td class="source">        cb(err, node, debug);</td></tr><tr><td class="line">657</td><td class="hits"></td><td class="source">      else</td></tr><tr class="hit"><td class="line">658</td><td class="hits">483</td><td class="source">        self._onAfterLoad(node, cb, debug);</td></tr><tr><td class="line">659</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">660</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">661</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">662</td><td class="hits">8</td><td class="source">  Node.prototype._onBeforeLoad = function(node, next, debug) {</td></tr><tr class="hit"><td class="line">663</td><td class="hits">483</td><td class="source">    this.onBeforeLoad(node, function(node) {</td></tr><tr class="hit"><td class="line">664</td><td class="hits">483</td><td class="source">      if (node.hasId()) {</td></tr><tr><td class="line">665</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">666</td><td class="hits">483</td><td class="source">        var _createNodeFromLabel = function(node, debug) {</td></tr><tr class="hit"><td class="line">667</td><td class="hits">483</td><td class="source">          node.isPersisted(true);</td></tr><tr class="hit"><td class="line">668</td><td class="hits">483</td><td class="source">          node.__skip_loading_labels__ = null;</td></tr><tr class="hit"><td class="line">669</td><td class="hits">483</td><td class="source">          next(null, node, debug);</td></tr><tr><td class="line">670</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">671</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">672</td><td class="hits">483</td><td class="source">        if (node.__skip_loading_labels__) {</td></tr><tr class="hit"><td class="line">673</td><td class="hits">150</td><td class="source">          return _createNodeFromLabel(node, debug);</td></tr><tr><td class="line">674</td><td class="hits"></td><td class="source">        } else {</td></tr><tr><td class="line">675</td><td class="hits"></td><td class="source">          // only load labels if it's set to not loaded</td></tr><tr class="hit"><td class="line">676</td><td class="hits">333</td><td class="source">          return node.allLabels(function(err, labels, debug) {</td></tr><tr class="hit"><td class="line">677</td><td class="hits">333</td><td class="source">            if (err)</td></tr><tr class="miss"><td class="line">678</td><td class="hits">0</td><td class="source">              return next(err, labels);</td></tr><tr class="hit"><td class="line">679</td><td class="hits">333</td><td class="source">            node.setLabels(labels);</td></tr><tr><td class="line">680</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">681</td><td class="hits">333</td><td class="source">            return _createNodeFromLabel(node, debug);</td></tr><tr><td class="line">682</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">683</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">684</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">685</td><td class="hits">0</td><td class="source">        return next(null, node);</td></tr><tr><td class="line">686</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">687</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">688</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">689</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">690</td><td class="hits">8</td><td class="source">  Node.prototype.reload = function (cb) {</td></tr><tr class="miss"><td class="line">691</td><td class="hits">0</td><td class="source">    this._is_loaded_ = false;</td></tr><tr class="miss"><td class="line">692</td><td class="hits">0</td><td class="source">    this.load(cb);</td></tr><tr><td class="line">693</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">694</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">695</td><td class="hits">8</td><td class="source">  Node.prototype.onBeforeLoad = function(node, next) {</td></tr><tr class="hit"><td class="line">696</td><td class="hits">483</td><td class="source">    return next(node);</td></tr><tr><td class="line">697</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">698</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">699</td><td class="hits">8</td><td class="source">  Node.prototype._onAfterLoad = function(node, next) {</td></tr><tr class="hit"><td class="line">700</td><td class="hits">483</td><td class="source">    node._is_loaded_ = true;</td></tr><tr class="hit"><td class="line">701</td><td class="hits">483</td><td class="source">    this.onAfterLoad(node, function(err, node) {</td></tr><tr class="hit"><td class="line">702</td><td class="hits">483</td><td class="source">      next(err, node);</td></tr><tr><td class="line">703</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">704</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">705</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">706</td><td class="hits">8</td><td class="source">  Node.prototype.onAfterLoad = function(node, next) {</td></tr><tr class="hit"><td class="line">707</td><td class="hits">483</td><td class="source">    next(null, node);</td></tr><tr><td class="line">708</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">709</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">710</td><td class="hits">8</td><td class="source">  Node.prototype.disableLoading = function() {</td></tr><tr class="hit"><td class="line">711</td><td class="hits">1</td><td class="source">    if (typeof this.load === 'function') {</td></tr><tr class="hit"><td class="line">712</td><td class="hits">1</td><td class="source">      this._load_hook_reference_ = this.load;</td></tr><tr class="hit"><td class="line">713</td><td class="hits">1</td><td class="source">      this.load = null;</td></tr><tr><td class="line">714</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">715</td><td class="hits">1</td><td class="source">    return this;</td></tr><tr><td class="line">716</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">717</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">718</td><td class="hits">8</td><td class="source">  Node.prototype.enableLoading = function() {</td></tr><tr class="hit"><td class="line">719</td><td class="hits">1</td><td class="source">    if (typeof this._load_hook_reference_ === 'function') {</td></tr><tr class="hit"><td class="line">720</td><td class="hits">1</td><td class="source">      this.load = this._load_hook_reference_;</td></tr><tr class="hit"><td class="line">721</td><td class="hits">1</td><td class="source">      this._load_hook_reference_ = null;</td></tr><tr><td class="line">722</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">723</td><td class="hits">1</td><td class="source">    return this;</td></tr><tr><td class="line">724</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">725</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">726</td><td class="hits">8</td><td class="source">  Node.prototype.populateWithDataFromResponse = function(data) {</td></tr><tr><td class="line">727</td><td class="hits"></td><td class="source">    // if we are working on the prototype object</td></tr><tr><td class="line">728</td><td class="hits"></td><td class="source">    // we won't mutate it and create a new node instance insetad</td></tr><tr class="hit"><td class="line">729</td><td class="hits">557</td><td class="source">    var node;</td></tr><tr class="hit"><td class="line">730</td><td class="hits">557</td><td class="source">    if (!this._is_instanced_)</td></tr><tr class="miss"><td class="line">731</td><td class="hits">0</td><td class="source">      node = new Node();</td></tr><tr><td class="line">732</td><td class="hits"></td><td class="source">    else</td></tr><tr class="hit"><td class="line">733</td><td class="hits">557</td><td class="source">      node = this;</td></tr><tr class="hit"><td class="line">734</td><td class="hits">557</td><td class="source">    node.resetQuery();</td></tr><tr class="hit"><td class="line">735</td><td class="hits">557</td><td class="source">    if (data) {</td></tr><tr class="hit"><td class="line">736</td><td class="hits">557</td><td class="source">      if (_.isObject(data) &amp;&amp; (!_.isArray(data)))</td></tr><tr class="hit"><td class="line">737</td><td class="hits">557</td><td class="source">        node._response_ = data;</td></tr><tr><td class="line">738</td><td class="hits"></td><td class="source">      else</td></tr><tr class="miss"><td class="line">739</td><td class="hits">0</td><td class="source">        node._response_ = data[0];</td></tr><tr class="hit"><td class="line">740</td><td class="hits">557</td><td class="source">      node.data = node._response_.data;</td></tr><tr class="hit"><td class="line">741</td><td class="hits">557</td><td class="source">      node.data = node.unflattenData();</td></tr><tr class="hit"><td class="line">742</td><td class="hits">557</td><td class="source">      node.uri  = node._response_.self;</td></tr><tr><td class="line">743</td><td class="hits"></td><td class="source">      //'http://localhost:7474/db/data/node/3648'</td></tr><tr class="hit"><td class="line">744</td><td class="hits">557</td><td class="source">      if ((node._response_.self) &amp;&amp; (node._response_.self.match(/[0-9]+$/))) {</td></tr><tr class="hit"><td class="line">745</td><td class="hits">557</td><td class="source">        node.id = node._id_ = Number(node._response_.self.match(/[0-9]+$/)[0]);</td></tr><tr><td class="line">746</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">747</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">748</td><td class="hits">557</td><td class="source">    node.isPersisted(true);</td></tr><tr class="hit"><td class="line">749</td><td class="hits">557</td><td class="source">    if (typeof node.onAfterPopulate === 'function')</td></tr><tr class="hit"><td class="line">750</td><td class="hits">557</td><td class="source">      node.onAfterPopulate();</td></tr><tr class="hit"><td class="line">751</td><td class="hits">557</td><td class="source">    return node;</td></tr><tr><td class="line">752</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">753</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">754</td><td class="hits">8</td><td class="source">  Node.prototype.onAfterPopulate = function() {</td></tr><tr class="hit"><td class="line">755</td><td class="hits">557</td><td class="source">    return this;</td></tr><tr><td class="line">756</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">757</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">758</td><td class="hits"></td><td class="source">  /*</td></tr><tr><td class="line">759</td><td class="hits"></td><td class="source">   * Query Methods (via chaining)</td></tr><tr><td class="line">760</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">761</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">762</td><td class="hits">8</td><td class="source">  Node.prototype.withLabel = function(label, cb) {</td></tr><tr class="hit"><td class="line">763</td><td class="hits">33</td><td class="source">    var self = this;</td></tr><tr><td class="line">764</td><td class="hits"></td><td class="source">    // return here if we have an instances node</td></tr><tr class="hit"><td class="line">765</td><td class="hits">33</td><td class="source">    if ( (self.hasId()) || (typeof label !== 'string') )</td></tr><tr class="miss"><td class="line">766</td><td class="hits">0</td><td class="source">      return self; // return self for chaining</td></tr><tr class="hit"><td class="line">767</td><td class="hits">33</td><td class="source">    self._query_history_.push({ withLabel: label });</td></tr><tr class="hit"><td class="line">768</td><td class="hits">33</td><td class="source">    self.cypher.segments.label = label;</td></tr><tr class="hit"><td class="line">769</td><td class="hits">33</td><td class="source">    return self.exec(cb);</td></tr><tr><td class="line">770</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">771</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">772</td><td class="hits">8</td><td class="source">  Node.prototype.shortestPathTo = function(end, type, cb) {</td></tr><tr class="hit"><td class="line">773</td><td class="hits">1</td><td class="source">    if (typeof type === 'function') {</td></tr><tr class="miss"><td class="line">774</td><td class="hits">0</td><td class="source">      cb = type;</td></tr><tr class="miss"><td class="line">775</td><td class="hits">0</td><td class="source">      type = '';</td></tr><tr><td class="line">776</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">777</td><td class="hits">1</td><td class="source">    return this.pathBetween(this, end, { 'type': type, 'algorithm' : 'shortestPath' }, function(err, result, debug){</td></tr><tr class="hit"><td class="line">778</td><td class="hits">1</td><td class="source">      if ((!err)&amp;&amp;(result))</td></tr><tr><td class="line">779</td><td class="hits"></td><td class="source">        // shortestPath result has always only one result</td></tr><tr class="hit"><td class="line">780</td><td class="hits">1</td><td class="source">        return cb(err, result[0], debug);</td></tr><tr><td class="line">781</td><td class="hits"></td><td class="source">      else</td></tr><tr class="miss"><td class="line">782</td><td class="hits">0</td><td class="source">        return cb(err, result, debug);</td></tr><tr><td class="line">783</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">784</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">785</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">786</td><td class="hits">8</td><td class="source">  Node.prototype.pathBetween = function(start, end, options, cb) {</td></tr><tr class="hit"><td class="line">787</td><td class="hits">1</td><td class="source">    var defaultOptions = {</td></tr><tr><td class="line">788</td><td class="hits"></td><td class="source">      'max_depth': 0,</td></tr><tr><td class="line">789</td><td class="hits"></td><td class="source">      'relationships': {</td></tr><tr><td class="line">790</td><td class="hits"></td><td class="source">        'type': '',</td></tr><tr><td class="line">791</td><td class="hits"></td><td class="source">        'direction': 'out'  // not in use, yet</td></tr><tr><td class="line">792</td><td class="hits"></td><td class="source">      },</td></tr><tr><td class="line">793</td><td class="hits"></td><td class="source">      'algorithm' : 'shortestPath'</td></tr><tr><td class="line">794</td><td class="hits"></td><td class="source">    };</td></tr><tr class="hit"><td class="line">795</td><td class="hits">1</td><td class="source">    if (typeof options === 'object') {</td></tr><tr class="hit"><td class="line">796</td><td class="hits">1</td><td class="source">      options = _.extend(defaultOptions, options);</td></tr><tr><td class="line">797</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">798</td><td class="hits">0</td><td class="source">      cb = options;</td></tr><tr class="miss"><td class="line">799</td><td class="hits">0</td><td class="source">      options = _.extend(defaultOptions);</td></tr><tr><td class="line">800</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">801</td><td class="hits"></td><td class="source">    // allow shorthands for easier usage</td></tr><tr class="hit"><td class="line">802</td><td class="hits">1</td><td class="source">    if (options.max)</td></tr><tr class="miss"><td class="line">803</td><td class="hits">0</td><td class="source">      options.max_depth = options.max;</td></tr><tr class="hit"><td class="line">804</td><td class="hits">1</td><td class="source">    if (options.type)</td></tr><tr class="hit"><td class="line">805</td><td class="hits">1</td><td class="source">      options.relationships.type = options.type;</td></tr><tr class="hit"><td class="line">806</td><td class="hits">1</td><td class="source">    if (options.direction)</td></tr><tr class="miss"><td class="line">807</td><td class="hits">0</td><td class="source">      options.relationships.direction = options.direction;</td></tr><tr class="hit"><td class="line">808</td><td class="hits">1</td><td class="source">    start = helpers.getIdFromObject(start);</td></tr><tr class="hit"><td class="line">809</td><td class="hits">1</td><td class="source">    end = helpers.getIdFromObject(end);</td></tr><tr class="hit"><td class="line">810</td><td class="hits">1</td><td class="source">    if ((start)&amp;&amp;(end)) {</td></tr><tr><td class="line">811</td><td class="hits"></td><td class="source">      // START martin=node(3), michael=node(7)</td></tr><tr><td class="line">812</td><td class="hits"></td><td class="source">      // MATCH p = allShortestPaths(martin-[*]-michael)</td></tr><tr><td class="line">813</td><td class="hits"></td><td class="source">      // RETURN p</td></tr><tr class="hit"><td class="line">814</td><td class="hits">1</td><td class="source">      var type = (options.relationships.type) ? ':'+options.relationships.type : options.relationships.type;</td></tr><tr><td class="line">815</td><td class="hits"></td><td class="source">      // this.cypher.segments.start = {};</td></tr><tr class="hit"><td class="line">816</td><td class="hits">1</td><td class="source">      this.cypher.segments.start.a = 'node('+start+')';</td></tr><tr class="hit"><td class="line">817</td><td class="hits">1</td><td class="source">      this.cypher.segments.start.b = 'node('+end+')';</td></tr><tr><td class="line">818</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">819</td><td class="hits">1</td><td class="source">      var matchString = 'p = '+options.algorithm+'((a)-['+type+( (options.max_depth&gt;0) ? '..'+options.max_depth : '*' )+']-(b))';</td></tr><tr><td class="line">820</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">821</td><td class="hits">1</td><td class="source">      this.cypher.segments.match = [ matchString.replace(/\[\:\*+/, '[*') ];</td></tr><tr class="hit"><td class="line">822</td><td class="hits">1</td><td class="source">      this.cypher.segments.return_properties = ['p'];</td></tr><tr><td class="line">823</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">824</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">825</td><td class="hits">1</td><td class="source">    return this.exec(cb);</td></tr><tr><td class="line">826</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">827</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">828</td><td class="hits">8</td><td class="source">  Node.prototype.count = function(identifier, cb) {</td></tr><tr class="hit"><td class="line">829</td><td class="hits">16</td><td class="source">    this.cypher.segments._count = true;</td></tr><tr class="hit"><td class="line">830</td><td class="hits">16</td><td class="source">    if (typeof identifier === 'function') {</td></tr><tr class="hit"><td class="line">831</td><td class="hits">14</td><td class="source">      cb = identifier;</td></tr><tr class="hit"><td class="line">832</td><td class="hits">14</td><td class="source">      identifier = '*';</td></tr><tr><td class="line">833</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">834</td><td class="hits">2</td><td class="source">    else if (typeof identifier !== 'string')</td></tr><tr class="hit"><td class="line">835</td><td class="hits">2</td><td class="source">      identifier = '*';</td></tr><tr><td class="line">836</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">837</td><td class="hits">16</td><td class="source">    if (Object.keys(this.cypher.segments.start).length &lt; 1) {</td></tr><tr><td class="line">838</td><td class="hits"></td><td class="source">      // this.cypher.segments.start = {};</td></tr><tr class="hit"><td class="line">839</td><td class="hits">7</td><td class="source">      this.cypher.segments.start[this.__TYPE_IDENTIFIER__] = this.__TYPE__+'(*)'; // all nodes by default</td></tr><tr><td class="line">840</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">841</td><td class="hits">16</td><td class="source">    this.cypher.segments.count = 'COUNT('+((this.cypher.segments._distinct) ? 'DISTINCT ' : '')+identifier+')';</td></tr><tr class="hit"><td class="line">842</td><td class="hits">16</td><td class="source">    if (this.cypher.segments._distinct)</td></tr><tr><td class="line">843</td><td class="hits"></td><td class="source">      // set `this.cypher.segments._distinct` to false</td></tr><tr class="hit"><td class="line">844</td><td class="hits">2</td><td class="source">      this.distinct(undefined, false);</td></tr><tr><td class="line">845</td><td class="hits"></td><td class="source">    // we only need the count column to return in this case</td></tr><tr class="hit"><td class="line">846</td><td class="hits">16</td><td class="source">    if (typeof cb === 'function')</td></tr><tr class="hit"><td class="line">847</td><td class="hits">14</td><td class="source">      this.exec(function(err, result, debug){</td></tr><tr class="hit"><td class="line">848</td><td class="hits">14</td><td class="source">        if ((result)&amp;&amp;(result.data)) {</td></tr><tr class="miss"><td class="line">849</td><td class="hits">0</td><td class="source">          if (result.data.length === 1)</td></tr><tr class="miss"><td class="line">850</td><td class="hits">0</td><td class="source">            result = result.data[0][0];</td></tr><tr><td class="line">851</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">852</td><td class="hits">14</td><td class="source">        cb(err, result, debug);</td></tr><tr><td class="line">853</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"><td class="line">854</td><td class="hits">16</td><td class="source">    this._query_history_.push({ count: { distinct: this.cypher.segments._distinct, identifier: identifier } });</td></tr><tr class="hit"><td class="line">855</td><td class="hits">16</td><td class="source">    return this; // return self for chaining</td></tr><tr><td class="line">856</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">857</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">858</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">859</td><td class="hits"></td><td class="source">   * Query-Building methods</td></tr><tr><td class="line">860</td><td class="hits"></td><td class="source">   * It evaluates `this.cypher` flags (initialized from `this.cypherStatementSegments`)</td></tr><tr><td class="line">861</td><td class="hits"></td><td class="source">   * and prepares for query building  with `Graph.start()…`</td></tr><tr><td class="line">862</td><td class="hits"></td><td class="source">   * @todo split into parts for each statement segment (e.g. query.start, query.return_properties …)</td></tr><tr><td class="line">863</td><td class="hits"></td><td class="source">   * @return {object} prepared query statements</td></tr><tr><td class="line">864</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">865</td><td class="hits">8</td><td class="source">  Node.prototype._prepareQuery = function() {</td></tr><tr class="hit"><td class="line">866</td><td class="hits">453</td><td class="source">    var query = _.extend(this.cypher.segments);</td></tr><tr class="hit"><td class="line">867</td><td class="hits">453</td><td class="source">    var label = (query.label) ? ':'+query.label : '';</td></tr><tr><td class="line">868</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">869</td><td class="hits">453</td><td class="source">    if ((this.cypher.segments.start) &amp;&amp; (this.cypher.segments) &amp;&amp; (Object.keys(this.cypher.segments.start).length &lt; 1)) {</td></tr><tr class="hit"><td class="line">870</td><td class="hits">164</td><td class="source">      if (_.isNumber(query.from)) {</td></tr><tr class="miss"><td class="line">871</td><td class="hits">0</td><td class="source">        query.start = {};</td></tr><tr class="miss"><td class="line">872</td><td class="hits">0</td><td class="source">        query.start.n = 'node('+query.from+')';</td></tr><tr class="miss"><td class="line">873</td><td class="hits">0</td><td class="source">        query.return_properties.push('n');</td></tr><tr><td class="line">874</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">875</td><td class="hits">164</td><td class="source">      if (_.isNumber(query.to)) {</td></tr><tr class="miss"><td class="line">876</td><td class="hits">0</td><td class="source">        query.start.m = 'node('+query.to+')';</td></tr><tr class="miss"><td class="line">877</td><td class="hits">0</td><td class="source">        query.return_properties.push('m');</td></tr><tr><td class="line">878</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">879</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">880</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">881</td><td class="hits">453</td><td class="source">    var relationships = '';</td></tr><tr><td class="line">882</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">883</td><td class="hits">453</td><td class="source">    if ((query.return_properties)&amp;&amp;(query.return_properties.constructor === Array)) {</td></tr><tr class="hit"><td class="line">884</td><td class="hits">244</td><td class="source">      var returnLabels = null;</td></tr><tr class="hit"><td class="line">885</td><td class="hits">244</td><td class="source">      query.return_properties.forEach(function(returnProperty){</td></tr><tr class="hit"><td class="line">886</td><td class="hits">250</td><td class="source">        if ((returnLabels === null) &amp;&amp; (/^n(\s+.*)*$/.test(returnProperty)))</td></tr><tr class="hit"><td class="line">887</td><td class="hits">206</td><td class="source">          returnLabels = true;</td></tr><tr><td class="line">888</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">889</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">890</td><td class="hits"></td><td class="source">      // but we don't return labels if we have an action like DELETE</td></tr><tr class="hit"><td class="line">891</td><td class="hits">244</td><td class="source">      if ((returnLabels) &amp;&amp; (!query.action))</td></tr><tr class="hit"><td class="line">892</td><td class="hits">203</td><td class="source">        query.return_properties.push('labels(n)');</td></tr><tr><td class="line">893</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">894</td><td class="hits">244</td><td class="source">      query.return_properties = _.uniq(query.return_properties).join(', ')</td></tr><tr><td class="line">895</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">896</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">897</td><td class="hits">453</td><td class="source">    if (query.relationship) {</td></tr><tr class="hit"><td class="line">898</td><td class="hits">27</td><td class="source">      if (query.relationship.constructor === Array) {</td></tr><tr class="hit"><td class="line">899</td><td class="hits">2</td><td class="source">        relationships = ':'+helpers.escapeString(query.relationship.join('|'));</td></tr><tr><td class="line">900</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">901</td><td class="hits">25</td><td class="source">        relationships = ':'+helpers.escapeString(query.relationship);</td></tr><tr><td class="line">902</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">903</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">904</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">905</td><td class="hits"></td><td class="source">    // if COUNT(*) is set, no return properties are set</td></tr><tr><td class="line">906</td><td class="hits"></td><td class="source">    // to avoid s.th. like `RETURN COUNT(*), n, r`</td></tr><tr class="hit"><td class="line">907</td><td class="hits">453</td><td class="source">    query.actionWith = (query.count) ? query.count : query.return_properties;</td></tr><tr><td class="line">908</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">909</td><td class="hits"></td><td class="source">    // build in/outgoing directions</td></tr><tr class="hit"><td class="line">910</td><td class="hits">453</td><td class="source">    if ((query.incoming)||(query.outgoing)) {</td></tr><tr class="hit"><td class="line">911</td><td class="hits">48</td><td class="source">      var x = '';</td></tr><tr class="hit"><td class="line">912</td><td class="hits">48</td><td class="source">      var y = '';</td></tr><tr class="hit"><td class="line">913</td><td class="hits">48</td><td class="source">      if ((query.incoming)&amp;&amp;(query.outgoing))</td></tr><tr class="hit"><td class="line">914</td><td class="hits">1</td><td class="source">        x = y = '-';</td></tr><tr><td class="line">915</td><td class="hits"></td><td class="source">      else {</td></tr><tr class="hit"><td class="line">916</td><td class="hits">47</td><td class="source">        if (query.incoming) {</td></tr><tr class="hit"><td class="line">917</td><td class="hits">20</td><td class="source">          x = '&lt;-';</td></tr><tr class="hit"><td class="line">918</td><td class="hits">20</td><td class="source">          y = '-';</td></tr><tr><td class="line">919</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">920</td><td class="hits">47</td><td class="source">        if (query.outgoing) {</td></tr><tr class="hit"><td class="line">921</td><td class="hits">27</td><td class="source">          x = '-';</td></tr><tr class="hit"><td class="line">922</td><td class="hits">27</td><td class="source">          y = '-&gt;';</td></tr><tr><td class="line">923</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">924</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">925</td><td class="hits">48</td><td class="source">      if (query.match.length === 0) {</td></tr><tr><td class="line">926</td><td class="hits"></td><td class="source">        // this.cypher.segments can be an ID or a label</td></tr><tr class="hit"><td class="line">927</td><td class="hits">29</td><td class="source">        query.match.push('(n'+label+')'+x+'[r'+relationships+']'+y+'('+( (this.cypher.segments.to &gt; 0) ? 'm' : ( (this.cypher.segments.to) ? this.cypher.segments.to.replace(/^\:*(.*)$/,':$1') : '' ) ) +')');</td></tr><tr><td class="line">928</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">929</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">930</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">931</td><td class="hits">453</td><td class="source">    var __startObjectToString = function(start) {</td></tr><tr class="hit"><td class="line">932</td><td class="hits">453</td><td class="source">      var s = [];</td></tr><tr class="hit"><td class="line">933</td><td class="hits">453</td><td class="source">      for (var attribute in start) {</td></tr><tr class="hit"><td class="line">934</td><td class="hits">474</td><td class="source">        s.push(attribute+' = '+start[attribute]);</td></tr><tr><td class="line">935</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">936</td><td class="hits">453</td><td class="source">      return s.join(', ').trim();</td></tr><tr><td class="line">937</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">938</td><td class="hits"></td><td class="source">    // guess return objects from start string if it's not set</td></tr><tr><td class="line">939</td><td class="hits"></td><td class="source">    // e.g. START n = node(*), a = node(2) WHERE … RETURN (~&gt;) n, a;</td></tr><tr class="hit"><td class="line">940</td><td class="hits">453</td><td class="source">    if ((!query.return_properties)||((query.return_properties)&amp;&amp;(query.return_properties.length == 0)&amp;&amp;(this.cypher.segments.start)&amp;&amp;(Object.keys(this.cypher.segments.start).length &gt; 0))) {</td></tr><tr class="miss"><td class="line">941</td><td class="hits">0</td><td class="source">      query.start_as_string = ' '+__startObjectToString(query.start)</td></tr><tr class="miss"><td class="line">942</td><td class="hits">0</td><td class="source">      if (/ [a-zA-Z]+ \= /.test(query.start_as_string)) {</td></tr><tr class="miss"><td class="line">943</td><td class="hits">0</td><td class="source">        var matches = query.start_as_string;</td></tr><tr class="miss"><td class="line">944</td><td class="hits">0</td><td class="source">        query.return_properties = [];</td></tr><tr class="miss"><td class="line">945</td><td class="hits">0</td><td class="source">        matches = matches.match(/[\s\,]([a-z]+) \= /g);</td></tr><tr class="miss"><td class="line">946</td><td class="hits">0</td><td class="source">        for (var i = 0; i &lt; matches.length; i++) {</td></tr><tr class="miss"><td class="line">947</td><td class="hits">0</td><td class="source">          query.return_properties.push(matches[i].replace(/^[\s\,]*([a-z]+).*$/i,'$1'));</td></tr><tr><td class="line">948</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">949</td><td class="hits">0</td><td class="source">        query.return_properties = query.return_properties.join(', ');</td></tr><tr><td class="line">950</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">951</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">952</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">953</td><td class="hits">453</td><td class="source">    if ((!(query.match.length&gt;0))&amp;&amp;(this.label)) {</td></tr><tr><td class="line">954</td><td class="hits"></td><td class="source">      // e.g. ~&gt; MATCH (n:Person)</td></tr><tr class="hit"><td class="line">955</td><td class="hits">25</td><td class="source">      if (this.__TYPE_IDENTIFIER__ === 'n')</td></tr><tr class="hit"><td class="line">956</td><td class="hits">25</td><td class="source">        query.match = [ '(n:'+this.label+')' ];</td></tr><tr class="miss"><td class="line">957</td><td class="hits">0</td><td class="source">      else if (this.__TYPE_IDENTIFIER__ === 'r')</td></tr><tr class="miss"><td class="line">958</td><td class="hits">0</td><td class="source">        query.match = [ '[r:'+this.label+']' ];</td></tr><tr><td class="line">959</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">960</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">961</td><td class="hits"></td><td class="source">    // Set a fallback to START n = node(*) if it's not null</td></tr><tr class="hit"><td class="line">962</td><td class="hits">453</td><td class="source">    if ((this.cypher.segments.start) &amp;&amp; (Object.keys(this.cypher.segments.start).length &lt; 1)&amp;&amp;(!(query.match.length &gt; 0))) {</td></tr><tr><td class="line">963</td><td class="hits"></td><td class="source">      // query.start = 'n = node(*)';</td></tr><tr><td class="line">964</td><td class="hits"></td><td class="source">      // leave out if a `MATCH` is defined (will speed up query in some cases)</td></tr><tr class="hit"><td class="line">965</td><td class="hits">144</td><td class="source">      if (query.match.length &gt; 0) {</td></tr><tr class="miss"><td class="line">966</td><td class="hits">0</td><td class="source">        query.start = '';</td></tr><tr><td class="line">967</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">968</td><td class="hits">144</td><td class="source">        query.start[this.__TYPE_IDENTIFIER__] = this.__TYPE__+'(*)';</td></tr><tr><td class="line">969</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">970</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">971</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">972</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">973</td><td class="hits"></td><td class="source">    // rule(s) for findById</td></tr><tr class="hit"><td class="line">974</td><td class="hits">453</td><td class="source">    if (_.isNumber(query.by_id)) {</td></tr><tr><td class="line">975</td><td class="hits"></td><td class="source">      // put in where clause if one or no START statement exists</td></tr><tr class="hit"><td class="line">976</td><td class="hits">346</td><td class="source">      if (Object.keys(this.cypher.segments.start).length &lt;= 1) {</td></tr><tr class="hit"><td class="line">977</td><td class="hits">328</td><td class="source">        var id = query.by_id;</td></tr><tr class="hit"><td class="line">978</td><td class="hits">328</td><td class="source">        if (this.cypher.useParameters) {</td></tr><tr class="hit"><td class="line">979</td><td class="hits">321</td><td class="source">          this.cypher.segments.start.n = 'node({_node_id_})';</td></tr><tr class="hit"><td class="line">980</td><td class="hits">321</td><td class="source">          this.cypher.addParameter( { _node_id_: id } );</td></tr><tr><td class="line">981</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">982</td><td class="hits">7</td><td class="source">          this.cypher.segments.start.n = 'node('+id+')';</td></tr><tr><td class="line">983</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">984</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">985</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">986</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">987</td><td class="hits"></td><td class="source">    // add all `HAS (property)` statements to where</td></tr><tr class="hit"><td class="line">988</td><td class="hits">453</td><td class="source">    if (query.hasProperty.length &gt; 0) {</td></tr><tr><td class="line">989</td><td class="hits"></td><td class="source">      // remove duplicate properties, not necessary but looks nicer</td></tr><tr class="hit"><td class="line">990</td><td class="hits">8</td><td class="source">      _.uniq(query.hasProperty).forEach(function(property) {</td></tr><tr class="hit"><td class="line">991</td><td class="hits">8</td><td class="source">        query.where.unshift('HAS ('+property+')');</td></tr><tr><td class="line">992</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">993</td><td class="hits"></td><td class="source">      // remove all duplicate-AND-conditions</td></tr><tr class="hit"><td class="line">994</td><td class="hits">8</td><td class="source">      query.where = _.unique(query.where);</td></tr><tr><td class="line">995</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">996</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">997</td><td class="hits">453</td><td class="source">    query.start_as_string = __startObjectToString(query.start);</td></tr><tr><td class="line">998</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">999</td><td class="hits">453</td><td class="source">    return query;</td></tr><tr><td class="line">1000</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1001</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1002</td><td class="hits">8</td><td class="source">  Node.prototype.toQuery = function() {</td></tr><tr class="hit"><td class="line">1003</td><td class="hits">455</td><td class="source">    if (this.hasId() &amp;&amp; (!(Object.keys(this.cypher.segments.start).length &gt; 1))) {</td></tr><tr class="hit"><td class="line">1004</td><td class="hits">2</td><td class="source">      return Node.findById(this._id_).toQuery();</td></tr><tr><td class="line">1005</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1006</td><td class="hits">453</td><td class="source">    var query = this._prepareQuery();</td></tr><tr class="hit"><td class="line">1007</td><td class="hits">453</td><td class="source">    var graph = Graph.start(query.start_as_string);</td></tr><tr class="hit"><td class="line">1008</td><td class="hits">453</td><td class="source">    if (query.match.length &gt; 0) {</td></tr><tr class="hit"><td class="line">1009</td><td class="hits">122</td><td class="source">      if (this.cypher._optionalMatch)</td></tr><tr class="hit"><td class="line">1010</td><td class="hits">3</td><td class="source">        graph.optionalMatch(query.match.join(' AND '));</td></tr><tr><td class="line">1011</td><td class="hits"></td><td class="source">      else</td></tr><tr class="hit"><td class="line">1012</td><td class="hits">119</td><td class="source">        graph.match(query.match.join(' AND '));</td></tr><tr><td class="line">1013</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1014</td><td class="hits">453</td><td class="source">    if ((query.where)&amp;&amp;(query.where.length &gt; 0))</td></tr><tr class="hit"><td class="line">1015</td><td class="hits">77</td><td class="source">      graph.where(query.where.join(' AND '));</td></tr><tr class="hit"><td class="line">1016</td><td class="hits">453</td><td class="source">    if (query.set)</td></tr><tr class="hit"><td class="line">1017</td><td class="hits">11</td><td class="source">      graph.set(query.set);</td></tr><tr class="hit"><td class="line">1018</td><td class="hits">453</td><td class="source">    if (query.action)</td></tr><tr class="hit"><td class="line">1019</td><td class="hits">17</td><td class="source">      graph.custom(query.action+' '+query.actionWith);</td></tr><tr class="hit"><td class="line">1020</td><td class="hits">436</td><td class="source">    else if (query._distinct)</td></tr><tr class="miss"><td class="line">1021</td><td class="hits">0</td><td class="source">      graph.returnDistinct(query.actionWith);</td></tr><tr><td class="line">1022</td><td class="hits"></td><td class="source">    else</td></tr><tr class="hit"><td class="line">1023</td><td class="hits">436</td><td class="source">      graph.return(query.actionWith);</td></tr><tr class="hit"><td class="line">1024</td><td class="hits">453</td><td class="source">    if (query.order_by)</td></tr><tr class="hit"><td class="line">1025</td><td class="hits">7</td><td class="source">      graph.orderBy(query.order_by+' '+query.order_direction);</td></tr><tr class="hit"><td class="line">1026</td><td class="hits">453</td><td class="source">    if (query.skip)</td></tr><tr class="hit"><td class="line">1027</td><td class="hits">6</td><td class="source">      graph.skip(Number(query.skip));</td></tr><tr class="hit"><td class="line">1028</td><td class="hits">453</td><td class="source">    if (query.limit)</td></tr><tr class="hit"><td class="line">1029</td><td class="hits">38</td><td class="source">      graph.limit(Number(query.limit));</td></tr><tr class="hit"><td class="line">1030</td><td class="hits">453</td><td class="source">    graph.cypher.parameters = this.cypher.parameters;</td></tr><tr class="hit"><td class="line">1031</td><td class="hits">453</td><td class="source">    return graph.toQuery();</td></tr><tr><td class="line">1032</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1033</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1034</td><td class="hits">8</td><td class="source">  Node.prototype.toQueryString = function() {</td></tr><tr class="hit"><td class="line">1035</td><td class="hits">2</td><td class="source">    return this.toQuery().toString();</td></tr><tr><td class="line">1036</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1037</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1038</td><td class="hits">8</td><td class="source">  Node.prototype.toCypherQuery = function() {</td></tr><tr class="hit"><td class="line">1039</td><td class="hits">234</td><td class="source">    return this.toQuery().toCypher();</td></tr><tr><td class="line">1040</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1041</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1042</td><td class="hits">8</td><td class="source">  Node.prototype._start_node_id = function(fallback) {</td></tr><tr class="hit"><td class="line">1043</td><td class="hits">39</td><td class="source">    if (typeof fallback === 'undefined')</td></tr><tr class="miss"><td class="line">1044</td><td class="hits">0</td><td class="source">      fallback = '*'</td></tr><tr class="hit"><td class="line">1045</td><td class="hits">39</td><td class="source">    if (this.cypher.segments.from &gt; 0)</td></tr><tr class="miss"><td class="line">1046</td><td class="hits">0</td><td class="source">      return this.cypher.segments.from;</td></tr><tr class="hit"><td class="line">1047</td><td class="hits">39</td><td class="source">    if (this.cypher.segments.by_id)</td></tr><tr class="hit"><td class="line">1048</td><td class="hits">21</td><td class="source">      return this.cypher.segments.by_id;</td></tr><tr><td class="line">1049</td><td class="hits"></td><td class="source">    else</td></tr><tr class="hit"><td class="line">1050</td><td class="hits">18</td><td class="source">      return (this.hasId()) ? this.id : fallback;</td></tr><tr><td class="line">1051</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1052</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1053</td><td class="hits">8</td><td class="source">  Node.prototype._end_node_id = function(fallback) {</td></tr><tr class="hit"><td class="line">1054</td><td class="hits">13</td><td class="source">    if (typeof fallback === 'undefined')</td></tr><tr class="miss"><td class="line">1055</td><td class="hits">0</td><td class="source">      fallback = '*'</td></tr><tr class="hit"><td class="line">1056</td><td class="hits">13</td><td class="source">    return (this.cypher.segments.to &gt; 0) ? this.cypher.segments.to : fallback;</td></tr><tr><td class="line">1057</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1058</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1059</td><td class="hits">8</td><td class="source">  Node.prototype.singletonForQuery = function(cypher) {</td></tr><tr class="hit"><td class="line">1060</td><td class="hits">67</td><td class="source">    var singleton = this.singleton()</td></tr><tr class="hit"><td class="line">1061</td><td class="hits">67</td><td class="source">    singleton.cypher = _.extend(singleton.cypher, cypher);</td></tr><tr class="hit"><td class="line">1062</td><td class="hits">67</td><td class="source">    return (this.hasId()) ? singleton.findById(this.id) : this;</td></tr><tr><td class="line">1063</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1064</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1065</td><td class="hits">8</td><td class="source">  Node.prototype.exec = function(cb, cypher_or_request) {</td></tr><tr class="hit"><td class="line">1066</td><td class="hits">468</td><td class="source">    var request = null;</td></tr><tr class="hit"><td class="line">1067</td><td class="hits">468</td><td class="source">    var cypherQuery = null;</td></tr><tr><td class="line">1068</td><td class="hits"></td><td class="source">    // you can alternatively use an url</td></tr><tr class="hit"><td class="line">1069</td><td class="hits">468</td><td class="source">    if (typeof cypher_or_request === 'string')</td></tr><tr class="miss"><td class="line">1070</td><td class="hits">0</td><td class="source">      cypherQuery = cypher_or_request;</td></tr><tr class="hit"><td class="line">1071</td><td class="hits">468</td><td class="source">    else if (typeof cypher_or_request === 'object')</td></tr><tr class="miss"><td class="line">1072</td><td class="hits">0</td><td class="source">      request = _.extend({ type: 'get', data: {}, url: null }, cypher_or_request);</td></tr><tr><td class="line">1073</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1074</td><td class="hits">468</td><td class="source">    if (typeof cb === 'function') {</td></tr><tr class="hit"><td class="line">1075</td><td class="hits">193</td><td class="source">      this.cypher.parameters = this.toQuery().parameters;</td></tr><tr class="hit"><td class="line">1076</td><td class="hits">193</td><td class="source">      return this.query(this.toCypherQuery(), cb);</td></tr><tr><td class="line">1077</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1078</td><td class="hits">275</td><td class="source">    return this;</td></tr><tr><td class="line">1079</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1080</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1081</td><td class="hits">8</td><td class="source">  Node.prototype.query = function(cypherQuery, parameters, cb, options) {</td></tr><tr class="hit"><td class="line">1082</td><td class="hits">194</td><td class="source">    var self = this;</td></tr><tr><td class="line">1083</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1084</td><td class="hits">194</td><td class="source">    if (typeof parameters === 'function') {</td></tr><tr class="hit"><td class="line">1085</td><td class="hits">194</td><td class="source">      cb = parameters;</td></tr><tr class="hit"><td class="line">1086</td><td class="hits">194</td><td class="source">      parameters = {};</td></tr><tr class="hit"><td class="line">1087</td><td class="hits">194</td><td class="source">      options = {};</td></tr><tr><td class="line">1088</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">1089</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1090</td><td class="hits"></td><td class="source">    // sort arguments</td></tr><tr class="hit"><td class="line">1091</td><td class="hits">194</td><td class="source">    if (!options) {</td></tr><tr class="miss"><td class="line">1092</td><td class="hits">0</td><td class="source">      options = {};</td></tr><tr><td class="line">1093</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">1094</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1095</td><td class="hits">194</td><td class="source">    options.cypher = _.extend(this.cypher.segments, { parameters: this.cypher.parameters });</td></tr><tr><td class="line">1096</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1097</td><td class="hits">194</td><td class="source">    var graph = Graph.start();</td></tr><tr><td class="line">1098</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1099</td><td class="hits"></td><td class="source">    // of loading is deactivated on Node, disable on Graph here as well</td></tr><tr class="hit"><td class="line">1100</td><td class="hits">194</td><td class="source">    if (!this.load)</td></tr><tr class="hit"><td class="line">1101</td><td class="hits">1</td><td class="source">      graph.disableLoading();</td></tr><tr><td class="line">1102</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1103</td><td class="hits"></td><td class="source">    // apply option values from Node to request</td></tr><tr class="hit"><td class="line">1104</td><td class="hits">194</td><td class="source">    if (this.label)</td></tr><tr class="hit"><td class="line">1105</td><td class="hits">22</td><td class="source">      options.label = this.label;</td></tr><tr><td class="line">1106</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1107</td><td class="hits">194</td><td class="source">    options.recommendConstructor = this.recommendConstructor();</td></tr><tr><td class="line">1108</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1109</td><td class="hits">194</td><td class="source">    if ((this.cypher.useParameters) &amp;&amp; (this.cypher.hasParameters()) &amp;&amp; (Object.keys(this.cypher.parameters).length &gt; 0)) {</td></tr><tr class="hit"><td class="line">1110</td><td class="hits">173</td><td class="source">      graph.setParameters(this.cypher.parameters);</td></tr><tr><td class="line">1111</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">1112</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1113</td><td class="hits">194</td><td class="source">    if (typeof cypherQuery === 'string') {</td></tr><tr><td class="line">1114</td><td class="hits"></td><td class="source">      // check for stream flag</td></tr><tr><td class="line">1115</td><td class="hits"></td><td class="source">      // in stream case we use stream() instead of query()</td></tr><tr class="hit"><td class="line">1116</td><td class="hits">194</td><td class="source">      if (this._stream_) {</td></tr><tr class="hit"><td class="line">1117</td><td class="hits">2</td><td class="source">        return graph.stream(cypherQuery, parameters, cb, options);</td></tr><tr><td class="line">1118</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">1119</td><td class="hits">192</td><td class="source">        return graph.query(cypherQuery, parameters, cb, options);</td></tr><tr><td class="line">1120</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">1121</td><td class="hits">0</td><td class="source">    } else if (typeof cypherQuery === 'object') {</td></tr><tr><td class="line">1122</td><td class="hits"></td><td class="source">      // we expect a raw request object here</td></tr><tr><td class="line">1123</td><td class="hits"></td><td class="source">      // this is used to make get/post/put restful request</td></tr><tr><td class="line">1124</td><td class="hits"></td><td class="source">      // with the feature of process node data</td></tr><tr class="miss"><td class="line">1125</td><td class="hits">0</td><td class="source">      var request = cypherQuery;</td></tr><tr class="miss"><td class="line">1126</td><td class="hits">0</td><td class="source">      if ( (!request.type) || (!request.data) || (!request.url) ) {</td></tr><tr class="miss"><td class="line">1127</td><td class="hits">0</td><td class="source">        return cb(Error(&quot;The 1st argument as request object must have the properties .url, .data and .type&quot;), null);</td></tr><tr><td class="line">1128</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">1129</td><td class="hits">0</td><td class="source">      return Graph.request()[request.type](request.url, request.data, function(err, data, debug) {</td></tr><tr><td class="line">1130</td><td class="hits"></td><td class="source">        // transform to resultset</td></tr><tr class="miss"><td class="line">1131</td><td class="hits">0</td><td class="source">        data = {</td></tr><tr><td class="line">1132</td><td class="hits"></td><td class="source">          data: [ [ data ] ]</td></tr><tr><td class="line">1133</td><td class="hits"></td><td class="source">        };</td></tr><tr class="miss"><td class="line">1134</td><td class="hits">0</td><td class="source">        graph._processResult(err, data, debug, self, cb);</td></tr><tr><td class="line">1135</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">1136</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">1137</td><td class="hits">0</td><td class="source">      return cb(Error(&quot;First argument must be a string with the cypher query&quot;), null);</td></tr><tr><td class="line">1138</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">1139</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1140</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1141</td><td class="hits"></td><td class="source">  /*</td></tr><tr><td class="line">1142</td><td class="hits"></td><td class="source">   * Relationship methods</td></tr><tr><td class="line">1143</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">1144</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1145</td><td class="hits">8</td><td class="source">  Node.prototype.withRelations = function(relation, cb) {</td></tr><tr class="hit"><td class="line">1146</td><td class="hits">2</td><td class="source">    var self = this.singletonForQuery();</td></tr><tr class="hit"><td class="line">1147</td><td class="hits">2</td><td class="source">    self._query_history_.push({ withRelation: true });</td></tr><tr><td class="line">1148</td><td class="hits"></td><td class="source">    // we expect a string or an array</td></tr><tr class="hit"><td class="line">1149</td><td class="hits">2</td><td class="source">    self.cypher.segments.relationship = (typeof relation === 'string') ? relation : relation.join('|');</td></tr><tr class="hit"><td class="line">1150</td><td class="hits">2</td><td class="source">    self.cypher.segments.incoming = true;</td></tr><tr class="hit"><td class="line">1151</td><td class="hits">2</td><td class="source">    self.cypher.segments.outgoing = true;</td></tr><tr class="hit"><td class="line">1152</td><td class="hits">2</td><td class="source">    self.exec(cb);</td></tr><tr class="hit"><td class="line">1153</td><td class="hits">2</td><td class="source">    return self;</td></tr><tr><td class="line">1154</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1155</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1156</td><td class="hits">8</td><td class="source">  Node.prototype.incomingRelations = function(relation, cb) {</td></tr><tr class="hit"><td class="line">1157</td><td class="hits">18</td><td class="source">    var self = this.singletonForQuery();</td></tr><tr class="hit"><td class="line">1158</td><td class="hits">18</td><td class="source">    self._query_history_.push({ incomingRelationships: true }); // only as a ”flag”</td></tr><tr class="hit"><td class="line">1159</td><td class="hits">18</td><td class="source">    if (typeof relation !== 'function') {</td></tr><tr class="hit"><td class="line">1160</td><td class="hits">17</td><td class="source">      self.cypher.segments.relationship = relation;</td></tr><tr><td class="line">1161</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">1162</td><td class="hits">1</td><td class="source">      cb = relation;</td></tr><tr><td class="line">1163</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1164</td><td class="hits">18</td><td class="source">    self.cypher.segments.node_identifier = 'n';</td></tr><tr><td class="line">1165</td><td class="hits"></td><td class="source">    // self.cypher.segments.start = {};</td></tr><tr class="hit"><td class="line">1166</td><td class="hits">18</td><td class="source">    self.cypher.segments.start.n = 'node('+self._start_node_id('*')+')';</td></tr><tr class="hit"><td class="line">1167</td><td class="hits">18</td><td class="source">    if (self.cypher.segments.to &gt; 0)</td></tr><tr class="hit"><td class="line">1168</td><td class="hits">4</td><td class="source">      self.cypher.segments.start.m = 'node('+self._end_node_id('*')+')';</td></tr><tr class="hit"><td class="line">1169</td><td class="hits">18</td><td class="source">    self.cypher.segments.incoming = true;</td></tr><tr class="hit"><td class="line">1170</td><td class="hits">18</td><td class="source">    self.cypher.segments.outgoing = false;</td></tr><tr class="hit"><td class="line">1171</td><td class="hits">18</td><td class="source">    self.cypher.segments.return_properties = ['r'];</td></tr><tr class="hit"><td class="line">1172</td><td class="hits">18</td><td class="source">    self.exec(cb);</td></tr><tr class="hit"><td class="line">1173</td><td class="hits">18</td><td class="source">    return self; // return self for chaining</td></tr><tr><td class="line">1174</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1175</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1176</td><td class="hits">8</td><td class="source">  Node.prototype.outgoingRelations = function(relation, cb) {</td></tr><tr class="hit"><td class="line">1177</td><td class="hits">21</td><td class="source">    var self = this.singletonForQuery();</td></tr><tr class="hit"><td class="line">1178</td><td class="hits">21</td><td class="source">    self._query_history_.push({ outgoingRelationships: true }); // only as a ”flag”</td></tr><tr class="hit"><td class="line">1179</td><td class="hits">21</td><td class="source">    if (typeof relation !== 'function') {</td></tr><tr class="hit"><td class="line">1180</td><td class="hits">19</td><td class="source">      self.cypher.segments.relationship = relation;</td></tr><tr><td class="line">1181</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">1182</td><td class="hits">2</td><td class="source">      cb = relation;</td></tr><tr><td class="line">1183</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1184</td><td class="hits">21</td><td class="source">    self.cypher.segments.node_identifier = 'n';</td></tr><tr><td class="line">1185</td><td class="hits"></td><td class="source">    // self.cypher.segments.start = {};</td></tr><tr class="hit"><td class="line">1186</td><td class="hits">21</td><td class="source">    self.cypher.segments.start.n = 'node('+self._start_node_id('*')+')';</td></tr><tr class="hit"><td class="line">1187</td><td class="hits">21</td><td class="source">    if (self.cypher.segments.to &gt; 0)</td></tr><tr class="hit"><td class="line">1188</td><td class="hits">9</td><td class="source">      self.cypher.segments.start.m = 'node('+self._end_node_id('*')+')';</td></tr><tr class="hit"><td class="line">1189</td><td class="hits">21</td><td class="source">    self.cypher.segments.incoming = false;</td></tr><tr class="hit"><td class="line">1190</td><td class="hits">21</td><td class="source">    self.cypher.segments.outgoing = true;</td></tr><tr class="hit"><td class="line">1191</td><td class="hits">21</td><td class="source">    self.cypher.segments.return_properties = ['r'];</td></tr><tr class="hit"><td class="line">1192</td><td class="hits">21</td><td class="source">    self.exec(cb);</td></tr><tr class="hit"><td class="line">1193</td><td class="hits">21</td><td class="source">    return self; // return self for chaining</td></tr><tr><td class="line">1194</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1195</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1196</td><td class="hits">8</td><td class="source">  Node.prototype.incomingRelationsFrom = function(node, relation, cb) {</td></tr><tr class="hit"><td class="line">1197</td><td class="hits">6</td><td class="source">    var self = this.singletonForQuery();</td></tr><tr class="hit"><td class="line">1198</td><td class="hits">6</td><td class="source">    self._query_history_.push({ incomingRelationshipsFrom: true }); // only as a ”flag”</td></tr><tr class="hit"><td class="line">1199</td><td class="hits">6</td><td class="source">    self.cypher.segments.from = self.id || null;</td></tr><tr><td class="line">1200</td><td class="hits"></td><td class="source">    // node can be a number or a label string: `123` | `Person`</td></tr><tr class="hit"><td class="line">1201</td><td class="hits">6</td><td class="source">    self.cypher.segments.to = helpers.getIdFromObject(node) || node;</td></tr><tr class="hit"><td class="line">1202</td><td class="hits">6</td><td class="source">    if (typeof relation !== 'function')</td></tr><tr class="hit"><td class="line">1203</td><td class="hits">6</td><td class="source">      self.cypher.segments.relationship = relation;</td></tr><tr class="hit"><td class="line">1204</td><td class="hits">6</td><td class="source">    self.cypher.segments.return_properties = ['r'];</td></tr><tr class="hit"><td class="line">1205</td><td class="hits">6</td><td class="source">    return self.incomingRelations(relation, cb);</td></tr><tr><td class="line">1206</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1207</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1208</td><td class="hits">8</td><td class="source">  Node.prototype.outgoingRelationsTo = function(node, relation, cb) {</td></tr><tr class="hit"><td class="line">1209</td><td class="hits">10</td><td class="source">    var self = this.singletonForQuery();</td></tr><tr class="hit"><td class="line">1210</td><td class="hits">10</td><td class="source">    self._query_history_.push({ outgoingRelationshipsTo: true }); // only as a ”flag”</td></tr><tr><td class="line">1211</td><td class="hits"></td><td class="source">    // node can be a number or a label string: `123` | `Person`</td></tr><tr class="hit"><td class="line">1212</td><td class="hits">10</td><td class="source">    self.cypher.segments.to = helpers.getIdFromObject(node) || node;</td></tr><tr class="hit"><td class="line">1213</td><td class="hits">10</td><td class="source">    if (typeof relation !== 'function')</td></tr><tr class="hit"><td class="line">1214</td><td class="hits">9</td><td class="source">      self.cypher.segments.relationship = relation;</td></tr><tr class="hit"><td class="line">1215</td><td class="hits">10</td><td class="source">    self.cypher.segments.return_properties = ['r'];</td></tr><tr class="hit"><td class="line">1216</td><td class="hits">10</td><td class="source">    return self.outgoingRelations(relation, cb);</td></tr><tr><td class="line">1217</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1218</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1219</td><td class="hits">8</td><td class="source">  Node.prototype.allDirections = function(relation, cb) {</td></tr><tr class="miss"><td class="line">1220</td><td class="hits">0</td><td class="source">    var self = this.singletonForQuery();</td></tr><tr class="miss"><td class="line">1221</td><td class="hits">0</td><td class="source">    self._query_history_.push({ allDirections: true });</td></tr><tr class="miss"><td class="line">1222</td><td class="hits">0</td><td class="source">    if (typeof relation !== 'function')</td></tr><tr class="miss"><td class="line">1223</td><td class="hits">0</td><td class="source">      self.cypher.segments.relationship = relation;</td></tr><tr class="miss"><td class="line">1224</td><td class="hits">0</td><td class="source">    self.cypher.segments.node_identifier = 'n';</td></tr><tr class="miss"><td class="line">1225</td><td class="hits">0</td><td class="source">    self.cypher.segments.start.n = 'node('+self._start_node_id('*')+')';</td></tr><tr class="miss"><td class="line">1226</td><td class="hits">0</td><td class="source">    self.cypher.segments.start.m = 'node('+self._end_node_id('*')+')';</td></tr><tr class="miss"><td class="line">1227</td><td class="hits">0</td><td class="source">    self.cypher.segments.incoming = true;</td></tr><tr class="miss"><td class="line">1228</td><td class="hits">0</td><td class="source">    self.cypher.segments.outgoing = true;</td></tr><tr class="miss"><td class="line">1229</td><td class="hits">0</td><td class="source">    self.cypher.segments.return_properties = ['n', 'm', 'r'];</td></tr><tr class="miss"><td class="line">1230</td><td class="hits">0</td><td class="source">    self.exec(cb);</td></tr><tr class="miss"><td class="line">1231</td><td class="hits">0</td><td class="source">    return self; // return self for chaining</td></tr><tr><td class="line">1232</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1233</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1234</td><td class="hits">8</td><td class="source">  Node.prototype.relationsBetween = function(node, relation, cb) {</td></tr><tr class="miss"><td class="line">1235</td><td class="hits">0</td><td class="source">    var self = this.singletonForQuery();</td></tr><tr class="miss"><td class="line">1236</td><td class="hits">0</td><td class="source">    self._query_history_.push({ relationshipsBetween: true });</td></tr><tr class="miss"><td class="line">1237</td><td class="hits">0</td><td class="source">    self.cypher.segments.to = helpers.getIdFromObject(node) || node;</td></tr><tr class="miss"><td class="line">1238</td><td class="hits">0</td><td class="source">    if (typeof relation !== 'function')</td></tr><tr class="miss"><td class="line">1239</td><td class="hits">0</td><td class="source">      self.cypher.segments.relationship = relation;</td></tr><tr class="miss"><td class="line">1240</td><td class="hits">0</td><td class="source">    self.cypher.segments.return_properties = ['r'];</td></tr><tr class="miss"><td class="line">1241</td><td class="hits">0</td><td class="source">    self.exec(cb);</td></tr><tr class="miss"><td class="line">1242</td><td class="hits">0</td><td class="source">    return self.allDirections(relation, cb);</td></tr><tr><td class="line">1243</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1244</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1245</td><td class="hits">8</td><td class="source">  Node.prototype.allRelations = function(relation, cb) {</td></tr><tr class="hit"><td class="line">1246</td><td class="hits">10</td><td class="source">    var self = this.singletonForQuery();</td></tr><tr class="hit"><td class="line">1247</td><td class="hits">10</td><td class="source">    var label = (this.cypher.segments.label) ? ':'+this.cypher.segments.label : '';</td></tr><tr class="hit"><td class="line">1248</td><td class="hits">10</td><td class="source">    if (typeof relation === 'string') {</td></tr><tr class="hit"><td class="line">1249</td><td class="hits">2</td><td class="source">      relation = ':'+relation;</td></tr><tr><td class="line">1250</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">1251</td><td class="hits">8</td><td class="source">      cb = relation;</td></tr><tr class="hit"><td class="line">1252</td><td class="hits">8</td><td class="source">      relation = '';</td></tr><tr><td class="line">1253</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1254</td><td class="hits">10</td><td class="source">    self._query_history_.push({ allRelationships: true });</td></tr><tr class="hit"><td class="line">1255</td><td class="hits">10</td><td class="source">    self.cypher.segments.match = [ '(n'+label+')-[r'+relation+']-()' ];</td></tr><tr class="hit"><td class="line">1256</td><td class="hits">10</td><td class="source">    self.cypher.segments.return_properties = ['r'];</td></tr><tr class="hit"><td class="line">1257</td><td class="hits">10</td><td class="source">    self.exec(cb);</td></tr><tr class="hit"><td class="line">1258</td><td class="hits">10</td><td class="source">    return self; // return self for chaining</td></tr><tr><td class="line">1259</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1260</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1261</td><td class="hits">8</td><td class="source">  Node.prototype.limit = function(limit, cb) {</td></tr><tr class="hit"><td class="line">1262</td><td class="hits">11</td><td class="source">    this._query_history_.push({ LIMIT: limit });</td></tr><tr class="hit"><td class="line">1263</td><td class="hits">11</td><td class="source">    this.cypher.segments.limit = parseInt(limit);</td></tr><tr class="hit"><td class="line">1264</td><td class="hits">11</td><td class="source">    if (limit === NaN)</td></tr><tr class="miss"><td class="line">1265</td><td class="hits">0</td><td class="source">      throw Error('LIMIT must be an integer number');</td></tr><tr class="hit"><td class="line">1266</td><td class="hits">11</td><td class="source">    if (this.cypher.segments.action === 'DELETE')</td></tr><tr class="hit"><td class="line">1267</td><td class="hits">1</td><td class="source">      throw Error(&quot;You can't use a limit on a DELETE, use WHERE instead to specify your limit&quot;);</td></tr><tr class="hit"><td class="line">1268</td><td class="hits">10</td><td class="source">    this.exec(cb);</td></tr><tr class="hit"><td class="line">1269</td><td class="hits">10</td><td class="source">    return this; // return self for chaining</td></tr><tr><td class="line">1270</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1271</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1272</td><td class="hits">8</td><td class="source">  Node.prototype.skip = function(skip, cb) {</td></tr><tr class="hit"><td class="line">1273</td><td class="hits">6</td><td class="source">    this.cypher.segments.skip = parseInt(skip);</td></tr><tr class="hit"><td class="line">1274</td><td class="hits">6</td><td class="source">    if (skip === NaN)</td></tr><tr class="miss"><td class="line">1275</td><td class="hits">0</td><td class="source">      throw Error('SKIP must be an integer number');</td></tr><tr class="hit"><td class="line">1276</td><td class="hits">6</td><td class="source">    this._query_history_.push({ SKIP: this.cypher.segments.skip });</td></tr><tr class="hit"><td class="line">1277</td><td class="hits">6</td><td class="source">    this.exec(cb);</td></tr><tr class="hit"><td class="line">1278</td><td class="hits">6</td><td class="source">    return this; // return self for chaining</td></tr><tr><td class="line">1279</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1280</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1281</td><td class="hits">8</td><td class="source">  Node.prototype.distinct = function(cb, value) {</td></tr><tr class="hit"><td class="line">1282</td><td class="hits">4</td><td class="source">    if (typeof value !== 'boolean')</td></tr><tr class="hit"><td class="line">1283</td><td class="hits">2</td><td class="source">      value = true;</td></tr><tr class="hit"><td class="line">1284</td><td class="hits">4</td><td class="source">    this.cypher.segments._distinct = value;</td></tr><tr class="hit"><td class="line">1285</td><td class="hits">4</td><td class="source">    this._query_history_.push({ dictinct: value });</td></tr><tr class="hit"><td class="line">1286</td><td class="hits">4</td><td class="source">    this.exec(cb);</td></tr><tr class="hit"><td class="line">1287</td><td class="hits">4</td><td class="source">    return this; // return self for chaining</td></tr><tr><td class="line">1288</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1289</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1290</td><td class="hits">8</td><td class="source">  Node.prototype.orderBy = function(property, cb, identifier) {</td></tr><tr class="hit"><td class="line">1291</td><td class="hits">8</td><td class="source">    var direction = '';</td></tr><tr class="hit"><td class="line">1292</td><td class="hits">8</td><td class="source">    if (typeof property === 'object') {</td></tr><tr class="hit"><td class="line">1293</td><td class="hits">8</td><td class="source">      var key = Object.keys(property)[0];</td></tr><tr class="hit"><td class="line">1294</td><td class="hits">8</td><td class="source">      cb = direction;</td></tr><tr class="hit"><td class="line">1295</td><td class="hits">8</td><td class="source">      direction = property[key];</td></tr><tr class="hit"><td class="line">1296</td><td class="hits">8</td><td class="source">      property = key;</td></tr><tr class="hit"><td class="line">1297</td><td class="hits">8</td><td class="source">      if ( (typeof direction === 'string') &amp;&amp; ((/^(ASC|DESC)$/).test(direction)) ) {</td></tr><tr class="hit"><td class="line">1298</td><td class="hits">8</td><td class="source">        this.cypher.segments.order_direction = direction;</td></tr><tr><td class="line">1299</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">1300</td><td class="hits">0</td><td class="source">    } else if (typeof property === 'string') {</td></tr><tr><td class="line">1301</td><td class="hits"></td><td class="source">      // custom statement, no process at all</td></tr><tr><td class="line">1302</td><td class="hits"></td><td class="source">      // we use 1:1 the string</td></tr><tr class="miss"><td class="line">1303</td><td class="hits">0</td><td class="source">      this.cypher.segments.order_by = property;</td></tr><tr class="miss"><td class="line">1304</td><td class="hits">0</td><td class="source">    } else if (typeof cb === 'string') {</td></tr><tr class="miss"><td class="line">1305</td><td class="hits">0</td><td class="source">      identifier = cb;</td></tr><tr class="miss"><td class="line">1306</td><td class="hits">0</td><td class="source">      cb = null;</td></tr><tr><td class="line">1307</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1308</td><td class="hits">8</td><td class="source">    if (typeof identifier === 'undefined')</td></tr><tr class="hit"><td class="line">1309</td><td class="hits">8</td><td class="source">      identifier = this.__TYPE_IDENTIFIER__;</td></tr><tr class="hit"><td class="line">1310</td><td class="hits">8</td><td class="source">    if ((typeof identifier === 'string') &amp;&amp; (/^[nmr]$/i.test(identifier))) {</td></tr><tr class="hit"><td class="line">1311</td><td class="hits">16</td><td class="source">      if (identifier === 'n') this.whereNodeHasProperty(property);</td></tr><tr class="hit"><td class="line">1312</td><td class="hits">8</td><td class="source">      if (identifier === 'm') this.whereEndNodeHasProperty(property);</td></tr><tr class="hit"><td class="line">1313</td><td class="hits">8</td><td class="source">      if (identifier === 'r') this.whereRelationshipHasProperty(property);</td></tr><tr><td class="line">1314</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">1315</td><td class="hits">0</td><td class="source">      identifier = null;</td></tr><tr><td class="line">1316</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">1317</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1318</td><td class="hits">8</td><td class="source">    if (identifier) {</td></tr><tr><td class="line">1319</td><td class="hits"></td><td class="source">      // s.th. like ORDER BY n.`name` ASC</td></tr><tr><td class="line">1320</td><td class="hits"></td><td class="source">      // escape property</td></tr><tr class="hit"><td class="line">1321</td><td class="hits">8</td><td class="source">      this.cypher.segments.order_by = identifier + &quot;.`&quot;+property+&quot;`&quot;;</td></tr><tr><td class="line">1322</td><td class="hits"></td><td class="source">    } else {</td></tr><tr><td class="line">1323</td><td class="hits"></td><td class="source">      // s.th. like ORDER BY n.name ASC</td></tr><tr class="miss"><td class="line">1324</td><td class="hits">0</td><td class="source">      this.cypher.segments.order_by = property;</td></tr><tr><td class="line">1325</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1326</td><td class="hits">8</td><td class="source">    this._query_history_.push({ ORDER_BY: this.cypher.segments.order_by });</td></tr><tr class="hit"><td class="line">1327</td><td class="hits">8</td><td class="source">    this.exec(cb);</td></tr><tr class="hit"><td class="line">1328</td><td class="hits">8</td><td class="source">    return this; // return self for chaining</td></tr><tr><td class="line">1329</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1330</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1331</td><td class="hits">8</td><td class="source">  Node.prototype.orderNodeBy = function(property, direction, cb) {</td></tr><tr class="hit"><td class="line">1332</td><td class="hits">2</td><td class="source">    return this.orderBy(property, direction, cb, 'n');</td></tr><tr><td class="line">1333</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1334</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1335</td><td class="hits">8</td><td class="source">  Node.prototype.orderStartNodeBy = function(property, direction, cb) {</td></tr><tr class="miss"><td class="line">1336</td><td class="hits">0</td><td class="source">    return this.orderNodeBy(property, direction, cb);</td></tr><tr><td class="line">1337</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1338</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1339</td><td class="hits">8</td><td class="source">  Node.prototype.orderEndNodeBy = function(property, direction, cb) {</td></tr><tr class="miss"><td class="line">1340</td><td class="hits">0</td><td class="source">    return this.orderBy(property, direction, cb, 'm');</td></tr><tr><td class="line">1341</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1342</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1343</td><td class="hits">8</td><td class="source">  Node.prototype.orderRelationshipBy = function(property, direction, cb) {</td></tr><tr class="miss"><td class="line">1344</td><td class="hits">0</td><td class="source">    return this.orderBy(property, direction, cb, 'r');</td></tr><tr><td class="line">1345</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1346</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1347</td><td class="hits"></td><td class="source">  // ### Adds a string to the MATCH statement</td></tr><tr><td class="line">1348</td><td class="hits"></td><td class="source">  // e.g.: 'p:PERSON-[:KNOWS|:FOLLOWS]-&gt;a:Actor-[:ACTS]-&gt;m'</td></tr><tr class="hit"><td class="line">1349</td><td class="hits">8</td><td class="source">  Node.prototype.match = function(string, cb) {</td></tr><tr><td class="line">1350</td><td class="hits"></td><td class="source">    // we guess that we match a node if we have s.th. like `n(:Person)`</td></tr><tr class="hit"><td class="line">1351</td><td class="hits">6</td><td class="source">    if (/^n(\:[a-zA-Z]+)*$/.test(string))</td></tr><tr class="hit"><td class="line">1352</td><td class="hits">4</td><td class="source">      string = '('+string+')';</td></tr><tr class="hit"><td class="line">1353</td><td class="hits">6</td><td class="source">    this._query_history_.push({ MATCH: string });</td></tr><tr class="hit"><td class="line">1354</td><td class="hits">6</td><td class="source">    this.cypher.segments.match.push(string);</td></tr><tr class="hit"><td class="line">1355</td><td class="hits">6</td><td class="source">    this.exec(cb);</td></tr><tr class="hit"><td class="line">1356</td><td class="hits">6</td><td class="source">    return this; // return self for chaining</td></tr><tr><td class="line">1357</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1358</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1359</td><td class="hits"></td><td class="source">  // ### Adds s.th. to the RETURN statement</td></tr><tr><td class="line">1360</td><td class="hits"></td><td class="source">  // Can be a string or an array</td></tr><tr><td class="line">1361</td><td class="hits"></td><td class="source">  // e.g. as string:  'award.name AS Award, awardee.name AS WonBy'</td></tr><tr><td class="line">1362</td><td class="hits"></td><td class="source">  // e.g. as array: [ 'award.name AS Award', 'awardee.name AS WonBy' ]</td></tr><tr class="hit"><td class="line">1363</td><td class="hits">8</td><td class="source">  Node.prototype.return = function(returnStatement, cb, options) {</td></tr><tr class="hit"><td class="line">1364</td><td class="hits">6</td><td class="source">    if (typeof options === 'undefined')</td></tr><tr class="hit"><td class="line">1365</td><td class="hits">6</td><td class="source">      options = { add: false };</td></tr><tr class="hit"><td class="line">1366</td><td class="hits">6</td><td class="source">    if (!options.add)</td></tr><tr class="hit"><td class="line">1367</td><td class="hits">6</td><td class="source">      this.cypher.segments.return_properties = [];</td></tr><tr class="hit"><td class="line">1368</td><td class="hits">6</td><td class="source">    if (returnStatement) {</td></tr><tr class="hit"><td class="line">1369</td><td class="hits">6</td><td class="source">      this.cypher.segments.return_properties = this.cypher.segments.return_properties.concat(</td></tr><tr><td class="line">1370</td><td class="hits"></td><td class="source">        (returnStatement.constructor === Array) ? returnStatement : returnStatement.split(', ')</td></tr><tr><td class="line">1371</td><td class="hits"></td><td class="source">      );</td></tr><tr class="hit"><td class="line">1372</td><td class="hits">6</td><td class="source">      this._query_history_.push({ RETURN: this.cypher.segments.return_properties });</td></tr><tr><td class="line">1373</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1374</td><td class="hits">6</td><td class="source">    this.exec(cb);</td></tr><tr class="hit"><td class="line">1375</td><td class="hits">6</td><td class="source">    return this; // return self for chaining</td></tr><tr><td class="line">1376</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1377</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1378</td><td class="hits"></td><td class="source">  // ### Sets or resets the START statement</td></tr><tr class="hit"><td class="line">1379</td><td class="hits">8</td><td class="source">  Node.prototype.start = function(start, cb) {</td></tr><tr class="hit"><td class="line">1380</td><td class="hits">2</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">1381</td><td class="hits">2</td><td class="source">    if (!self._is_singleton_)</td></tr><tr class="miss"><td class="line">1382</td><td class="hits">0</td><td class="source">      self = this.singleton(undefined, this);</td></tr><tr class="hit"><td class="line">1383</td><td class="hits">2</td><td class="source">    if (self.label)</td></tr><tr class="miss"><td class="line">1384</td><td class="hits">0</td><td class="source">      self.withLabel(self.label);</td></tr><tr><td class="line">1385</td><td class="hits"></td><td class="source">    //self.resetQuery();</td></tr><tr class="hit"><td class="line">1386</td><td class="hits">2</td><td class="source">    if (typeof start !== 'string')</td></tr><tr class="hit"><td class="line">1387</td><td class="hits">2</td><td class="source">      self.cypher.segments.start = null;</td></tr><tr><td class="line">1388</td><td class="hits"></td><td class="source">    else</td></tr><tr class="miss"><td class="line">1389</td><td class="hits">0</td><td class="source">      self.cypher.segments.start = start;</td></tr><tr class="hit"><td class="line">1390</td><td class="hits">2</td><td class="source">    self._query_history_.push({ START: self.cypher.start });</td></tr><tr class="hit"><td class="line">1391</td><td class="hits">2</td><td class="source">    self.exec(cb);</td></tr><tr class="hit"><td class="line">1392</td><td class="hits">2</td><td class="source">    return self; // return self for chaining</td></tr><tr><td class="line">1393</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1394</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1395</td><td class="hits">8</td><td class="source">  Node.prototype.where = function(where, cb, options) {</td></tr><tr class="hit"><td class="line">1396</td><td class="hits">49</td><td class="source">    if (_.isObject(where)) {</td></tr><tr class="hit"><td class="line">1397</td><td class="hits">44</td><td class="source">      if (Object.keys(where).length === 0) {</td></tr><tr><td class="line">1398</td><td class="hits"></td><td class="source">        // return here</td></tr><tr class="miss"><td class="line">1399</td><td class="hits">0</td><td class="source">        this.exec(cb);</td></tr><tr class="miss"><td class="line">1400</td><td class="hits">0</td><td class="source">        return this;</td></tr><tr><td class="line">1401</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">1402</td><td class="hits">44</td><td class="source">      if (!_.isArray(where))</td></tr><tr class="hit"><td class="line">1403</td><td class="hits">41</td><td class="source">        where = [ where ];</td></tr><tr><td class="line">1404</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">1405</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1406</td><td class="hits">49</td><td class="source">    if (typeof options === 'undefined')</td></tr><tr class="hit"><td class="line">1407</td><td class="hits">43</td><td class="source">      options = {};</td></tr><tr class="hit"><td class="line">1408</td><td class="hits">49</td><td class="source">    if (typeof options.identifier !== 'string')</td></tr><tr><td class="line">1409</td><td class="hits"></td><td class="source">      // good or bad idea that we use by default n as identifier?</td></tr><tr class="hit"><td class="line">1410</td><td class="hits">43</td><td class="source">      options.identifier = 'n';</td></tr><tr><td class="line">1411</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1412</td><td class="hits"></td><td class="source">    // add identifier to return properties if not exists already</td></tr><tr class="hit"><td class="line">1413</td><td class="hits">49</td><td class="source">    if (_.indexOf(this.cypher.segments.return_properties, options.identifier) === -1)</td></tr><tr class="hit"><td class="line">1414</td><td class="hits">23</td><td class="source">      this.cypher.segments.return_properties.push(options.identifier);</td></tr><tr><td class="line">1415</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1416</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1417</td><td class="hits">49</td><td class="source">    if (this.cypher.segments.start) {</td></tr><tr class="hit"><td class="line">1418</td><td class="hits">49</td><td class="source">      if (!this.cypher.segments.start.n)</td></tr><tr class="hit"><td class="line">1419</td><td class="hits">42</td><td class="source">        this.cypher.segments.start.n = 'node(*)';</td></tr><tr class="hit"><td class="line">1420</td><td class="hits">49</td><td class="source">      if (this.cypher.segments.start.m)</td></tr><tr class="hit"><td class="line">1421</td><td class="hits">4</td><td class="source">        this.cypher.segments.start.m = 'node(*)';</td></tr><tr class="hit"><td class="line">1422</td><td class="hits">49</td><td class="source">      if (options.identifier === 'r')</td></tr><tr class="hit"><td class="line">1423</td><td class="hits">4</td><td class="source">        this.cypher.segments.start.r = 'relationship(*)';</td></tr><tr><td class="line">1424</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">1425</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1426</td><td class="hits"></td><td class="source">    // use parameters for query or send an ordinary string?</td></tr><tr><td class="line">1427</td><td class="hits"></td><td class="source">    // http://docs.neo4j.org/chunked/stable/rest-api-cypher.html</td></tr><tr class="hit"><td class="line">1428</td><td class="hits">49</td><td class="source">    if (typeof options.valuesToParameters === 'undefined')</td></tr><tr class="hit"><td class="line">1429</td><td class="hits">49</td><td class="source">      options.valuesToParameters = Boolean(this.cypher.useParameters);</td></tr><tr><td class="line">1430</td><td class="hits"></td><td class="source">    // if already parameters are added, starting with {_value#i_} instead of {_value0_}</td></tr><tr class="hit"><td class="line">1431</td><td class="hits">49</td><td class="source">    if ((this.cypher.parameters)&amp;&amp;(this.cypher.parameters.length &gt; 0))</td></tr><tr class="miss"><td class="line">1432</td><td class="hits">0</td><td class="source">      options.parametersStartCountAt = this.cypher.parameters.length;</td></tr><tr class="hit"><td class="line">1433</td><td class="hits">49</td><td class="source">    var condition = new ConditionalParameters(_.extend(where), options);</td></tr><tr class="hit"><td class="line">1434</td><td class="hits">49</td><td class="source">    var whereCondition = condition.toString();</td></tr><tr class="hit"><td class="line">1435</td><td class="hits">49</td><td class="source">    this.cypher.segments.where.push(whereCondition);</td></tr><tr class="hit"><td class="line">1436</td><td class="hits">49</td><td class="source">    if ((options.valuesToParameters) &amp;&amp; (condition.hasParameters()))</td></tr><tr class="hit"><td class="line">1437</td><td class="hits">27</td><td class="source">      this._addParametersToCypher(condition.values());</td></tr><tr class="hit"><td class="line">1438</td><td class="hits">49</td><td class="source">    this._query_history_.push({ WHERE: whereCondition });</td></tr><tr><td class="line">1439</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1440</td><td class="hits">49</td><td class="source">    this.exec(cb);</td></tr><tr class="hit"><td class="line">1441</td><td class="hits">49</td><td class="source">    return this; // return self for chaining</td></tr><tr><td class="line">1442</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1443</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1444</td><td class="hits">8</td><td class="source">  Node.prototype.whereStartNode = function(where, cb) {</td></tr><tr class="miss"><td class="line">1445</td><td class="hits">0</td><td class="source">    return this.where(where, cb, { identifier: 'n' });</td></tr><tr><td class="line">1446</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1447</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1448</td><td class="hits">8</td><td class="source">  Node.prototype.whereEndNode = function(where, cb) {</td></tr><tr class="miss"><td class="line">1449</td><td class="hits">0</td><td class="source">    return this.where(where, cb, { identifier: 'm' });</td></tr><tr><td class="line">1450</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1451</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1452</td><td class="hits">8</td><td class="source">  Node.prototype.whereNode = function(where, cb) {</td></tr><tr class="hit"><td class="line">1453</td><td class="hits">2</td><td class="source">    return this.where(where, cb, { identifier: 'n' });</td></tr><tr><td class="line">1454</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1455</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1456</td><td class="hits">8</td><td class="source">  Node.prototype.whereRelationship = function(where, cb) {</td></tr><tr class="hit"><td class="line">1457</td><td class="hits">4</td><td class="source">    return this.where(where, cb, { identifier: 'r' });</td></tr><tr><td class="line">1458</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1459</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1460</td><td class="hits">8</td><td class="source">  Node.prototype.whereRelation = function(where, cb) {</td></tr><tr class="miss"><td class="line">1461</td><td class="hits">0</td><td class="source">    return this.whereRelationship(where, cb);</td></tr><tr><td class="line">1462</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1463</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1464</td><td class="hits">8</td><td class="source">  Node.prototype.whereHasProperty = function(property, identifier, cb) {</td></tr><tr class="miss"><td class="line">1465</td><td class="hits">0</td><td class="source">    return this.andHasProperty(property, identifier, cb);</td></tr><tr><td class="line">1466</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1467</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1468</td><td class="hits">8</td><td class="source">  Node.prototype.andHasProperty = function(property, identifier, cb) {</td></tr><tr class="hit"><td class="line">1469</td><td class="hits">10</td><td class="source">    if (_.isFunction(identifier)) {</td></tr><tr class="miss"><td class="line">1470</td><td class="hits">0</td><td class="source">      cb = identifier;</td></tr><tr class="miss"><td class="line">1471</td><td class="hits">0</td><td class="source">      identifier = null;</td></tr><tr><td class="line">1472</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1473</td><td class="hits">10</td><td class="source">    if (typeof property !== 'string') {</td></tr><tr><td class="line">1474</td><td class="hits"></td><td class="source">      // we need a property to proceed</td></tr><tr class="miss"><td class="line">1475</td><td class="hits">0</td><td class="source">      return cb(Error('Property name is mandatory.'),null);</td></tr><tr><td class="line">1476</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1477</td><td class="hits">10</td><td class="source">    if (/^[nmr]\./.test(property))</td></tr><tr><td class="line">1478</td><td class="hits"></td><td class="source">      // remove identifier</td></tr><tr class="miss"><td class="line">1479</td><td class="hits">0</td><td class="source">      property = property.replace(/^[nmr]\./,'')</td></tr><tr><td class="line">1480</td><td class="hits"></td><td class="source">    // if NOT default to true/false, no property condition is needed</td></tr><tr class="hit"><td class="line">1481</td><td class="hits">10</td><td class="source">    if (!/[\!\?]$/.test(property)) {</td></tr><tr class="hit"><td class="line">1482</td><td class="hits">10</td><td class="source">      if (this.cypher.segments.return_properties.length === 0) {</td></tr><tr class="miss"><td class="line">1483</td><td class="hits">0</td><td class="source">        this.findAll();</td></tr><tr><td class="line">1484</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">1485</td><td class="hits"></td><td class="source">      // no identifier found, guessing from return properties</td></tr><tr class="hit"><td class="line">1486</td><td class="hits">10</td><td class="source">      if (typeof identifier !== 'string')</td></tr><tr class="hit"><td class="line">1487</td><td class="hits">2</td><td class="source">        identifier = this.cypher.segments.return_properties[this.cypher.segments.return_properties.length-1];</td></tr><tr class="hit"><td class="line">1488</td><td class="hits">10</td><td class="source">      this.cypher.segments.hasProperty.push(identifier+'.`'+property+'`');</td></tr><tr class="hit"><td class="line">1489</td><td class="hits">10</td><td class="source">      this._query_history_.push({ HAS: { identifier: identifier, property: property }});</td></tr><tr><td class="line">1490</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1491</td><td class="hits">10</td><td class="source">    this.exec(cb);</td></tr><tr class="hit"><td class="line">1492</td><td class="hits">10</td><td class="source">    return this; // return self for chaining</td></tr><tr><td class="line">1493</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1494</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1495</td><td class="hits">8</td><td class="source">  Node.prototype.whereNodeHasProperty = function(property, cb) {</td></tr><tr class="hit"><td class="line">1496</td><td class="hits">8</td><td class="source">    return this.andHasProperty(property, 'n', cb);</td></tr><tr><td class="line">1497</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1498</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1499</td><td class="hits">8</td><td class="source">  Node.prototype.whereStartNodeHasProperty = function(property, cb) {</td></tr><tr class="miss"><td class="line">1500</td><td class="hits">0</td><td class="source">    return this.andHasProperty(property, 'n', cb);</td></tr><tr><td class="line">1501</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1502</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1503</td><td class="hits">8</td><td class="source">  Node.prototype.whereEndNodeHasProperty = function(property, cb) {</td></tr><tr class="miss"><td class="line">1504</td><td class="hits">0</td><td class="source">    return this.andHasProperty(property, 'm', cb);</td></tr><tr><td class="line">1505</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1506</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1507</td><td class="hits">8</td><td class="source">  Node.prototype.whereRelationshipHasProperty = function(property, cb) {</td></tr><tr class="miss"><td class="line">1508</td><td class="hits">0</td><td class="source">    return this.andHasProperty(property, 'r', cb);</td></tr><tr><td class="line">1509</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1510</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1511</td><td class="hits">8</td><td class="source">  Node.prototype.delete = function(cb) {</td></tr><tr class="hit"><td class="line">1512</td><td class="hits">18</td><td class="source">    if (this.hasId()) {</td></tr><tr class="miss"><td class="line">1513</td><td class="hits">0</td><td class="source">      throw Error('To delete a node, use remove(). delete() is for queries');</td></tr><tr><td class="line">1514</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1515</td><td class="hits">18</td><td class="source">    if (this.cypher.segments.limit) {</td></tr><tr class="hit"><td class="line">1516</td><td class="hits">1</td><td class="source">      throw Error(&quot;You can't use a limit on a DELETE, use WHERE instead to specify your limit&quot;);</td></tr><tr><td class="line">1517</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1518</td><td class="hits">17</td><td class="source">    this._query_history_.push({ DELETE: true });</td></tr><tr class="hit"><td class="line">1519</td><td class="hits">17</td><td class="source">    this.cypher.segments.action = 'DELETE';</td></tr><tr class="hit"><td class="line">1520</td><td class="hits">17</td><td class="source">    return this.exec(cb);</td></tr><tr><td class="line">1521</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1522</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1523</td><td class="hits">8</td><td class="source">  Node.prototype.deleteIncludingRelations = function(cb) {</td></tr><tr class="hit"><td class="line">1524</td><td class="hits">8</td><td class="source">    var label = (this.label) ? &quot;:&quot;+this.label : &quot;&quot;;</td></tr><tr class="hit"><td class="line">1525</td><td class="hits">8</td><td class="source">    if (Object.keys(this.cypher.segments.start).length &lt; 1) {</td></tr><tr class="hit"><td class="line">1526</td><td class="hits">8</td><td class="source">      this.cypher.segments.start[this.__TYPE_IDENTIFIER__] = this.__TYPE__+&quot;(*)&quot;;</td></tr><tr><td class="line">1527</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1528</td><td class="hits">8</td><td class="source">    this.cypher._optionalMatch = true;</td></tr><tr class="hit"><td class="line">1529</td><td class="hits">8</td><td class="source">    this.cypher.segments.match = [ '('+this.__TYPE_IDENTIFIER__+label+&quot;)-[r]-()&quot; ];</td></tr><tr class="hit"><td class="line">1530</td><td class="hits">8</td><td class="source">    this.cypher.segments.return_properties = [ &quot;n&quot;, &quot;r&quot; ];</td></tr><tr class="hit"><td class="line">1531</td><td class="hits">8</td><td class="source">    return this.delete(cb);</td></tr><tr><td class="line">1532</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1533</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1534</td><td class="hits">8</td><td class="source">  Node.prototype.remove = function(cb) {</td></tr><tr class="hit"><td class="line">1535</td><td class="hits">18</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">1536</td><td class="hits">18</td><td class="source">    this.onBeforeRemove(function(/*err*/) {</td></tr><tr class="hit"><td class="line">1537</td><td class="hits">18</td><td class="source">      if (self._is_singleton_)</td></tr><tr class="miss"><td class="line">1538</td><td class="hits">0</td><td class="source">        return cb(Error(&quot;To delete results of a query use delete(). remove() is for removing an instanced &quot;+this.__TYPE__),null);</td></tr><tr class="hit"><td class="line">1539</td><td class="hits">18</td><td class="source">      if (self.hasId()) {</td></tr><tr class="hit"><td class="line">1540</td><td class="hits">18</td><td class="source">        return Graph.start('n = node({id}) DELETE n', { id: self.id }, cb);</td></tr><tr><td class="line">1541</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">1542</td><td class="hits"></td><td class="source">    })</td></tr><tr class="hit"><td class="line">1543</td><td class="hits">18</td><td class="source">    return this;</td></tr><tr><td class="line">1544</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1545</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1546</td><td class="hits">25</td><td class="source">  Node.prototype.onBeforeRemove = function(next) { next(null,null); }</td></tr><tr><td class="line">1547</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1548</td><td class="hits"></td><td class="source">  // was mistakenly called `removeWithRelationships`, so it is renamed</td></tr><tr class="hit"><td class="line">1549</td><td class="hits">8</td><td class="source">  Node.prototype.removeIncludingRelations = function(cb) {</td></tr><tr class="hit"><td class="line">1550</td><td class="hits">6</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">1551</td><td class="hits">6</td><td class="source">    return this.removeAllRelations(function(err) {</td></tr><tr class="hit"><td class="line">1552</td><td class="hits">6</td><td class="source">      if (err)</td></tr><tr class="miss"><td class="line">1553</td><td class="hits">0</td><td class="source">        return cb(err, null);</td></tr><tr><td class="line">1554</td><td class="hits"></td><td class="source">      else // remove now node</td></tr><tr class="hit"><td class="line">1555</td><td class="hits">6</td><td class="source">        return self.remove(cb);</td></tr><tr><td class="line">1556</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">1557</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1558</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1559</td><td class="hits">8</td><td class="source">  Node.prototype.removeOutgoingRelations = function(type, cb) {</td></tr><tr class="miss"><td class="line">1560</td><td class="hits">0</td><td class="source">    return this.removeRelations(type, cb, { direction: '-&gt;' });</td></tr><tr><td class="line">1561</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">1562</td><td class="hits">8</td><td class="source">  Node.prototype.removeIncomingRelations = function(type, cb) {</td></tr><tr class="miss"><td class="line">1563</td><td class="hits">0</td><td class="source">    return this.removeRelations(type, cb, { direction: '&lt;-' });</td></tr><tr><td class="line">1564</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1565</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1566</td><td class="hits">8</td><td class="source">  Node.prototype.removeAllRelations = function(cb) {</td></tr><tr class="hit"><td class="line">1567</td><td class="hits">6</td><td class="source">    return this.removeRelations('', cb);</td></tr><tr><td class="line">1568</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1569</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1570</td><td class="hits">8</td><td class="source">  Node.prototype.removeRelations = function(type, cb, _options) {</td></tr><tr class="hit"><td class="line">1571</td><td class="hits">6</td><td class="source">    if (typeof type === 'function') {</td></tr><tr class="miss"><td class="line">1572</td><td class="hits">0</td><td class="source">      _options = cb;</td></tr><tr class="miss"><td class="line">1573</td><td class="hits">0</td><td class="source">      cb = type;</td></tr><tr class="miss"><td class="line">1574</td><td class="hits">0</td><td class="source">      type = null;</td></tr><tr><td class="line">1575</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1576</td><td class="hits">6</td><td class="source">    var defaultOptions = {</td></tr><tr><td class="line">1577</td><td class="hits"></td><td class="source">      direction: 'all', // incoming / outgoing</td></tr><tr><td class="line">1578</td><td class="hits"></td><td class="source">      type: type,</td></tr><tr><td class="line">1579</td><td class="hits"></td><td class="source">      endNodeId: null</td></tr><tr><td class="line">1580</td><td class="hits"></td><td class="source">    };</td></tr><tr class="hit"><td class="line">1581</td><td class="hits">6</td><td class="source">    if (typeof _options === 'undefined') {</td></tr><tr class="hit"><td class="line">1582</td><td class="hits">6</td><td class="source">      _options = _.extend({},defaultOptions);</td></tr><tr><td class="line">1583</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">1584</td><td class="hits">0</td><td class="source">      _options = _.extend({},defaultOptions,_options);</td></tr><tr><td class="line">1585</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1586</td><td class="hits">6</td><td class="source">    if ((this.hasId())&amp;&amp;(typeof cb === 'function')) {</td></tr><tr class="hit"><td class="line">1587</td><td class="hits">6</td><td class="source">      var direction = _options.direction;</td></tr><tr class="hit"><td class="line">1588</td><td class="hits">6</td><td class="source">      if ( (!(direction === 'incoming')) || (!(direction === 'outgoing')) )</td></tr><tr class="hit"><td class="line">1589</td><td class="hits">6</td><td class="source">        direction = 'all';</td></tr><tr class="hit"><td class="line">1590</td><td class="hits">6</td><td class="source">      Node.findById(this.id)[direction+'Relations']().delete(cb);</td></tr><tr><td class="line">1591</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">1592</td><td class="hits">0</td><td class="source">      cb(Error(&quot;You can remove relationships only from an instanced node /w a valid cb&quot;), null);</td></tr><tr><td class="line">1593</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1594</td><td class="hits">6</td><td class="source">    return this;</td></tr><tr><td class="line">1595</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1596</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1597</td><td class="hits">8</td><td class="source">  Node.prototype.createRelation = function(options, cb) {</td></tr><tr class="hit"><td class="line">1598</td><td class="hits">32</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">1599</td><td class="hits">32</td><td class="source">    options = _.extend({</td></tr><tr><td class="line">1600</td><td class="hits"></td><td class="source">      from_id: this._id_,</td></tr><tr><td class="line">1601</td><td class="hits"></td><td class="source">      to_id: null,</td></tr><tr><td class="line">1602</td><td class="hits"></td><td class="source">      type: null,</td></tr><tr><td class="line">1603</td><td class="hits"></td><td class="source">      // unique: false ,// TODO: implement!</td></tr><tr><td class="line">1604</td><td class="hits"></td><td class="source">      properties: null,</td></tr><tr><td class="line">1605</td><td class="hits"></td><td class="source">      distinct: null</td></tr><tr><td class="line">1606</td><td class="hits"></td><td class="source">    }, options);</td></tr><tr class="hit"><td class="line">1607</td><td class="hits">32</td><td class="source">    if (typeof options.type !== 'string')</td></tr><tr class="hit"><td class="line">1608</td><td class="hits">2</td><td class="source">      throw Error(&quot;You have to give the type of relationship, e.g. 'knows|follows'&quot;);</td></tr><tr class="hit"><td class="line">1609</td><td class="hits">30</td><td class="source">    if (options.properties)</td></tr><tr class="hit"><td class="line">1610</td><td class="hits">30</td><td class="source">      options.properties = helpers.flattenObject(options.properties);</td></tr><tr class="hit"><td class="line">1611</td><td class="hits">30</td><td class="source">    if ((_.isNumber(options.from_id))&amp;&amp;(_.isNumber(options.to_id))&amp;&amp;(typeof cb === 'function')) {</td></tr><tr class="hit"><td class="line">1612</td><td class="hits">30</td><td class="source">      if (options.distinct) {</td></tr><tr class="hit"><td class="line">1613</td><td class="hits">5</td><td class="source">        Node.findById(options.from_id).outgoingRelationsTo(options.to_id, options.type, function(err, result) {</td></tr><tr class="hit"><td class="line">1614</td><td class="hits">5</td><td class="source">          if (err)</td></tr><tr class="miss"><td class="line">1615</td><td class="hits">0</td><td class="source">            return cb(err, result);</td></tr><tr class="hit"><td class="line">1616</td><td class="hits">5</td><td class="source">          if ((result) &amp;&amp; (result.length === 1)) {</td></tr><tr><td class="line">1617</td><td class="hits"></td><td class="source">            // if we have only one relationship, we update this one</td></tr><tr class="hit"><td class="line">1618</td><td class="hits">2</td><td class="source">            Node.Relationship.findById(result[0].id, function(err, relationship){</td></tr><tr class="hit"><td class="line">1619</td><td class="hits">2</td><td class="source">              if (relationship) {</td></tr><tr class="hit"><td class="line">1620</td><td class="hits">2</td><td class="source">                if (options.properties)</td></tr><tr class="hit"><td class="line">1621</td><td class="hits">2</td><td class="source">                  relationship.data = options.properties;</td></tr><tr class="hit"><td class="line">1622</td><td class="hits">2</td><td class="source">                if (options.type)</td></tr><tr class="hit"><td class="line">1623</td><td class="hits">2</td><td class="source">                  relationship.type = options.type;</td></tr><tr class="hit"><td class="line">1624</td><td class="hits">2</td><td class="source">                relationship.save(cb);</td></tr><tr><td class="line">1625</td><td class="hits"></td><td class="source">              } else {</td></tr><tr class="miss"><td class="line">1626</td><td class="hits">0</td><td class="source">                cb(err, relationship);</td></tr><tr><td class="line">1627</td><td class="hits"></td><td class="source">              }</td></tr><tr><td class="line">1628</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1629</td><td class="hits"></td><td class="source">          } else {</td></tr><tr><td class="line">1630</td><td class="hits"></td><td class="source">            // we create a new one</td></tr><tr class="hit"><td class="line">1631</td><td class="hits">3</td><td class="source">            Node.Relationship.create(options.type, options.properties, options.from_id, options.to_id, cb);</td></tr><tr class="hit"><td class="line">1632</td><td class="hits">3</td><td class="source">            return self;</td></tr><tr><td class="line">1633</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">1634</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">1635</td><td class="hits"></td><td class="source">      } else {</td></tr><tr><td class="line">1636</td><td class="hits"></td><td class="source">        // create relationship</td></tr><tr class="hit"><td class="line">1637</td><td class="hits">25</td><td class="source">        Node.Relationship.create(options.type, options.properties, options.from_id, options.to_id, cb);</td></tr><tr class="hit"><td class="line">1638</td><td class="hits">25</td><td class="source">        return self;</td></tr><tr><td class="line">1639</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">1640</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">1641</td><td class="hits">0</td><td class="source">      cb(Error('Missing from_id('+options.from_id+') or to_id('+options.to_id+') OR no cb attached'), null);</td></tr><tr><td class="line">1642</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1643</td><td class="hits">5</td><td class="source">    return this;</td></tr><tr><td class="line">1644</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1645</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1646</td><td class="hits">8</td><td class="source">  Node.prototype.createRelationBetween = function(node, type, properties, cb, options) {</td></tr><tr class="hit"><td class="line">1647</td><td class="hits">11</td><td class="source">    if (typeof options !== 'object') options = {};</td></tr><tr class="hit"><td class="line">1648</td><td class="hits">6</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">1649</td><td class="hits">6</td><td class="source">    if (typeof properties === 'function') {</td></tr><tr class="hit"><td class="line">1650</td><td class="hits">3</td><td class="source">      cb = properties;</td></tr><tr class="hit"><td class="line">1651</td><td class="hits">3</td><td class="source">      properties = {};</td></tr><tr><td class="line">1652</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1653</td><td class="hits">6</td><td class="source">    if ((this.hasId())&amp;&amp;(helpers.getIdFromObject(node))) {</td></tr><tr><td class="line">1654</td><td class="hits"></td><td class="source">      // to avoid deadlocks</td></tr><tr><td class="line">1655</td><td class="hits"></td><td class="source">      // we have to create the relationships sequentially</td></tr><tr class="hit"><td class="line">1656</td><td class="hits">6</td><td class="source">      self.createRelationTo(node, type, properties, function(err, resultFirst, debug_a){</td></tr><tr class="hit"><td class="line">1657</td><td class="hits">4</td><td class="source">        self.createRelationFrom(node, type, properties, function(secondErr, resultSecond, debug_b) {</td></tr><tr class="hit"><td class="line">1658</td><td class="hits">4</td><td class="source">          if ((err)||(secondErr)) {</td></tr><tr class="miss"><td class="line">1659</td><td class="hits">0</td><td class="source">            if ((err)&amp;&amp;(secondErr))</td></tr><tr class="miss"><td class="line">1660</td><td class="hits">0</td><td class="source">              cb([err, secondErr], null, [ debug_a, debug_b ]);</td></tr><tr><td class="line">1661</td><td class="hits"></td><td class="source">            else</td></tr><tr class="miss"><td class="line">1662</td><td class="hits">0</td><td class="source">              cb(err || secondErr, null, [ debug_a, debug_b ]);</td></tr><tr><td class="line">1663</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="hit"><td class="line">1664</td><td class="hits">4</td><td class="source">            cb(null, [ resultFirst, resultSecond ], debug_a || debug_b);</td></tr><tr><td class="line">1665</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">1666</td><td class="hits"></td><td class="source">        }, options);</td></tr><tr><td class="line">1667</td><td class="hits"></td><td class="source">      }, options);</td></tr><tr><td class="line">1668</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">1669</td><td class="hits">0</td><td class="source">      cb(Error(&quot;You need two instanced nodes as start and end point&quot;), null);</td></tr><tr><td class="line">1670</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1671</td><td class="hits">4</td><td class="source">    return this;</td></tr><tr><td class="line">1672</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1673</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1674</td><td class="hits">8</td><td class="source">  Node.prototype.createRelationTo = function(node, type, properties, cb, options) {</td></tr><tr class="hit"><td class="line">1675</td><td class="hits">41</td><td class="source">    if (typeof options !== 'object') options = {};</td></tr><tr class="hit"><td class="line">1676</td><td class="hits">24</td><td class="source">    var args;</td></tr><tr class="hit"><td class="line">1677</td><td class="hits">24</td><td class="source">    var id = helpers.getIdFromObject(node);</td></tr><tr class="hit"><td class="line">1678</td><td class="hits">24</td><td class="source">    ( ( args = helpers.sortOptionsAndCallbackArguments(properties, cb) ) &amp;&amp; ( properties = args.options ) &amp;&amp; ( cb = args.callback ) );</td></tr><tr class="hit"><td class="line">1679</td><td class="hits">24</td><td class="source">    options = _.extend({</td></tr><tr><td class="line">1680</td><td class="hits"></td><td class="source">      properties: properties,</td></tr><tr><td class="line">1681</td><td class="hits"></td><td class="source">      to_id: id,</td></tr><tr><td class="line">1682</td><td class="hits"></td><td class="source">      type: type</td></tr><tr><td class="line">1683</td><td class="hits"></td><td class="source">    }, options);</td></tr><tr class="hit"><td class="line">1684</td><td class="hits">24</td><td class="source">    return this.createRelation(options, cb);</td></tr><tr><td class="line">1685</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1686</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1687</td><td class="hits">8</td><td class="source">  Node.prototype.createRelationFrom = function(node, type, properties, cb, options) {</td></tr><tr class="hit"><td class="line">1688</td><td class="hits">10</td><td class="source">    if (typeof options !== 'object') options = {};</td></tr><tr class="hit"><td class="line">1689</td><td class="hits">8</td><td class="source">    var args;</td></tr><tr class="hit"><td class="line">1690</td><td class="hits">8</td><td class="source">    var id = helpers.getIdFromObject(node);</td></tr><tr class="hit"><td class="line">1691</td><td class="hits">8</td><td class="source">    ( ( args = helpers.sortOptionsAndCallbackArguments(properties, cb) ) &amp;&amp; ( properties = args.options ) &amp;&amp; ( cb = args.callback ) );</td></tr><tr class="hit"><td class="line">1692</td><td class="hits">8</td><td class="source">    options = _.extend({</td></tr><tr><td class="line">1693</td><td class="hits"></td><td class="source">      properties: properties,</td></tr><tr><td class="line">1694</td><td class="hits"></td><td class="source">      from_id: id,</td></tr><tr><td class="line">1695</td><td class="hits"></td><td class="source">      to_id: this.id,</td></tr><tr><td class="line">1696</td><td class="hits"></td><td class="source">      type: type</td></tr><tr><td class="line">1697</td><td class="hits"></td><td class="source">    }, options);</td></tr><tr class="hit"><td class="line">1698</td><td class="hits">8</td><td class="source">    return this.createRelation(options, cb);</td></tr><tr><td class="line">1699</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1700</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1701</td><td class="hits">8</td><td class="source">  Node.prototype.createOrUpdateRelation = function(options, cb) {</td></tr><tr class="miss"><td class="line">1702</td><td class="hits">0</td><td class="source">    if (typeof options !== 'object') options = {};</td></tr><tr class="miss"><td class="line">1703</td><td class="hits">0</td><td class="source">    options.distinct = true;</td></tr><tr class="miss"><td class="line">1704</td><td class="hits">0</td><td class="source">    return this.createRelation(options, cb);</td></tr><tr><td class="line">1705</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1706</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1707</td><td class="hits">8</td><td class="source">  Node.prototype.createOrUpdateRelationTo = function(node, type, properties, cb, options) {</td></tr><tr class="hit"><td class="line">1708</td><td class="hits">2</td><td class="source">    if (typeof options !== 'object') options = {};</td></tr><tr class="hit"><td class="line">1709</td><td class="hits">1</td><td class="source">    options.distinct = true;</td></tr><tr class="hit"><td class="line">1710</td><td class="hits">1</td><td class="source">    return this.createRelationTo(node, type, properties, cb, options);</td></tr><tr><td class="line">1711</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1712</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1713</td><td class="hits">8</td><td class="source">  Node.prototype.createOrUpdateRelationFrom = function(node, type, properties, cb, options) {</td></tr><tr class="hit"><td class="line">1714</td><td class="hits">4</td><td class="source">    if (typeof options !== 'object') options = {};</td></tr><tr class="hit"><td class="line">1715</td><td class="hits">2</td><td class="source">    options.distinct = true;</td></tr><tr class="hit"><td class="line">1716</td><td class="hits">2</td><td class="source">    return this.createRelationFrom(node, type, properties, cb, options);</td></tr><tr><td class="line">1717</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1718</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1719</td><td class="hits">8</td><td class="source">  Node.prototype.createOrUpdateRelationBetween = function(node, type, properties, cb, options) {</td></tr><tr class="hit"><td class="line">1720</td><td class="hits">2</td><td class="source">    if (typeof options !== 'object') options = {};</td></tr><tr class="hit"><td class="line">1721</td><td class="hits">1</td><td class="source">    options.distinct = true;</td></tr><tr class="hit"><td class="line">1722</td><td class="hits">1</td><td class="source">    return this.createRelationBetween(node, type, properties, cb, options);</td></tr><tr><td class="line">1723</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1724</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1725</td><td class="hits">8</td><td class="source">  Node.prototype.recommendConstructor = function(Fallback) {</td></tr><tr class="hit"><td class="line">1726</td><td class="hits">347</td><td class="source">    if (typeof Fallback !== 'function')</td></tr><tr class="hit"><td class="line">1727</td><td class="hits">347</td><td class="source">      Fallback = this.constructor;</td></tr><tr class="hit"><td class="line">1728</td><td class="hits">347</td><td class="source">    var label = (this.label) ? this.label : ( ((this.labels)&amp;&amp;(this.labels.length===1)) ? this.labels[0] : null );</td></tr><tr class="hit"><td class="line">1729</td><td class="hits">347</td><td class="source">    return (label) ? Node.registered_model(label) || Fallback : Fallback;</td></tr><tr><td class="line">1730</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1731</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1732</td><td class="hits">8</td><td class="source">  Node.prototype.setId = function(id) {</td></tr><tr class="hit"><td class="line">1733</td><td class="hits">1279</td><td class="source">    this.id = this._id_ = id;</td></tr><tr class="hit"><td class="line">1734</td><td class="hits">1279</td><td class="source">    return this;</td></tr><tr><td class="line">1735</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1736</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1737</td><td class="hits"></td><td class="source">  /*</td></tr><tr><td class="line">1738</td><td class="hits"></td><td class="source">   * Label methods</td></tr><tr><td class="line">1739</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">1740</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1741</td><td class="hits">8</td><td class="source">  Node.prototype.requestLabels = function(cb) {</td></tr><tr class="hit"><td class="line">1742</td><td class="hits">380</td><td class="source">    if ((this.hasId())&amp;&amp;(typeof cb === 'function')) {</td></tr><tr class="hit"><td class="line">1743</td><td class="hits">380</td><td class="source">      Graph.request().get('node/'+this.id+'/labels', cb);</td></tr><tr><td class="line">1744</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1745</td><td class="hits">380</td><td class="source">    return this;</td></tr><tr><td class="line">1746</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1747</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1748</td><td class="hits">8</td><td class="source">  Node.prototype.setLabel = function(label) {</td></tr><tr class="hit"><td class="line">1749</td><td class="hits">1</td><td class="source">    return this.setLabels([ label ]);</td></tr><tr><td class="line">1750</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1751</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1752</td><td class="hits">8</td><td class="source">  Node.prototype.setLabels = function(labels) {</td></tr><tr class="hit"><td class="line">1753</td><td class="hits">497</td><td class="source">    if (typeof labels === 'string') {</td></tr><tr class="hit"><td class="line">1754</td><td class="hits">2</td><td class="source">      labels = [ labels ];</td></tr><tr><td class="line">1755</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1756</td><td class="hits">497</td><td class="source">    if (_.isArray(labels)) {</td></tr><tr class="hit"><td class="line">1757</td><td class="hits">487</td><td class="source">      this.labels = labels;</td></tr><tr><td class="line">1758</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">1759</td><td class="hits"></td><td class="source">    // if we have only one label we set this to default label</td></tr><tr class="hit"><td class="line">1760</td><td class="hits">497</td><td class="source">    if ((_.isArray(this.labels))&amp;&amp;(this.labels.length === 1)) {</td></tr><tr class="hit"><td class="line">1761</td><td class="hits">85</td><td class="source">      this.label = this.labels[0];</td></tr><tr><td class="line">1762</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1763</td><td class="hits">497</td><td class="source">    return this;</td></tr><tr><td class="line">1764</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1765</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1766</td><td class="hits">8</td><td class="source">  Node.prototype.labelsAsArray = function() {</td></tr><tr class="hit"><td class="line">1767</td><td class="hits">202</td><td class="source">    var labels = this.labels;</td></tr><tr class="hit"><td class="line">1768</td><td class="hits">202</td><td class="source">    if (!_.isArray(labels))</td></tr><tr class="miss"><td class="line">1769</td><td class="hits">0</td><td class="source">      labels = [];</td></tr><tr class="hit"><td class="line">1770</td><td class="hits">202</td><td class="source">    if (this.label)</td></tr><tr class="hit"><td class="line">1771</td><td class="hits">38</td><td class="source">      labels.push(this.label);</td></tr><tr class="hit"><td class="line">1772</td><td class="hits">202</td><td class="source">    labels = _.uniq(labels);</td></tr><tr class="hit"><td class="line">1773</td><td class="hits">202</td><td class="source">    return labels;</td></tr><tr><td class="line">1774</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1775</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1776</td><td class="hits">8</td><td class="source">  Node.prototype.allLabels = function(cb) {</td></tr><tr class="hit"><td class="line">1777</td><td class="hits">378</td><td class="source">    return this.requestLabels(cb);</td></tr><tr><td class="line">1778</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1779</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1780</td><td class="hits">8</td><td class="source">  Node.prototype.createLabel = function(label, cb) {</td></tr><tr class="miss"><td class="line">1781</td><td class="hits">0</td><td class="source">    return this.createLabels([ label ], cb);</td></tr><tr><td class="line">1782</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1783</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1784</td><td class="hits">8</td><td class="source">  Node.prototype.createLabels = function(labels, cb) {</td></tr><tr class="hit"><td class="line">1785</td><td class="hits">3</td><td class="source">    if ( (this.hasId()) &amp;&amp; (_.isFunction(cb)) )</td></tr><tr class="hit"><td class="line">1786</td><td class="hits">3</td><td class="source">      return Graph.request().post('node/'+this.id+'/labels', { data: labels }, cb);</td></tr><tr><td class="line">1787</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1788</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1789</td><td class="hits"></td><td class="source">  //http://docs.neo4j.org/chunked/milestone/rest-api-node-labels.html</td></tr><tr class="hit"><td class="line">1790</td><td class="hits">8</td><td class="source">  Node.prototype.addLabels = function(labels, cb) {</td></tr><tr class="hit"><td class="line">1791</td><td class="hits">42</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">1792</td><td class="hits">42</td><td class="source">    if ( (this.hasId()) &amp;&amp; (_.isFunction(cb)) ) {</td></tr><tr class="hit"><td class="line">1793</td><td class="hits">40</td><td class="source">      if (!_.isArray(labels))</td></tr><tr class="miss"><td class="line">1794</td><td class="hits">0</td><td class="source">        labels = [ labels ];</td></tr><tr class="hit"><td class="line">1795</td><td class="hits">40</td><td class="source">      self.allLabels(function(err, storedLabels, debug) {</td></tr><tr class="hit"><td class="line">1796</td><td class="hits">40</td><td class="source">        if (err)</td></tr><tr class="miss"><td class="line">1797</td><td class="hits">0</td><td class="source">          return cb(err, storedLabels, debug);</td></tr><tr class="hit"><td class="line">1798</td><td class="hits">40</td><td class="source">        if (!_.isArray(storedLabels))</td></tr><tr class="miss"><td class="line">1799</td><td class="hits">0</td><td class="source">          storedLabels = [];</td></tr><tr class="hit"><td class="line">1800</td><td class="hits">40</td><td class="source">        var addLabels = [];</td></tr><tr><td class="line">1801</td><td class="hits"></td><td class="source">        // only add new labels</td></tr><tr class="hit"><td class="line">1802</td><td class="hits">40</td><td class="source">        labels.forEach(function(label){</td></tr><tr class="hit"><td class="line">1803</td><td class="hits">47</td><td class="source">          if (_.indexOf(storedLabels, label) === -1)</td></tr><tr class="hit"><td class="line">1804</td><td class="hits">4</td><td class="source">            addLabels.push(label);</td></tr><tr><td class="line">1805</td><td class="hits"></td><td class="source">        });</td></tr><tr class="hit"><td class="line">1806</td><td class="hits">40</td><td class="source">        if (addLabels.length &gt; 0)</td></tr><tr class="hit"><td class="line">1807</td><td class="hits">3</td><td class="source">          self.createLabels(addLabels, cb);</td></tr><tr><td class="line">1808</td><td class="hits"></td><td class="source">        else</td></tr><tr class="hit"><td class="line">1809</td><td class="hits">37</td><td class="source">          cb(null, storedLabels, debug);</td></tr><tr><td class="line">1810</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">1811</td><td class="hits"></td><td class="source">    } else {</td></tr><tr><td class="line">1812</td><td class="hits"></td><td class="source">      // otherwise it can be used as a setter</td></tr><tr class="hit"><td class="line">1813</td><td class="hits">2</td><td class="source">      this.labels = labels;</td></tr><tr class="hit"><td class="line">1814</td><td class="hits">2</td><td class="source">      if (labels.length===1)</td></tr><tr class="hit"><td class="line">1815</td><td class="hits">2</td><td class="source">        this.label = labels[0];</td></tr><tr><td class="line">1816</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1817</td><td class="hits">42</td><td class="source">    return this;</td></tr><tr><td class="line">1818</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1819</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1820</td><td class="hits">8</td><td class="source">  Node.prototype.addLabel = function(label, cb) {</td></tr><tr class="hit"><td class="line">1821</td><td class="hits">3</td><td class="source">    return this.addLabels([ label ], cb);</td></tr><tr><td class="line">1822</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1823</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1824</td><td class="hits">8</td><td class="source">  Node.prototype.replaceLabels = function(labels, cb) {</td></tr><tr class="hit"><td class="line">1825</td><td class="hits">1</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">1826</td><td class="hits">1</td><td class="source">    if ( (this.hasId()) &amp;&amp; (_.isFunction(cb)) ) {</td></tr><tr class="hit"><td class="line">1827</td><td class="hits">1</td><td class="source">      if (!_.isArray(labels))</td></tr><tr class="miss"><td class="line">1828</td><td class="hits">0</td><td class="source">        labels = [ labels ];</td></tr><tr class="hit"><td class="line">1829</td><td class="hits">1</td><td class="source">      self.labels = labels;</td></tr><tr class="hit"><td class="line">1830</td><td class="hits">1</td><td class="source">      Graph.request().put('node/'+self.id+'/labels', { data: labels }, cb);</td></tr><tr><td class="line">1831</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1832</td><td class="hits">1</td><td class="source">    return this;</td></tr><tr><td class="line">1833</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1834</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1835</td><td class="hits">8</td><td class="source">  Node.prototype.removeLabels = function(cb) {</td></tr><tr class="miss"><td class="line">1836</td><td class="hits">0</td><td class="source">    var id = this.id;</td></tr><tr class="miss"><td class="line">1837</td><td class="hits">0</td><td class="source">    if ( (this.hasId()) &amp;&amp; (_.isFunction(cb)) ) {</td></tr><tr class="miss"><td class="line">1838</td><td class="hits">0</td><td class="source">      this.allLabels(function(err, labels, debug) {</td></tr><tr class="miss"><td class="line">1839</td><td class="hits">0</td><td class="source">        if ((err)||(!labels))</td></tr><tr class="miss"><td class="line">1840</td><td class="hits">0</td><td class="source">          return cb(err, labels, debug);</td></tr><tr class="miss"><td class="line">1841</td><td class="hits">0</td><td class="source">        var todo = labels.length;</td></tr><tr class="miss"><td class="line">1842</td><td class="hits">0</td><td class="source">        if (todo === 0)</td></tr><tr class="miss"><td class="line">1843</td><td class="hits">0</td><td class="source">          return cb(null, null, debug);</td></tr><tr class="miss"><td class="line">1844</td><td class="hits">0</td><td class="source">        labels.forEach(function(label) {</td></tr><tr class="miss"><td class="line">1845</td><td class="hits">0</td><td class="source">          return Graph.request().delete('node/'+id+'/labels/'+label, function() {</td></tr><tr class="miss"><td class="line">1846</td><td class="hits">0</td><td class="source">            todo--;</td></tr><tr class="miss"><td class="line">1847</td><td class="hits">0</td><td class="source">            if (todo === 0)</td></tr><tr class="miss"><td class="line">1848</td><td class="hits">0</td><td class="source">              cb(null, null, debug);</td></tr><tr><td class="line">1849</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">1850</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">1851</td><td class="hits"></td><td class="source">      })</td></tr><tr><td class="line">1852</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1853</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">1854</td><td class="hits">0</td><td class="source">      return this;</td></tr><tr><td class="line">1855</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">1856</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1857</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1858</td><td class="hits">8</td><td class="source">  Node.prototype.toObject = function() {</td></tr><tr class="hit"><td class="line">1859</td><td class="hits">2813</td><td class="source">    return {</td></tr><tr><td class="line">1860</td><td class="hits"></td><td class="source">      id: this.id,</td></tr><tr><td class="line">1861</td><td class="hits"></td><td class="source">      classification: this.classification,</td></tr><tr><td class="line">1862</td><td class="hits"></td><td class="source">      data: _.clone(this.data),</td></tr><tr><td class="line">1863</td><td class="hits"></td><td class="source">      uri: this.uri,</td></tr><tr><td class="line">1864</td><td class="hits"></td><td class="source">      label: (this.label) ? this.label : null,</td></tr><tr><td class="line">1865</td><td class="hits"></td><td class="source">      labels: (this.labels.length &gt; 0) ? _.clone(this.labels) : []</td></tr><tr><td class="line">1866</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1867</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1868</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1869</td><td class="hits"></td><td class="source">  /*</td></tr><tr><td class="line">1870</td><td class="hits"></td><td class="source">   * Request methods</td></tr><tr><td class="line">1871</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">1872</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1873</td><td class="hits">8</td><td class="source">  Node.prototype.stream = function(cb) {</td></tr><tr class="hit"><td class="line">1874</td><td class="hits">2</td><td class="source">    this._stream_ = true;</td></tr><tr class="hit"><td class="line">1875</td><td class="hits">2</td><td class="source">    return this.exec(cb);</td></tr><tr><td class="line">1876</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1877</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1878</td><td class="hits">8</td><td class="source">  Node.prototype.each = function(cb) {</td></tr><tr class="hit"><td class="line">1879</td><td class="hits">2</td><td class="source">    return this.stream(cb);</td></tr><tr><td class="line">1880</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1881</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1882</td><td class="hits"></td><td class="source">  /*</td></tr><tr><td class="line">1883</td><td class="hits"></td><td class="source">   * STATIC METHODS for `find` Queries</td></tr><tr><td class="line">1884</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">1885</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1886</td><td class="hits">8</td><td class="source">  Node.prototype.find = function(where, cb) {</td></tr><tr class="hit"><td class="line">1887</td><td class="hits">53</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">1888</td><td class="hits">53</td><td class="source">    if (!self._is_singleton_)</td></tr><tr class="miss"><td class="line">1889</td><td class="hits">0</td><td class="source">      self = this.singleton(undefined, this);</td></tr><tr class="hit"><td class="line">1890</td><td class="hits">53</td><td class="source">    self._query_history_.push({ find: true });</td></tr><tr class="hit"><td class="line">1891</td><td class="hits">53</td><td class="source">    if (self.label)</td></tr><tr class="hit"><td class="line">1892</td><td class="hits">17</td><td class="source">      self.withLabel(self.label);</td></tr><tr class="hit"><td class="line">1893</td><td class="hits">53</td><td class="source">    if ((typeof where === 'string')||(typeof where === 'object')) {</td></tr><tr class="hit"><td class="line">1894</td><td class="hits">19</td><td class="source">      return self.where(where,cb);</td></tr><tr><td class="line">1895</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">1896</td><td class="hits">34</td><td class="source">      return self.findAll(cb);</td></tr><tr><td class="line">1897</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">1898</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1899</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1900</td><td class="hits">8</td><td class="source">  Node.prototype.findOne = function(where, cb) {</td></tr><tr class="hit"><td class="line">1901</td><td class="hits">25</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">1902</td><td class="hits">25</td><td class="source">    if (typeof where === 'function') {</td></tr><tr class="miss"><td class="line">1903</td><td class="hits">0</td><td class="source">      cb = where;</td></tr><tr class="miss"><td class="line">1904</td><td class="hits">0</td><td class="source">      where = undefined;</td></tr><tr><td class="line">1905</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1906</td><td class="hits">25</td><td class="source">    self = this.find(where);</td></tr><tr class="hit"><td class="line">1907</td><td class="hits">25</td><td class="source">    self.cypher.segments.limit = 1;</td></tr><tr class="hit"><td class="line">1908</td><td class="hits">25</td><td class="source">    return self.exec(cb);</td></tr><tr><td class="line">1909</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1910</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1911</td><td class="hits">8</td><td class="source">  Node.prototype.findById = function(id, cb) {</td></tr><tr class="hit"><td class="line">1912</td><td class="hits">183</td><td class="source">    var id = Number(id);</td></tr><tr class="hit"><td class="line">1913</td><td class="hits">183</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">1914</td><td class="hits">183</td><td class="source">    if (isNaN(id)) {</td></tr><tr class="miss"><td class="line">1915</td><td class="hits">0</td><td class="source">      throw Error('You have to give a numeric id as argument');</td></tr><tr><td class="line">1916</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1917</td><td class="hits">183</td><td class="source">    this._query_history_.push({ findById: id });</td></tr><tr class="hit"><td class="line">1918</td><td class="hits">183</td><td class="source">    this.cypher.segments.by_id = Number(id);</td></tr><tr class="hit"><td class="line">1919</td><td class="hits">183</td><td class="source">    var identifier = this.cypher.segments.node_identifier || this.__TYPE_IDENTIFIER__;</td></tr><tr class="hit"><td class="line">1920</td><td class="hits">183</td><td class="source">    this.cypher.segments.return_properties = [ identifier ];</td></tr><tr class="hit"><td class="line">1921</td><td class="hits">183</td><td class="source">    if (typeof cb === 'function') {</td></tr><tr class="hit"><td class="line">1922</td><td class="hits">139</td><td class="source">      return this.exec(function(err, found, debug) {</td></tr><tr class="hit"><td class="line">1923</td><td class="hits">139</td><td class="source">        if ( (err) &amp;&amp; (err.exception) &amp;&amp; (self.ignoreExceptionPattern) &amp;&amp; (self.ignoreExceptionPattern.test(err.exception)) ) {</td></tr><tr class="hit"><td class="line">1924</td><td class="hits">4</td><td class="source">          return cb(null, null, debug);</td></tr><tr><td class="line">1925</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">1926</td><td class="hits">135</td><td class="source">        if (found) {</td></tr><tr class="hit"><td class="line">1927</td><td class="hits">134</td><td class="source">          if (found.length &gt; 1) {</td></tr><tr class="miss"><td class="line">1928</td><td class="hits">0</td><td class="source">            return cb(Error('More than one result rows on findById… expected only one distinct result'), found, debug);</td></tr><tr><td class="line">1929</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"><td class="line">1930</td><td class="hits">134</td><td class="source">          found = found[0];</td></tr><tr><td class="line">1931</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">1932</td><td class="hits">135</td><td class="source">        cb(err, found, debug);</td></tr><tr><td class="line">1933</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">1934</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1935</td><td class="hits">44</td><td class="source">    return this.findByKeyValue({ id: id });</td></tr><tr><td class="line">1936</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1937</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1938</td><td class="hits">8</td><td class="source">  Node.prototype.findByKeyValue = function(key, value, cb, _limit_) {</td></tr><tr class="hit"><td class="line">1939</td><td class="hits">46</td><td class="source">    if (typeof _limit_ === 'undefined')</td></tr><tr class="hit"><td class="line">1940</td><td class="hits">44</td><td class="source">      _limit_ = null;</td></tr><tr><td class="line">1941</td><td class="hits"></td><td class="source">    // we have s.th. like</td></tr><tr><td class="line">1942</td><td class="hits"></td><td class="source">    // { key: value }</td></tr><tr class="hit"><td class="line">1943</td><td class="hits">46</td><td class="source">    if (typeof key === 'object') {</td></tr><tr class="hit"><td class="line">1944</td><td class="hits">45</td><td class="source">      cb = value;</td></tr><tr class="hit"><td class="line">1945</td><td class="hits">45</td><td class="source">      var _key = Object.keys(key)[0];</td></tr><tr class="hit"><td class="line">1946</td><td class="hits">45</td><td class="source">      value = key[_key];</td></tr><tr class="hit"><td class="line">1947</td><td class="hits">45</td><td class="source">      key = _key;</td></tr><tr><td class="line">1948</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">1949</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1950</td><td class="hits">46</td><td class="source">    if (typeof key !== 'string')</td></tr><tr class="miss"><td class="line">1951</td><td class="hits">0</td><td class="source">      key = 'id';</td></tr><tr class="hit"><td class="line">1952</td><td class="hits">46</td><td class="source">    if ( (_.isString(key)) &amp;&amp; (typeof value !== 'undefined') ) {</td></tr><tr class="hit"><td class="line">1953</td><td class="hits">46</td><td class="source">      this._query_history_.push({ findByKeyValue: true });</td></tr><tr class="hit"><td class="line">1954</td><td class="hits">46</td><td class="source">      var identifier = this.cypher.segments.node_identifier || this.__TYPE_IDENTIFIER__;</td></tr><tr class="hit"><td class="line">1955</td><td class="hits">46</td><td class="source">      if (this.cypher.segments.return_properties.length === 0)</td></tr><tr class="hit"><td class="line">1956</td><td class="hits">2</td><td class="source">        this.cypher.segments.return_properties = [ identifier ];</td></tr><tr class="hit"><td class="line">1957</td><td class="hits">46</td><td class="source">      if (key !== 'id') {</td></tr><tr class="hit"><td class="line">1958</td><td class="hits">2</td><td class="source">        var query = {};</td></tr><tr class="hit"><td class="line">1959</td><td class="hits">2</td><td class="source">        query[key] = value;</td></tr><tr class="hit"><td class="line">1960</td><td class="hits">2</td><td class="source">        this.where(query);</td></tr><tr class="hit"><td class="line">1961</td><td class="hits">2</td><td class="source">        if (this.label)</td></tr><tr class="miss"><td class="line">1962</td><td class="hits">0</td><td class="source">          this.withLabel(this.label);</td></tr><tr><td class="line">1963</td><td class="hits"></td><td class="source">        // if we have an id: value, we will build the query in prepareQuery</td></tr><tr><td class="line">1964</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">1965</td><td class="hits">46</td><td class="source">      if (typeof cb === 'function') {</td></tr><tr class="hit"><td class="line">1966</td><td class="hits">2</td><td class="source">        return this.exec(function(err,found){</td></tr><tr class="hit"><td class="line">1967</td><td class="hits">2</td><td class="source">          if (err)</td></tr><tr class="miss"><td class="line">1968</td><td class="hits">0</td><td class="source">            return cb(err, found);</td></tr><tr><td class="line">1969</td><td class="hits"></td><td class="source">          else {</td></tr><tr><td class="line">1970</td><td class="hits"></td><td class="source">            // try to return the first (if exists)</td></tr><tr class="hit"><td class="line">1971</td><td class="hits">2</td><td class="source">            if (found === null)</td></tr><tr class="hit"><td class="line">1972</td><td class="hits">1</td><td class="source">              return cb(null, found);</td></tr><tr class="hit"><td class="line">1973</td><td class="hits">1</td><td class="source">            else if (found.length === 0)</td></tr><tr class="miss"><td class="line">1974</td><td class="hits">0</td><td class="source">              found = null;</td></tr><tr class="hit"><td class="line">1975</td><td class="hits">1</td><td class="source">            else if ((found.length === 1) &amp;&amp; ( 1 === _limit_))</td></tr><tr class="hit"><td class="line">1976</td><td class="hits">1</td><td class="source">              found = found[0];</td></tr><tr class="miss"><td class="line">1977</td><td class="hits">0</td><td class="source">            else if ((_limit_ &gt; 1) &amp;&amp; (found.length &gt; _limit_))</td></tr><tr><td class="line">1978</td><td class="hits"></td><td class="source">              // TODO: use a cypher limit instead</td></tr><tr class="miss"><td class="line">1979</td><td class="hits">0</td><td class="source">              found = found.splice(0, _limit_);</td></tr><tr class="hit"><td class="line">1980</td><td class="hits">1</td><td class="source">            return cb(null, found);</td></tr><tr><td class="line">1981</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">1982</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">1983</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">1984</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1985</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">1986</td><td class="hits">44</td><td class="source">    return this;</td></tr><tr><td class="line">1987</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1988</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1989</td><td class="hits">8</td><td class="source">  Node.prototype.findOneByKeyValue = function(key, value, cb) {</td></tr><tr class="hit"><td class="line">1990</td><td class="hits">2</td><td class="source">    return this.findByKeyValue(key, value, cb, 1);</td></tr><tr><td class="line">1991</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">1992</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1993</td><td class="hits">8</td><td class="source">  Node.prototype.findAll = function(cb) {</td></tr><tr class="hit"><td class="line">1994</td><td class="hits">73</td><td class="source">    this._query_history_.push({ findAll: true });</td></tr><tr class="hit"><td class="line">1995</td><td class="hits">73</td><td class="source">    this.cypher.segments.limit = null;</td></tr><tr class="hit"><td class="line">1996</td><td class="hits">73</td><td class="source">    this.cypher.segments.return_properties = ['n'];</td></tr><tr class="hit"><td class="line">1997</td><td class="hits">73</td><td class="source">    if (this.label)</td></tr><tr class="hit"><td class="line">1998</td><td class="hits">16</td><td class="source">      this.withLabel(this.label);</td></tr><tr class="hit"><td class="line">1999</td><td class="hits">73</td><td class="source">    return this.exec(cb);</td></tr><tr><td class="line">2000</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2001</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2002</td><td class="hits">8</td><td class="source">  Node.prototype.findOrCreate = function(where, cb) {</td></tr><tr class="hit"><td class="line">2003</td><td class="hits">4</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">2004</td><td class="hits">4</td><td class="source">    this.constructor.find(where).count(function(err, count, debug) {</td></tr><tr class="hit"><td class="line">2005</td><td class="hits">4</td><td class="source">      if (err)</td></tr><tr class="miss"><td class="line">2006</td><td class="hits">0</td><td class="source">        return cb(err, count, debug);</td></tr><tr><td class="line">2007</td><td class="hits"></td><td class="source">      else {</td></tr><tr class="hit"><td class="line">2008</td><td class="hits">4</td><td class="source">        if (count === 1)</td></tr><tr class="hit"><td class="line">2009</td><td class="hits">1</td><td class="source">          return self.findOne(where, cb);</td></tr><tr class="hit"><td class="line">2010</td><td class="hits">3</td><td class="source">        else if (count &gt; 1)</td></tr><tr class="hit"><td class="line">2011</td><td class="hits">1</td><td class="source">          return cb(Error(&quot;More than one node found… You have query one distinct result&quot;), null);</td></tr><tr><td class="line">2012</td><td class="hits"></td><td class="source">        // else</td></tr><tr class="hit"><td class="line">2013</td><td class="hits">2</td><td class="source">        var node = new self.constructor(where);</td></tr><tr class="hit"><td class="line">2014</td><td class="hits">2</td><td class="source">        node.save(cb);</td></tr><tr><td class="line">2015</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">2016</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">2017</td><td class="hits">4</td><td class="source">    return this;</td></tr><tr><td class="line">2018</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2019</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2020</td><td class="hits"></td><td class="source">  /*</td></tr><tr><td class="line">2021</td><td class="hits"></td><td class="source">   * Singleton methods, shorthands for their corresponding (static) prototype methods</td></tr><tr><td class="line">2022</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">2023</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2024</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">2025</td><td class="hits"></td><td class="source">   * Create a singleton</td></tr><tr><td class="line">2026</td><td class="hits"></td><td class="source">   * Here a singleton (name may convey a singleton object is as single instance)</td></tr><tr><td class="line">2027</td><td class="hits"></td><td class="source">   * is a node object that is used as object to use</td></tr><tr><td class="line">2028</td><td class="hits"></td><td class="source">   * all `static` methods of the node api.</td></tr><tr><td class="line">2029</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">2030</td><td class="hits"></td><td class="source">   * Example:</td></tr><tr><td class="line">2031</td><td class="hits"></td><td class="source">   *    `Node.singleton().findOne().where()`</td></tr><tr><td class="line">2032</td><td class="hits"></td><td class="source">   */</td></tr><tr class="hit"><td class="line">2033</td><td class="hits">8</td><td class="source">  Node.prototype.singleton = function(id, label) {</td></tr><tr class="hit"><td class="line">2034</td><td class="hits">345</td><td class="source">    var Class = this.constructor;</td></tr><tr class="hit"><td class="line">2035</td><td class="hits">345</td><td class="source">    var node = new Class({},id);</td></tr><tr class="hit"><td class="line">2036</td><td class="hits">345</td><td class="source">    if (typeof label === 'string')</td></tr><tr class="miss"><td class="line">2037</td><td class="hits">0</td><td class="source">      node.label = label;</td></tr><tr class="hit"><td class="line">2038</td><td class="hits">345</td><td class="source">    node.resetQuery();</td></tr><tr class="hit"><td class="line">2039</td><td class="hits">345</td><td class="source">    node._is_singleton_ = true;</td></tr><tr class="hit"><td class="line">2040</td><td class="hits">345</td><td class="source">    node.resetQuery();</td></tr><tr class="hit"><td class="line">2041</td><td class="hits">345</td><td class="source">    return node;</td></tr><tr><td class="line">2042</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2043</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2044</td><td class="hits">8</td><td class="source">  Node.singleton = function(id, label) {</td></tr><tr class="hit"><td class="line">2045</td><td class="hits">13</td><td class="source">    return this.prototype.singleton(id, label);</td></tr><tr><td class="line">2046</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2047</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2048</td><td class="hits">8</td><td class="source">  Node.find = function(where, cb) {</td></tr><tr class="miss"><td class="line">2049</td><td class="hits">0</td><td class="source">    return this.prototype.singleton().find(where, cb);</td></tr><tr><td class="line">2050</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2051</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2052</td><td class="hits">8</td><td class="source">  Node.findAll = function(cb) {</td></tr><tr class="hit"><td class="line">2053</td><td class="hits">36</td><td class="source">    return this.prototype.singleton().findAll(cb);</td></tr><tr><td class="line">2054</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2055</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2056</td><td class="hits">8</td><td class="source">  Node.findById = function(id, cb) {</td></tr><tr class="hit"><td class="line">2057</td><td class="hits">169</td><td class="source">    return this.prototype.singleton().findById(id, cb);</td></tr><tr><td class="line">2058</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2059</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2060</td><td class="hits">8</td><td class="source">  Node.findOne = function(where, cb) {</td></tr><tr class="hit"><td class="line">2061</td><td class="hits">24</td><td class="source">    return this.prototype.singleton().findOne(where, cb);</td></tr><tr><td class="line">2062</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2063</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2064</td><td class="hits">8</td><td class="source">  Node.find = function(where, cb) {</td></tr><tr class="hit"><td class="line">2065</td><td class="hits">28</td><td class="source">    return this.prototype.singleton().find(where, cb);</td></tr><tr><td class="line">2066</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2067</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2068</td><td class="hits">8</td><td class="source">  Node.findOrCreate = function(where, cb) {</td></tr><tr class="hit"><td class="line">2069</td><td class="hits">4</td><td class="source">    return this.prototype.singleton().findOrCreate(where, cb);</td></tr><tr><td class="line">2070</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2071</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2072</td><td class="hits">8</td><td class="source">  Node.findByKeyValue = function(key, value, cb) {</td></tr><tr class="miss"><td class="line">2073</td><td class="hits">0</td><td class="source">    return this.prototype.singleton().findByKeyValue(key, value, cb);</td></tr><tr><td class="line">2074</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2075</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2076</td><td class="hits">8</td><td class="source">  Node.findOneByKeyValue = function(key, value, cb) {</td></tr><tr class="hit"><td class="line">2077</td><td class="hits">2</td><td class="source">    return this.prototype.singleton().findOneByKeyValue(key, value, cb);</td></tr><tr><td class="line">2078</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2079</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2080</td><td class="hits">8</td><td class="source">  Node.start = function(start, cb) {</td></tr><tr class="hit"><td class="line">2081</td><td class="hits">2</td><td class="source">    return this.prototype.singleton().start(start, cb);</td></tr><tr><td class="line">2082</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2083</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2084</td><td class="hits">8</td><td class="source">  Node.query = function(cypherQuery, parameters, cb, options) {</td></tr><tr class="miss"><td class="line">2085</td><td class="hits">0</td><td class="source">    return this.prototype.singleton().query(cypherQuery, parameters, cb, options);</td></tr><tr><td class="line">2086</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2087</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2088</td><td class="hits">8</td><td class="source">  Node.registerModel = function(Class, label, prototype, cb) {</td></tr><tr class="hit"><td class="line">2089</td><td class="hits">42</td><td class="source">    var name = null;</td></tr><tr class="hit"><td class="line">2090</td><td class="hits">42</td><td class="source">    var ParentModel = this;</td></tr><tr><td class="line">2091</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2092</td><td class="hits">42</td><td class="source">    if (typeof Class === 'string') {</td></tr><tr><td class="line">2093</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2094</td><td class="hits">22</td><td class="source">      if (typeof label === 'function') {</td></tr><tr class="hit"><td class="line">2095</td><td class="hits">1</td><td class="source">        cb = label;</td></tr><tr class="hit"><td class="line">2096</td><td class="hits">1</td><td class="source">        prototype = {};</td></tr><tr class="hit"><td class="line">2097</td><td class="hits">21</td><td class="source">      } else if (typeof label === 'object') {</td></tr><tr class="hit"><td class="line">2098</td><td class="hits">9</td><td class="source">        cb = prototype;</td></tr><tr class="hit"><td class="line">2099</td><td class="hits">9</td><td class="source">        prototype = label;</td></tr><tr class="hit"><td class="line">2100</td><td class="hits">9</td><td class="source">        label = null;</td></tr><tr class="hit"><td class="line">2101</td><td class="hits">12</td><td class="source">      } else if (typeof prototype === 'function') {</td></tr><tr class="miss"><td class="line">2102</td><td class="hits">0</td><td class="source">        cb = prototype;</td></tr><tr class="miss"><td class="line">2103</td><td class="hits">0</td><td class="source">        prototype = {};</td></tr><tr><td class="line">2104</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">2105</td><td class="hits">22</td><td class="source">      if (typeof prototype !== 'object')</td></tr><tr class="hit"><td class="line">2106</td><td class="hits">12</td><td class="source">        prototype = {};</td></tr><tr class="hit"><td class="line">2107</td><td class="hits">22</td><td class="source">      label = name = Class;</td></tr><tr><td class="line">2108</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2109</td><td class="hits"></td><td class="source">      // we define here an anonymous constructor</td></tr><tr class="hit"><td class="line">2110</td><td class="hits">22</td><td class="source">      Class = function() {</td></tr><tr class="hit"><td class="line">2111</td><td class="hits">76</td><td class="source">        this.init.apply(this, arguments);</td></tr><tr><td class="line">2112</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">2113</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2114</td><td class="hits">22</td><td class="source">      _.extend(Class, ParentModel); // 'static' methods</td></tr><tr><td class="line">2115</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2116</td><td class="hits">22</td><td class="source">      if (prototype) {</td></tr><tr class="hit"><td class="line">2117</td><td class="hits">22</td><td class="source">        _.extend(Class.prototype, ParentModel.prototype, prototype);</td></tr><tr class="hit"><td class="line">2118</td><td class="hits">22</td><td class="source">        if (prototype.fields) {</td></tr><tr><td class="line">2119</td><td class="hits"></td><td class="source">          // extend each field defintion on prototype</td></tr><tr><td class="line">2120</td><td class="hits"></td><td class="source">          // e.g. indexes, defaults…</td></tr><tr class="hit"><td class="line">2121</td><td class="hits">9</td><td class="source">          var fieldDefinitions = prototype.fields;</td></tr><tr><td class="line">2122</td><td class="hits"></td><td class="source">          // fields will be extended seperately</td></tr><tr class="hit"><td class="line">2123</td><td class="hits">9</td><td class="source">          Class.prototype.fields = {};</td></tr><tr><td class="line">2124</td><td class="hits"></td><td class="source">          // iterate and extend through defaults, indexes, unique …</td></tr><tr class="hit"><td class="line">2125</td><td class="hits">9</td><td class="source">          for (var attribute in { indexes: {}, defaults: {},  unique: {} }) {</td></tr><tr class="hit"><td class="line">2126</td><td class="hits">27</td><td class="source">            if ((ParentModel.prototype.fields)&amp;&amp;(ParentModel.prototype.fields[attribute]))</td></tr><tr class="hit"><td class="line">2127</td><td class="hits">27</td><td class="source">              Class.prototype.fields[attribute] = _.extend({}, ParentModel.prototype.fields[attribute], fieldDefinitions[attribute] || {});</td></tr><tr><td class="line">2128</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">2129</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">2130</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">2131</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2132</td><td class="hits">22</td><td class="source">      Class.prototype._constructor_name_ = Class.prototype.label = label;</td></tr><tr><td class="line">2133</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2134</td><td class="hits">22</td><td class="source">      if (!Class.prototype.labels)</td></tr><tr class="hit"><td class="line">2135</td><td class="hits">17</td><td class="source">        Class.prototype.labels = [];</td></tr><tr><td class="line">2136</td><td class="hits"></td><td class="source">      else</td></tr><tr><td class="line">2137</td><td class="hits"></td><td class="source">        // copy (inherited) labels from parent class</td></tr><tr class="hit"><td class="line">2138</td><td class="hits">5</td><td class="source">        Class.prototype.labels = ParentModel.prototype.labels.slice();</td></tr><tr><td class="line">2139</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2140</td><td class="hits">22</td><td class="source">      Class.prototype.labels.unshift(label);</td></tr><tr><td class="line">2141</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2142</td><td class="hits"></td><td class="source">    } else {</td></tr><tr><td class="line">2143</td><td class="hits"></td><td class="source">      // we expect to have a `class`-object as known from CoffeeScript</td></tr><tr class="hit"><td class="line">2144</td><td class="hits">20</td><td class="source">      Class.prototype.labels = Class.getParentModels();</td></tr><tr class="hit"><td class="line">2145</td><td class="hits">20</td><td class="source">      if (typeof label === 'string') {</td></tr><tr class="miss"><td class="line">2146</td><td class="hits">0</td><td class="source">        name = label;</td></tr><tr><td class="line">2147</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">2148</td><td class="hits">20</td><td class="source">        name = helpers.constructorNameOfFunction(Class);</td></tr><tr class="hit"><td class="line">2149</td><td class="hits">20</td><td class="source">        cb = label;</td></tr><tr><td class="line">2150</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">2151</td><td class="hits">20</td><td class="source">      Class.prototype.label = name;</td></tr><tr><td class="line">2152</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">2153</td><td class="hits">42</td><td class="source">    Node.__models__[name] = Class;</td></tr><tr class="hit"><td class="line">2154</td><td class="hits">42</td><td class="source">    if (typeof cb === 'function') {</td></tr><tr class="hit"><td class="line">2155</td><td class="hits">12</td><td class="source">      Class.prototype.initialize(cb);</td></tr><tr><td class="line">2156</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">2157</td><td class="hits">42</td><td class="source">    return Class;</td></tr><tr><td class="line">2158</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2159</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2160</td><td class="hits">8</td><td class="source">  Node.getParentModels = function() {</td></tr><tr class="hit"><td class="line">2161</td><td class="hits">20</td><td class="source">    var models = [];</td></tr><tr class="hit"><td class="line">2162</td><td class="hits">20</td><td class="source">    models.push(helpers.constructorNameOfFunction(this));</td></tr><tr class="hit"><td class="line">2163</td><td class="hits">20</td><td class="source">    if (this.__super__) {</td></tr><tr class="hit"><td class="line">2164</td><td class="hits">20</td><td class="source">      var Class = this;</td></tr><tr class="hit"><td class="line">2165</td><td class="hits">20</td><td class="source">      var i = 0;</td></tr><tr class="hit"><td class="line">2166</td><td class="hits">20</td><td class="source">      var modelName = '';</td></tr><tr class="hit"><td class="line">2167</td><td class="hits">20</td><td class="source">      while((Class.__super__) &amp;&amp; (i &lt; 10)) {</td></tr><tr class="hit"><td class="line">2168</td><td class="hits">20</td><td class="source">        i++;</td></tr><tr class="hit"><td class="line">2169</td><td class="hits">20</td><td class="source">        modelName = helpers.constructorNameOfFunction(Class.__super__);</td></tr><tr><td class="line">2170</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2171</td><td class="hits">20</td><td class="source">        if (!/^(Node|Relationship|Path)/.test(modelName))</td></tr><tr class="hit"><td class="line">2172</td><td class="hits">2</td><td class="source">          models.push(modelName);</td></tr><tr class="hit"><td class="line">2173</td><td class="hits">20</td><td class="source">        if ((Class.prototype.labels)&amp;&amp;(Class.prototype.labels.length &gt; 0))</td></tr><tr class="hit"><td class="line">2174</td><td class="hits">3</td><td class="source">          models.push(Class.prototype.labels);</td></tr><tr class="hit"><td class="line">2175</td><td class="hits">20</td><td class="source">        Class = Class.__super__;</td></tr><tr><td class="line">2176</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">2177</td><td class="hits"></td><td class="source">      // we have a &quot;coffeescript class&quot; object</td></tr><tr><td class="line">2178</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">2179</td><td class="hits">20</td><td class="source">    return _.uniq(_.flatten(models));</td></tr><tr><td class="line">2180</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2181</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2182</td><td class="hits">8</td><td class="source">  Node.unregisterModel = function(Class) {</td></tr><tr class="hit"><td class="line">2183</td><td class="hits">4</td><td class="source">    var name = (typeof Class === 'string') ? Class : helpers.constructorNameOfFunction(Class);</td></tr><tr class="hit"><td class="line">2184</td><td class="hits">4</td><td class="source">    if (typeof Node.__models__[name] === 'function')</td></tr><tr class="hit"><td class="line">2185</td><td class="hits">3</td><td class="source">      delete Node.__models__[name];</td></tr><tr class="hit"><td class="line">2186</td><td class="hits">4</td><td class="source">    return Node.__models__;</td></tr><tr><td class="line">2187</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2188</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2189</td><td class="hits">8</td><td class="source">  Node.registeredModels = function() {</td></tr><tr class="hit"><td class="line">2190</td><td class="hits">97</td><td class="source">    return Node.__models__;</td></tr><tr><td class="line">2191</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2192</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2193</td><td class="hits">8</td><td class="source">  Node.registeredModel = function(model) {</td></tr><tr class="hit"><td class="line">2194</td><td class="hits">94</td><td class="source">    if (typeof model === 'function') {</td></tr><tr class="miss"><td class="line">2195</td><td class="hits">0</td><td class="source">      model = helpers.constructorNameOfFunction(model);</td></tr><tr><td class="line">2196</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">2197</td><td class="hits">94</td><td class="source">    return Node.registeredModels()[model] || null;</td></tr><tr><td class="line">2198</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2199</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2200</td><td class="hits">8</td><td class="source">  Node.ensureIndex = function(cb) {</td></tr><tr class="hit"><td class="line">2201</td><td class="hits">2</td><td class="source">    return this.singleton().ensureIndex(cb);</td></tr><tr><td class="line">2202</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2203</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2204</td><td class="hits">8</td><td class="source">  Node.dropIndex = function(fields, cb) {</td></tr><tr class="miss"><td class="line">2205</td><td class="hits">0</td><td class="source">    return this.singleton().dropIndex(fields, cb);</td></tr><tr><td class="line">2206</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2207</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2208</td><td class="hits">8</td><td class="source">  Node.dropEntireIndex = function(cb) {</td></tr><tr class="hit"><td class="line">2209</td><td class="hits">2</td><td class="source">    return this.singleton().dropEntireIndex(cb);</td></tr><tr><td class="line">2210</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2211</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2212</td><td class="hits">8</td><td class="source">  Node.getIndex = function(cb) {</td></tr><tr class="hit"><td class="line">2213</td><td class="hits">5</td><td class="source">    return this.singleton().getIndex(cb);</td></tr><tr><td class="line">2214</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2215</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2216</td><td class="hits">8</td><td class="source">  Node.disableLoading = function() {</td></tr><tr class="miss"><td class="line">2217</td><td class="hits">0</td><td class="source">    return this.prototype.disableLoading();</td></tr><tr><td class="line">2218</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2219</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2220</td><td class="hits">8</td><td class="source">  Node.enableLoading = function() {</td></tr><tr class="miss"><td class="line">2221</td><td class="hits">0</td><td class="source">    return this.prototype.enableLoading();</td></tr><tr><td class="line">2222</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2223</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2224</td><td class="hits">8</td><td class="source">  Node.deleteAllIncludingRelations = function(cb) {</td></tr><tr class="hit"><td class="line">2225</td><td class="hits">2</td><td class="source">    return this.find().deleteIncludingRelations(cb);</td></tr><tr><td class="line">2226</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2227</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2228</td><td class="hits">8</td><td class="source">  Node.create = function(data, id, cb) {</td></tr><tr class="hit"><td class="line">2229</td><td class="hits">132</td><td class="source">    if (typeof id === 'function') {</td></tr><tr class="hit"><td class="line">2230</td><td class="hits">131</td><td class="source">      cb = id;</td></tr><tr class="hit"><td class="line">2231</td><td class="hits">131</td><td class="source">      id = undefined;</td></tr><tr><td class="line">2232</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">2233</td><td class="hits">132</td><td class="source">    var node = new this(data, id);</td></tr><tr class="hit"><td class="line">2234</td><td class="hits">132</td><td class="source">    if (typeof cb === 'function')</td></tr><tr class="hit"><td class="line">2235</td><td class="hits">131</td><td class="source">      return node.save(cb);</td></tr><tr><td class="line">2236</td><td class="hits"></td><td class="source">    else</td></tr><tr class="hit"><td class="line">2237</td><td class="hits">1</td><td class="source">      return node;</td></tr><tr><td class="line">2238</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2239</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2240</td><td class="hits">8</td><td class="source">  Node.new = function(data, id, cb) {</td></tr><tr class="miss"><td class="line">2241</td><td class="hits">0</td><td class="source">    return this.create(data, id, cb);</td></tr><tr><td class="line">2242</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2243</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2244</td><td class="hits">8</td><td class="source">  Node.setDefaultFields = function(fields) {</td></tr><tr class="hit"><td class="line">2245</td><td class="hits">3</td><td class="source">    return this._setModelFields('defaults', fields);</td></tr><tr><td class="line">2246</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2247</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2248</td><td class="hits">8</td><td class="source">  Node.setIndexFields = function(fields) {</td></tr><tr class="miss"><td class="line">2249</td><td class="hits">0</td><td class="source">    return this._setModelFields('indexes', fields);</td></tr><tr><td class="line">2250</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2251</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2252</td><td class="hits">8</td><td class="source">  Node.setUniqueFields = function(fields) {</td></tr><tr class="miss"><td class="line">2253</td><td class="hits">0</td><td class="source">    return this._setModelFields('unique', fields);</td></tr><tr><td class="line">2254</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2255</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2256</td><td class="hits">8</td><td class="source">  Node._setModelFields = function(part, fields) {</td></tr><tr><td class="line">2257</td><td class="hits"></td><td class="source">    // part: defaults|unique|indexes</td></tr><tr class="hit"><td class="line">2258</td><td class="hits">3</td><td class="source">    for (var attribute in this.prototype.fields[part])</td></tr><tr><td class="line">2259</td><td class="hits"></td><td class="source">      // delete previous fields</td></tr><tr class="hit"><td class="line">2260</td><td class="hits">1</td><td class="source">      delete(this.prototype.fields[part][attribute]);</td></tr><tr class="hit"><td class="line">2261</td><td class="hits">3</td><td class="source">    if ((typeof fields === 'object') &amp;&amp; (fields !== null)) {</td></tr><tr class="hit"><td class="line">2262</td><td class="hits">3</td><td class="source">      for (var attribute in fields)</td></tr><tr class="hit"><td class="line">2263</td><td class="hits">3</td><td class="source">        this.prototype.fields[part][attribute] = fields[attribute]</td></tr><tr><td class="line">2264</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">2265</td><td class="hits">3</td><td class="source">    return this;</td></tr><tr><td class="line">2266</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2267</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2268</td><td class="hits">8</td><td class="source">  Node.registered_model   = Node.registeredModel;</td></tr><tr class="hit"><td class="line">2269</td><td class="hits">8</td><td class="source">  Node.registered_models  = Node.registeredModels;</td></tr><tr class="hit"><td class="line">2270</td><td class="hits">8</td><td class="source">  Node.unregister_model   = Node.unregisterModel;</td></tr><tr class="hit"><td class="line">2271</td><td class="hits">8</td><td class="source">  Node.register_model     = Node.registerModel;</td></tr><tr><td class="line">2272</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2273</td><td class="hits">8</td><td class="source">  Node.prototype._addParametersToCypher = Graph.prototype._addParametersToCypher;</td></tr><tr class="hit"><td class="line">2274</td><td class="hits">8</td><td class="source">  Node.prototype._addParameterToCypher  = Graph.prototype._addParameterToCypher;</td></tr><tr><td class="line">2275</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2276</td><td class="hits">8</td><td class="source">  return neo4jrestful.Node = Node;</td></tr><tr><td class="line">2277</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">2278</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2279</td><td class="hits">1</td><td class="source">if (typeof window !== 'object') {</td></tr><tr class="hit"><td class="line">2280</td><td class="hits">1</td><td class="source">  module.exports = exports = {</td></tr><tr><td class="line">2281</td><td class="hits"></td><td class="source">    init: __initNode__</td></tr><tr><td class="line">2282</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">2283</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="miss"><td class="line">2284</td><td class="hits">0</td><td class="source">  window.Neo4jMapper.initNode = __initNode__;</td></tr><tr><td class="line">2285</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">2286</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/philipp/code/neo4jmapper/src/path.js">/Users/philipp/code/neo4jmapper/src/path.js</h2><div id="stats" class="high"><div class="percentage">87%</div><div class="sloc">66</div><div class="hits">58</div><div class="misses">8</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// # Path</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// Path Object represents a path between two Nodes</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">var __initPath__ = function(neo4jrestful) {</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">8</td><td class="source">  var helpers = null</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">    , _       = null</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">8</td><td class="source">  if (typeof window === 'object') {</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">    // browser</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">    helpers = window.Neo4jMapper.helpers;</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">    _       = window._;</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">  } else {</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    // nodejs</td></tr><tr class="hit"><td class="line">14</td><td class="hits">8</td><td class="source">    helpers = require('./helpers')</td></tr><tr class="hit"><td class="line">15</td><td class="hits">8</td><td class="source">    _       = require('underscore');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">  // Constructor of Path</td></tr><tr class="hit"><td class="line">19</td><td class="hits">8</td><td class="source">  var Path = function Path() {</td></tr><tr class="hit"><td class="line">20</td><td class="hits">2</td><td class="source">    this.nodes = [];</td></tr><tr class="hit"><td class="line">21</td><td class="hits">2</td><td class="source">    this.relationships = [];</td></tr><tr class="hit"><td class="line">22</td><td class="hits">2</td><td class="source">    this.from = {</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">      id: null,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">      uri: null</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    };</td></tr><tr class="hit"><td class="line">26</td><td class="hits">2</td><td class="source">    this.to = {</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">      id: null,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">      uri: null</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    };</td></tr><tr class="hit"><td class="line">30</td><td class="hits">2</td><td class="source">    this._is_instanced_ = true;</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">33</td><td class="hits">8</td><td class="source">  Path.prototype.classification   = 'Path';   // only needed for toObject()</td></tr><tr class="hit"><td class="line">34</td><td class="hits">8</td><td class="source">  Path.prototype.from             = null;</td></tr><tr class="hit"><td class="line">35</td><td class="hits">8</td><td class="source">  Path.prototype.to               = null;</td></tr><tr class="hit"><td class="line">36</td><td class="hits">8</td><td class="source">  Path.prototype.start            = null;</td></tr><tr class="hit"><td class="line">37</td><td class="hits">8</td><td class="source">  Path.prototype.end              = null;</td></tr><tr class="hit"><td class="line">38</td><td class="hits">8</td><td class="source">  Path.prototype.length           = 0;</td></tr><tr class="hit"><td class="line">39</td><td class="hits">8</td><td class="source">  Path.prototype.relationships    = null;</td></tr><tr class="hit"><td class="line">40</td><td class="hits">8</td><td class="source">  Path.prototype.nodes            = null;</td></tr><tr class="hit"><td class="line">41</td><td class="hits">8</td><td class="source">  Path.prototype._response_       = null;</td></tr><tr class="hit"><td class="line">42</td><td class="hits">8</td><td class="source">  Path.prototype._is_singleton_   = false;</td></tr><tr class="hit"><td class="line">43</td><td class="hits">8</td><td class="source">  Path.prototype._is_persisted_   = false;</td></tr><tr class="hit"><td class="line">44</td><td class="hits">8</td><td class="source">  Path.prototype._is_instanced_   = null;</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">46</td><td class="hits">8</td><td class="source">  Path.prototype.singleton = function() {</td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">    var path = new Path();</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">    path._is_singleton_ = true;</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">    return path;</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">  /*</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">  [</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    { start: 'http://localhost:7419/db/data/node/1019',</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">      nodes:</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">       [ 'http://localhost:7419/db/data/node/1019',</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">         'http://localhost:7419/db/data/node/1020',</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">         'http://localhost:7419/db/data/node/1021' ],</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">      length: 2,</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">      relationships:</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">       [ 'http://localhost:7419/db/data/relationship/315',</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">         'http://localhost:7419/db/data/relationship/316' ],</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">      end: 'http://localhost:7419/db/data/node/1021' } ]</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">  */</td></tr><tr class="hit"><td class="line">65</td><td class="hits">8</td><td class="source">  Path.prototype.populateWithDataFromResponse = function(data) {</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">    // if we are working on the prototype object</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">    // we won't mutate it and create a new path instance insetad</td></tr><tr class="hit"><td class="line">68</td><td class="hits">2</td><td class="source">    var path = (this._is_instanced_ !== null) ? this : new Path();</td></tr><tr class="hit"><td class="line">69</td><td class="hits">2</td><td class="source">    if (data) {</td></tr><tr class="hit"><td class="line">70</td><td class="hits">2</td><td class="source">      if (_.isObject(data) &amp;&amp; (!_.isArray(data)))</td></tr><tr class="hit"><td class="line">71</td><td class="hits">2</td><td class="source">        path._response_ = data;</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">      else</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">        path._response_ = data[0];</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">75</td><td class="hits">2</td><td class="source">      if (_.isArray(data.nodes)) {</td></tr><tr class="hit"><td class="line">76</td><td class="hits">2</td><td class="source">        for (var i=0; i &lt; data.nodes.length; i++) {</td></tr><tr class="hit"><td class="line">77</td><td class="hits">6</td><td class="source">          var url = data.nodes[i];</td></tr><tr class="hit"><td class="line">78</td><td class="hits">6</td><td class="source">          if (/[0-9]+$/.test(url))</td></tr><tr class="hit"><td class="line">79</td><td class="hits">3</td><td class="source">            data.nodes[i] = {</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">              uri: url,</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">              id: Number(url.match(/[0-9]+$/)[0])</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">86</td><td class="hits">2</td><td class="source">      path.nodes = _.extend(data.nodes);</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">88</td><td class="hits">2</td><td class="source">      if (_.isArray(data.relationships)) {</td></tr><tr class="hit"><td class="line">89</td><td class="hits">2</td><td class="source">        for (var i=0; i &lt; data.relationships.length; i++) {</td></tr><tr class="hit"><td class="line">90</td><td class="hits">4</td><td class="source">          var url = data.relationships[i];</td></tr><tr class="hit"><td class="line">91</td><td class="hits">4</td><td class="source">          if (/[0-9]+$/.test(url))</td></tr><tr class="hit"><td class="line">92</td><td class="hits">2</td><td class="source">            data.relationships[i] = {</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">              uri: url,</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">              id: Number(url.match(/[0-9]+$/)[0])</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">99</td><td class="hits">2</td><td class="source">      path.relationships = _.extend(data.relationships);</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">101</td><td class="hits">2</td><td class="source">      path.from = {</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">        id: Number(data.start.match(/[0-9]+$/)[0]),</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">        uri: data.start</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">106</td><td class="hits">2</td><td class="source">      path.to = {</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        id: Number(data.end.match(/[0-9]+$/)[0]),</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">        uri: data.end</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">111</td><td class="hits">2</td><td class="source">      path.start = data.start;</td></tr><tr class="hit"><td class="line">112</td><td class="hits">2</td><td class="source">      path.end = data.end;</td></tr><tr class="hit"><td class="line">113</td><td class="hits">2</td><td class="source">      path.length = data.length;</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">116</td><td class="hits">2</td><td class="source">    path._is_persisted_ = true;</td></tr><tr class="hit"><td class="line">117</td><td class="hits">2</td><td class="source">    return path;</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">120</td><td class="hits">8</td><td class="source">  Path.prototype.load = function(cb) {</td></tr><tr class="hit"><td class="line">121</td><td class="hits">1</td><td class="source">    cb(null, this);</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">124</td><td class="hits">8</td><td class="source">  Path.prototype.toObject = function() {</td></tr><tr class="hit"><td class="line">125</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">      classification: this.classification,</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">      start: this.start,</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">      end: this.end,</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">      from: _.extend(this.from),</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">      to: _.extend(this.to),</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">      relationships: _.extend(this.relationships),</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">      nodes: _.extend(this.nodes)</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">136</td><td class="hits">8</td><td class="source">  Path.prototype.resetQuery = function() { return this; }</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">138</td><td class="hits">8</td><td class="source">  Path.new = function() {</td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="source">    return new Path();</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">142</td><td class="hits">8</td><td class="source">  Path.create = Path.new;</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">144</td><td class="hits">8</td><td class="source">  return neo4jrestful.Path = Path;</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">147</td><td class="hits">1</td><td class="source">if (typeof window !== 'object') {</td></tr><tr class="hit"><td class="line">148</td><td class="hits">1</td><td class="source">  module.exports = exports = {</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">    init: __initPath__</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="source">  window.Neo4jMapper.initPath = __initPath__;</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">}</td></tr></tbody></table></div><div class="file"><h2 id="/Users/philipp/code/neo4jmapper/src/relationship.js">/Users/philipp/code/neo4jmapper/src/relationship.js</h2><div id="stats" class="high"><div class="percentage">87%</div><div class="sloc">260</div><div class="hits">228</div><div class="misses">32</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// # Relationship</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * TODO:</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * * make query mapper from Node available for relationships as well</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * * make relationships queryable with custom queries</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">var __initRelationship__ = function(neo4jrestful, Graph, Node) {</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">8</td><td class="source">  if (typeof window === 'object') {</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">    var helpers = window.Neo4jMapper.helpers;</td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">    var _       = window._;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  } else {</td></tr><tr class="hit"><td class="line">15</td><td class="hits">8</td><td class="source">    var helpers  = require('./helpers');</td></tr><tr class="hit"><td class="line">16</td><td class="hits">8</td><td class="source">    var _        = require('underscore');</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">  // Constructor of Relationship</td></tr><tr class="hit"><td class="line">20</td><td class="hits">8</td><td class="source">  var Relationship = function Relationship(type, data, start, end, id, cb) {</td></tr><tr class="hit"><td class="line">21</td><td class="hits">104</td><td class="source">    this.type = this._type_ = type || null;</td></tr><tr class="hit"><td class="line">22</td><td class="hits">104</td><td class="source">    this.from = {</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">      id: null,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">      uri: null</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    };</td></tr><tr class="hit"><td class="line">26</td><td class="hits">104</td><td class="source">    this.to = {</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">      id: null,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">      uri: null</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    };</td></tr><tr class="hit"><td class="line">30</td><td class="hits">104</td><td class="source">    this.data = data || {};</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">32</td><td class="hits">104</td><td class="source">    var startID = null;</td></tr><tr class="hit"><td class="line">33</td><td class="hits">104</td><td class="source">    var endID = null;</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">104</td><td class="source">    if (start)</td></tr><tr class="hit"><td class="line">36</td><td class="hits">31</td><td class="source">      if (Number(start.id))</td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">        startID = Number(start.id);</td></tr><tr class="hit"><td class="line">38</td><td class="hits">30</td><td class="source">      else if (Number(start))</td></tr><tr class="hit"><td class="line">39</td><td class="hits">28</td><td class="source">        startID = Number(start);</td></tr><tr class="hit"><td class="line">40</td><td class="hits">2</td><td class="source">      else if (start)</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        // we assume we have a url here</td></tr><tr class="hit"><td class="line">42</td><td class="hits">2</td><td class="source">        this.setPointIdByUri('from', start);</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">104</td><td class="source">    if (startID)</td></tr><tr class="hit"><td class="line">45</td><td class="hits">29</td><td class="source">      this.setPointUriById('from', startID);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">104</td><td class="source">    if (end)</td></tr><tr class="hit"><td class="line">48</td><td class="hits">31</td><td class="source">      if (Number(end.id))</td></tr><tr class="hit"><td class="line">49</td><td class="hits">1</td><td class="source">        endID = Number(end.id);</td></tr><tr class="hit"><td class="line">50</td><td class="hits">30</td><td class="source">      else if (Number(end))</td></tr><tr class="hit"><td class="line">51</td><td class="hits">28</td><td class="source">        endID = Number(end);</td></tr><tr class="hit"><td class="line">52</td><td class="hits">2</td><td class="source">      else if (end)</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        // we assume we have a url here</td></tr><tr class="hit"><td class="line">54</td><td class="hits">2</td><td class="source">        this.setPointIdByUri('to', end);</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">56</td><td class="hits">104</td><td class="source">    if (endID)</td></tr><tr class="hit"><td class="line">57</td><td class="hits">29</td><td class="source">      this.setPointUriById('to', endID);</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">59</td><td class="hits">104</td><td class="source">    this.fields = _.extend({},{</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">      defaults: _.extend({}, this.fields.defaults),</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">      indexes: _.extend({}, this.fields.indexes) // TODO: implement</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">64</td><td class="hits">104</td><td class="source">    this._is_instanced_ = true;</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">66</td><td class="hits">104</td><td class="source">    if (typeof id === 'number') {</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">      this.setUriById(id);</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">      this.id = this._id_ = id;</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">70</td><td class="hits">104</td><td class="source">      cb = id;</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">72</td><td class="hits">104</td><td class="source">    if (typeof cb === 'function') {</td></tr><tr class="hit"><td class="line">73</td><td class="hits">30</td><td class="source">      return this.save(cb);</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">77</td><td class="hits">8</td><td class="source">  Relationship.prototype.classification   = 'Relationship'; // only needed for toObject()</td></tr><tr class="hit"><td class="line">78</td><td class="hits">8</td><td class="source">  Relationship.prototype.data             = {};</td></tr><tr class="hit"><td class="line">79</td><td class="hits">8</td><td class="source">  Relationship.prototype.start            = null;</td></tr><tr class="hit"><td class="line">80</td><td class="hits">8</td><td class="source">  Relationship.prototype.type             = null;</td></tr><tr class="hit"><td class="line">81</td><td class="hits">8</td><td class="source">  Relationship.prototype._type_           = null;           // like `_id_` to keep a reference to the legacy type</td></tr><tr class="hit"><td class="line">82</td><td class="hits">8</td><td class="source">  Relationship.prototype.end              = null;</td></tr><tr class="hit"><td class="line">83</td><td class="hits">8</td><td class="source">  Relationship.prototype.from             = null;</td></tr><tr class="hit"><td class="line">84</td><td class="hits">8</td><td class="source">  Relationship.prototype.to               = null;</td></tr><tr class="hit"><td class="line">85</td><td class="hits">8</td><td class="source">  Relationship.prototype.id               = null;</td></tr><tr class="hit"><td class="line">86</td><td class="hits">8</td><td class="source">  Relationship.prototype._id_             = null;</td></tr><tr class="hit"><td class="line">87</td><td class="hits">8</td><td class="source">  Relationship.prototype._hashedData_     = null;</td></tr><tr class="hit"><td class="line">88</td><td class="hits">8</td><td class="source">  Relationship.prototype.uri              = null;</td></tr><tr class="hit"><td class="line">89</td><td class="hits">8</td><td class="source">  Relationship.prototype._response_       = null;</td></tr><tr class="hit"><td class="line">90</td><td class="hits">8</td><td class="source">  Relationship.prototype._is_singleton_   = false;</td></tr><tr class="hit"><td class="line">91</td><td class="hits">8</td><td class="source">  Relationship.prototype._is_persisted_   = false;</td></tr><tr class="hit"><td class="line">92</td><td class="hits">8</td><td class="source">  Relationship.prototype.cypher           = null;</td></tr><tr class="hit"><td class="line">93</td><td class="hits">8</td><td class="source">  Relationship.prototype._is_instanced_   = null;</td></tr><tr class="hit"><td class="line">94</td><td class="hits">8</td><td class="source">  Relationship.prototype.fields = {</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">    defaults: {},</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">    indexes: {}</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">  // should **never** be changed</td></tr><tr class="hit"><td class="line">100</td><td class="hits">8</td><td class="source">  Relationship.prototype.__TYPE__ = 'relationship';</td></tr><tr class="hit"><td class="line">101</td><td class="hits">8</td><td class="source">  Relationship.prototype.__TYPE_IDENTIFIER__ = 'r';</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">103</td><td class="hits">8</td><td class="source">  Relationship.prototype.singleton = function(id) {</td></tr><tr class="hit"><td class="line">104</td><td class="hits">10</td><td class="source">    var relationship = new Relationship();</td></tr><tr class="hit"><td class="line">105</td><td class="hits">10</td><td class="source">    if (typeof id === 'number') {</td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="source">      this.id = this._id_ = id;</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">108</td><td class="hits">10</td><td class="source">    relationship._is_singleton_ = true;</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">    // relationship.resetQuery();</td></tr><tr class="hit"><td class="line">110</td><td class="hits">10</td><td class="source">    return relationship;</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">113</td><td class="hits">8</td><td class="source">  Relationship.singleton = function(id) {</td></tr><tr class="hit"><td class="line">114</td><td class="hits">10</td><td class="source">    return this.prototype.singleton(id);</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">117</td><td class="hits">8</td><td class="source">  Relationship.prototype.setPointUriById = function(startOrEnd, id) {</td></tr><tr class="hit"><td class="line">118</td><td class="hits">58</td><td class="source">    if (typeof startOrEnd !== 'string')</td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">      startOrEnd = 'from';</td></tr><tr class="hit"><td class="line">120</td><td class="hits">58</td><td class="source">    if ((startOrEnd !== 'from')&amp;&amp;(startOrEnd !== 'to'))</td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">      throw Error(&quot;You have to set startOrEnd argument to 'from' or 'to'&quot;);</td></tr><tr class="hit"><td class="line">122</td><td class="hits">58</td><td class="source">    if (_.isNumber(id)) {</td></tr><tr class="hit"><td class="line">123</td><td class="hits">58</td><td class="source">      this[startOrEnd].uri = neo4jrestful.absoluteUrl('/relationship/'+id);</td></tr><tr class="hit"><td class="line">124</td><td class="hits">58</td><td class="source">      this[startOrEnd].id = id;</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">126</td><td class="hits">58</td><td class="source">    return this;</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">129</td><td class="hits">8</td><td class="source">  Relationship.prototype.setPointIdByUri = function(startOrEnd, uri) {</td></tr><tr class="hit"><td class="line">130</td><td class="hits">128</td><td class="source">    if (typeof startOrEnd !== 'string')</td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="source">      startOrEnd = 'from';</td></tr><tr class="hit"><td class="line">132</td><td class="hits">128</td><td class="source">    if ((startOrEnd !== 'from')&amp;&amp;(startOrEnd !== 'to'))</td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="source">      throw Error(&quot;You have to set startOrEnd argument to 'from' or 'to'&quot;);</td></tr><tr class="hit"><td class="line">134</td><td class="hits">128</td><td class="source">    if (uri.match(/[0-9]+$/)) {</td></tr><tr class="hit"><td class="line">135</td><td class="hits">128</td><td class="source">      this[startOrEnd].uri = uri;</td></tr><tr class="hit"><td class="line">136</td><td class="hits">128</td><td class="source">      this[startOrEnd].id = Number(uri.match(/[0-9]+$/)[0]);</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">140</td><td class="hits">8</td><td class="source">  Relationship.prototype.applyDefaultValues = null; // will be initialized</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">142</td><td class="hits">8</td><td class="source">  Relationship.prototype.findById = function(id, cb) {</td></tr><tr class="hit"><td class="line">143</td><td class="hits">10</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">144</td><td class="hits">10</td><td class="source">    if ( (_.isNumber(Number(id))) &amp;&amp; (typeof cb === 'function') ) {</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">      // to reduce calls we'll make a specific restful request for one node</td></tr><tr class="hit"><td class="line">146</td><td class="hits">10</td><td class="source">      return Graph.request().get(this.__TYPE__+'/'+id, function(err, object) {</td></tr><tr class="hit"><td class="line">147</td><td class="hits">10</td><td class="source">        if ((object) &amp;&amp; (typeof self.load === 'function')) {</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">          //  &amp;&amp; (typeof node.load === 'function')</td></tr><tr class="hit"><td class="line">149</td><td class="hits">7</td><td class="source">          object.load(cb);</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">151</td><td class="hits">3</td><td class="source">          cb(err, object);</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">    return this;</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">158</td><td class="hits">8</td><td class="source">  Relationship.prototype.save = function(cb) {</td></tr><tr class="hit"><td class="line">159</td><td class="hits">38</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">160</td><td class="hits">38</td><td class="source">    self.onBeforeSave(self, function(err) {</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">      // don't execute if an error is passed through</td></tr><tr class="hit"><td class="line">162</td><td class="hits">38</td><td class="source">      if ((typeof err !== 'undefined')&amp;&amp;(err !== null))</td></tr><tr class="miss"><td class="line">163</td><td class="hits">0</td><td class="source">        cb(err, null);</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">      else</td></tr><tr class="hit"><td class="line">165</td><td class="hits">38</td><td class="source">        self.onSave(function(err, relationship, debug) {</td></tr><tr class="hit"><td class="line">166</td><td class="hits">38</td><td class="source">          if (err)</td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="source">            return cb(err, relationship, debug);</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">          else</td></tr><tr class="hit"><td class="line">169</td><td class="hits">38</td><td class="source">            return self.onAfterSave(self, cb, debug);</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">174</td><td class="hits">8</td><td class="source">  Relationship.prototype.onSave = function(cb) {</td></tr><tr class="hit"><td class="line">175</td><td class="hits">38</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">176</td><td class="hits">38</td><td class="source">    if (this._is_singleton_)</td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="source">      return cb(Error('Singleton instances can not be persisted'), null);</td></tr><tr class="hit"><td class="line">178</td><td class="hits">38</td><td class="source">    if (!this.hasValidData())</td></tr><tr class="miss"><td class="line">179</td><td class="hits">0</td><td class="source">      return cb(Error('relationship does not contain valid data. `'+this.__TYPE__+'.data` must be an object.'));</td></tr><tr class="hit"><td class="line">180</td><td class="hits">38</td><td class="source">    this.resetQuery();</td></tr><tr class="hit"><td class="line">181</td><td class="hits">38</td><td class="source">    this.applyDefaultValues();</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">183</td><td class="hits">38</td><td class="source">    this.id = this._id_;</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">185</td><td class="hits">38</td><td class="source">    if (!this.type)</td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="source">      throw Error(&quot;Type for a relationship is mandatory, e.g. `relationship.type = 'KNOW'`&quot;);</td></tr><tr class="hit"><td class="line">187</td><td class="hits">38</td><td class="source">    if ((!(this.from))||(isNaN(this.from.id)))</td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="source">      throw Error('Relationship requires a `relationship.from` startnode');</td></tr><tr class="hit"><td class="line">189</td><td class="hits">38</td><td class="source">    if ((!(this.to))||(isNaN(this.to.id)))</td></tr><tr class="miss"><td class="line">190</td><td class="hits">0</td><td class="source">      throw Error('Relationship requires a `relationship.to` endnode');</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">192</td><td class="hits">38</td><td class="source">    if (this.hasId()) {</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">194</td><td class="hits">7</td><td class="source">      if ((this._type_) &amp;&amp; (this.type !== this._type_)) {</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">        // type has changed</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">        // since we can't update a relationship type (only properties)</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">        // we have to create a new relationship and delete the &quot;old&quot; one</td></tr><tr class="hit"><td class="line">198</td><td class="hits">1</td><td class="source">        return Relationship.create(this.type, this.data, this.start, this.end, function(err, relationship, debug) {</td></tr><tr class="hit"><td class="line">199</td><td class="hits">1</td><td class="source">          if (err) {</td></tr><tr class="miss"><td class="line">200</td><td class="hits">0</td><td class="source">            return cb(err, relationship, debug);</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">          } else {</td></tr><tr class="hit"><td class="line">202</td><td class="hits">1</td><td class="source">            self.remove(function(err, res, debugDelete) {</td></tr><tr class="hit"><td class="line">203</td><td class="hits">1</td><td class="source">              if (err) {</td></tr><tr class="miss"><td class="line">204</td><td class="hits">0</td><td class="source">                return cb(err, res, debugDelete);</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">              } else {</td></tr><tr class="hit"><td class="line">206</td><td class="hits">1</td><td class="source">                relationship.copyTo(self);</td></tr><tr class="hit"><td class="line">207</td><td class="hits">1</td><td class="source">                return cb(null, self, debug);</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">              }</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">      // UPDATE properties</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">      // url = 'relationship/'+this._id_+'/properties';</td></tr><tr class="hit"><td class="line">216</td><td class="hits">6</td><td class="source">      Graph</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">        .start('r = relationship({id})', {</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">          id: Number(this.id),</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">        .setWith( { r: this.dataForCypher() } )</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">        .return('r')</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">        .exec(cb);</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">224</td><td class="hits">31</td><td class="source">      Graph</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">        .start('n = node({from}), m = node({to})', {</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">          from: Number(this.from.id),</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">          to: Number(this.to.id),</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">        .create([ '(n)-[r: '+helpers.escapeProperty(this.type), this.dataForCypher(), ']-&gt;(m)'])</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">        .return('r')</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">        .limit(1)</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">        .exec(function(err, relationship, debug) {</td></tr><tr class="hit"><td class="line">233</td><td class="hits">31</td><td class="source">          if ((err) || (!relationship))</td></tr><tr class="miss"><td class="line">234</td><td class="hits">0</td><td class="source">            return cb(err, relationship, debug);</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">          else {</td></tr><tr class="hit"><td class="line">236</td><td class="hits">31</td><td class="source">            relationship.copyTo(self);</td></tr><tr class="hit"><td class="line">237</td><td class="hits">31</td><td class="source">            return cb(null, self, debug);</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">243</td><td class="hits">8</td><td class="source">  Relationship.prototype.update = function(data, cb) {</td></tr><tr class="hit"><td class="line">244</td><td class="hits">2</td><td class="source">    if (helpers.isObjectLiteral(data)) {</td></tr><tr class="hit"><td class="line">245</td><td class="hits">2</td><td class="source">      this.data = _.extend(this.data, data);</td></tr><tr class="hit"><td class="line">246</td><td class="hits">2</td><td class="source">      data = this.flattenData();</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">248</td><td class="hits">0</td><td class="source">      cb = data;</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">250</td><td class="hits">2</td><td class="source">    return this.save(cb);</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">253</td><td class="hits">8</td><td class="source">  Relationship.prototype.populateWithDataFromResponse = function(data, create) {</td></tr><tr class="hit"><td class="line">254</td><td class="hits">62</td><td class="source">    create = (typeof create !== 'undefined') ? create : false;</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">    // if we are working on the prototype object</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">    // we won't mutate it and create a new relationship instance insetad</td></tr><tr class="hit"><td class="line">257</td><td class="hits">62</td><td class="source">    var relationship = (this._is_instanced_ !== null) ? this : new Relationship();</td></tr><tr class="hit"><td class="line">258</td><td class="hits">62</td><td class="source">    if (create)</td></tr><tr class="miss"><td class="line">259</td><td class="hits">0</td><td class="source">      relationship = new Relationship();</td></tr><tr class="hit"><td class="line">260</td><td class="hits">62</td><td class="source">    if (data) {</td></tr><tr class="hit"><td class="line">261</td><td class="hits">62</td><td class="source">      if (_.isObject(data) &amp;&amp; (!_.isArray(data)))</td></tr><tr class="hit"><td class="line">262</td><td class="hits">62</td><td class="source">        relationship._response_ = data;</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">      else</td></tr><tr class="miss"><td class="line">264</td><td class="hits">0</td><td class="source">        relationship._response_ = data[0];</td></tr><tr class="hit"><td class="line">265</td><td class="hits">62</td><td class="source">      relationship.data = relationship._response_.data;</td></tr><tr class="hit"><td class="line">266</td><td class="hits">62</td><td class="source">      relationship.data = helpers.unflattenObject(this.data);</td></tr><tr class="hit"><td class="line">267</td><td class="hits">62</td><td class="source">      relationship.uri  = relationship._response_.self;</td></tr><tr class="hit"><td class="line">268</td><td class="hits">62</td><td class="source">      relationship.type = relationship._type_ = relationship._response_.type;</td></tr><tr class="hit"><td class="line">269</td><td class="hits">62</td><td class="source">      if ((relationship._response_.self) &amp;&amp; (relationship._response_.self.match(/[0-9]+$/))) {</td></tr><tr class="hit"><td class="line">270</td><td class="hits">62</td><td class="source">        relationship.id = relationship._id_ = Number(relationship._response_.self.match(/[0-9]+$/)[0]);</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">272</td><td class="hits">62</td><td class="source">      if ((relationship._response_.start) &amp;&amp; (relationship._response_.start.match(/[0-9]+$/))) {</td></tr><tr class="hit"><td class="line">273</td><td class="hits">62</td><td class="source">        relationship.from.uri = relationship.start = relationship._response_.start;</td></tr><tr class="hit"><td class="line">274</td><td class="hits">62</td><td class="source">        relationship.setPointIdByUri('from', relationship._response_.start);</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">276</td><td class="hits">62</td><td class="source">      if ((relationship._response_.end) &amp;&amp; (relationship._response_.end.match(/[0-9]+$/))) {</td></tr><tr class="hit"><td class="line">277</td><td class="hits">62</td><td class="source">        relationship.to.uri = relationship.end = relationship._response_.end;</td></tr><tr class="hit"><td class="line">278</td><td class="hits">62</td><td class="source">        relationship.setPointIdByUri('to', relationship._response_.end);</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">281</td><td class="hits">62</td><td class="source">    relationship._is_persisted_ = true;</td></tr><tr class="hit"><td class="line">282</td><td class="hits">62</td><td class="source">    relationship.isPersisted(true);</td></tr><tr class="hit"><td class="line">283</td><td class="hits">62</td><td class="source">    return relationship;</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">286</td><td class="hits">8</td><td class="source">  Relationship.prototype.remove = function(cb) {</td></tr><tr class="hit"><td class="line">287</td><td class="hits">2</td><td class="source">    if (this._is_singleton_)</td></tr><tr class="miss"><td class="line">288</td><td class="hits">0</td><td class="source">      return cb(Error(&quot;To delete results of a query use delete(). remove() is for removing a relationship.&quot;),null);</td></tr><tr class="hit"><td class="line">289</td><td class="hits">2</td><td class="source">    if (this.hasId()) {</td></tr><tr class="hit"><td class="line">290</td><td class="hits">2</td><td class="source">      return Graph.request().delete('relationship/'+this.id, cb);</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">292</td><td class="hits">0</td><td class="source">    return this;</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">295</td><td class="hits">8</td><td class="source">  Relationship.prototype.loadFromAndToNodes = function(cb) {</td></tr><tr class="hit"><td class="line">296</td><td class="hits">61</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">297</td><td class="hits">61</td><td class="source">    var attributes = ['from', 'to'];</td></tr><tr class="hit"><td class="line">298</td><td class="hits">61</td><td class="source">    var done = 0;</td></tr><tr class="hit"><td class="line">299</td><td class="hits">61</td><td class="source">    var errors = [];</td></tr><tr class="hit"><td class="line">300</td><td class="hits">61</td><td class="source">    for (var i = 0; i &lt; 2; i++) {</td></tr><tr class="hit"><td class="line">301</td><td class="hits">122</td><td class="source">      (function(point){</td></tr><tr class="hit"><td class="line">302</td><td class="hits">122</td><td class="source">        Node.findById(self[point].id,function(err,node) {</td></tr><tr class="hit"><td class="line">303</td><td class="hits">122</td><td class="source">          self[point] = node;</td></tr><tr class="hit"><td class="line">304</td><td class="hits">122</td><td class="source">          if (err)</td></tr><tr class="miss"><td class="line">305</td><td class="hits">0</td><td class="source">            errors.push(err);</td></tr><tr class="hit"><td class="line">306</td><td class="hits">122</td><td class="source">          done++;</td></tr><tr class="hit"><td class="line">307</td><td class="hits">122</td><td class="source">          if (done === 2) {</td></tr><tr class="hit"><td class="line">308</td><td class="hits">61</td><td class="source">            cb((errors.length === 0) ? null : errors, self);</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source">      })(attributes[i]);</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">316</td><td class="hits">8</td><td class="source">  Relationship.prototype.load = function(cb) {</td></tr><tr class="hit"><td class="line">317</td><td class="hits">61</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">318</td><td class="hits">61</td><td class="source">    this._onBeforeLoad(self, function(err, relationship){</td></tr><tr class="hit"><td class="line">319</td><td class="hits">61</td><td class="source">      if (err)</td></tr><tr class="miss"><td class="line">320</td><td class="hits">0</td><td class="source">        cb(err, relationship);</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">      else</td></tr><tr class="hit"><td class="line">322</td><td class="hits">61</td><td class="source">        self._onAfterLoad(relationship, cb);</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">326</td><td class="hits">8</td><td class="source">  Relationship.prototype._onBeforeLoad = function(relationship, next) {</td></tr><tr class="hit"><td class="line">327</td><td class="hits">61</td><td class="source">    return this.onBeforeLoad(relationship, function(err, relationship) {</td></tr><tr class="hit"><td class="line">328</td><td class="hits">61</td><td class="source">      if (relationship.hasId()) {</td></tr><tr class="hit"><td class="line">329</td><td class="hits">61</td><td class="source">        relationship.loadFromAndToNodes(function(err, relationship){</td></tr><tr class="hit"><td class="line">330</td><td class="hits">61</td><td class="source">          next(err, relationship);</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">333</td><td class="hits">0</td><td class="source">        next(null, relationship);</td></tr><tr><td class="line">334</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">336</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">338</td><td class="hits">8</td><td class="source">  Relationship.prototype.onBeforeLoad = function(relationship, next) {</td></tr><tr class="hit"><td class="line">339</td><td class="hits">61</td><td class="source">    return next(null, relationship);</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">342</td><td class="hits">8</td><td class="source">  Relationship.prototype._onAfterLoad = function(relationship, next) {</td></tr><tr class="hit"><td class="line">343</td><td class="hits">61</td><td class="source">    return this.onAfterLoad(relationship, function(err, relationship) {</td></tr><tr class="hit"><td class="line">344</td><td class="hits">61</td><td class="source">      return next(null, relationship);</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source">    })</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">348</td><td class="hits">8</td><td class="source">  Relationship.prototype.onAfterLoad = function(relationship, next) {</td></tr><tr class="hit"><td class="line">349</td><td class="hits">61</td><td class="source">    return next(null, relationship);</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">352</td><td class="hits">8</td><td class="source">  Relationship.prototype.toQuery = function() {</td></tr><tr class="hit"><td class="line">353</td><td class="hits">2</td><td class="source">    if (this.hasId()) {</td></tr><tr class="hit"><td class="line">354</td><td class="hits">2</td><td class="source">      return Graph</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source">        .start('r = relationship('+this.id+')')</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">        .return('r').toQuery();</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source">    }</td></tr><tr class="miss"><td class="line">358</td><td class="hits">0</td><td class="source">    return Graph.start('r = relationship(*)').toQuery();</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">361</td><td class="hits">8</td><td class="source">  Relationship.prototype.toQueryString = Node.prototype.toQueryString;</td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">363</td><td class="hits">8</td><td class="source">  Relationship.prototype.toCypherQuery = Node.prototype.toCypherQuery;</td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">365</td><td class="hits">8</td><td class="source">  Relationship.prototype.toObject = function() {</td></tr><tr class="hit"><td class="line">366</td><td class="hits">125</td><td class="source">    var o = {</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">      id: this.id,</td></tr><tr><td class="line">368</td><td class="hits"></td><td class="source">      classification: this.classification,</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source">      data: _.clone(this.data),</td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source">      start: this.start,</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source">      end: this.end,</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source">      from: _.extend(this.from),</td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source">      to: _.extend(this.to),</td></tr><tr><td class="line">374</td><td class="hits"></td><td class="source">      uri: this.uri,</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source">      type: this.type</td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source">    };</td></tr><tr class="hit"><td class="line">377</td><td class="hits">125</td><td class="source">    if ( (o.from) &amp;&amp; (typeof o.from.toObject === 'function') )</td></tr><tr class="hit"><td class="line">378</td><td class="hits">1</td><td class="source">      o.from = o.from.toObject();</td></tr><tr class="hit"><td class="line">379</td><td class="hits">125</td><td class="source">    if ( (o.to)   &amp;&amp; (typeof o.to.toObject === 'function') )</td></tr><tr class="hit"><td class="line">380</td><td class="hits">1</td><td class="source">      o.to   = o.to.toObject();</td></tr><tr class="hit"><td class="line">381</td><td class="hits">125</td><td class="source">    return o;</td></tr><tr><td class="line">382</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">383</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">384</td><td class="hits">8</td><td class="source">  Relationship.prototype._hashData_ = function() {</td></tr><tr class="hit"><td class="line">385</td><td class="hits">124</td><td class="source">    if (this.hasValidData())</td></tr><tr class="hit"><td class="line">386</td><td class="hits">124</td><td class="source">      return helpers.md5(JSON.stringify(this.toObject()));</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source">    else</td></tr><tr class="miss"><td class="line">388</td><td class="hits">0</td><td class="source">      return null;</td></tr><tr><td class="line">389</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">390</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">391</td><td class="hits">8</td><td class="source">  Relationship.prototype.onBeforeSave = function(node, next) {</td></tr><tr class="hit"><td class="line">392</td><td class="hits">38</td><td class="source">    next(null, null);</td></tr><tr><td class="line">393</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">394</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">395</td><td class="hits">8</td><td class="source">  Relationship.prototype.onAfterSave = function(relationship, next, debug) {</td></tr><tr class="hit"><td class="line">396</td><td class="hits">38</td><td class="source">    return next(null, relationship, debug);</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">398</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">399</td><td class="hits">8</td><td class="source">  Relationship.prototype.resetQuery = function() {</td></tr><tr class="hit"><td class="line">400</td><td class="hits">38</td><td class="source">    this.cypher = new helpers.CypherQuery();</td></tr><tr class="hit"><td class="line">401</td><td class="hits">38</td><td class="source">    return this;</td></tr><tr><td class="line">402</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">403</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">404</td><td class="hits">8</td><td class="source">  Relationship.prototype._load_hook_reference_  = null;</td></tr><tr><td class="line">405</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">406</td><td class="hits"></td><td class="source">  /*</td></tr><tr><td class="line">407</td><td class="hits"></td><td class="source">   * Static singleton methods</td></tr><tr><td class="line">408</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">409</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">410</td><td class="hits">8</td><td class="source">  Relationship.findById = function(id, cb) {</td></tr><tr class="hit"><td class="line">411</td><td class="hits">10</td><td class="source">    return Relationship.singleton().findById(id, cb);</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">413</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">414</td><td class="hits">8</td><td class="source">  Relationship.recommendConstructor = function() {</td></tr><tr class="miss"><td class="line">415</td><td class="hits">0</td><td class="source">    return Relationship;</td></tr><tr><td class="line">416</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">419</td><td class="hits"></td><td class="source">  /* from Node */</td></tr><tr class="hit"><td class="line">420</td><td class="hits">8</td><td class="source">  Relationship.prototype.applyDefaultValues = Node.prototype.applyDefaultValues</td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source">  // Copys only the node's relevant data(s) to another object</td></tr><tr class="hit"><td class="line">423</td><td class="hits">8</td><td class="source">  Relationship.prototype.copyTo = function(r) {</td></tr><tr class="hit"><td class="line">424</td><td class="hits">32</td><td class="source">    r.id = r._id_ = this._id_;</td></tr><tr class="hit"><td class="line">425</td><td class="hits">32</td><td class="source">    r.data   = _.clone(this.data);</td></tr><tr class="hit"><td class="line">426</td><td class="hits">32</td><td class="source">    r.uri = this.uri;</td></tr><tr class="hit"><td class="line">427</td><td class="hits">32</td><td class="source">    r._response_ = _.clone(this._response_);</td></tr><tr class="hit"><td class="line">428</td><td class="hits">32</td><td class="source">    r.from = _.clone(this.from);</td></tr><tr class="hit"><td class="line">429</td><td class="hits">32</td><td class="source">    r.to = _.clone(this.to);</td></tr><tr class="hit"><td class="line">430</td><td class="hits">32</td><td class="source">    r.start = this.start;</td></tr><tr class="hit"><td class="line">431</td><td class="hits">32</td><td class="source">    r.end = this.end;</td></tr><tr class="hit"><td class="line">432</td><td class="hits">32</td><td class="source">    r.type = r._type_ = this._type_;</td></tr><tr class="hit"><td class="line">433</td><td class="hits">32</td><td class="source">    return r;</td></tr><tr><td class="line">434</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">435</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">436</td><td class="hits">8</td><td class="source">  Relationship.prototype.hasValidData     = Node.prototype.hasValidData;</td></tr><tr class="hit"><td class="line">437</td><td class="hits">8</td><td class="source">  Relationship.prototype.flattenData      = Node.prototype.flattenData;</td></tr><tr class="hit"><td class="line">438</td><td class="hits">8</td><td class="source">  Relationship.prototype.setUriById       = Node.prototype.setUriById;</td></tr><tr class="hit"><td class="line">439</td><td class="hits">8</td><td class="source">  Relationship.prototype.isPersisted      = Node.prototype.isPersisted;</td></tr><tr class="hit"><td class="line">440</td><td class="hits">8</td><td class="source">  Relationship.prototype.hasId            = Node.prototype.hasId;</td></tr><tr class="hit"><td class="line">441</td><td class="hits">8</td><td class="source">  Relationship.prototype.dataForCypher    = Node.prototype.dataForCypher;</td></tr><tr><td class="line">442</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">443</td><td class="hits">8</td><td class="source">  Relationship.setDefaultFields            = Node.setDefaultFields;</td></tr><tr class="hit"><td class="line">444</td><td class="hits">8</td><td class="source">  Relationship.setIndexFields              = Node.setIndexFields;</td></tr><tr class="hit"><td class="line">445</td><td class="hits">8</td><td class="source">  Relationship.setUniqueFields             = Node.setUniqueFields;</td></tr><tr class="hit"><td class="line">446</td><td class="hits">8</td><td class="source">  Relationship._setModelFields             = Node._setModelFields;</td></tr><tr><td class="line">447</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">448</td><td class="hits">8</td><td class="source">  Relationship.new = function(type, data, start, end, id, cb) {</td></tr><tr class="hit"><td class="line">449</td><td class="hits">31</td><td class="source">    return new Relationship(type, data, start, end, id, cb);</td></tr><tr><td class="line">450</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">451</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">452</td><td class="hits">8</td><td class="source">  Relationship.create = Relationship.new;</td></tr><tr><td class="line">453</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">454</td><td class="hits">8</td><td class="source">  return neo4jrestful.Relationship = Relationship;</td></tr><tr><td class="line">455</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">456</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">457</td><td class="hits">1</td><td class="source">if (typeof window !== 'object') {</td></tr><tr class="hit"><td class="line">458</td><td class="hits">1</td><td class="source">  module.exports = exports = {</td></tr><tr><td class="line">459</td><td class="hits"></td><td class="source">    init: __initRelationship__</td></tr><tr><td class="line">460</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">461</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="miss"><td class="line">462</td><td class="hits">0</td><td class="source">  window.Neo4jMapper.initRelationship = __initRelationship__;</td></tr><tr><td class="line">463</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">464</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/philipp/code/neo4jmapper/src/transaction.js">/Users/philipp/code/neo4jmapper/src/transaction.js</h2><div id="stats" class="high"><div class="percentage">85%</div><div class="sloc">223</div><div class="hits">191</div><div class="misses">32</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">// # Transaction</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">// Can be used to send (many) cypher statement(s) as transaction</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">// see: [http://docs.neo4j.org/chunked/preview/rest-api-transactional.html](http://docs.neo4j.org/chunked/preview/rest-api-transactional.html)</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">var __initTransaction__ = function(neo4jrestful) {</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">8</td><td class="source">  var Statement = function Statement(transaction, cypher, parameters) {</td></tr><tr class="hit"><td class="line">8</td><td class="hits">24</td><td class="source">    this._transaction_  = transaction;</td></tr><tr class="hit"><td class="line">9</td><td class="hits">24</td><td class="source">    this.statement = cypher;</td></tr><tr class="hit"><td class="line">10</td><td class="hits">24</td><td class="source">    this.parameters = parameters;</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">8</td><td class="source">  Statement.prototype._transaction_ = null;</td></tr><tr class="hit"><td class="line">14</td><td class="hits">8</td><td class="source">  Statement.prototype.statement = '';</td></tr><tr class="hit"><td class="line">15</td><td class="hits">8</td><td class="source">  Statement.prototype.parameters = null;</td></tr><tr class="hit"><td class="line">16</td><td class="hits">8</td><td class="source">  Statement.prototype.status = null; // 'sending', 'sended'</td></tr><tr class="hit"><td class="line">17</td><td class="hits">8</td><td class="source">  Statement.prototype.position = null;</td></tr><tr class="hit"><td class="line">18</td><td class="hits">8</td><td class="source">  Statement.prototype.results = null;</td></tr><tr class="hit"><td class="line">19</td><td class="hits">8</td><td class="source">  Statement.prototype.errors = null;</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">8</td><td class="source">  Statement.prototype.toObject = function() {</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">    return {</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">      statement: this.statement,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">      parameters: JSON.stringify(this.parameters),</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">      status: this.status,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">      position: this.position,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">      errors: this.errors,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">      results: this.results,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">32</td><td class="hits">8</td><td class="source">  var Transaction = function Transaction(cypher, parameters, cb) {</td></tr><tr class="hit"><td class="line">33</td><td class="hits">16</td><td class="source">    this.neo4jrestful = neo4jrestful.singleton();</td></tr><tr class="hit"><td class="line">34</td><td class="hits">16</td><td class="source">    this.begin(cypher, parameters, cb);</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">37</td><td class="hits">8</td><td class="source">  Transaction.Statement = Statement;</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">8</td><td class="source">  Transaction.prototype.statements = null;</td></tr><tr class="hit"><td class="line">40</td><td class="hits">8</td><td class="source">  Transaction.prototype._response_ = null;</td></tr><tr class="hit"><td class="line">41</td><td class="hits">8</td><td class="source">  Transaction.prototype.neo4jrestful = null;</td></tr><tr class="hit"><td class="line">42</td><td class="hits">8</td><td class="source">  Transaction.prototype.status = ''; // new|creating|open|committing|committed</td></tr><tr class="hit"><td class="line">43</td><td class="hits">8</td><td class="source">  Transaction.prototype.id = null;</td></tr><tr class="hit"><td class="line">44</td><td class="hits">8</td><td class="source">  Transaction.prototype.uri = null</td></tr><tr class="hit"><td class="line">45</td><td class="hits">8</td><td class="source">  Transaction.prototype.expires = null;</td></tr><tr class="hit"><td class="line">46</td><td class="hits">8</td><td class="source">  Transaction.prototype.results = null;</td></tr><tr class="hit"><td class="line">47</td><td class="hits">8</td><td class="source">  Transaction.prototype._concurrentTransmissions_ = 0;</td></tr><tr class="hit"><td class="line">48</td><td class="hits">8</td><td class="source">  Transaction.prototype._responseError_ = null; //will contain response Error</td></tr><tr class="hit"><td class="line">49</td><td class="hits">8</td><td class="source">  Transaction.prototype._resortResults_ = true;</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">51</td><td class="hits">8</td><td class="source">  Transaction.prototype.begin = function(cypher, parameters, cb) {</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">    // reset</td></tr><tr class="hit"><td class="line">53</td><td class="hits">16</td><td class="source">    this.statements = [];</td></tr><tr class="hit"><td class="line">54</td><td class="hits">16</td><td class="source">    this.results = [];</td></tr><tr class="hit"><td class="line">55</td><td class="hits">16</td><td class="source">    this.errors = [];</td></tr><tr class="hit"><td class="line">56</td><td class="hits">16</td><td class="source">    this.id = null;</td></tr><tr class="hit"><td class="line">57</td><td class="hits">16</td><td class="source">    this.status = 'new';</td></tr><tr class="hit"><td class="line">58</td><td class="hits">16</td><td class="source">    return this.add(cypher, parameters, cb);</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">61</td><td class="hits">8</td><td class="source">  Transaction.prototype.add = function(cypher, parameters, cb) {</td></tr><tr class="hit"><td class="line">62</td><td class="hits">29</td><td class="source">    var args = Transaction._sortTransactionArguments(cypher, parameters, cb);</td></tr><tr class="hit"><td class="line">63</td><td class="hits">29</td><td class="source">    var statements = args.statements;</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">    // we cancel the operation if we are comitting</td></tr><tr class="hit"><td class="line">65</td><td class="hits">29</td><td class="source">    if (this.status === 'committed') {</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">      var err = Error(&quot;You can't add statements after transaction is committed&quot;);</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">      if (typeof args.cb === 'function') {</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">        cb(err, null);</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="source">        throw err;</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">      return this;</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">74</td><td class="hits">29</td><td class="source">    this.addStatementsToQueue(statements);</td></tr><tr class="hit"><td class="line">75</td><td class="hits">29</td><td class="source">    if (args.cb) {</td></tr><tr class="hit"><td class="line">76</td><td class="hits">10</td><td class="source">      cb = args.cb;</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">    } else {</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">      // we execute if we have a callback</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">      // till then we'll collect the statements</td></tr><tr class="hit"><td class="line">80</td><td class="hits">19</td><td class="source">      return this;</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">82</td><td class="hits">10</td><td class="source">    return this.exec(cb);</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">85</td><td class="hits">8</td><td class="source">  Transaction.prototype.exec = function(cb) {</td></tr><tr class="hit"><td class="line">86</td><td class="hits">21</td><td class="source">    var self = this;</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    // stop here if there is no callback attached</td></tr><tr class="hit"><td class="line">88</td><td class="hits">21</td><td class="source">    if (typeof cb !== 'function') {</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">      return this;</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">91</td><td class="hits">21</td><td class="source">    self.onResponse = cb;</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">93</td><td class="hits">21</td><td class="source">    var url = '';</td></tr><tr class="hit"><td class="line">94</td><td class="hits">21</td><td class="source">    var untransmittedStatements = this.untransmittedStatements();</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">96</td><td class="hits">21</td><td class="source">    if (this.status === 'committing') {</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">      // commit transaction</td></tr><tr class="hit"><td class="line">98</td><td class="hits">10</td><td class="source">      url = (this.id) ? '/transaction/'+this.id+'/commit' : '/transaction/commit';</td></tr><tr class="hit"><td class="line">99</td><td class="hits">11</td><td class="source">    } else if (!this.id) {</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">      // begin a transaction</td></tr><tr class="hit"><td class="line">101</td><td class="hits">9</td><td class="source">      this.status = 'creating';</td></tr><tr class="hit"><td class="line">102</td><td class="hits">9</td><td class="source">      url = '/transaction';</td></tr><tr class="hit"><td class="line">103</td><td class="hits">2</td><td class="source">    } else if (this.status === 'open') {</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">      // add to transaction</td></tr><tr class="hit"><td class="line">105</td><td class="hits">2</td><td class="source">      this.status = 'adding';</td></tr><tr class="hit"><td class="line">106</td><td class="hits">2</td><td class="source">      url = '/transaction/'+this.id;</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">    } else if (this.status = 'committed') {</td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">      cb(Error('Transaction is committed. Create a new transaction instead.'), null, null);</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="source">      throw Error('Transaction has a unknown status. Possible are: creating|open|committing|committed');</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">112</td><td class="hits">21</td><td class="source">    var statements = [];</td></tr><tr class="hit"><td class="line">113</td><td class="hits">21</td><td class="source">    untransmittedStatements.forEach(function(statement, i){</td></tr><tr class="hit"><td class="line">114</td><td class="hits">23</td><td class="source">      self.statements[i].status = 'sending';</td></tr><tr class="hit"><td class="line">115</td><td class="hits">23</td><td class="source">      statements.push({ statement: statement.statement, parameters: statement.parameters });</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">117</td><td class="hits">21</td><td class="source">    this._concurrentTransmissions_++;</td></tr><tr class="hit"><td class="line">118</td><td class="hits">21</td><td class="source">    this.neo4jrestful.post(url, { data: { statements: statements } }, function(err, response, debug) {</td></tr><tr class="hit"><td class="line">119</td><td class="hits">21</td><td class="source">      self._response_ = response;</td></tr><tr class="hit"><td class="line">120</td><td class="hits">21</td><td class="source">      self._concurrentTransmissions_--;</td></tr><tr class="hit"><td class="line">121</td><td class="hits">21</td><td class="source">      self._applyResponse(err, response, debug, untransmittedStatements);</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">123</td><td class="hits">21</td><td class="source">      untransmittedStatements.forEach(function(statement) {</td></tr><tr class="hit"><td class="line">124</td><td class="hits">23</td><td class="source">        self.statements[statement.position].status = statement.status = 'sended';</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">127</td><td class="hits">21</td><td class="source">      untransmittedStatements = self.untransmittedStatements();</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">129</td><td class="hits">21</td><td class="source">      if (untransmittedStatements.length &gt; 0) {</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">        // re call exec() until all statements are transmitted</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">        // TODO: set a limit to avoid endless loop</td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="source">        return self.exec(cb);</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">      // TODO: sort and populate resultset, but currently no good way to detect result objects</td></tr><tr class="hit"><td class="line">135</td><td class="hits">21</td><td class="source">      else if (self._concurrentTransmissions_ === 0) {//  {</td></tr><tr class="hit"><td class="line">136</td><td class="hits">21</td><td class="source">        if (typeof self.onResponse === 'function') {</td></tr><tr class="hit"><td class="line">137</td><td class="hits">21</td><td class="source">          var cb = self.onResponse;</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">          // release onResponse for (optional) next cb</td></tr><tr class="hit"><td class="line">139</td><td class="hits">21</td><td class="source">          self.onResponse = null;</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">          // call final callback</td></tr><tr class="hit"><td class="line">141</td><td class="hits">21</td><td class="source">          if (self.status === 'committing')</td></tr><tr class="hit"><td class="line">142</td><td class="hits">10</td><td class="source">            self.status = 'committed';</td></tr><tr class="hit"><td class="line">143</td><td class="hits">21</td><td class="source">          cb(self._responseError_, self, debug);</td></tr><tr class="hit"><td class="line">144</td><td class="hits">21</td><td class="source">          return self;</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">149</td><td class="hits">21</td><td class="source">    return this;</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">152</td><td class="hits">8</td><td class="source">  Transaction.prototype.addStatementsToQueue = function(statements) {</td></tr><tr class="hit"><td class="line">153</td><td class="hits">32</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">154</td><td class="hits">32</td><td class="source">    if ((statements) &amp;&amp; (statements.constructor === Array) &amp;&amp; (statements.length &gt; 0)) {</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">      // attach all statments</td></tr><tr class="hit"><td class="line">156</td><td class="hits">24</td><td class="source">      statements.forEach(function(data){</td></tr><tr class="hit"><td class="line">157</td><td class="hits">24</td><td class="source">        if (data.statement) {</td></tr><tr class="hit"><td class="line">158</td><td class="hits">24</td><td class="source">          var statement = new Statement(self, data.statement, data.parameters);</td></tr><tr class="hit"><td class="line">159</td><td class="hits">24</td><td class="source">          statement.position = self.statements.length;</td></tr><tr class="hit"><td class="line">160</td><td class="hits">24</td><td class="source">          self.statements.push(statement);</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">164</td><td class="hits">32</td><td class="source">    return this;</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">167</td><td class="hits">8</td><td class="source">  Transaction.prototype._applyResponse = function(err, response, debug, untransmittedStatements) {</td></tr><tr class="hit"><td class="line">168</td><td class="hits">21</td><td class="source">    var self = this;</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">    // if error on request/response</td></tr><tr class="hit"><td class="line">170</td><td class="hits">21</td><td class="source">    if (self.status !== 'committing')</td></tr><tr class="hit"><td class="line">171</td><td class="hits">11</td><td class="source">      self.status = 'open';</td></tr><tr class="hit"><td class="line">172</td><td class="hits">21</td><td class="source">    if (err) {</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">      self.status = (err.status) ? err.status : err;</td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">      if (!self.status)</td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">        self.status = self._response_.status;</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">177</td><td class="hits">21</td><td class="source">    untransmittedStatements.forEach(function(statement, i){</td></tr><tr class="hit"><td class="line">178</td><td class="hits">23</td><td class="source">      if (response.errors[i]) {</td></tr><tr class="hit"><td class="line">179</td><td class="hits">1</td><td class="source">        statement.error = response.errors[i];</td></tr><tr class="hit"><td class="line">180</td><td class="hits">1</td><td class="source">        self.errors.push(response.errors[i]);</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">182</td><td class="hits">23</td><td class="source">      if (response.results[i]) {</td></tr><tr class="hit"><td class="line">183</td><td class="hits">22</td><td class="source">        if (self._resortResults_) {</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">          // move row property one level above</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">          // { rows: [ {}, {} ]} -&gt; { [ {}, {} ]}</td></tr><tr class="hit"><td class="line">186</td><td class="hits">22</td><td class="source">          response.results[i].data.forEach(function(data, j){</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">            //if ((response.results[i]) &amp;&amp; (data.row)) {</td></tr><tr class="hit"><td class="line">188</td><td class="hits">24</td><td class="source">            if (data.row) {</td></tr><tr class="hit"><td class="line">189</td><td class="hits">24</td><td class="source">              response.results[i].data[j] = data.row;</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">          })</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">193</td><td class="hits">22</td><td class="source">        self.results.push(response.results[i]);</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">196</td><td class="hits">21</td><td class="source">    if ((err)||(!response)) {</td></tr><tr class="miss"><td class="line">197</td><td class="hits">0</td><td class="source">      self._responseError_ = (self._responseError_) ? self._responseError_.push(err) : self._responseError_ = [ err ];</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">199</td><td class="hits">21</td><td class="source">      self.populateWithDataFromResponse(response);</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">      // keep track of open transactions</td></tr><tr class="hit"><td class="line">201</td><td class="hits">21</td><td class="source">      if (self.status === 'open')</td></tr><tr class="hit"><td class="line">202</td><td class="hits">11</td><td class="source">        Transaction.__open_transactions__[self.id] = self;</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">      else</td></tr><tr class="hit"><td class="line">204</td><td class="hits">10</td><td class="source">        delete Transaction.__open_transactions__[self.id];</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">208</td><td class="hits">8</td><td class="source">  Transaction.prototype.toObject = function() {</td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="source">    var statements = [];</td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="source">    this.statements.forEach(function(stat){</td></tr><tr class="miss"><td class="line">211</td><td class="hits">0</td><td class="source">      statements.push(stat.toObject());</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">    });</td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="source">    return {</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">      id: this.id,</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">      status: this.status,</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">      statements: statements,</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">      expires: this.expires,</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">      uri: this.uri,</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">222</td><td class="hits">8</td><td class="source">  Transaction.prototype.populateWithDataFromResponse = function(data) {</td></tr><tr class="hit"><td class="line">223</td><td class="hits">21</td><td class="source">    if (data) {</td></tr><tr class="hit"><td class="line">224</td><td class="hits">21</td><td class="source">      if ((data.transaction) &amp;&amp; (data.transaction.expires))</td></tr><tr class="hit"><td class="line">225</td><td class="hits">11</td><td class="source">        this.expires = new Date(data.transaction.expires);</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">      // exists only on POST a new transaction</td></tr><tr class="hit"><td class="line">227</td><td class="hits">21</td><td class="source">      if (data.commit) {</td></tr><tr class="hit"><td class="line">228</td><td class="hits">11</td><td class="source">        var match = data.commit.match(/^(.+?\/transaction\/(\d+))\/commit$/);</td></tr><tr class="hit"><td class="line">229</td><td class="hits">11</td><td class="source">        this.id = Number(match[2]);</td></tr><tr class="hit"><td class="line">230</td><td class="hits">11</td><td class="source">        this.uri = match[1];</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">235</td><td class="hits">8</td><td class="source">  Transaction.prototype.untransmittedStatements = function() {</td></tr><tr class="hit"><td class="line">236</td><td class="hits">43</td><td class="source">    var statements = [];</td></tr><tr class="hit"><td class="line">237</td><td class="hits">43</td><td class="source">    this.statements.forEach(function(statement){</td></tr><tr class="hit"><td class="line">238</td><td class="hits">76</td><td class="source">      if ((statement)&amp;&amp;(!statement.status))</td></tr><tr class="hit"><td class="line">239</td><td class="hits">23</td><td class="source">        statements.push(statement);</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">241</td><td class="hits">43</td><td class="source">    return statements;</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">244</td><td class="hits">8</td><td class="source">  Transaction.prototype.commit = function(cypher, parameters, cb) {</td></tr><tr class="hit"><td class="line">245</td><td class="hits">10</td><td class="source">    if (typeof cypher === 'function') {</td></tr><tr class="hit"><td class="line">246</td><td class="hits">7</td><td class="source">      cb = cypher;</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">248</td><td class="hits">3</td><td class="source">      var args = Transaction._sortTransactionArguments(cypher, parameters, cb);</td></tr><tr class="hit"><td class="line">249</td><td class="hits">3</td><td class="source">      this.addStatementsToQueue(args.statements);</td></tr><tr class="hit"><td class="line">250</td><td class="hits">3</td><td class="source">      cb = args.cb;</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">252</td><td class="hits">10</td><td class="source">    if (typeof cb !== 'function') {</td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="source">      throw Error('You need to attach a callback an a commit/close operation');</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">255</td><td class="hits">10</td><td class="source">    this.onResponse = cb;</td></tr><tr class="hit"><td class="line">256</td><td class="hits">10</td><td class="source">    this.status = 'committing';</td></tr><tr class="hit"><td class="line">257</td><td class="hits">10</td><td class="source">    return this.exec(cb);</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">260</td><td class="hits">8</td><td class="source">  Transaction.prototype.close = Transaction.prototype.commit;</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">262</td><td class="hits">8</td><td class="source">  Transaction.create = function(cypher, parameters, cb) {</td></tr><tr class="miss"><td class="line">263</td><td class="hits">0</td><td class="source">    return new Transaction(cypher, parameters, cb);</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">266</td><td class="hits">8</td><td class="source">  Transaction.new = function(cypher, parameters) {</td></tr><tr class="miss"><td class="line">267</td><td class="hits">0</td><td class="source">    return new Transaction(cypher, parameters);</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">270</td><td class="hits">8</td><td class="source">  Transaction.prototype.onResponse = null;</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">272</td><td class="hits">8</td><td class="source">  Transaction._sortTransactionArguments = function(cypher, parameters, cb) {</td></tr><tr class="hit"><td class="line">273</td><td class="hits">32</td><td class="source">    var statements = null;</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">    // we might have a Graph or CypherQuery Object</td></tr><tr class="hit"><td class="line">275</td><td class="hits">32</td><td class="source">    if ((typeof cypher === 'object') &amp;&amp; ((typeof cypher.toQuery === 'function') || (typeof cypher.statementsToString === 'function'))) {</td></tr><tr class="hit"><td class="line">276</td><td class="hits">1</td><td class="source">      if (cypher.toQuery) {</td></tr><tr class="hit"><td class="line">277</td><td class="hits">1</td><td class="source">        statements = [ { statement: cypher.toQuery().statementsToString(), parameters: cypher.parameters() }];</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">279</td><td class="hits">0</td><td class="source">        statements = [ { statement: cypher.statementsToString(), parameters: cypher.parameters() }];</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">281</td><td class="hits">1</td><td class="source">      cb = parameters;</td></tr><tr class="hit"><td class="line">282</td><td class="hits">31</td><td class="source">    } else if (typeof cypher === 'string') {</td></tr><tr class="hit"><td class="line">283</td><td class="hits">23</td><td class="source">      if (typeof parameters === 'function') {</td></tr><tr class="miss"><td class="line">284</td><td class="hits">0</td><td class="source">        cb = parameters;</td></tr><tr class="miss"><td class="line">285</td><td class="hits">0</td><td class="source">        parameters = {};</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">287</td><td class="hits">23</td><td class="source">      statements = [ { statement: cypher, parameters: parameters || {} } ];</td></tr><tr class="hit"><td class="line">288</td><td class="hits">8</td><td class="source">    } else if ((cypher) &amp;&amp; (cypher.constructor === Array)) {</td></tr><tr class="miss"><td class="line">289</td><td class="hits">0</td><td class="source">      cb = parameters;</td></tr><tr class="miss"><td class="line">290</td><td class="hits">0</td><td class="source">      statements = cypher;</td></tr><tr class="hit"><td class="line">291</td><td class="hits">8</td><td class="source">    } else if ((cypher) &amp;&amp; (cypher.statement)) {</td></tr><tr class="miss"><td class="line">292</td><td class="hits">0</td><td class="source">      statements = [ cypher ];</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">294</td><td class="hits">32</td><td class="source">    return {</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source">      statements: statements,</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source">      cb: cb || null</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">300</td><td class="hits">8</td><td class="source">  Transaction.prototype.rollback = function(cb) {</td></tr><tr class="hit"><td class="line">301</td><td class="hits">4</td><td class="source">    var self = this;</td></tr><tr class="hit"><td class="line">302</td><td class="hits">4</td><td class="source">    if ((this.id)&amp;&amp;(this.status!=='finalized')) {</td></tr><tr class="hit"><td class="line">303</td><td class="hits">4</td><td class="source">      this.neo4jrestful.delete('/transaction/'+this.id, function(err, res, debug) {</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">        // remove from open_transactions</td></tr><tr class="hit"><td class="line">305</td><td class="hits">4</td><td class="source">        if (!err)</td></tr><tr class="hit"><td class="line">306</td><td class="hits">4</td><td class="source">          delete Transaction.__open_transactions__[self.id];</td></tr><tr class="hit"><td class="line">307</td><td class="hits">4</td><td class="source">        cb(err, res, debug);</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">310</td><td class="hits">0</td><td class="source">      cb(Error('You can only perform a rollback on an open transaction.'), null);</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">312</td><td class="hits">4</td><td class="source">    return this;</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">315</td><td class="hits">8</td><td class="source">  Transaction.prototype.undo   = Transaction.prototype.rollback;</td></tr><tr class="hit"><td class="line">316</td><td class="hits">8</td><td class="source">  Transaction.prototype.delete = Transaction.prototype.rollback;</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">318</td><td class="hits">8</td><td class="source">  Transaction.begin = function(cypher, parameters, cb) {</td></tr><tr class="hit"><td class="line">319</td><td class="hits">9</td><td class="source">    return new Transaction(cypher, parameters, cb);</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">322</td><td class="hits">8</td><td class="source">  Transaction.create = Transaction.begin;</td></tr><tr class="hit"><td class="line">323</td><td class="hits">8</td><td class="source">  Transaction.open = Transaction.begin;</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">325</td><td class="hits">8</td><td class="source">  Transaction.commit = function(cypher, parameters, cb) {</td></tr><tr class="hit"><td class="line">326</td><td class="hits">3</td><td class="source">    return new Transaction().commit(cypher, parameters, cb);</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">329</td><td class="hits">8</td><td class="source">  Transaction.executeAllOpenTransactions = function(cb, action) {</td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source">    // action can be commit|rollback</td></tr><tr class="hit"><td class="line">331</td><td class="hits">2</td><td class="source">    if (typeof action === 'undefined')</td></tr><tr class="miss"><td class="line">332</td><td class="hits">0</td><td class="source">      action = 'commit';</td></tr><tr class="hit"><td class="line">333</td><td class="hits">2</td><td class="source">    var count = Object.keys(Transaction.__open_transactions__).length;</td></tr><tr class="hit"><td class="line">334</td><td class="hits">2</td><td class="source">    var errors = [];</td></tr><tr class="hit"><td class="line">335</td><td class="hits">2</td><td class="source">    var debugs = [];</td></tr><tr><td class="line">336</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">337</td><td class="hits">2</td><td class="source">    var _onDone_ = function(err, res, debug) {</td></tr><tr class="hit"><td class="line">338</td><td class="hits">4</td><td class="source">      count--;</td></tr><tr class="hit"><td class="line">339</td><td class="hits">4</td><td class="source">      if (err)</td></tr><tr class="miss"><td class="line">340</td><td class="hits">0</td><td class="source">        errors.push(err);</td></tr><tr class="hit"><td class="line">341</td><td class="hits">4</td><td class="source">      debugs.push(debug);</td></tr><tr class="hit"><td class="line">342</td><td class="hits">4</td><td class="source">      if (count === 0)</td></tr><tr class="hit"><td class="line">343</td><td class="hits">2</td><td class="source">        cb( ((errors.length &gt; 0) ? errors : null), null, debugs );</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">346</td><td class="hits">2</td><td class="source">    for (var id in Transaction.__open_transactions__) {</td></tr><tr class="hit"><td class="line">347</td><td class="hits">4</td><td class="source">      Transaction.__open_transactions__[id][action](_onDone_);</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">350</td><td class="hits">2</td><td class="source">    return this;</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">353</td><td class="hits">8</td><td class="source">  Transaction.commitAll   = function(cb) {</td></tr><tr class="hit"><td class="line">354</td><td class="hits">1</td><td class="source">    return this.executeAllOpenTransactions(cb, 'commit');</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">356</td><td class="hits">8</td><td class="source">  Transaction.closeAll    = Transaction.commitAll;</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">358</td><td class="hits">8</td><td class="source">  Transaction.rollbackAll = function(cb) {</td></tr><tr class="hit"><td class="line">359</td><td class="hits">1</td><td class="source">    Transaction.executeAllOpenTransactions(cb, 'rollback');</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">362</td><td class="hits">8</td><td class="source">  Transaction.deleteAll   = Transaction.rollbackAll;</td></tr><tr class="hit"><td class="line">363</td><td class="hits">8</td><td class="source">  Transaction.undoAll     = Transaction.rollbackAll;</td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">  // all open transactions</td></tr><tr class="hit"><td class="line">366</td><td class="hits">8</td><td class="source">  Transaction.__open_transactions__ = {};</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">368</td><td class="hits">8</td><td class="source">  return neo4jrestful.Transaction = Transaction;</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">372</td><td class="hits">1</td><td class="source">if (typeof window !== 'object') {</td></tr><tr class="hit"><td class="line">373</td><td class="hits">1</td><td class="source">  module.exports = exports = {</td></tr><tr><td class="line">374</td><td class="hits"></td><td class="source">    init: __initTransaction__</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source">} else {</td></tr><tr class="miss"><td class="line">377</td><td class="hits">0</td><td class="source">  window.Neo4jMapper.initTransaction = __initTransaction__;</td></tr><tr><td class="line">378</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">379</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div></div></div></body></html>